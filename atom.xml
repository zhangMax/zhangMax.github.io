<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Wonkey Zhang</title>
  <icon>https://www.gravatar.com/avatar/52f4c6aa1dd1284f9fdf1f9ff8036d97</icon>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://wonkeyz.com/"/>
  <updated>2018-01-10T02:41:38.296Z</updated>
  <id>http://wonkeyz.com/</id>
  
  <author>
    <name>Wonkey Zhang</name>
    <email>zhangQiangView@163.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>WZRunLoopObserver</title>
    <link href="http://wonkeyz.com/2017/11/17/WZRunLoopObserver/"/>
    <id>http://wonkeyz.com/2017/11/17/WZRunLoopObserver/</id>
    <published>2017-11-17T07:25:53.000Z</published>
    <updated>2018-01-10T02:41:38.296Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰å†™çš„<a href="http://www.wonkeyz.com/2017/07/22/Runloop-Learning-summary/" target="_blank" rel="external">RunLoopå­¦ä¹ æ€»ç»“</a>æ–‡ç« ä¸­æåˆ°äº†åˆ©ç”¨ RunLoop è§£å†³åœ¨tableViewä¸­åŒæ—¶åŠ è½½å¤šä¸ªå¤§å›¾å¡é¡¿çš„æ–¹æ¡ˆ<a href="https://github.com/diwu/RunLoopWorkDistribution" target="_blank" rel="external">RunLoopWorkDistribution</a>ï¼Œå®ƒçš„è§£å†³æ€è·¯æ˜¯åœ¨ä¸€æ¬¡ RunLoop æ—¶å€™åªç»˜åˆ¶ä¸€å¼ å›¾ç‰‡ï¼Œè¿™æ ·æ¯æ¬¡ RunLoop éœ€è¦å¤„ç†çš„æ“ä½œå˜å°‘ï¼Œä»è€Œé¿å…å¡é¡¿ã€‚å—å®ƒçš„å¯å‘æˆ‘æœ€è¿‘å†™äº†ä¸€ä¸ªæ–¹æ¡ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸å…¶ç›¸åŒçš„ä¹Ÿæ˜¯ç›‘å¬æ¯æ¬¡ RunLoop çš„ç©ºé—²æ—¶(<code>kCFRunLoopBeforeWaiting</code>)æ¥å®Œæˆä¸€æ¬¡ä»»åŠ¡ï¼Œä¸åŒçš„æ˜¯æ›´åŠ æ˜“ç”¨ï¼Œæ”¯æŒåŠŸèƒ½æ›´é½å…¨ï¼Œä¸‹é¢æˆ‘æ¥ç®€å•ä»‹ç»ä¸‹ã€‚<br><a id="more"></a><br>å…ˆæ¥çœ‹ä¸‹æ¥å£:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WZRunLoopObserver</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> ä¸»ä»»åŠ¡é˜Ÿåˆ—, observerä¸ä¼šç§»é™¤</div><div class="line"> </div><div class="line"> WZRunLoopObserver.main;</div><div class="line"> */</div><div class="line">+ (WZRunLoopObserver *)main;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> è‡ªå®šä¹‰é˜Ÿåˆ—, å½“ä»»åŠ¡æ•°ä¸º0æ—¶, ä¼šåœ¨å½“å‰RunLoopå¾ªç¯næ¬¡åç§»é™¤observer, né»˜è®¤å€¼ä¸º100</div><div class="line"> </div><div class="line"> WZRunLoopObserver.queue(@"com.wonkeyz.queue");</div><div class="line"> */</div><div class="line">+ (WZRunLoopObserver *(^)(<span class="built_in">NSString</span> *))queue;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> æ·»åŠ ä»»åŠ¡</div><div class="line"> </div><div class="line"> WZRunLoopObserver.main.add(dispatch_block_t task).add(...);</div><div class="line"> */</div><div class="line">- (WZRunLoopObserver *(^)(dispatch_block_t))add;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> å–æ¶ˆä»»åŠ¡</div><div class="line"> </div><div class="line"> WZRunLoopObserver.main.cancel(dispatch_block_t task)</div><div class="line"> */</div><div class="line">- (WZRunLoopObserver *(^)(dispatch_block_t))cancel;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> é™åˆ¶ä»»åŠ¡ä¸ªæ•°, é»˜è®¤ä¸é™åˆ¶, è¶…å‡ºåä¼šç§»é™¤å…ˆæ·»åŠ çš„ä»»åŠ¡</div><div class="line"> </div><div class="line"> WZRunLoopObserver.main.limit(n).add(...);</div><div class="line"> */</div><div class="line">- (WZRunLoopObserver *(^)(<span class="built_in">NSUInteger</span>))limit;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> ç¼“å­˜è¶…å‡ºé™åˆ¶çš„ä»»åŠ¡, å½“ä»»åŠ¡é˜Ÿåˆ—ä¸å†è¶…é™æ—¶å°†ç¼“å­˜çš„ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­, é»˜è®¤å…³é—­</div><div class="line"> </div><div class="line"> WZRunLoopObserver.main.limit(10).cache.add(...);</div><div class="line"> */</div><div class="line">- (WZRunLoopObserver *(^)(<span class="built_in">BOOL</span>))cache;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> å»¶è¿Ÿè°ƒç”¨ä»»åŠ¡, åœ¨å½“å‰RunLoopå¾ªç¯næ¬¡åæ‰§è¡Œä»»åŠ¡</div><div class="line"> </div><div class="line"> WZRunLoopObserver.main.delay(n).add(...);</div><div class="line"> */</div><div class="line">- (WZRunLoopObserver *(^)(<span class="built_in">NSUInteger</span>))delay;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p><p>æ˜“ç”¨æ€§ä½“ç°åœ¨é“¾å¼è°ƒç”¨ï¼Œè¿™é‡Œæˆ‘å‚è€ƒäº†<code>Masonry</code>ï¼Œä¸¾ä¸ªä¾‹å­ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (WZRunLoopObserver *(^)(<span class="built_in">NSUInteger</span>))limit &#123;</div><div class="line">    <span class="keyword">return</span> ^<span class="keyword">id</span>(<span class="built_in">NSUInteger</span> limit)&#123;</div><div class="line">        _limitCount = limit;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>å› ä¸ºå¾ˆå¤šåœ°æ–¹è¦ç”¨åˆ°è¿™ç§è¿”å›<code>self</code>çš„blockï¼Œæ‰€ä»¥æˆ‘å¼„äº†ä¸ªå®ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#define kRunLoopChainLockBlock(param, ...) \</span></div><div class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(&amp;*<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>; \</div><div class="line"><span class="keyword">return</span> ^<span class="keyword">id</span>(param)&#123; \</div><div class="line">__<span class="keyword">strong</span> <span class="keyword">typeof</span>(&amp;*weakSelf) <span class="keyword">self</span> = weakSelf; \</div><div class="line">dispatch_semaphore_wait(_lock, DISPATCH_TIME_FOREVER); \</div><div class="line">__VA_ARGS__ \</div><div class="line">dispatch_semaphore_signal(_lock); \</div><div class="line"><span class="keyword">return</span> <span class="keyword">self</span>; \</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p><p>ä¸ºäº†é˜²æ­¢æ•°æ®æŠ¢å¤ºï¼Œå®é‡Œä½¿ç”¨äº†<code>dispatch_semaphore_t</code>ç»™æ•°æ®çš„æ“ä½œåŠ äº†é”ã€‚</p><p>åŠŸèƒ½æ›´ä¸°å¯Œä½“ç°åœ¨æ”¯æŒå¯¹ä»»åŠ¡ä¸ªæ•°çš„é™åˆ¶ã€ç¼“å­˜ä»»åŠ¡ã€å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ã€å–æ¶ˆä»»åŠ¡çš„æ“ä½œã€‚</p><p>æ ¸å¿ƒä»£ç ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)addObserverWithRunLoop:(<span class="built_in">CFRunLoopRef</span>)runloop &#123;</div><div class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(&amp;*<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(<span class="literal">NULL</span>, kCFRunLoopBeforeWaiting, <span class="literal">YES</span>, <span class="number">0</span>, ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</div><div class="line">        </div><div class="line">        __<span class="keyword">strong</span> <span class="keyword">typeof</span>(&amp;*weakSelf) <span class="keyword">self</span> = weakSelf;</div><div class="line">        </div><div class="line">        <span class="comment">// æ— ä»»åŠ¡æ‰§è¡Œ</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.tasks.count == <span class="number">0</span>) <span class="keyword">return</span>;</div><div class="line">        </div><div class="line">        <span class="comment">// å»¶è¿ŸæŒ‡å®šæ¬¡æ•°æ‰§è¡Œ</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>-&gt;_delay &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">self</span>-&gt;_delay--;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></div><div class="line">        dispatch_block_t task = <span class="keyword">self</span>.tasks.firstObject;</div><div class="line">        task();</div><div class="line">        [<span class="keyword">self</span>.tasks removeObject:task];</div><div class="line">        </div><div class="line">        <span class="comment">// æ·»åŠ ç¼“å­˜ä»»åŠ¡</span></div><div class="line">        <span class="keyword">if</span> (_isCache &amp;&amp; <span class="keyword">self</span>.caches.count) &#123;</div><div class="line">            <span class="keyword">id</span> cacheTask = <span class="keyword">self</span>.caches.firstObject;</div><div class="line">            [<span class="keyword">self</span>.tasks addObject:cacheTask];</div><div class="line">            [<span class="keyword">self</span>.caches removeObject:cacheTask];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// ç§»é™¤è§‚å¯Ÿè€…</span></div><div class="line">        [<span class="keyword">self</span> removeObserver:observer];</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="built_in">CFRunLoopAddObserver</span>(runloop, observer, kCFRunLoopCommonModes);</div><div class="line">    <span class="built_in">CFRelease</span>(observer);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ä½¿ç”¨æ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// tableViewåŠ è½½å¤šå¼ å¤§å›¾çš„æƒ…å†µ</div><div class="line">WZRunLoopObserver.main.limit(50).cache(YES).add(^&#123;</div><div class="line">    imageView1.image = [UIImage imageWithContentsOfFile:path];</div><div class="line">&#125;).add(^&#123;</div><div class="line">    imageView2.image = [UIImage imageWithContentsOfFile:path];</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p><p>æ•´ä½“é€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä¹‹åæˆ‘ä¼šæ•´ç†ä¸‹æŠŠä»£ç ä¼ ä¸Šå»ï¼Œå¤§å®¶çœ‹ä»£ç å°±ä¸€ç›®äº†ç„¶äº†ã€‚å½“ç„¶å¯èƒ½è‡ªå·±å¤ªæ°´ä¼šæœ‰ä¸€äº›éšè—çš„å‘åœ¨é‡Œé¢ï¼Œå¤§å®¶è°¨æ…ä½¿ç”¨ï¼Œé‡åœ¨ç†è§£æ€è·¯å§ğŸ˜‚ï¼Œæ—¥åæˆ‘ä¼šæŠ½ç©ºå®Œå–„~</p><p>demo:<a href="https://github.com/zhangMax/WZRunLoopObserver" target="_blank" rel="external">WZRunLoopObserver</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¹‹å‰å†™çš„&lt;a href=&quot;http://www.wonkeyz.com/2017/07/22/Runloop-Learning-summary/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RunLoopå­¦ä¹ æ€»ç»“&lt;/a&gt;æ–‡ç« ä¸­æåˆ°äº†åˆ©ç”¨ RunLoop è§£å†³åœ¨tableViewä¸­åŒæ—¶åŠ è½½å¤šä¸ªå¤§å›¾å¡é¡¿çš„æ–¹æ¡ˆ&lt;a href=&quot;https://github.com/diwu/RunLoopWorkDistribution&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RunLoopWorkDistribution&lt;/a&gt;ï¼Œå®ƒçš„è§£å†³æ€è·¯æ˜¯åœ¨ä¸€æ¬¡ RunLoop æ—¶å€™åªç»˜åˆ¶ä¸€å¼ å›¾ç‰‡ï¼Œè¿™æ ·æ¯æ¬¡ RunLoop éœ€è¦å¤„ç†çš„æ“ä½œå˜å°‘ï¼Œä»è€Œé¿å…å¡é¡¿ã€‚å—å®ƒçš„å¯å‘æˆ‘æœ€è¿‘å†™äº†ä¸€ä¸ªæ–¹æ¡ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸å…¶ç›¸åŒçš„ä¹Ÿæ˜¯ç›‘å¬æ¯æ¬¡ RunLoop çš„ç©ºé—²æ—¶(&lt;code&gt;kCFRunLoopBeforeWaiting&lt;/code&gt;)æ¥å®Œæˆä¸€æ¬¡ä»»åŠ¡ï¼Œä¸åŒçš„æ˜¯æ›´åŠ æ˜“ç”¨ï¼Œæ”¯æŒåŠŸèƒ½æ›´é½å…¨ï¼Œä¸‹é¢æˆ‘æ¥ç®€å•ä»‹ç»ä¸‹ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="RunLoop" scheme="http://wonkeyz.com/tags/RunLoop/"/>
    
      <category term="å¡é¡¿" scheme="http://wonkeyz.com/tags/%E5%8D%A1%E9%A1%BF/"/>
    
  </entry>
  
  <entry>
    <title>å…¥å‘å°ç¨‹åº</title>
    <link href="http://wonkeyz.com/2017/10/15/wxapp/"/>
    <id>http://wonkeyz.com/2017/10/15/wxapp/</id>
    <published>2017-10-15T14:23:51.000Z</published>
    <updated>2017-12-21T10:10:15.264Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰ä¸€å¤©äº§å“ç»ç†è¯´å’±ä»¬æä¸ªå°ç¨‹åºå§ï¼Œç¨‹åºçŒ¿ï¼šå“¦ğŸ™ƒ</p><p>å¹¸å¥½å®‰å“çš„åŒäº‹æå‰å…¥äº†å‘ï¼Œåœ¨ä»–çš„æŠ€æœ¯åˆ†äº«åï¼Œæˆ‘ä¹Ÿéšä¹‹å…¥äº†å‘ã€‚</p><p>å¼€å§‹æˆ‘ä»¥ä¸ºå°ç¨‹åºçš„å®ç°æ˜¯ç±»ä¼¼React-nativeçš„ï¼Œé€šè¿‡äº†è§£æ‰çŸ¥é“åœ¨iOSä¸Šæ˜¯é€šè¿‡<code>WKWebView</code>å°†<code>Html+CSS</code>å‘ˆç°ç»™ç”¨æˆ·ï¼Œé¡µé¢é—´çš„åˆ‡æ¢å’Œè·³è½¬æ˜¯åŸºäºåŸç”Ÿçš„<code>UITabBarController</code>å’Œ<code>UINavigationController</code>ï¼Œè¿™ç§`native+webviewçš„å®ç°é€ å°±äº†å°ç¨‹åºæ˜“ä¸Šæ‰‹ã€ä½“éªŒå¥½çš„ä¼˜ç‚¹ã€‚<br><a id="more"></a></p><h2 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h2><p>é¦–å…ˆè¦æœ‰ä¸€å®šçš„å‰ç«¯åŸºç¡€ï¼ˆæˆ‘ä¸ä¼šå‘Šè¯‰ä½ æˆ‘æ˜¯ä¸´æ—¶æŠ±ä½›è„šçš„â€¦ï¼‰ï¼Œå…¶æ¬¡å°±æ˜¯çœ‹<a href="https://mp.weixin.qq.com/debug/wxadoc/dev/framework/structure.html" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>å’Œ<a href="https://mp.weixin.qq.com/debug/wxadoc/dev/demo.html?t=2017112" target="_blank" rel="external">æ¼”ç¤ºdemo</a>ï¼Œé‡Œé¢å†™çš„å¾ˆè¯¦ç»†ï¼Œèµ°ä¸€éä¸‹æ¥å†å†™å‡ ä¸ªdemoï¼ŒåŸºæœ¬å°±èƒ½ç€æ‰‹å¼€å‘äº†ï¼Œå°±æ˜¯è¿™ä¹ˆæ˜“ä¸Šæ‰‹ã€‚é‡åˆ°é—®é¢˜å¯ä»¥å»<a href="http://developers.weixin.qq.com/home?tab=1&amp;labels=&amp;lang=zh_CN&amp;token=" target="_blank" rel="external">å®˜æ–¹ç¤¾åŒº</a>æé—®ã€‚</p><h2 id="ç®€å•ç¤ºä¾‹"><a href="#ç®€å•ç¤ºä¾‹" class="headerlink" title="ç®€å•ç¤ºä¾‹"></a>ç®€å•ç¤ºä¾‹</h2><p>ç®€å•ä¸¾å‡ ä¸ªç¤ºä¾‹</p><h3 id="é€šè¿‡è¯·æ±‚åŠ è½½åˆ—è¡¨"><a href="#é€šè¿‡è¯·æ±‚åŠ è½½åˆ—è¡¨" class="headerlink" title="é€šè¿‡è¯·æ±‚åŠ è½½åˆ—è¡¨"></a>é€šè¿‡è¯·æ±‚åŠ è½½åˆ—è¡¨</h3><p>æƒ³è¦æ˜¾ç¤ºç±»ä¼¼UITabViewçš„åˆ—è¡¨å¿…é¡»åœ¨viewç»„ä»¶ä¸Šç”¨<code>wx:for</code>æ¥ç»‘å®šä¸€ä¸ªæ•°ç»„ç„¶åæ¸²æŸ“ã€‚åœ¨.jsæ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªæ•°ç»„items<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Page(&#123;</div><div class="line">  <span class="attr">data</span>: &#123;</div><div class="line">    <span class="attr">items</span>:[],</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><p>åœ¨.jsæ–‡ä»¶ä¸­è¯·æ±‚æ¥å£è·å–æ•°æ®å¹¶èµ‹å€¼ç»™items<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Page(&#123;</div><div class="line">  <span class="attr">data</span>: &#123;</div><div class="line">    <span class="attr">items</span>:[],</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">onLoad</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;</div><div class="line">    wx.request(&#123;</div><div class="line">      <span class="attr">url</span>: Url,</div><div class="line">      <span class="attr">method</span>: <span class="string">'GET'</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</div><div class="line">        that.setData(&#123;</div><div class="line">          <span class="attr">items</span>: res.data.result,</div><div class="line">        &#125;)</div><div class="line">      &#125;,</div><div class="line">    &#125;)</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><p>å‡†å¤‡å¥½æ•°æ®åï¼Œå°±å¯ä»¥åˆ·æ–°ç•Œé¢äº†ï¼Œåœ¨.wxmlä¸­ï¼š<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"contain"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;items&#125;&#125;"</span> <span class="attr">wx:key</span>=<span class="string">"&#123;&#123;item.id&#125;&#125;"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123;item.text&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123;index&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p><p>è¿™é‡Œçš„<code>&lt;view wx:for=&quot;&quot;&gt;</code>ç›¸å½“äºcellï¼Œitem æ˜¯é»˜è®¤æ•°ç»„å…ƒç´ ï¼Œindexæ˜¯é»˜è®¤æ˜¯ç´¢å¼•ï¼Œé»˜è®¤å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£åˆ—è¡¨æ¸²æŸ“ã€‚</p><p><code>wx:key</code>æ˜¯ç”¨äºæ ‡è¯†viewçš„å”¯ä¸€æ€§çš„ï¼Œå¯ä»¥æé«˜åˆ—è¡¨çš„æ¸²æŸ“æ€§èƒ½ã€‚å½“æ•°æ®æ”¹å˜è§¦å‘æ¸²æŸ“å±‚é‡æ–°æ¸²æŸ“çš„æ—¶å€™ï¼Œä¼šæ ¡æ­£å¸¦æœ‰keyçš„ç»„ä»¶ï¼Œæ¡†æ¶ä¼šç¡®ä¿ä»–ä»¬è¢«é‡æ–°æ’åºï¼Œè€Œä¸æ˜¯é‡æ–°åˆ›å»ºï¼Œä»¥ç¡®ä¿ä½¿ç»„ä»¶ä¿æŒè‡ªèº«çš„çŠ¶æ€ï¼Œå¹¶ä¸”æé«˜åˆ—è¡¨æ¸²æŸ“æ—¶çš„æ•ˆç‡ã€‚</p><h3 id="æ·»åŠ ç‚¹å‡»äº‹ä»¶"><a href="#æ·»åŠ ç‚¹å‡»äº‹ä»¶" class="headerlink" title="æ·»åŠ ç‚¹å‡»äº‹ä»¶"></a>æ·»åŠ ç‚¹å‡»äº‹ä»¶</h3><p>é€šè¿‡<code>bintap</code>ç»™viewç»‘å®šç‚¹å‡»äº‹ä»¶ï¼š<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"contain"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;items&#125;&#125;"</span> <span class="attr">wx:key</span>=<span class="string">"&#123;&#123;item.id&#125;&#125;"</span> <span class="attr">bindtap</span>=<span class="string">"cellAction"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123;item.text&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123;index&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p><p>ç„¶ååœ¨.jså®ç°ç›¸åº”çš„æ–¹æ³•ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Page(&#123;</div><div class="line">  cellAction()&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'action'</span>)</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><h3 id="é¡µé¢è·³è½¬ã€ä¼ å‚"><a href="#é¡µé¢è·³è½¬ã€ä¼ å‚" class="headerlink" title="é¡µé¢è·³è½¬ã€ä¼ å‚"></a>é¡µé¢è·³è½¬ã€ä¼ å‚</h3><p>æƒ³è¦ç‚¹å‡»è·³è½¬æŸä¸€ç•Œé¢ï¼Œéœ€è¦ç°åœ¨<code>app.json</code>æ–‡ä»¶åœ¨ä¸­é…ç½®ï¼Œåœ¨ç‚¹å‡»æ–¹æ³•é‡Œè°ƒç”¨<code>navigateTo</code>æ–¹æ³•å³å¯ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Page(&#123;</div><div class="line">  cellAction()&#123;</div><div class="line">    wx.navigateTo(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="string">'./detail'</span>,</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><p>å¦‚æœæƒ³ä¼ å‚å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ç§çš„æ–¹å¼ï¼š</p><h4 id="å…¨å±€å˜é‡ï¼š"><a href="#å…¨å±€å˜é‡ï¼š" class="headerlink" title="å…¨å±€å˜é‡ï¼š"></a>å…¨å±€å˜é‡ï¼š</h4><p>é¦–å…ˆå¿…é¡»åœ¨<code>app.js</code>å®šä¹‰ä¸€ä¸ªå…¨å±€çš„å˜é‡ï¼Œæ¯”å¦‚ï¼šglobalDataï¼Œç„¶åå®šä¹‰ä¸€ä¸ªparameterå±æ€§ç”¨äºå‚¨å­˜å‚æ•°ï¼Œé€šè¿‡<code>var app = getApp()</code>æ‹¿åˆ°appå®ä¾‹å»è·å–æ•°æ®ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">App(&#123;</div><div class="line">  <span class="attr">onLaunch</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">globalData</span>:&#123;</div><div class="line">    <span class="attr">parameter</span>:<span class="literal">null</span></div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><p>å‚æ•°èµ‹å€¼ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = getApp()</div><div class="line"></div><div class="line">Page(&#123;</div><div class="line">  cellAction(object)&#123;</div><div class="line">    <span class="keyword">var</span> id = <span class="keyword">this</span>.data.items[<span class="number">0</span>].id;</div><div class="line">    <span class="keyword">var</span> text = <span class="keyword">this</span>.data.items[<span class="number">0</span>].text;</div><div class="line">    app.globalData.parameter = &#123;</div><div class="line">      <span class="string">"id"</span> : id,</div><div class="line">      <span class="string">"text"</span> : text</div><div class="line">    &#125;</div><div class="line">    wx.navigateTo(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="string">'./detail'</span>,</div><div class="line">    &#125;)</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><p>è·å–å‚æ•°ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// detail.js</span></div><div class="line"><span class="keyword">var</span> app = getApp()</div><div class="line">Page(&#123;</div><div class="line">  <span class="attr">onLoad</span>:<span class="function"><span class="keyword">function</span>(<span class="params">options</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> id = app.globalData.parameter.id;</div><div class="line">    <span class="keyword">var</span> text = app.globalData.parameter.text;</div><div class="line">    <span class="built_in">console</span>.log(id);</div><div class="line">    <span class="built_in">console</span>.log(text);</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><h4 id="è·¯ç”±ï¼š"><a href="#è·¯ç”±ï¼š" class="headerlink" title="è·¯ç”±ï¼š"></a>è·¯ç”±ï¼š</h4><p>å°±åƒiOSè·¯ç”±ä¸€æ ·ï¼Œå‚æ•°é€šè¿‡é“¾æ¥ä¼ é€’ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Page(&#123;</div><div class="line">  cellAction(object)&#123;</div><div class="line">    <span class="keyword">var</span> id = <span class="keyword">this</span>.data.items[<span class="number">0</span>].id;</div><div class="line">    <span class="keyword">var</span> text = <span class="keyword">this</span>.data.items[<span class="number">0</span>].text;</div><div class="line">    <span class="built_in">console</span>.log(id);</div><div class="line">    wx.navigateTo(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="string">'./detail?id='</span> + id + <span class="string">'&amp;text='</span> + text,</div><div class="line">    &#125;)</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><p>åˆ°ä¸‹ä¸€ç•Œé¢åœ¨<code>onLoad</code>å‡½æ•°ä¸­é€šè¿‡<code>options</code>è·å–ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// detail.js</span></div><div class="line">Page(&#123;</div><div class="line">  <span class="attr">onLoad</span>:<span class="function"><span class="keyword">function</span>(<span class="params">options</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> id = options.id;</div><div class="line">    <span class="keyword">var</span> text = options.text;</div><div class="line">    <span class="built_in">console</span>.log(id);</div><div class="line">    <span class="built_in">console</span>.log(text);</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><h4 id="æœ¬åœ°ç¼“å­˜ï¼š"><a href="#æœ¬åœ°ç¼“å­˜ï¼š" class="headerlink" title="æœ¬åœ°ç¼“å­˜ï¼š"></a>æœ¬åœ°ç¼“å­˜ï¼š</h4><p>é€šè¿‡<code>wx.setStorageSync</code>å’Œ<code>wx.getStorageSync</code>å­˜å–æ•°æ®ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cellAction(object)&#123;</div><div class="line">    <span class="keyword">var</span> id = <span class="keyword">this</span>.data.items[<span class="number">0</span>].id;</div><div class="line">    <span class="keyword">var</span> text = <span class="keyword">this</span>.data.items[<span class="number">0</span>].text;</div><div class="line">    wx.setStorageSync(<span class="string">"id"</span>,id);</div><div class="line">    wx.setStorageSync(<span class="string">"text"</span>,text);</div><div class="line">    wx.navigateTo(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="string">'./detail'</span>,</div><div class="line">    &#125;)</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p><p>è·å–æ•°æ®ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// detail.js</span></div><div class="line"><span class="keyword">var</span> app = getApp()</div><div class="line">Page(&#123;</div><div class="line">  <span class="attr">onLoad</span>:<span class="function"><span class="keyword">function</span>(<span class="params">options</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> id = wx.getStorageSync(<span class="string">"id"</span>);</div><div class="line">    <span class="keyword">var</span> text = wx.getStorageSync(<span class="string">"text"</span>);</div><div class="line">    <span class="built_in">console</span>.log(id);</div><div class="line">    <span class="built_in">console</span>.log(text);</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><p>å¦‚æœæƒ³ä¼ é€’indexå¯¹åº”æ•°æ®éœ€è¦ç”¨åˆ°<code>dataset</code>ï¼šåœ¨ç»„ä»¶ä¸­å¯ä»¥å®šä¹‰æ•°æ®ï¼Œè¿™äº›æ•°æ®å°†ä¼šé€šè¿‡äº‹ä»¶ä¼ é€’ç»™<code>SERVICE</code>ã€‚ ä¹¦å†™æ–¹å¼ï¼šä»¥data-å¼€å¤´ï¼Œå¤šä¸ªå•è¯ç”±è¿å­—ç¬¦-é“¾æ¥ï¼Œä¸èƒ½æœ‰å¤§å†™(å¤§å†™ä¼šè‡ªåŠ¨è½¬æˆå°å†™)å¦‚data-element-typeï¼Œæœ€ç»ˆåœ¨ <code>event.target.dataset</code>ä¸­ä¼šå°†è¿å­—ç¬¦è½¬æˆé©¼å³°elementTypeã€‚</p><p>æˆ‘ä»¬ç»™ä¹‹å‰çš„ä¾‹å­å®šä¹‰ä¸€ä¸ªå‚æ•°ï¼š<code>data-index=&quot;&quot;</code>ï¼š<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"contain"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;items&#125;&#125;"</span> <span class="attr">wx:key</span>=<span class="string">"&#123;&#123;item.id&#125;&#125;"</span> <span class="attr">bindtap</span>=<span class="string">"cellAction"</span> <span class="attr">data-index</span>=<span class="string">"&#123;&#123;index&#125;&#125;"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123;item.text&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123;index&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p><p>é€šè¿‡<code>object.currentTarget.dataset</code>è·å–å‚æ•°ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Page(&#123;</div><div class="line">  cellAction(object)&#123;</div><div class="line">    <span class="keyword">var</span> index = object.currentTarget.dataset.index;</div><div class="line">    <span class="keyword">var</span> id = <span class="keyword">this</span>.data.items[index].id;</div><div class="line">    <span class="keyword">var</span> text = <span class="keyword">this</span>.data.items[index].text;</div><div class="line">    wx.navigateTo(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="string">'./detail?id='</span> + id + <span class="string">'&amp;text='</span> + text,</div><div class="line">    &#125;)</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><h3 id="åŠ¨æ€æ”¹å˜æ ·å¼"><a href="#åŠ¨æ€æ”¹å˜æ ·å¼" class="headerlink" title="åŠ¨æ€æ”¹å˜æ ·å¼"></a>åŠ¨æ€æ”¹å˜æ ·å¼</h3><p>å¯ä»¥é€šè¿‡<code>sytle</code>æ¥æ¥æ”¶åŠ¨æ€æ ·å¼ã€‚æ¯”å¦‚ç‚¹å‡»ä¹‹åæ”¹å˜å­—ä½“é¢œè‰²ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Page(&#123;</div><div class="line">  <span class="attr">data</span>: &#123;</div><div class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªå­—ä½“é¢œè‰²çš„å˜é‡</span></div><div class="line">    textColor: <span class="string">"red"</span></div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p><p>å°†åŠ¨æ€å˜é‡èµ‹å€¼ç»™æ ‡ç­¾ï¼š<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">text</span> <span class="attr">bindtap</span>=<span class="string">"change"</span> <span class="attr">style</span>=<span class="string">"color: &#123;&#123;textColor&#125;&#125;"</span>&gt;</span> text <span class="tag">&lt;/<span class="name">text</span>&gt;</span></div></pre></td></tr></table></figure></p><p>ç‚¹å‡»æ‰§è¡Œchangeæ–¹æ³•ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">change()&#123;</div><div class="line">    <span class="keyword">var</span> color = <span class="string">"green"</span></div><div class="line">    <span class="keyword">this</span>.setData(&#123;</div><div class="line">      <span class="attr">textColor</span> : color</div><div class="line">    &#125;)</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p><p>å…ˆæ€»ç»“åˆ°è¿™é‡Œï¼Œåç»­æˆ‘ä¼šæ€»ç»“ä¸€äº›å¼€å‘ä¸­é‡åˆ°çš„å‘ï¼Œå¸Œæœ›åˆ«å¤ªå¤šğŸ˜‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ‰ä¸€å¤©äº§å“ç»ç†è¯´å’±ä»¬æä¸ªå°ç¨‹åºå§ï¼Œç¨‹åºçŒ¿ï¼šå“¦ğŸ™ƒ&lt;/p&gt;
&lt;p&gt;å¹¸å¥½å®‰å“çš„åŒäº‹æå‰å…¥äº†å‘ï¼Œåœ¨ä»–çš„æŠ€æœ¯åˆ†äº«åï¼Œæˆ‘ä¹Ÿéšä¹‹å…¥äº†å‘ã€‚&lt;/p&gt;
&lt;p&gt;å¼€å§‹æˆ‘ä»¥ä¸ºå°ç¨‹åºçš„å®ç°æ˜¯ç±»ä¼¼React-nativeçš„ï¼Œé€šè¿‡äº†è§£æ‰çŸ¥é“åœ¨iOSä¸Šæ˜¯é€šè¿‡&lt;code&gt;WKWebView&lt;/code&gt;å°†&lt;code&gt;Html+CSS&lt;/code&gt;å‘ˆç°ç»™ç”¨æˆ·ï¼Œé¡µé¢é—´çš„åˆ‡æ¢å’Œè·³è½¬æ˜¯åŸºäºåŸç”Ÿçš„&lt;code&gt;UITabBarController&lt;/code&gt;å’Œ&lt;code&gt;UINavigationController&lt;/code&gt;ï¼Œè¿™ç§`native+webviewçš„å®ç°é€ å°±äº†å°ç¨‹åºæ˜“ä¸Šæ‰‹ã€ä½“éªŒå¥½çš„ä¼˜ç‚¹ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="å°ç¨‹åº" scheme="http://wonkeyz.com/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>é€‚é…iOS11&amp;iPhoneXçš„ä¸€äº›å‘</title>
    <link href="http://wonkeyz.com/2017/09/17/Some-pits-for-iOS11-iPhoneX-adaptation/"/>
    <id>http://wonkeyz.com/2017/09/17/Some-pits-for-iOS11-iPhoneX-adaptation/</id>
    <published>2017-09-17T08:09:08.000Z</published>
    <updated>2017-11-07T08:26:58.343Z</updated>
    
    <content type="html"><![CDATA[<p>å‰é˜µå­é¡¹ç›®å¼€å‘å¿™æˆç‹—ï¼Œå°±ä¸€ç›´æ²¡åšiOS11çš„é€‚é…ï¼Œç›´åˆ°XcodeGMç‰ˆå‘å¸ƒåï¼Œæˆ‘èƒ¸æœ‰æˆç«¹çš„åœ¨iPhoneXä¸Šè·‘èµ·é¡¹ç›®ï¼Œæ•´ä¸ªäººéƒ½å‡‰é€äº†â€¦ä¸‹é¢æ€»ç»“ä¸€ä¸‹æˆ‘é‡åˆ°çš„å‘ï¼Œä¸æ˜¯å¾ˆå…¨é¢ï¼Œæ—¥åè¡¥å……ã€‚</p><a id="more"></a><h3 id="å¯¼èˆªæ "><a href="#å¯¼èˆªæ " class="headerlink" title="å¯¼èˆªæ "></a>å¯¼èˆªæ </h3><h4 id="å¯¼èˆªæ é«˜åº¦çš„å˜åŒ–"><a href="#å¯¼èˆªæ é«˜åº¦çš„å˜åŒ–" class="headerlink" title="å¯¼èˆªæ é«˜åº¦çš„å˜åŒ–"></a>å¯¼èˆªæ é«˜åº¦çš„å˜åŒ–</h4><p>iOS11ä¹‹å‰å¯¼èˆªæ é»˜è®¤é«˜åº¦ä¸º64pt(<strong>è¿™é‡Œé«˜åº¦æŒ‡statusBar + NavigationBar</strong>)ï¼ŒiOS11ä¹‹åå¦‚æœè®¾ç½®äº†<code>prefersLargeTitles = YES</code>åˆ™ä¸º96ptï¼Œé»˜è®¤æƒ…å†µä¸‹è¿˜æ˜¯64ptï¼Œä½†åœ¨iPhoneXä¸Šç”±äºåˆ˜æµ·çš„å‡ºç°statusBarç”±ä»¥å‰çš„20ptå˜æˆäº†44ptï¼Œæ‰€ä»¥iPhoneXä¸Šé«˜åº¦å˜ä¸º88ptï¼Œå¦‚æœé¡¹ç›®é‡Œéšè—äº†å¯¼èˆªæ åŠ äº†è‡ªå®šä¹‰æŒ‰é’®ä¹‹ç±»çš„ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„é€‚é…ä¸€ä¸‹ã€‚</p><h4 id="å¯¼èˆªæ å›¾å±‚åŠå¯¹titleViewå¸ƒå±€çš„å½±å“"><a href="#å¯¼èˆªæ å›¾å±‚åŠå¯¹titleViewå¸ƒå±€çš„å½±å“" class="headerlink" title="å¯¼èˆªæ å›¾å±‚åŠå¯¹titleViewå¸ƒå±€çš„å½±å“"></a>å¯¼èˆªæ å›¾å±‚åŠå¯¹titleViewå¸ƒå±€çš„å½±å“</h4><p>iOS11ä¹‹å‰å¯¼èˆªæ çš„titleæ˜¯æ·»åŠ åœ¨<code>UINavigationItemView</code>ä¸Šé¢ï¼Œè€ŒnavigationBarButtonåˆ™ç›´æ¥æ·»åŠ åœ¨<code>UINavigationBar</code>ä¸Šé¢ï¼Œå¦‚æœè®¾ç½®äº†titleViewï¼Œåˆ™titleViewä¹Ÿæ˜¯ç›´æ¥æ·»åŠ åœ¨<code>UINavigationBar</code>ä¸Šé¢ã€‚iOS11ä¹‹åï¼Œå¤§æ¦‚å› ä¸º<code>largeTitle</code>çš„åŸå› ï¼Œè§†å›¾å±‚çº§å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰ç»™titleViewèµ‹å€¼ï¼Œåˆ™titleViewä¼šç›´æ¥æ·»åŠ åœ¨<code>_UINavigationBarContentView</code>ä¸Šé¢ï¼Œå¦‚æœèµ‹å€¼äº†titleViewï¼Œåˆ™ä¼šæŠŠtitleViewæ·»åŠ åœ¨<code>_UITAMICAdaptorView</code>ä¸Šï¼Œè€ŒnavigationBarButtonè¢«åŠ åœ¨äº†<code>_UIButtonBarStackView</code>ä¸Šï¼Œç„¶åä»–ä»¬éƒ½è¢«åŠ åœ¨äº†<code>_UINavigationBarContentView</code>ä¸Šï¼Œå¦‚å›¾ï¼š<br><img src="http://upload-images.jianshu.io/upload_images/702870-11488fe68c9d145b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å›¾1"><br>æ‰€ä»¥å¦‚æœä½ çš„é¡¹ç›®æ˜¯è‡ªå®šä¹‰çš„navigationBarï¼Œé‚£ä¹ˆåœ¨iOS11ä¸Šè¿è¡Œå°±å¯èƒ½å‡ºç°å¸ƒå±€é”™ä¹±çš„bugï¼Œè§£å†³åŠæ³•æ˜¯é‡å†™<code>UINavigationBar</code>çš„<code>layoutSubviews</code>æ–¹æ³•ï¼Œè°ƒæ•´å¸ƒå±€ï¼Œä¸Šä»£ç ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)layoutSubviews &#123;</div><div class="line">    [<span class="keyword">super</span> layoutSubviews];</div><div class="line"></div><div class="line">    <span class="comment">//æ³¨æ„å¯¼èˆªæ åŠçŠ¶æ€æ é«˜åº¦é€‚é…</span></div><div class="line">    <span class="keyword">self</span>.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">CGRectGetWidth</span>(<span class="keyword">self</span>.frame), naviBarHeight);</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">UIView</span> *view <span class="keyword">in</span> <span class="keyword">self</span>.subviews) &#123;</div><div class="line">        <span class="keyword">if</span>([<span class="built_in">NSStringFromClass</span>([view <span class="keyword">class</span>]) containsString:<span class="string">@"Background"</span>]) &#123;</div><div class="line">            view.frame = <span class="keyword">self</span>.bounds;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="built_in">NSStringFromClass</span>([view <span class="keyword">class</span>]) containsString:<span class="string">@"ContentView"</span>]) &#123;</div><div class="line">            <span class="built_in">CGRect</span> frame = view.frame;</div><div class="line">            frame.origin.y = statusBarHeight;</div><div class="line">            frame.size.height = <span class="keyword">self</span>.bounds.size.height - frame.origin.y;</div><div class="line">            view.frame = frame;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>å†è¡¥å……ä¸€ç‚¹ï¼Œçœ‹äº†<a href="http://www.jianshu.com/p/26fc39135c34" target="_blank" rel="external">ç®€ä¹¦Appé€‚é…iOS11</a>å‘ç°titleViewæ”¯æŒ<code>autolayout</code>ï¼Œè¿™è¦æ±‚titleViewå¿…é¡»æ˜¯èƒ½å¤Ÿè‡ªæ’‘å¼€çš„æˆ–å®ç°äº†<code>- intrinsicContentSize</code>æ–¹æ³•<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">CGSize</span>)intrinsicContentSize &#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">UILayoutFittingExpandedSize</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="ç»§æ‰¿è‡ªUIScrollViewçš„è§†å›¾åç§»é—®é¢˜"><a href="#ç»§æ‰¿è‡ªUIScrollViewçš„è§†å›¾åç§»é—®é¢˜" class="headerlink" title="ç»§æ‰¿è‡ªUIScrollViewçš„è§†å›¾åç§»é—®é¢˜"></a>ç»§æ‰¿è‡ªUIScrollViewçš„è§†å›¾åç§»é—®é¢˜</h3><p>å¤§å®¶åœ¨iOS11è®¾å¤‡ä¸Šè¿è¡Œå‡ºç°æœ€å¤šé—®é¢˜åº”è¯¥å°±æ˜¯<code>tableview</code>è«åå¥‡å¦™çš„åç§»20ptæˆ–è€…64ptäº†ã€‚ã€‚åŸå› æ˜¯iOS11å¼ƒç”¨äº†<code>automaticallyAdjustsScrollViewInsets</code>å±æ€§ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯<code>UIScrollView</code>æ–°å¢äº†<code>contentInsetAdjustmentBehavior</code>å±æ€§ï¼Œè¿™ä¸€åˆ‡çš„ç½ªé­ç¥¸é¦–éƒ½æ˜¯æ–°å¼•å…¥çš„<code>safeArea</code>ï¼Œå…³äº<code>safeArea</code>é€‚é…è¿™ç¯‡æ–‡ç« <a href="http://www.jianshu.com/p/efbc8619d56b" target="_blank" rel="external">iOS 11 å®‰å…¨åŒºåŸŸé€‚é…æ€»ç»“</a>è®²çš„å¾ˆè¯¦ç»†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸‹ï¼Œæˆ‘ç›´æ¥è´´é€‚é…ä»£ç ï¼Œå› ä¸ºä½ç‰ˆæœ¬ç›´æ¥ç”¨<code>contentInsetAdjustmentBehavior</code>ä¼šæŠ¥è­¦å‘Šï¼Œæ‰€æœ‰å®šä¹‰äº†å¦‚ä¸‹çš„å®ï¼ˆæ„Ÿè°¢<a href="http://www.jianshu.com/u/634f3d1c7c22" target="_blank" rel="external">@ç‚’é¸¡èŒƒ</a>çš„æŒ‡æ­£ï¼Œä¹‹å‰çš„å®çŠ¯äº†ä¸ªä½çº§é”™è¯¯â€¦ç°æ”¹ä¸ºï¼‰<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#define  adjustsScrollViewInsets(scrollView)\</span></div><div class="line"><span class="keyword">do</span> &#123;\</div><div class="line">_Pragma(<span class="string">"clang diagnostic push"</span>)\</div><div class="line">_Pragma(<span class="string">"clang diagnostic ignored \"-Warc-performSelector-leaks\""</span>)\</div><div class="line"><span class="keyword">if</span> ([scrollView respondsToSelector:<span class="built_in">NSSelectorFromString</span>(<span class="string">@"setContentInsetAdjustmentBehavior:"</span>)]) &#123;\</div><div class="line"><span class="built_in">NSMethodSignature</span> *signature = [<span class="built_in">UIScrollView</span> instanceMethodSignatureForSelector:<span class="keyword">@selector</span>(setContentInsetAdjustmentBehavior:)];\</div><div class="line"><span class="built_in">NSInvocation</span> *invocation = [<span class="built_in">NSInvocation</span> invocationWithMethodSignature:signature];\</div><div class="line"><span class="built_in">NSInteger</span> argument = <span class="number">2</span>;\</div><div class="line">invocation.target = scrollView;\</div><div class="line">invocation.selector = <span class="keyword">@selector</span>(setContentInsetAdjustmentBehavior:);\</div><div class="line">[invocation setArgument:&amp;argument atIndex:<span class="number">2</span>];\</div><div class="line">[invocation retainArguments];\</div><div class="line">[invocation invoke];\</div><div class="line">&#125;\</div><div class="line">_Pragma(<span class="string">"clang diagnostic pop"</span>)\</div><div class="line">&#125; <span class="keyword">while</span> (<span class="number">0</span>)</div></pre></td></tr></table></figure></p><p>è¿˜æœ‰çš„å‘ç°æŸäº›ç•Œé¢<code>tableView</code>çš„<code>sectionHeader</code>ã€<code>sectionFooter</code>é«˜åº¦ä¸è®¾ç½®ä¸ç¬¦çš„é—®é¢˜ï¼Œåœ¨iOS11ä¸­å¦‚æœä¸å®ç° <code>-tableView: viewForHeaderInSection:</code>å’Œ<code>-tableView: viewForFooterInSection:</code> ï¼Œåˆ™<code>-tableView: heightForHeaderInSection:</code>å’Œ<code>- tableView: heightForFooterInSection:</code>ä¸ä¼šè¢«è°ƒç”¨ï¼Œå¯¼è‡´å®ƒä»¬éƒ½å˜æˆäº†é»˜è®¤é«˜åº¦ï¼Œè¿™æ˜¯å› ä¸º<code>tableView</code>åœ¨iOS11é»˜è®¤ä½¿ç”¨<code>Self-Sizing</code>ï¼Œ<code>tableView</code>çš„<code>estimatedRowHeight</code>ã€<code>estimatedSectionHeaderHeight</code>ã€ <code>estimatedSectionFooterHeight</code>ä¸‰ä¸ªé«˜åº¦ä¼°ç®—å±æ€§ç”±é»˜è®¤çš„0å˜æˆäº†<code>UITableViewAutomaticDimension</code>ï¼Œè§£å†³åŠæ³•ç®€å•ç²—æš´ï¼Œå°±æ˜¯åœ¨å¯¹åº”ç•Œé¢å®ç°å¯¹åº”æ–¹æ³•æˆ–æŠŠ<code>tableView</code>çš„è¿™ä¸‰ä¸ªå±æ€§è®¾ä¸º0ã€‚å¦‚æœä½ æƒ³å…¨å±€å…³é—­<code>Self-Sizing</code>å¯ä½¿ç”¨ä¸‹é¢è¿™æ®µä»£ç ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">UITableView</span>.appearance.estimatedRowHeight = <span class="number">0</span>; </div><div class="line"><span class="built_in">UITableView</span>.appearance.estimatedSectionFooterHeight = <span class="number">0</span>;</div><div class="line"><span class="built_in">UITableView</span>.appearance.estimatedSectionHeaderHeight = <span class="number">0</span>;</div></pre></td></tr></table></figure></p><p>å¦‚æœä½ ä½¿ç”¨äº†<code>Masonry</code>ï¼ŒæŸäº›ç•Œé¢éœ€è¦é€‚é…éœ€è¦é€‚é…<code>safeArea</code>ï¼Œå¯ä»¥è¯•è¯•ä¸‹é¢è¿™æ®µä»£ç <br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (@available(iOS <span class="number">11.0</span>, *)) &#123;</div><div class="line">    make.edges.equalTo()(<span class="keyword">self</span>.view.safeAreaInsets)</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    make.edges.equalTo()(<span class="keyword">self</span>.view)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="ç›¸å†Œè®¿é—®æƒé™"><a href="#ç›¸å†Œè®¿é—®æƒé™" class="headerlink" title="ç›¸å†Œè®¿é—®æƒé™"></a>ç›¸å†Œè®¿é—®æƒé™</h3><p>çœ‹å…¶ä»–é€‚é…æ–‡ç« ä¸Šå¯¹iOS11ç›¸å†Œæƒé™è°ƒæ•´çš„è¯´æ˜æ˜¯â€œiOS11æŠŠ <a href="https://developer.apple.com/library/content/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW17" target="_blank" rel="external">NSPhotoLibraryUsageDescription</a> æ›¿æ¢æˆäº†<a href="https://developer.apple.com/library/content/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW73" target="_blank" rel="external">NSPhotoLibraryAddUsageDescription</a>â€ï¼Œå¥‡æ€ªçš„æ˜¯æˆ‘çš„é¡¹ç›®å¹¶æ²¡æœ‰æ·»åŠ <code>NSPhotoLibraryAddUsageDescription</code>ï¼Œåœ¨è®¿é—®ç›¸å†Œæ—¶ä¹Ÿæ²¡å‘ç”Ÿcrashï¼Œåæ¥åœ¨ä»”ç»†é˜…è¯»äº†å®˜æ–¹æ–‡æ¡£æ‰å‘ç°<code>NSPhotoLibraryAddUsageDescription</code>åªé’ˆå¯¹ç›¸å†Œå­˜å‚¨æƒé™ï¼Œåœ¨iOS11ä¸Šç³»ç»Ÿé»˜è®¤æ‰“å¼€äº†ç”¨æˆ·ç›¸å†Œçš„è®¿é—®æƒé™ï¼Œå¦‚æœåº”ç”¨éœ€è¦å­˜å‚¨æƒé™å°±éœ€è¦æ·»åŠ è¿™ä¸ªkeyï¼Œå¦åˆ™å°±ä¼šcrashã€‚</p><h3 id="AppIcon"><a href="#AppIcon" class="headerlink" title="AppIcon"></a>AppIcon</h3><p>åœ¨iOS11ä¸Šå‘ç°äº†ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼ŒAPPåœ¨å¯åŠ¨å›¾æ ‡ä¼šå‡ºç°é»‘è¾¹ï¼Œå¦‚å›¾ï¼ˆå¤„å¥³åº§å®åœ¨å¿ä¸äº†â€¦ï¼‰<br><img src="http://owgqmweju.bkt.clouddn.com/17-10-23/31263530.jpg" alt="å›¾2"><br>åŸå› æ˜¯iOS11ä¿®æ”¹äº†Appå¯åŠ¨åŠ¨ç”»ï¼Œå¦‚æœä½ çš„Appå›¾æ ‡æœ‰åœ†è§’é‚£ä¹ˆå°±ä¼šå˜æˆè¿™ä¸ªé¸Ÿæ ·äº†â€¦æ‰€æœ‰å›¾æ ‡éƒ½æ¢æˆç›´è§’å°±å¥½äº†ï¼Œå…·ä½“è§„èŒƒè§<a href="https://developer.apple.com/design/" target="_blank" rel="external">Human Interface Guidelines-App Icon</a>ï¼Œè¿˜æ˜¯è¦å¬è‹¹æœçˆ¸çˆ¸çš„è¯å•Šâ€¦</p><h3 id="iPhoneX"><a href="#iPhoneX" class="headerlink" title="iPhoneX"></a>iPhoneX</h3><h4 id="LaunchImage"><a href="#LaunchImage" class="headerlink" title="LaunchImage"></a>LaunchImage</h4><p>å…³äºiPhoneX(æˆ‘å°±ä¸åæ§½åˆ˜æµ·äº†â€¦)ï¼Œå¦‚æœä½ çš„APPåœ¨iPhoneXä¸Šè¿è¡Œå‘ç°æ²¡æœ‰å……æ»¡å±å¹•ï¼Œä¸Šä¸‹æœ‰é»‘è‰²åŒºåŸŸï¼Œé‚£ä¹ˆä½ åº”è¯¥ä¹Ÿåƒæˆ‘ä¸€æ ·<code>LaunchImage</code>æ²¡æœ‰ç”¨<code>storyboard</code>è€Œæ˜¯ç”¨çš„<code>Assets</code>ï¼Œè§£å†³åŠæ³•å¦‚å›¾ï¼Œå¯åŠ¨å›¾çš„å°ºå¯¸ä¸º<code>1125x2436</code>ï¼Œor you can <a href="http://www.jianshu.com/p/77054dccafdb" target="_blank" rel="external">iOSå¼€å‘æ—¶å¦‚ä½•ä½¿ç”¨ Launch Screen Storyboard</a>ã€‚<br><img src="http://upload-images.jianshu.io/upload_images/702870-71705661b4518de5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å›¾2"></p><h4 id="TabBarController"><a href="#TabBarController" class="headerlink" title="TabBarController"></a>TabBarController</h4><p>å¦‚æœä½ ä½¿ç”¨äº†åŸç”ŸtabBarï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€‚é…ï¼Œå› ä¸ºæˆ‘ä»¬çš„é¡¹ç›®ç”¨äº†ç¬¬ä¸‰æ–¹çš„<code>TabBarController</code>ï¼Œåœ¨iPhoneXè¿è¡Œï¼ŒtabBarçœ‹èµ·æ¥æ€ªæ€ªçš„(<strong>å¦‚æœä¸ç¡®å®šä½ çš„é¡¹ç›®tabBaråœ¨iPhoneXä¸Šçœ‹èµ·æ¥æ˜¯å¦æ­£å¸¸ï¼Œå¯ä»¥å‚ç…§æ¨¡æ‹Ÿå™¨çš„ç…§ç‰‡APPï¼Œä¸€çœ‹ä¾¿çŸ¥</strong>)â€¦ä¼°è®¡ä½œè€…è¦ç­‰åˆ°çŒ´å¹´é©¬æœˆæ‰é€‚é…iPhoneXï¼Œé¡¹ç›®åˆç€æ€¥ä¸Šçº¿ï¼Œå°±è‡ªå·±æ”¹äº†ä¸‹ï¼Œä¸»è¦æ˜¯<code>tabBar</code>é«˜åº¦åŠ<code>tabBarItem</code>åç§»é€‚é…ï¼ŒiPhoneXç”±äºåº•éƒ¨å®‰å…¨åŒºçš„åŸå› <code>UITabBar</code>é«˜åº¦ç”±49ptå˜æˆäº†83ptï¼Œå¤šå‡ºæ¥çš„34ptæ˜¯ç©ºç™½æ‰‹åŠ¿åŒºåŸŸã€‚å¯ä»¥é€šè¿‡åˆ¤æ–­æœºå‹æ¥ä¿®æ”¹ç›¸å…³ç•Œé¢ä»£ç ï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼Œé€šè¿‡åˆ†è¾¨ç‡åˆ¤æ–­ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#define kDevice_Is_iPhoneX ([UIScreen instancesRespondToSelector:@selector(currentMode)] ? CGSizeEqualToSize(CGSizeMake(1125, 2436), [[UIScreen mainScreen] currentMode].size) : NO)</span></div></pre></td></tr></table></figure></p><p>é€šè¿‡è®¾å¤‡åç§°åˆ¤æ–­ï¼š<br>@â€iPhone10,1â€ : @â€iPhone 8â€,<br>@â€iPhone10,4â€ : @â€iPhone 8â€,<br>@â€iPhone10,2â€ : @â€iPhone 8 Plusâ€,<br>@â€iPhone10,5â€ : @â€iPhone 8 Plusâ€,<br>@â€iPhone10,3â€ : @â€iPhone Xâ€,<br>@â€iPhone10,6â€ : @â€iPhone Xâ€,<br>è¿™é‡Œæ¨èä½¿ç”¨<a href="https://github.com/squarefrog/UIDeviceIdentifier" target="_blank" rel="external">UIDeviceIdentifier</a>ã€‚</p><p>ç›®å‰é‡åˆ°çš„å°±è¿™äº›å‘ï¼Œæ¬¢è¿å¤§å®¶æŒ‡æ­£è¡¥å……~</p><p>ä½œä¸ºä¸€åiOSå¼€å‘äººå‘˜ï¼Œæƒ³åˆ°å½“å¹´å˜²ç¬‘Androidå¼€å‘è›‹ç–¼çš„é€‚é…å„ç§æœºå‹å¿ƒæƒ…å¦‚å›¾â€¦<br><img src="http://upload-images.jianshu.io/upload_images/702870-4db780c96ed7f4b5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p><p>æœ€åå¥‰ä¸ŠWWDCå®˜æ–¹è§†é¢‘ï¼š</p><p><a href="https://developer.apple.com/videos/play/wwdc2017/204/" target="_blank" rel="external">Updating Your App for iOS 11</a></p><p><a href="https://developer.apple.com/videos/play/fall2017/201/" target="_blank" rel="external">Building Apps for iPhone X</a></p><p><a href="https://developer.apple.com/videos/play/fall2017/801/" target="_blank" rel="external">Designing for iPhone X</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰é˜µå­é¡¹ç›®å¼€å‘å¿™æˆç‹—ï¼Œå°±ä¸€ç›´æ²¡åšiOS11çš„é€‚é…ï¼Œç›´åˆ°XcodeGMç‰ˆå‘å¸ƒåï¼Œæˆ‘èƒ¸æœ‰æˆç«¹çš„åœ¨iPhoneXä¸Šè·‘èµ·é¡¹ç›®ï¼Œæ•´ä¸ªäººéƒ½å‡‰é€äº†â€¦ä¸‹é¢æ€»ç»“ä¸€ä¸‹æˆ‘é‡åˆ°çš„å‘ï¼Œä¸æ˜¯å¾ˆå…¨é¢ï¼Œæ—¥åè¡¥å……ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="é€‚é…iOS11" scheme="http://wonkeyz.com/tags/%E9%80%82%E9%85%8DiOS11/"/>
    
      <category term="é€‚é…iPhoneX" scheme="http://wonkeyz.com/tags/%E9%80%82%E9%85%8DiPhoneX/"/>
    
  </entry>
  
  <entry>
    <title>ReactiveCocoaå®è·µæ€»ç»“</title>
    <link href="http://wonkeyz.com/2017/08/20/ReactiveCocoa-common-method/"/>
    <id>http://wonkeyz.com/2017/08/20/ReactiveCocoa-common-method/</id>
    <published>2017-08-20T09:39:38.000Z</published>
    <updated>2017-12-27T13:17:24.063Z</updated>
    
    <content type="html"><![CDATA[<p>RACæ˜¯iOSå¼€å‘ä¸­ä½¿ç”¨æœ€å¹¿æ³›ã€æœ€å¼ºå¤§çš„å‡½æ•°å“åº”å¼ç¼–ç¨‹æ¡†æ¶ï¼Œæœ‰äº†å®ƒå°±ä¸éœ€è¦ä½¿ç”¨å¦‚notificarionã€delegateã€blockã€kvoç­‰OCçš„ç¦»æ•£æ¶ˆæ¯ä¼ é€’æ–¹å¼ï¼Œåªéœ€è¦è€ƒè™‘ç»“æœã€‚å†ç»“åˆå…¶å¼ºå¤§çš„ä¿¡å·æ“ä½œæ–¹æ³•ä½¿ç”¨ï¼Œè®©ä»£ç é«˜åº¦èšåˆï¼Œé™ä½è€¦åˆæ€§ï¼Œç»™å¼€å‘å¸¦æ¥äº†å¾ˆå¤§çš„ä¾¿åˆ©ã€‚ä½†åŒæ—¶å› ä¸ºä»–çš„å¼ºå¤§å¯¼è‡´æˆ‘ç»å¸¸å¿˜è®°ä¸€äº›apiçš„ç”¨æ³•ğŸ˜‚ï¼Œä¸‹é¢æˆ‘æ¥ç®€å•æ•´ç†ä¸‹é¡¹ç›®ä¸­ç”¨åˆ°çš„RACï¼Œæ–¹ä¾¿å¼€å‘æ—¶æŸ¥é˜…ã€‚<br><a id="more"></a></p><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>RACæ˜¯ä¸»è¦å®ç°åŸç†å°±æ˜¯ä¿¡å·çš„<strong>å‘é€</strong>å’Œ<strong>è®¢é˜…</strong>ï¼Œä¿¡å·æ˜¯RACçš„æ„é€ å•å…ƒï¼Œå®ƒä»£è¡¨æˆ‘ä»¬æœ€ç»ˆå°†è¦æ”¶åˆ°çš„ä¿¡æ¯ã€‚å½“æ•°æ®æ”¹å˜æ—¶ï¼Œä¿¡å·å†…éƒ¨ä¼šå‘å‡ºæ•°æ®ï¼Œé€šè¿‡è®¢é˜…è¯¥ä¿¡å·ï¼Œæˆ‘ä»¬å¯ä»¥é¢„å…ˆå†™å¥½å¤„ç†é€»è¾‘ï¼ŒæŠŠä¿¡å·ä¸äº‹ä»¶<strong>ç»‘å®š</strong>ï¼Œè€Œä¸æ˜¯å¿…é¡»ç­‰åˆ°äº‹ä»¶å‘ç”Ÿ(é€šå¸¸çš„å‘½ä»¤å¼å¼€å‘)ã€‚</p><p>ç®€å•çš„ä¿¡å·è®¢é˜…æµç¨‹å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1.åˆ›å»ºä¿¡å·(é»˜è®¤åˆ›å»ºå†·ä¿¡å·,å³ä¿¡å·æ•°æ®æ”¹å˜æ—¶ä¹Ÿä¸ä¼šè§¦å‘,å†·ä¿¡å·è¢«è®¢é˜…åå˜ä¸ºçƒ­ä¿¡å·,ä¼šè§¦å‘å“åº”).</span></div><div class="line">RACSignal *siganl = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</div><div class="line">    </div><div class="line">    <span class="comment">// æ¯å½“æœ‰è®¢é˜…è€…è®¢é˜…ä¿¡å·ï¼Œblockå°±ä¼šè°ƒç”¨</span></div><div class="line">    </div><div class="line">    <span class="comment">// 2.å‘é€ä¿¡å·</span></div><div class="line">    [subscriber sendNext:@<span class="number">1</span>];</div><div class="line">    </div><div class="line">    <span class="comment">// è¿˜å¯ä»¥å‘é€å¤±è´¥ä¿¡å·[subscriber sendError:nil];</span></div><div class="line">    <span class="comment">// å¦‚æœä¸å†å‘é€æ•°æ®ï¼Œæœ€å¥½å‘é€ä¿¡å·å®Œæˆï¼Œå†…éƒ¨ä¼šè‡ªåŠ¨è°ƒç”¨[RACDisposable disposable]å–æ¶ˆè®¢é˜…ä¿¡å·ã€‚</span></div><div class="line">    [subscriber sendCompleted];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</div><div class="line">        </div><div class="line">        <span class="comment">// å½“ä¿¡å·å‘é€å®Œæˆæˆ–è€…å‘é€é”™è¯¯ï¼Œå°±ä¼šè‡ªåŠ¨æ‰§è¡Œè¿™ä¸ªblock,å–æ¶ˆè®¢é˜…ä¿¡å·ã€‚</span></div><div class="line">        </div><div class="line">        <span class="comment">// æ‰§è¡Œå®ŒBlockåï¼Œå½“å‰ä¿¡å·å°±ä¸åœ¨è¢«è®¢é˜…äº†ã€‚</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"ä¿¡å·è¢«é”€æ¯"</span>);</div><div class="line">        </div><div class="line">    &#125;];</div><div class="line">&#125;];</div><div class="line"></div><div class="line"><span class="comment">// 3.è®¢é˜…ä¿¡å·,æ‰ä¼šæ¿€æ´»ä¿¡å·.</span></div><div class="line">[siganl subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="comment">// æ¯å½“æœ‰ä¿¡å·å‘å‡ºæ•°æ®ï¼Œblockå°±ä¼šè°ƒç”¨</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"æ¥æ”¶åˆ°æ•°æ®:%@"</span>,x);</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p><p>æ ¹æ®ä¸Šè¿°æµç¨‹åŠæºç ç®€å•åˆ†æä¸‹<code>RACSignal</code>çš„åº•å±‚å®ç°ï¼š</p><p>1.åˆ›å»ºä¿¡å·siganlï¼Œé¦–å…ˆæŠŠ<code>didSubscribe</code>ä¿å­˜åˆ°ä¿¡å·ä¸­ï¼Œç­‰å¾…è¢«è®¢é˜…ï¼›</p><p>2.å½“ä¿¡å·è¢«è®¢é˜…ï¼Œå³è°ƒç”¨<code>subscribeNext:nextBlock</code>æ—¶å†…éƒ¨ä¼šåˆ›å»ºè®¢é˜…è€…<code>subscriber</code>ï¼Œå¹¶ä¸”æŠŠ<code>nextBlock</code>ä¿å­˜åˆ°<code>subscriber</code>ä¸­ã€‚<code>subscribeNext</code>å†…éƒ¨ä¼šè°ƒç”¨siganlçš„<code>didSubscribe</code>ï¼›</p><p>3.siganlçš„<code>didSubscribe</code>ä¸­è°ƒç”¨<code>[subscriber sendNext:@1]</code>ï¼Œè§¦å‘<code>nextBlock</code>å›è°ƒã€‚</p><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><h3 id="ä»£æ›¿ä»£ç†"><a href="#ä»£æ›¿ä»£ç†" class="headerlink" title="ä»£æ›¿ä»£ç†"></a>ä»£æ›¿ä»£ç†</h3><p><code>RACSubject</code>æ˜¯ä¿¡å·æä¾›è€…ï¼Œå®ƒç»§æ‰¿è‡ª<code>RACSignal</code>ï¼ŒåŒæ—¶åˆéµå®ˆ<code>RACSubscriber</code>åè®®ï¼Œæ‰€ä»¥å®ƒæ—¢èƒ½å……å½“ä¿¡å·ï¼Œä¹Ÿèƒ½å‘é€ä¿¡å·ï¼Œé€šå¸¸ç”¨æ¥ä»£æ›¿æ— è¿”å›å€¼çš„ä»£ç†ï¼ŒRACå°è£…äº†ä¸€ä¸ªæ–¹æ³•<code>rac_signalForSelector:subscribeNext:</code>æ¥ç›‘å¬æ–¹æ³•çš„è°ƒç”¨ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å½“_loginViewè°ƒç”¨loginBtnClicked:æ—¶å‘é€ä¿¡å·</span></div><div class="line">[[_loginView rac_signalForSelector:<span class="keyword">@selector</span>(loginBtnClicked:)] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ç‚¹å‡»äº†ç™»å½•æŒ‰é’®"</span>);</div><div class="line">&#125;];</div><div class="line"></div><div class="line"><span class="comment">// å½“æŒ‰é’®èƒŒæ™¯å›¾ç‰‡æ”¹å˜æ—¶å‘é€ä¿¡å·</span></div><div class="line">[[_btn rac_signalForSelector:<span class="keyword">@selector</span>(setBackgroundImage:)] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"æ”¹å˜æŒ‰é’®èƒŒæ™¯å›¾ç‰‡"</span>);</div><div class="line">&#125;];</div><div class="line"></div><div class="line"><span class="comment">// tableViewç‚¹å‡»ä»£ç†</span></div><div class="line">[[<span class="keyword">self</span> rac_signalForSelector:<span class="keyword">@selector</span>(tableView:didSelectRowAtIndexPath:) fromProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">UITableViewDelegate</span>) ] <span class="title">subscribeNext</span>:^(<span class="title">RACTuple</span> * <span class="title">x</span>) </span>&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"tableView: %@, indexPath: %@"</span>, x.first, x.second);</div><div class="line">&#125;];</div><div class="line">tableview.delegate = <span class="keyword">self</span>;</div></pre></td></tr></table></figure></p><h3 id="ä»£æ›¿é€šçŸ¥"><a href="#ä»£æ›¿é€šçŸ¥" class="headerlink" title="ä»£æ›¿é€šçŸ¥"></a>ä»£æ›¿é€šçŸ¥</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ç›‘å¬é”®ç›˜å¼¹å‡º</span></div><div class="line">[[[[<span class="built_in">NSNotificationCenter</span> defaultCenter] rac_addObserverForName:<span class="built_in">UIKeyboardDidShowNotification</span> object:<span class="literal">nil</span>] takeUntil:<span class="keyword">self</span>.rac_willDeallocSignal] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"é”®ç›˜å¼¹å‡º:%@"</span>, x);</div><div class="line">&#125;];</div></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„<code>takeUntil:</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ¥æ”¶ä¸€ä¸ªsignalï¼Œå½“signalè§¦å‘åä¼šæŠŠä¹‹å‰çš„ä¿¡å·é‡Šæ”¾æ‰ï¼Œé˜²æ­¢ä¿¡å·å åŠ ã€‚</p><h3 id="ä»£æ›¿KVO"><a href="#ä»£æ›¿KVO" class="headerlink" title="ä»£æ›¿KVO"></a>ä»£æ›¿KVO</h3><p>æœ‰ä¸¤ç§<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è‡ªå®šä¹‰options</span></div><div class="line">[_scrollView rac_observeKeyPath:<span class="string">@"contentOffset"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> observer:<span class="literal">nil</span> block:^(<span class="keyword">id</span> value, <span class="built_in">NSDictionary</span> *change, <span class="built_in">BOOL</span> causedByDealloc, <span class="built_in">BOOL</span> affectedOnlyLastComponent) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"contentOffset:%@"</span>,x);</div><div class="line">&#125;];</div><div class="line">    </div><div class="line"><span class="comment">// optionsé»˜è®¤ä¸ºNSKeyValueObservingOptionInitial</span></div><div class="line">[[_scrollView rac_valuesForKeyPath:<span class="string">@"contentOffset"</span> observer:<span class="literal">nil</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"contentOffset:%@"</span>,x);</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p><h3 id="ç›‘å¬äº‹ä»¶"><a href="#ç›‘å¬äº‹ä»¶" class="headerlink" title="ç›‘å¬äº‹ä»¶"></a>ç›‘å¬äº‹ä»¶</h3><p>RACä¸ºå¸¸ç”¨çš„UIæ§ä»¶åŠæ‰‹åŠ¿å¢åŠ äº†åˆ†ç±»ï¼Œæä¾›äº†ä¸åŸç”Ÿæ¡¥æ¥çš„æ¥å£ï¼Œæ–¹ä¾¿ç›‘å¬äº‹ä»¶ï¼Œç¤ºä¾‹ï¼š</p><p>1.ç›‘å¬æŒ‰é’®ç‚¹å‡»äº‹ä»¶<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[[_btn rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ç‚¹å‡»æŒ‰é’®:%@"</span>,x);</div><div class="line">&#125;];</div><div class="line"></div><div class="line"><span class="comment">// ä½¿ç”¨RACCommandç›‘å¬ç‚¹å‡»äº‹ä»¶</span></div><div class="line">_btn.rac_command = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"æŒ‰é’®ç‚¹å‡»%@"</span>, input);</div><div class="line">    <span class="keyword">return</span> [RACSignal empty];</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p><p>2.ç›‘å¬textFieldæ–‡æœ¬æ”¹å˜</p><p>å¯ä»¥é€šè¿‡è®¢é˜…<code>rac_textSignal</code>æ¥ç›‘å¬textFieldçš„textæ”¹å˜ï¼Œè¿˜å¯ä»¥æ ¹æ®éœ€æ±‚åŠ ä¸Šä¸€äº›ä¿¡å·æ“ä½œæ–¹æ³•ï¼Œç¤ºä¾‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ä½¿ç”¨filter:è¿‡æ»¤ä¿¡å·,æ¯æ¬¡ä¿¡å·å‘å‡ºéƒ½ä¼šå…ˆæ‰§è¡Œè¿‡æ»¤æ¡ä»¶åˆ¤æ–­</span></div><div class="line">[[_textfield.rac_textSignal filter:^<span class="built_in">BOOL</span>(<span class="built_in">NSString</span>  *value) &#123;</div><div class="line">    <span class="comment">// å½“æ¡ä»¶åˆ¤æ–­ç­‰äºYESçš„æ—¶å€™æ‰ä¼šè°ƒç”¨è®¢é˜…çš„block</span></div><div class="line">    <span class="keyword">return</span>  value.length &gt; <span class="number">6</span>;</div><div class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    _loginBtn.enabled = <span class="literal">YES</span>;</div><div class="line">&#125;];</div><div class="line"></div><div class="line"><span class="comment">// ä½¿ç”¨ignore:å¿½ç•¥æŸäº›å€¼çš„ä¿¡å·</span></div><div class="line">[[_textfield.rac_textSignal ignore:<span class="string">@"hehe"</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,x);</div><div class="line">&#125;];</div><div class="line"></div><div class="line"><span class="comment">// ä½¿ç”¨skip:è·³è¿‡å‡ ä¸ªä¿¡å·</span></div><div class="line">[[_textfield.rac_textSignal skip:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,x);</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p><h3 id="å®šæ—¶å™¨"><a href="#å®šæ—¶å™¨" class="headerlink" title="å®šæ—¶å™¨"></a>å®šæ—¶å™¨</h3><p>RACæŠŠGCDå°è£…æˆäº†<code>RACScheduler</code>ï¼Œå¸¸ç”¨æ¥åšå®šæ—¶å™¨ä½¿ç”¨ï¼š</p><p>1.å»¶è¿Ÿæ‰§è¡Œï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</div><div class="line">    [subscriber sendNext:<span class="string">@"3"</span>];</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;] delay:<span class="number">3</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="comment">//å‘é€ä¿¡å·3ç§’åæ‰§è¡Œè¿™ä¸ªblock</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[[RACScheduler mainThreadScheduler] afterDelay:<span class="number">3</span> schedule:^&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"3s later..."</span>);</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p><p>è¿™é‡Œé™¤äº†ä½¿ç”¨<code>delay:</code>æ“ä½œä¿¡å·ï¼Œè¿˜å¯ä»¥æ ¹æ®éœ€æ±‚ä½¿ç”¨é‡è¯•(<code>retry</code>)ã€è¶…æ—¶(<code>timeout:</code>)ã€èŠ‚æµ(<code>throttle:</code>)ç­‰æ–¹æ³•æ“ä½œä¿¡å·ã€ï¼Œä¸ä¸€ä¸€åˆ—ä¸¾ã€‚</p><p>2.å®šæ—¶æ‰§è¡Œï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ¯ç§’æ‰§è¡Œä¸€æ¬¡</span></div><div class="line">[[[RACSignal interval:<span class="number">1</span> onScheduler:[RACScheduler mainThreadScheduler]] takeUntil:<span class="keyword">self</span>.rac_willDeallocSignal] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"1s"</span>);</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p><p>åŠ <code>takeUntil:</code>(ç›´åˆ°ä¿¡å·<code>Completed</code>)æ˜¯ä¸ºäº†é˜²æ­¢æ§åˆ¶å™¨é‡Šæ”¾åå®šæ—¶å™¨ä»æ‰§è¡Œã€‚è¿˜å¯ä»¥ä½¿ç”¨<code>take:</code>ï¼ˆä¸åŒ…æ‹¬ä¿¡å·<code>Completed/Error</code>ï¼‰é™åˆ¶å®šæ—¶å™¨æ‰§è¡Œæ¬¡æ•°ã€‚</p><h3 id="é›†åˆæ“ä½œ"><a href="#é›†åˆæ“ä½œ" class="headerlink" title="é›†åˆæ“ä½œ"></a>é›†åˆæ“ä½œ</h3><p>ä½¿ç”¨<code>RACSequence</code>é›†åˆç±»æ¥å¯¹æ•°ç»„ã€å­—å…¸è¿›è¡Œéå†ã€ç­›é€‰ç­‰æ“ä½œï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// éå†å­—å…¸</span></div><div class="line">[dic.rac_sequence.signal subscribeNext:^(RACTuple *x) &#123;</div><div class="line">    <span class="comment">// è§£åŒ…å…ƒç»„ï¼Œä¼šæŠŠå…ƒç»„çš„å€¼ï¼ŒæŒ‰é¡ºåºç»™å‚æ•°é‡Œé¢çš„å˜é‡èµ‹å€¼</span></div><div class="line">    RACTupleUnpack(<span class="built_in">NSString</span> *key, <span class="built_in">NSString</span> *value) = x;</div><div class="line"></div><div class="line">    <span class="comment">// ç›¸å½“äºä»¥ä¸‹å†™æ³•</span></div><div class="line">    <span class="comment">// NSString *key = x.first;</span></div><div class="line">    <span class="comment">// NSString *value = x.second;</span></div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ %@"</span>,key,value); </div><div class="line">&#125;];</div><div class="line"></div><div class="line"><span class="comment">// å­—å…¸æ•°ç»„è½¬æ¨¡å‹æ•°ç»„ï¼Œä½¿ç”¨map:å°†å­—å…¸æ˜ å°„æˆmodelï¼Œå†å°†é›†åˆè½¬æ¢æˆæ•°ç»„</span></div><div class="line"><span class="built_in">NSArray</span> *models = [[dicArray.rac_sequence map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</div><div class="line">    <span class="keyword">return</span> [Model modelWithDict:value];</div><div class="line">&#125;] array];</div></pre></td></tr></table></figure></p><h3 id="è·å–å¤šä¸ªè¯·æ±‚æ•°æ®åˆ·æ–°ç•Œé¢"><a href="#è·å–å¤šä¸ªè¯·æ±‚æ•°æ®åˆ·æ–°ç•Œé¢" class="headerlink" title="è·å–å¤šä¸ªè¯·æ±‚æ•°æ®åˆ·æ–°ç•Œé¢"></a>è·å–å¤šä¸ªè¯·æ±‚æ•°æ®åˆ·æ–°ç•Œé¢</h3><p>ä½¿ç”¨<code>rac_liftSelector:withSignalsFromArray:</code>æ–¹æ³•å¯ä»¥åœ¨ä¿¡å·æ•°ç»„ä¸­æ¯ä¸€ä¸ªä¿¡å·éƒ½è‡³å°‘å‘é€è¿‡ä¸€æ¬¡åè°ƒç”¨selectorã€‚å¯ä»¥åº”ç”¨åœ¨è·å–å¤šä¸ªè¯·æ±‚æ•°æ®åˆ·æ–°ç•Œé¢æˆ–å¤šä¸ªtextFieldéƒ½æœ‰å€¼æ—¶æŒ‰é’®å¯ç‚¹å‡»çš„åœºæ™¯ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="comment">// æ¨¡æ‹Ÿå¤šè¯·æ±‚</span></div><div class="line">    RACSignal *requestSignal1 = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</div><div class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</div><div class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3.0</span>];</div><div class="line">            [subscriber sendNext:<span class="string">@"è¯·æ±‚1åŠ è½½å®Œæˆ"</span>];</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"å–æ¶ˆè¯·æ±‚ä¿¡å·1"</span>);</div><div class="line">        &#125;];</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">    RACSignal *requestSignal2 = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</div><div class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</div><div class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3.0</span>];</div><div class="line">            [subscriber sendNext:<span class="string">@"è¯·æ±‚2åŠ è½½å®Œæˆ"</span>];</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"å–æ¶ˆè¯·æ±‚ä¿¡å·2"</span>);</div><div class="line">        &#125;];</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(responseRequest1:request2:) withSignalsFromArray:@[signalA, signalB]];</div><div class="line">   </div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)responseRequest1:(<span class="keyword">id</span>)data1 request2:(<span class="keyword">id</span>)data2 &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@, %@"</span>, data1, data2);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="å®åŠé”®å€¼ç»‘å®š"><a href="#å®åŠé”®å€¼ç»‘å®š" class="headerlink" title="å®åŠé”®å€¼ç»‘å®š"></a>å®åŠé”®å€¼ç»‘å®š</h3><p>RACä¹‹æ‰€ä»¥å¼ºå¤§ç¦»ä¸å¼€å®ƒå¯¹å®çš„åº”ç”¨å’Œé”®å€¼ç»‘å®šï¼Œæå¤§çš„æé«˜äº†ä»£ç çš„ç®€æ´æ€§ï¼Œå…³äºå®çš„ä½¿ç”¨å¯ä»¥çœ‹ä¸‹<a href="http://blog.sunnyxx.com/2014/03/06/rac_1_macros/" target="_blank" rel="external">Reactive Cocoa Tutorial [1] = ç¥å¥‡çš„Macros</a>ã€<a href="https://halfrost.com/reactivecocoa_macro/" target="_blank" rel="external">ReactiveCocoa ä¸­ å¥‡å¦™æ— æ¯”çš„â€œå®â€é­”æ³•</a>ï¼Œå¤§ä½¬ä»¬è®²çš„å¾ˆè¯¦ç»†ï¼Œè¿™é‡Œä¸¾å‡ ä¸ªé¡¹ç›®ä¸­çš„ç®€å•åº”ç”¨ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UIä¸ModelåŒå‘ç»‘å®š</span></div><div class="line">RACChannelTo(_mobileField, text) = RACChannelTo(_resetModel, mobile);</div><div class="line"></div><div class="line"><span class="comment">// UIç»‘å®šModel</span></div><div class="line">RAC(_sendCodeBtn, enabled) = [_mobileField.rac_textSignal map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *mobile) &#123;</div><div class="line">    <span class="keyword">return</span> @([mobile isValidMobile]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line"><span class="comment">// ä½¿ç”¨combineLatest:reduce:å°†ä¿¡å·å…ˆç»„åˆå†èšåˆè¿”å›æˆ‘ä»¬éœ€è¦çš„æ•°æ®æ ¼å¼</span></div><div class="line">RAC(_resetBtn, enabled) = [RACSignal combineLatest:@[</div><div class="line">                                                        _mobileField.rac_textSignal,</div><div class="line">                                                        _vercodeField.rac_textSignal,</div><div class="line">                                                        _passwordField.rac_textSignal] reduce:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *mobile, <span class="built_in">NSString</span> *vercode, <span class="built_in">NSString</span> *password)&#123;</div><div class="line">                                                            <span class="keyword">return</span> @(mobile.length &gt; <span class="number">11</span> &amp;&amp; vercode.length == <span class="number">6</span> &amp;&amp; password.length &gt; <span class="number">6</span>);</div><div class="line">                                                        &#125;];</div><div class="line">                    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// @weakify()ã€@strongify()æˆå¯¹å‡ºç°ï¼Œé˜²æ­¢å¾ªç¯å¼•ç”¨</span></div><div class="line">@weakify(<span class="keyword">self</span>);</div><div class="line">[[<span class="keyword">self</span>.sendCodeBtn rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    @strongify(<span class="keyword">self</span>);</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.sendCodeBtn.enabled = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">self</span>.remainSeconds = <span class="number">60</span>;</div><div class="line">    <span class="keyword">self</span>.startCheckTimer = <span class="number">1</span>;</div><div class="line"></div><div class="line">    [<span class="keyword">self</span> startResendVerifyCode];</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p><p><br>ç›®å‰RACåœ¨é¡¹ç›®ä¸­çš„åº”ç”¨å°±è¿™äº›ï¼Œå› ä¸ºè‡ªå·±ä¹Ÿåœ¨ä¸æ–­æ‘¸ç´¢å­¦ä¹ ä¸­ï¼Œæ‰€ä»¥è¿˜æ²¡æœ‰å¤§é¢ç§¯åº”ç”¨ï¼Œç›¸ä¿¡åªè¦å¤šå†™ï¼Œå¤šç»ƒæˆ‘ä¹Ÿèƒ½å†™å‡ºå¤§ä½¬ä»¬é‚£ç§ä¸€é•¿ä¸²çš„ä»£ç ğŸ˜‚ã€‚</p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p>å¼ºçƒˆæ¨èéœœç¥çš„<a href="https://halfrost.com/tag/rac/" target="_blank" rel="external">RACåŸç†ç³»åˆ—æ–‡ç« </a></p><p><a href="https://ming1016.github.io/2016/08/09/how-to-use-reactivecocoa/" target="_blank" rel="external">iOSå‡½æ•°å“åº”å¼ç¼–ç¨‹ä»¥åŠReactiveCocoaçš„ä½¿ç”¨</a></p><p><a href="https://www.jianshu.com/p/87ef6720a096" target="_blank" rel="external">æœ€å¿«è®©ä½ ä¸Šæ‰‹ReactiveCocoaä¹‹åŸºç¡€ç¯‡</a></p><p><a href="http://yulingtianxia.com/blog/2015/05/21/ReactiveCocoa-and-MVVM-an-Introduction/#%E8%BF%9B%E5%85%A5-ReactiveCocoa" target="_blank" rel="external">ReactiveCocoa å’Œ MVVM å…¥é—¨</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;RACæ˜¯iOSå¼€å‘ä¸­ä½¿ç”¨æœ€å¹¿æ³›ã€æœ€å¼ºå¤§çš„å‡½æ•°å“åº”å¼ç¼–ç¨‹æ¡†æ¶ï¼Œæœ‰äº†å®ƒå°±ä¸éœ€è¦ä½¿ç”¨å¦‚notificarionã€delegateã€blockã€kvoç­‰OCçš„ç¦»æ•£æ¶ˆæ¯ä¼ é€’æ–¹å¼ï¼Œåªéœ€è¦è€ƒè™‘ç»“æœã€‚å†ç»“åˆå…¶å¼ºå¤§çš„ä¿¡å·æ“ä½œæ–¹æ³•ä½¿ç”¨ï¼Œè®©ä»£ç é«˜åº¦èšåˆï¼Œé™ä½è€¦åˆæ€§ï¼Œç»™å¼€å‘å¸¦æ¥äº†å¾ˆå¤§çš„ä¾¿åˆ©ã€‚ä½†åŒæ—¶å› ä¸ºä»–çš„å¼ºå¤§å¯¼è‡´æˆ‘ç»å¸¸å¿˜è®°ä¸€äº›apiçš„ç”¨æ³•ğŸ˜‚ï¼Œä¸‹é¢æˆ‘æ¥ç®€å•æ•´ç†ä¸‹é¡¹ç›®ä¸­ç”¨åˆ°çš„RACï¼Œæ–¹ä¾¿å¼€å‘æ—¶æŸ¥é˜…ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="ReactiveCocoa" scheme="http://wonkeyz.com/tags/ReactiveCocoa/"/>
    
  </entry>
  
  <entry>
    <title>æ…ç”¨NSLog</title>
    <link href="http://wonkeyz.com/2017/08/13/Careful-use-of-NSLog/"/>
    <id>http://wonkeyz.com/2017/08/13/Careful-use-of-NSLog/</id>
    <published>2017-08-13T08:13:29.000Z</published>
    <updated>2018-01-02T10:08:46.195Z</updated>
    
    <content type="html"><![CDATA[<p>å‰é˜µå­çœ‹äº† sunnyxx å¤§ç¥çš„<a href="http://blog.sunnyxx.com/2014/04/22/objc_dig_nslog/" target="_blank" rel="external">NSLogæ•ˆç‡ä½ä¸‹çš„åŸå› åŠå°è¯•lldbæ–­ç‚¹æ‰“å°Log</a>ï¼Œæ–‡ä¸­ä¸»è¦è®²äº†<code>NSLog</code>å¯¹æ€§èƒ½çš„æ¶ˆè€—ä¸å®¹å°è§†ï¼Œå“å¾—æˆ‘èµ¶ç´§æœäº†ä¸‹ï¼Œæœç„¶æœ‰æ»¥ç”¨çš„æƒ…å†µâ€¦ä½†æ˜¯æ–‡ä¸­å¹¶æ²¡æœ‰å…·ä½“è¯´æ˜<code>NSLog</code>çš„æ€§èƒ½æ¶ˆè€—ç‚¹ï¼Œäºæ˜¯æˆ‘ä¸‹è½½<a href="http://ftpmain.gnustep.org/pub/gnustep/core/gnustep-base-1.25.0.tar.gz" target="_blank" rel="external">GNUstep Base</a>ï¼Œä»<code>NSLog</code>çš„æºç ä¸­ä¸€æ¢ç©¶ç«Ÿã€‚<br><a id="more"></a></p><h2 id="è°ƒç”¨æ­¥éª¤"><a href="#è°ƒç”¨æ­¥éª¤" class="headerlink" title="è°ƒç”¨æ­¥éª¤"></a>è°ƒç”¨æ­¥éª¤</h2><p>çœ‹ä¼¼ç®€å•ä¸€å¥<code>NSLog()</code>ï¼Œå…¶å®å†…éƒ¨èµ°äº†å‡ ç™¾è¡Œä»£ç ï¼Œä¸»è¦åˆ†ä¸‰æ­¥è°ƒç”¨ï¼š</p><ul><li><code>NSLog(NSString* format, ...)</code></li><li><code>NSLogv(NSString* format, va_list args)</code></li><li><code>_NSLog_standard_printf_handler(NSString* message)</code></li></ul><p>æˆ‘ä»¬æ¥é€ä¸€åˆ†æä¸‹ï¼š</p><h3 id="NSLog-NSString-format-â€¦"><a href="#NSLog-NSString-format-â€¦" class="headerlink" title="NSLog(NSString* format, â€¦)"></a>NSLog(NSString* format, â€¦)</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="built_in">NSString</span>* format, ...)</div><div class="line">&#123;</div><div class="line">  va_list ap;</div><div class="line"></div><div class="line">  va_start(ap, format);</div><div class="line">  <span class="built_in">NSLogv</span>(format, ap);</div><div class="line">  va_end(ap);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ç¬¬ä¸€æ­¥å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯è·å–å‚æ•°åˆ—è¡¨<code>va_list ap</code>ï¼Œç„¶åè°ƒç”¨<code>NSLogv(format, ap)</code>ã€‚</p><h3 id="NSLogv-NSString-format-va-list-args"><a href="#NSLogv-NSString-format-va-list-args" class="headerlink" title="NSLogv(NSString* format, va_list args)"></a>NSLogv(NSString* format, va_list args)</h3><p>è¿™éƒ¨å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œå®ƒä¸»è¦åšçš„æ˜¯å°†æˆ‘ä»¬æ§åˆ¶å°çœ‹åˆ°çš„ Log çš„å‰ç¼€åŠæ‰“å°ä¿¡æ¯æ‹¼æ¥ï¼Œå‰ç¼€åŒ…æ‹¬è¿›ç¨‹ã€çº¿ç¨‹ã€æ—¶é—´ç­‰ä¿¡æ¯ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSMutableString</span>*prefix;</div><div class="line"><span class="built_in">NSString</span>              *message;</div><div class="line"><span class="built_in">NSString</span>              *threadName = <span class="literal">nil</span>;</div><div class="line"><span class="built_in">NSThread</span>              *t = <span class="literal">nil</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span>pid = <span class="number">0</span>;</div></pre></td></tr></table></figure><p>1.è¿›ç¨‹ pid<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line"><span class="meta">#if defined(_WIN32)</span></div><div class="line">      pid = (<span class="keyword">int</span>)GetCurrentProcessId();</div><div class="line"><span class="meta">#else</span></div><div class="line">      pid = (<span class="keyword">int</span>)getpid();</div><div class="line"><span class="meta">#endif</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p><p>2.çº¿ç¨‹ threadName<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (GSPrivateDefaultsFlag(GSLogThread) == <span class="literal">YES</span>)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* If no name has been set for the current thread,</span></div><div class="line">     * we log the address of the NSThread object instead.</div><div class="line">     */</div><div class="line">    t = GSCurrentThread();</div><div class="line">    threadName = [t name];</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p><p>3.æ‰“å°ä¿¡æ¯ message<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1.æ—¶é—´</span></div><div class="line"><span class="keyword">if</span> (GSPrivateDefaultsFlag(GSLogOffset) == <span class="literal">YES</span>)</div><div class="line">&#123;</div><div class="line">   fmt = <span class="string">@"%Y-%m-%d %H:%M:%S.%F %z"</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span></div><div class="line">&#123;</div><div class="line">   fmt = <span class="string">@"%Y-%m-%d %H:%M:%S.%F"</span>;</div><div class="line">&#125;</div><div class="line">cal = [[<span class="built_in">NSCalendarDate</span> calendarDate] descriptionWithCalendarFormat: fmt];</div><div class="line">    </div><div class="line">[prefix appendString: cal];</div><div class="line">[prefix appendString: <span class="string">@" "</span>];</div><div class="line"></div><div class="line"><span class="comment">// 2.è¿›ç¨‹ã€çº¿ç¨‹</span></div><div class="line"><span class="meta">#ifdefHAVE_SYSLOG</span></div><div class="line"><span class="keyword">if</span> (GSPrivateDefaultsFlag(GSLogSyslog) == <span class="literal">YES</span>)</div><div class="line">&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="literal">nil</span> == t)</div><div class="line">   &#123;</div><div class="line">       [prefix appendFormat: <span class="string">@"[thread:%"</span>PRIuPTR<span class="string">"] "</span>,</div><div class="line">     GSPrivateThreadID()];</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">nil</span> == threadName)</div><div class="line">   &#123;</div><div class="line">       [prefix appendFormat: <span class="string">@"[thread:%"</span>PRIuPTR<span class="string">",%p] "</span>,</div><div class="line">     GSPrivateThreadID(), t];</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">else</span></div><div class="line">   &#123;</div><div class="line">       [prefix appendFormat: <span class="string">@"[thread:%"</span>PRIuPTR<span class="string">",%@] "</span>,</div><div class="line">     GSPrivateThreadID(), threadName];</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">   [prefix appendString: [[<span class="built_in">NSProcessInfo</span> processInfo] processName]];</div><div class="line">   <span class="keyword">if</span> (<span class="literal">nil</span> == t)</div><div class="line">   &#123;</div><div class="line">       [prefix appendFormat: <span class="string">@"[%d:%"</span>PRIuPTR<span class="string">"] "</span>,</div><div class="line">        pid, GSPrivateThreadID()];</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">nil</span> == threadName)</div><div class="line">   &#123;</div><div class="line">       [prefix appendFormat: <span class="string">@"[%d:%"</span>PRIuPTR<span class="string">",%p] "</span>,</div><div class="line">        pid, GSPrivateThreadID(), t];</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">else</span></div><div class="line">   &#123;</div><div class="line">       [prefix appendFormat: <span class="string">@"[%d:%"</span>PRIuPTR<span class="string">",%@] "</span>,</div><div class="line">        pid, GSPrivateThreadID(), threadName];</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="meta">#endif</span></div><div class="line"></div><div class="line"><span class="comment">// 3.æ‹¼æ¥æ‰“å°ä¿¡æ¯</span></div><div class="line">  message = [[<span class="built_in">NSString</span> alloc] initWithFormat: format arguments: args];</div><div class="line">  [prefix appendString: message];</div><div class="line">  [message release];</div><div class="line">  <span class="keyword">if</span> ([prefix hasSuffix: <span class="string">@"\n"</span>] ==  <span class="literal">NO</span>)</div><div class="line">    &#123;</div><div class="line">      [prefix appendString: <span class="string">@"\n"</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> == myLock)</div><div class="line">    &#123;</div><div class="line">      GSLogLock();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">// 4.è°ƒç”¨ _NSLog_standard_printf_handler æ‰“å°message</span></div><div class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> == myLock)</div><div class="line">    &#123;</div><div class="line">      GSLogLock();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  (*lockImp)(myLock, <span class="keyword">@selector</span>(lock));</div><div class="line"></div><div class="line">  _NSLog_printf_handler(prefix);</div><div class="line"></div><div class="line">  (*unlockImp)(myLock, <span class="keyword">@selector</span>(unlock));</div></pre></td></tr></table></figure></p><p>ä¸ºäº†ä¿è¯ä¿¡æ¯çš„å‡†ç¡®æ€§ï¼Œç¬¬4æ­¥åœ¨è°ƒç”¨<code>_NSLog_printf_handler()</code>æ—¶åŠ äº†é€’å½’é”<code>NSRecursiveLock</code>ï¼Œå¯¹é”æ„Ÿå…´è¶£è¯·è§<a href="http://www.jianshu.com/p/ddbe44064ca4" target="_blank" rel="external">iOS ä¸­çš„å…«å¤§é”</a>ã€‚</p><h3 id="NSLog-standard-printf-handler-NSString-message"><a href="#NSLog-standard-printf-handler-NSString-message" class="headerlink" title="_NSLog_standard_printf_handler(NSString* message)"></a>_NSLog_standard_printf_handler(NSString* message)</h3><p>è¿™ä¸ªæ–¹æ³•æ ¹æ®ä¸åŒçš„ç¯å¢ƒè°ƒç”¨å¯¹åº”çš„è¾“å‡ºå‡½æ•°ï¼Œå®šä¹‰äº†ä¸€ä¸‹å˜é‡ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">  <span class="built_in">NSData</span>*d;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span>*buf;</div><div class="line">  <span class="keyword">unsigned</span>len;</div><div class="line"><span class="meta">#ifdefined(_WIN32)</span></div><div class="line">  LPCWSTRnull_terminated_buf;</div><div class="line"><span class="meta">#else</span></div><div class="line"><span class="meta">#ifdefined(HAVE_SYSLOG) || defined(HAVE_SLOGF)</span></div><div class="line">  <span class="keyword">char</span>*null_terminated_buf = <span class="literal">NULL</span>;</div><div class="line"><span class="meta">#endif</span></div><div class="line"><span class="meta">#endif</span></div><div class="line">  <span class="keyword">static</span> <span class="built_in">NSStringEncoding</span> enc = <span class="number">0</span>;</div></pre></td></tr></table></figure></p><p>æ¥ä¸‹æ¥å°†<code>message</code>è½¬æˆ<code>buffer</code>ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (enc == <span class="number">0</span>)</div><div class="line">  &#123;</div><div class="line">    enc = [<span class="built_in">NSString</span> defaultCStringEncoding];</div><div class="line">  &#125;</div><div class="line">d = [message dataUsingEncoding: enc allowLossyConversion: <span class="literal">NO</span>];</div><div class="line"><span class="keyword">if</span> (d == <span class="literal">nil</span>)</div><div class="line">  &#123;</div><div class="line">    d = [message dataUsingEncoding: <span class="built_in">NSUTF8StringEncoding</span></div><div class="line">allowLossyConversion: <span class="literal">NO</span>];</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (d == <span class="literal">nil</span>)<span class="comment">// Should never happen.</span></div><div class="line">  &#123;</div><div class="line">    buf = [message lossyCString];</div><div class="line">    len = strlen(buf);</div><div class="line">  &#125;</div><div class="line"><span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    buf = (<span class="keyword">const</span> <span class="keyword">char</span>*)[d bytes];</div><div class="line">    len = [d length];</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p><p>æœ€åæ ¹æ®ä¸åŒç³»ç»Ÿè°ƒç”¨å¯¹åº”æ‰“å°å‡½æ•°ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#ifdefined(_WIN32)</span></div><div class="line">  null_terminated_buf = UNISTR(message);</div><div class="line"></div><div class="line">  OutputDebugStringW(null_terminated_buf);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> ((GSPrivateDefaultsFlag(GSLogSyslog) == <span class="literal">YES</span></div><div class="line">    || write(_NSLogDescriptor, buf, len) != (<span class="keyword">int</span>)len) &amp;&amp; !IsDebuggerPresent())</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">static</span> HANDLE eventloghandle = <span class="number">0</span>;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!eventloghandle)</div><div class="line">&#123;</div><div class="line">  eventloghandle = RegisterEventSourceW(<span class="literal">NULL</span>,</div><div class="line">    UNISTR([[<span class="built_in">NSProcessInfo</span> processInfo] processName]));</div><div class="line">&#125;</div><div class="line">      <span class="keyword">if</span> (eventloghandle)</div><div class="line">&#123;</div><div class="line">  ReportEventW(eventloghandle,<span class="comment">// event log handle</span></div><div class="line">    EVENTLOG_WARNING_TYPE,<span class="comment">// event type</span></div><div class="line">    <span class="number">0</span>,<span class="comment">// category zero</span></div><div class="line">    <span class="number">0</span>,<span class="comment">// event identifier</span></div><div class="line">    <span class="literal">NULL</span>,<span class="comment">// no user security identifier</span></div><div class="line">    <span class="number">1</span>,<span class="comment">// one substitution string</span></div><div class="line">    <span class="number">0</span>,<span class="comment">// no data</span></div><div class="line">    &amp;null_terminated_buf,<span class="comment">// pointer to string array</span></div><div class="line">    <span class="literal">NULL</span>);<span class="comment">// pointer to data</span></div><div class="line">&#125;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#else</span></div><div class="line"></div><div class="line"><span class="meta">#ifdefined(HAVE_SYSLOG)</span></div><div class="line">  <span class="keyword">if</span> (GSPrivateDefaultsFlag(GSLogSyslog) == <span class="literal">YES</span></div><div class="line">    || write(_NSLogDescriptor, buf, len) != (<span class="keyword">int</span>)len)</div><div class="line">    &#123;</div><div class="line">      null_terminated_buf = malloc(<span class="keyword">sizeof</span> (<span class="keyword">char</span>) * (len + <span class="number">1</span>));</div><div class="line">      strncpy (null_terminated_buf, buf, len);</div><div class="line">      null_terminated_buf[len] = <span class="string">'\0'</span>;</div><div class="line"></div><div class="line">      syslog(SYSLOGMASK, <span class="string">"%s"</span>,  null_terminated_buf);</div><div class="line"></div><div class="line">      free(null_terminated_buf);</div><div class="line">    &#125;</div><div class="line"><span class="meta">#elif defined(HAVE_SLOGF)</span></div><div class="line">  <span class="keyword">if</span> (GSPrivateDefaultsFlag(GSLogSyslog) == <span class="literal">YES</span></div><div class="line">    || write(_NSLogDescriptor, buf, len) != (<span class="keyword">int</span>)len)</div><div class="line">    &#123;</div><div class="line">      <span class="comment">/* QNX's slog has a size limit per entry. We might need to iterate over</span></div><div class="line">       * _SLOG_MAXSIZEd chunks of the buffer</div><div class="line">       */</div><div class="line">      <span class="keyword">const</span> <span class="keyword">char</span> *newBuf = buf;</div><div class="line">      <span class="keyword">unsigned</span> newLen = len;</div><div class="line"></div><div class="line">      <span class="comment">// Allocate at most _SLOG_MAXSIZE bytes</span></div><div class="line">      null_terminated_buf = malloc(<span class="keyword">sizeof</span>(<span class="keyword">char</span>) * MIN(newLen, _SLOG_MAXSIZE));</div><div class="line">      <span class="comment">// If it's shorter than that, we never even enter the loop</span></div><div class="line">      <span class="keyword">while</span> (newLen &gt;= _SLOG_MAXSIZE)</div><div class="line">        &#123;</div><div class="line">          strncpy(null_terminated_buf, newBuf, (_SLOG_MAXSIZE - <span class="number">1</span>));</div><div class="line">          null_terminated_buf[_SLOG_MAXSIZE] = <span class="string">'\0'</span>;</div><div class="line">          slogf(_SLOG_SETCODE(_SLOG_SYSLOG, <span class="number">0</span>), _SLOG_ERROR, <span class="string">"%s"</span>,</div><div class="line">            null_terminated_buf);</div><div class="line">          newBuf += (_SLOG_MAXSIZE - <span class="number">1</span>);</div><div class="line">          newLen -= (_SLOG_MAXSIZE - <span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">      <span class="comment">/* Write out the rest (which will be at most (_SLOG_MAXSIZE - 1) chars,</span></div><div class="line">       * so the terminator still fits.</div><div class="line">       */</div><div class="line">      <span class="keyword">if</span> (<span class="number">0</span> != newLen)</div><div class="line">        &#123;</div><div class="line">          strncpy(null_terminated_buf, newBuf, newLen);</div><div class="line">          null_terminated_buf[newLen] = <span class="string">'\0'</span>;</div><div class="line">          slogf(_SLOG_SETCODE(_SLOG_SYSLOG, <span class="number">0</span>), _SLOG_ERROR, <span class="string">"%s"</span>,</div><div class="line">            null_terminated_buf);</div><div class="line">        &#125;</div><div class="line">      free(null_terminated_buf);</div><div class="line">    &#125;</div><div class="line"><span class="meta">#else</span></div><div class="line">  write(_NSLogDescriptor, buf, len);</div><div class="line"><span class="meta">#endif</span></div></pre></td></tr></table></figure></p><p>é»˜è®¤æƒ…å†µä¸‹è°ƒç”¨<code>write(_NSLogDescriptor, buf, len)</code>ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>çœŸæ˜¯ä¸€çœ‹æºç å“ä¸€è·³å•Šï¼Œä¸€å¥<code>NSLog</code>é‡Œè—äº†è¿™ä¹ˆå¤šæ“ä½œâ€¦ä»¥åè¿˜æ˜¯æ…ç”¨<code>NSLog</code>ï¼Œå¤šç”¨<code>lldb</code>(<a href="https://casatwy.com/shi-yong-lldbdiao-shi-cheng-xu.html" target="_blank" rel="external">ä½¿ç”¨LLDBè°ƒè¯•ç¨‹åº</a>)å¤§æ³•å§~</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰é˜µå­çœ‹äº† sunnyxx å¤§ç¥çš„&lt;a href=&quot;http://blog.sunnyxx.com/2014/04/22/objc_dig_nslog/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;NSLogæ•ˆç‡ä½ä¸‹çš„åŸå› åŠå°è¯•lldbæ–­ç‚¹æ‰“å°Log&lt;/a&gt;ï¼Œæ–‡ä¸­ä¸»è¦è®²äº†&lt;code&gt;NSLog&lt;/code&gt;å¯¹æ€§èƒ½çš„æ¶ˆè€—ä¸å®¹å°è§†ï¼Œå“å¾—æˆ‘èµ¶ç´§æœäº†ä¸‹ï¼Œæœç„¶æœ‰æ»¥ç”¨çš„æƒ…å†µâ€¦ä½†æ˜¯æ–‡ä¸­å¹¶æ²¡æœ‰å…·ä½“è¯´æ˜&lt;code&gt;NSLog&lt;/code&gt;çš„æ€§èƒ½æ¶ˆè€—ç‚¹ï¼Œäºæ˜¯æˆ‘ä¸‹è½½&lt;a href=&quot;http://ftpmain.gnustep.org/pub/gnustep/core/gnustep-base-1.25.0.tar.gz&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GNUstep Base&lt;/a&gt;ï¼Œä»&lt;code&gt;NSLog&lt;/code&gt;çš„æºç ä¸­ä¸€æ¢ç©¶ç«Ÿã€‚&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>å †å¯¹è±¡ä¸æ ˆå¯¹è±¡</title>
    <link href="http://wonkeyz.com/2017/08/11/Heap-and-stack/"/>
    <id>http://wonkeyz.com/2017/08/11/Heap-and-stack/</id>
    <published>2017-08-11T05:58:15.000Z</published>
    <updated>2018-02-01T01:41:06.641Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨ä¸€æ¬¡ç»„å†…è®¨è®ºæ—¶ï¼Œå¤§å®¶è¢«ä¸€ä¸ªå¾ˆåŸºç¡€çš„é—®é¢˜éš¾ä½äº†ï¼Œå°±æ˜¯OCå¯¹è±¡ä¸ºä»€ä¹ˆå­˜å‚¨åœ¨å †ä¸Šï¼Ÿå­˜åœ¨æ ˆä¸Šä¼šæ€ä¹ˆæ ·ï¼Ÿå¤§å®¶ç»™çš„ç­”æ¡ˆéƒ½æ¨¡æ£±ä¸¤å¯ï¼Œçœ‹æ¥åŸºç¡€çŸ¥è¯†è¿˜æ˜¯ä¸æ‰å®å•Šâ€¦è¿™ç¯‡æ–‡ç« å°±æ¥ç®€å•æ€»ç»“ä¸€ä¸‹å †ä¸æ ˆã€‚</p><h2 id="å †ä¸æ ˆæ¦‚å¿µ"><a href="#å †ä¸æ ˆæ¦‚å¿µ" class="headerlink" title="å †ä¸æ ˆæ¦‚å¿µ"></a>å †ä¸æ ˆæ¦‚å¿µ</h2><p>ä¸¤è€…éƒ½æ˜¯è¿›ç¨‹ä¸­çš„ä¸€æ®µå†…å­˜åŒºåŸŸï¼Œå…ˆæ¥çœ‹ä¸‹åŸºæœ¬æ¦‚å¿µï¼š</p><ul><li>å †ï¼ˆheapï¼‰ï¼šå †æ˜¯å‘é«˜åœ°å€æ‰©å±•çš„æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œå †åˆ†å…¨å±€å †å’Œå±€éƒ¨å †ã€‚å…¨å±€å †å°±æ˜¯æ‰€æœ‰æ²¡æœ‰åˆ†é…çš„ç©ºé—´ï¼Œå±€éƒ¨å †å°±æ˜¯ç”¨æˆ·åˆ†é…çš„ç©ºé—´ã€‚å®ƒç”±<strong>ç¨‹åºå‘˜</strong>åˆ†é…å’Œé‡Šæ”¾ï¼Œç”¨äºå­˜æ”¾è¿›ç¨‹è¿è¡Œä¸­è¢«åŠ¨æ€åˆ†é…çš„å†…å­˜æ®µï¼Œå®ƒå¤§å°å¹¶ä¸å›ºå®šï¼Œå¯åŠ¨æ€æ‰©å¼ æˆ–ç¼©å‡ã€‚å½“è¿›ç¨‹è°ƒç”¨allocç­‰å‡½æ•°åˆ†é…å†…å­˜æ—¶ï¼Œæ–°åˆ†é…çš„å†…å­˜å°±è¢«åŠ¨æ€æ·»åŠ åˆ°å †ä¸Šï¼ˆå †è¢«æ‰©å¼ ï¼‰ï¼›å½“åˆ©ç”¨realseé‡Šæ”¾å†…å­˜æ—¶ï¼Œè¢«é‡Šæ”¾çš„å†…å­˜ä»å †ä¸­è¢«å‰”é™¤ï¼ˆå †è¢«ç¼©å‡ï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨iOSåŸºæœ¬éƒ½ä½¿ç”¨ARCæ¥ç®¡ç†å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ç”¨æˆ‘ä»¬ç¨‹åºå‘˜æ¥ç®¡ç†ï¼Œä½†æ˜¯æˆ‘ä»¬è¦çŸ¥é“è¿™ä¸ªå¯¹è±¡å­˜å‚¨çš„ä½ç½®ã€‚<a id="more"></a></li><li>æ ˆï¼ˆstackï¼‰ï¼šæ ˆæ˜¯å‘ä½åœ°å€æ‰©å±•çš„æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸€å—è¿ç»­çš„å†…å­˜çš„åŒºåŸŸã€‚å®ƒç”±<strong>ç¼–è¯‘å™¨</strong>è‡ªåŠ¨åˆ†é…å¹¶é‡Šæ”¾ï¼Œç”¨äºå­˜æ”¾å±€éƒ¨å˜é‡ã€å ç”¨ç©ºé—´ç¡®å®šçš„æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å‡½æ•°æ‹¬å¼§â€œ{}â€ä¸­å®šä¹‰çš„å˜é‡ï¼ˆä½†ä¸åŒ…æ‹¬staticå£°æ˜çš„å˜é‡ï¼Œstaticæ„å‘³ç€åœ¨æ•°æ®æ®µä¸­å­˜æ”¾å˜é‡ï¼‰ã€‚é™¤æ­¤ä»¥å¤–åœ¨å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå…¶å‚æ•°ä¹Ÿä¼šè¢«å‹å…¥å‘èµ·è°ƒç”¨çš„è¿›ç¨‹æ ˆä¸­ï¼Œå¹¶ä¸”å¾…åˆ°è°ƒç”¨ç»“æŸåï¼Œå‡½æ•°çš„è¿”å›å€¼ä¹Ÿä¼šè¢«å­˜æ”¾å›æ ˆä¸­ã€‚ç”±äºæ ˆçš„å…ˆè¿›å…ˆå‡ºç‰¹ç‚¹ï¼Œæ‰€ä»¥æ ˆç‰¹åˆ«æ–¹ä¾¿ç”¨æ¥ä¿å­˜/æ¢å¤è°ƒç”¨ç°åœºã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šå°†æˆ‘ä»¬å¯ä»¥æŠŠæ ˆçœ‹æˆä¸€ä¸ªä¸´æ—¶æ•°æ®å¯„å­˜ã€äº¤æ¢çš„å†…å­˜åŒºã€‚</li></ul><h2 id="å †å¯¹è±¡ä¸æ ˆå¯¹è±¡"><a href="#å †å¯¹è±¡ä¸æ ˆå¯¹è±¡" class="headerlink" title="å †å¯¹è±¡ä¸æ ˆå¯¹è±¡"></a>å †å¯¹è±¡ä¸æ ˆå¯¹è±¡</h2><p>è®²å®Œæ¦‚å¿µæˆ‘ä»¬æ¥ä¸¾ä¾‹çœ‹ä¸€ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ ˆ</span></div><div class="line"><span class="built_in">NSInteger</span> i = <span class="number">233</span>;</div><div class="line"><span class="comment">// æ ˆ</span></div><div class="line"><span class="built_in">NSString</span> *s = <span class="string">@"stack"</span>;</div><div class="line"></div><div class="line"><span class="built_in">NSObject</span> *obj = [[<span class="built_in">NSObject</span> alloc] init];</div></pre></td></tr></table></figure></p><p>å‰ä¸¤ä¸ªä¸å¿…è¯´ï¼Œç¬¬ä¸‰è¡Œåˆ›å»ºäº†ä¸€ä¸ªNSObjectç±»å‹çš„æŒ‡é’ˆobjå’Œä¸€ä¸ª NSObjectç±»å‹çš„å¯¹è±¡ï¼Œå› ä¸ºæŒ‡é’ˆçš„å¤§å°ç¡®å®šï¼Œæ‰€ä»¥objæŒ‡é’ˆå­˜å‚¨åœ¨æ ˆä¸Šï¼Œè€Œå…¶æŒ‡å‘çš„å¯¹è±¡å†…å­˜æ— æ³•ç¡®å®šï¼Œæ‰€ä»¥å­˜å‚¨åœ¨å †ä¸Šï¼ˆå³å †å¯¹è±¡ï¼‰ã€‚</p><p>é‚£ä¹ˆå¯¹è±¡å°±åªèƒ½å­˜å‚¨åœ¨å †ä¸Šå—ï¼Ÿç›®å‰Objective-Cä¸æ”¯æŒç›´æ¥åœ¨æ ˆä¸Šåˆ›å»ºå¯¹è±¡ï¼ˆæ ˆå¯¹è±¡ï¼‰ï¼Œä½†å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼é—´æ¥åˆ›å»ºï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> &#123;</div><div class="line">    Class isa;</div><div class="line">&#125; fakeNSObject;</div><div class="line"></div><div class="line">fakeNSObject.isa = [<span class="built_in">NSObject</span> <span class="keyword">class</span>];</div><div class="line"></div><div class="line"><span class="built_in">NSObject</span> *obj = (__bridge <span class="built_in">NSObject</span> *)&amp;fakeNSObject;</div><div class="line"></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [obj description]);</div><div class="line"></div><div class="line"><span class="comment">// è¾“å‡º &lt;NSObject: 0x1066eadc8&gt; å¾—çŸ¥å­˜æ”¾äºæ ˆä¸­</span></div></pre></td></tr></table></figure></p><p>æ‰€ä»¥æ ˆå¯¹è±¡ä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œé‚£ä¹ˆå°±å›åˆ°äº†å¼€å¤´çš„é—®é¢˜ï¼Œå¯¹è±¡ä¸ºä½•ä¸å­˜å‚¨åœ¨æ ˆä¸Šå‘¢ï¼Ÿ</p><h3 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h3><p>æ—¢ç„¶æœ‰äº†æ ˆå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒä¼šæœ‰å“ªäº›ä¼˜ç¼ºç‚¹å§ï¼š</p><h4 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><ul><li><p>åˆ›å»ºæ•ˆç‡ï¼šå› ä¸ºæ ˆæ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„æ•°æ®ç»“æ„ï¼Œç³»ç»Ÿä¼šåœ¨åº•å±‚å¯¹æ ˆæä¾›æ”¯æŒï¼šåˆ†é…ä¸“é—¨çš„å¯„å­˜å™¨å­˜æ”¾æ ˆçš„åœ°å€ï¼Œå‹æ ˆå‡ºæ ˆéƒ½æœ‰ä¸“é—¨çš„æŒ‡ä»¤æ‰§è¡Œã€‚ç›¸æ¯”åŠ¨æ€åˆ†é…çš„å †å¯¹è±¡ï¼Œæ ˆå¯¹è±¡å†…å­˜çš„ç”³è¯·ã€åˆ†é…æ•ˆç‡è¦é«˜å¾—å¤šã€‚</p></li><li><p>ç®¡ç†ç®€å•ã€å®‰å…¨ï¼šæ ˆå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç¡®å®šçš„ï¼Œå¯¹è±¡å‡ºæ ˆä»¥åå°±ä¼šè¢«é‡Šæ”¾ï¼Œä¸ä¼šå­˜åœ¨å†…å­˜æ³„æ¼ï¼Œä½†è¿™åŒæ—¶ä¹Ÿæ˜¯æ ˆå¯¹è±¡çš„æœ€å¤§ç¼ºç‚¹ã€‚æ¯ä¸ªçº¿ç¨‹çš„æ ˆç›¸äº’ç‹¬ç«‹ï¼Œæ‰€ä»¥æ ˆå¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚è€Œä¸€ä¸ªè¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹å…±æœ‰è¿™äº›å †ï¼Œæ‰€ä»¥å¯¹å †å¯¹è±¡çš„æ“ä½œè¦è€ƒè™‘åŒæ­¥å’Œäº’æ–¥çš„é—®é¢˜ã€‚</p></li></ul><h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ul><li><p>ç©ºé—´é™åˆ¶ï¼šå‰é¢è®²åˆ°æ ˆæ˜¯ä¸€å—è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œæ‰€ä»¥æ ˆçš„å®¹é‡å¤§å°æ˜¯ç³»ç»Ÿé¢„å…ˆè®¾å®šå¥½çš„ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">512 KB (secondary threads)</div><div class="line">8 MB (OS X main thread)</div><div class="line">1 MB (iOS main thread)</div></pre></td></tr></table></figure><p>å› æ­¤å¯¹è±¡å¦‚æœéƒ½åœ¨æ ˆä¸Šåˆ›å»ºä¸å¤ªç°å®ï¼Œè€Œå †åªè¦ç‰©ç†å†…å­˜ä¸å‘Šè­¦å¯ä»¥æ— é™åˆ¶ä½¿ç”¨ã€‚</p></li><li>ç”Ÿå‘½å‘¨æœŸä¸å¯æ§ï¼šObjective-Cå˜é‡æœ‰æ•ˆèŒƒå›´æ˜¯ç”± â€œ{}â€ åŒ…å«çš„å—æ¥å†³å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ ˆå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä»…é™äºå…¶æ‰€åœ¨çš„å—é‡Œï¼Œå‡ºäº†å—ç«‹é©¬ä¼šè¢«é‡Šæ”¾ã€‚ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºä»¥åæœ‰å¯èƒ½ä¼šé€šè¿‡æ–¹æ³•è°ƒç”¨ä¼ é€’åˆ°åˆ«çš„æ–¹æ³•ï¼Œå½“æ ˆå¯¹è±¡çš„åˆ›å»ºæ–¹æ³•è¿”å›æ—¶ï¼Œæ ˆå¯¹è±¡ä¼šè¢«ä¸€èµ· pop å‡ºæ ˆè€Œé‡Šæ”¾ï¼Œå¯¼è‡´å…¶æ²¡æ³•åœ¨åˆ«å¤„è¢«ç»§ç»­æŒæœ‰ã€‚æ­¤æ—¶ retain æ“ä½œä¼šå¤±æ•ˆï¼Œé™¤éç”¨ copy æ–¹æ³•åœ¨æƒ³æŒæœ‰è¯¥æ ˆå¯¹è±¡çš„åœ°æ–¹é‡æ–°æ‹·è´ä¸€ä»½å±äºè‡ªå·±çš„æ ˆå¯¹è±¡ã€‚å› æ­¤ï¼Œæ ˆå¯¹è±¡ä¼šç»™å¯¹è±¡çš„å†…å­˜ç®¡ç†é€ æˆç›¸å½“å¤§çš„éº»çƒ¦ã€‚</li></ul><p>é€šè¿‡è¿™å‡ ç‚¹æ¯”è¾ƒï¼Œä¸éš¾çœ‹å‡ºå¯¹è±¡å­˜å‚¨åœ¨å †ä¸­æ˜¯æœ‰é“ç†çš„~</p><h3 id="block"><a href="#block" class="headerlink" title="block"></a>block</h3><p>å…¶å®OCä¸­æ˜¯æœ‰æ ˆå¯¹è±¡çš„ï¼Œé‚£å°±æ˜¯blockï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨blockæ—¶è¦æ³¨æ„å¾ˆå¤šç‚¹ï¼Œæ¯”å¦‚æƒ³æŒæœ‰ä¸€ä¸ªblockè¦ç”¨<code>copy</code>å°†blockä»æ ˆæ‹·è´åˆ°å †ä¸Šã€‚</p><p>å‰é¢æåˆ°æ ˆå¯¹è±¡çš„æœ‰æ•ˆåŒºåŸŸä»…é™äºå…¶æ‰€åœ¨çš„å—å†…ï¼Œæ‰€ä»¥åœ¨MRCç¯å¢ƒä¸‹ï¼Œä¸‹é¢ä»£ç ä¼šæœ‰é—®é¢˜ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^BasicBlock)(<span class="keyword">void</span>);</div><div class="line"></div><div class="line"><span class="keyword">void</span> someFunction() &#123;</div><div class="line">    BasicBlock block;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(condition) &#123;</div><div class="line">        block = ^ &#123; ... &#125;;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        block = ^ &#123; ... &#125;;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    block();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// æ­£ç¡®å†™æ³•</span></div><div class="line"><span class="keyword">void</span> someFunction() &#123; </div><div class="line">    BasicBlock block; </div><div class="line">    <span class="keyword">if</span>(condition) &#123; </div><div class="line">        block = Block_copy(^ &#123; ... &#125;); </div><div class="line">    &#125; <span class="keyword">else</span> &#123; </div><div class="line">        block = Block_copy(^ &#123; ... &#125;); </div><div class="line">    &#125; </div><div class="line">    </div><div class="line">    block();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><strong>å› ä¸ºARCç¯å¢ƒä¸‹ï¼Œä¸€æ—¦Blockèµ‹å€¼å°±ä¼šè§¦å‘copyï¼Œ<strong>blockå°±ä¼šcopyåˆ°å †ä¸Šï¼Œè¿™ç§æƒ…å†µæ˜¯`</strong>NSMallocBlock<code>ã€‚ARCç¯å¢ƒä¸‹ä¹Ÿæ˜¯å­˜åœ¨</code><strong>NSStackBlock`çš„æ—¶å€™ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œ</strong>blockå°±åœ¨æ ˆä¸Šã€‚</strong></p><p><strong>MRCç¯å¢ƒä¸‹ï¼Œåªæœ‰copyï¼Œ<strong>blockæ‰ä¼šè¢«å¤åˆ¶åˆ°å †ä¸Šï¼Œå¦åˆ™ï¼Œ</strong>blockä¸€ç›´éƒ½åœ¨æ ˆä¸Šï¼Œæ˜¯<code>__NSStackBlock</code>ã€‚</strong>è¯¦è§<a href="https://halfrost.com/ios_block/" target="_blank" rel="external">æ·±å…¥ç ”ç©¶ Block æ•è·å¤–éƒ¨å˜é‡å’Œ __block å®ç°åŸç†</a>ã€‚</p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://www.mikeash.com/pyblog/friday-qa-2010-01-15-stack-and-heap-objects-in-objective-c.html" target="_blank" rel="external">Stack and Heap Objects in Objective-C</a></p><p><a href="https://www.cnblogs.com/aibangxiansheng/p/5961830.html" target="_blank" rel="external">iOSå¼€å‘ä¸­çš„å†…å­˜åˆ†é…ï¼ˆå †å’Œæ ˆï¼‰</a></p><p><a href="http://www.ruanyifeng.com/blog/2013/11/stack.html" target="_blank" rel="external">Stackçš„ä¸‰ç§å«ä¹‰</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘åœ¨ä¸€æ¬¡ç»„å†…è®¨è®ºæ—¶ï¼Œå¤§å®¶è¢«ä¸€ä¸ªå¾ˆåŸºç¡€çš„é—®é¢˜éš¾ä½äº†ï¼Œå°±æ˜¯OCå¯¹è±¡ä¸ºä»€ä¹ˆå­˜å‚¨åœ¨å †ä¸Šï¼Ÿå­˜åœ¨æ ˆä¸Šä¼šæ€ä¹ˆæ ·ï¼Ÿå¤§å®¶ç»™çš„ç­”æ¡ˆéƒ½æ¨¡æ£±ä¸¤å¯ï¼Œçœ‹æ¥åŸºç¡€çŸ¥è¯†è¿˜æ˜¯ä¸æ‰å®å•Šâ€¦è¿™ç¯‡æ–‡ç« å°±æ¥ç®€å•æ€»ç»“ä¸€ä¸‹å †ä¸æ ˆã€‚&lt;/p&gt;
&lt;h2 id=&quot;å †ä¸æ ˆæ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#å †ä¸æ ˆæ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;å †ä¸æ ˆæ¦‚å¿µ&quot;&gt;&lt;/a&gt;å †ä¸æ ˆæ¦‚å¿µ&lt;/h2&gt;&lt;p&gt;ä¸¤è€…éƒ½æ˜¯è¿›ç¨‹ä¸­çš„ä¸€æ®µå†…å­˜åŒºåŸŸï¼Œå…ˆæ¥çœ‹ä¸‹åŸºæœ¬æ¦‚å¿µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å †ï¼ˆheapï¼‰ï¼šå †æ˜¯å‘é«˜åœ°å€æ‰©å±•çš„æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œå †åˆ†å…¨å±€å †å’Œå±€éƒ¨å †ã€‚å…¨å±€å †å°±æ˜¯æ‰€æœ‰æ²¡æœ‰åˆ†é…çš„ç©ºé—´ï¼Œå±€éƒ¨å †å°±æ˜¯ç”¨æˆ·åˆ†é…çš„ç©ºé—´ã€‚å®ƒç”±&lt;strong&gt;ç¨‹åºå‘˜&lt;/strong&gt;åˆ†é…å’Œé‡Šæ”¾ï¼Œç”¨äºå­˜æ”¾è¿›ç¨‹è¿è¡Œä¸­è¢«åŠ¨æ€åˆ†é…çš„å†…å­˜æ®µï¼Œå®ƒå¤§å°å¹¶ä¸å›ºå®šï¼Œå¯åŠ¨æ€æ‰©å¼ æˆ–ç¼©å‡ã€‚å½“è¿›ç¨‹è°ƒç”¨allocç­‰å‡½æ•°åˆ†é…å†…å­˜æ—¶ï¼Œæ–°åˆ†é…çš„å†…å­˜å°±è¢«åŠ¨æ€æ·»åŠ åˆ°å †ä¸Šï¼ˆå †è¢«æ‰©å¼ ï¼‰ï¼›å½“åˆ©ç”¨realseé‡Šæ”¾å†…å­˜æ—¶ï¼Œè¢«é‡Šæ”¾çš„å†…å­˜ä»å †ä¸­è¢«å‰”é™¤ï¼ˆå †è¢«ç¼©å‡ï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨iOSåŸºæœ¬éƒ½ä½¿ç”¨ARCæ¥ç®¡ç†å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ç”¨æˆ‘ä»¬ç¨‹åºå‘˜æ¥ç®¡ç†ï¼Œä½†æ˜¯æˆ‘ä»¬è¦çŸ¥é“è¿™ä¸ªå¯¹è±¡å­˜å‚¨çš„ä½ç½®ã€‚
    
    </summary>
    
    
      <category term="å†…å­˜" scheme="http://wonkeyz.com/tags/%E5%86%85%E5%AD%98/"/>
    
  </entry>
  
  <entry>
    <title>GCDçš„ä¸€äº›å‘</title>
    <link href="http://wonkeyz.com/2017/08/05/pit-of-GCD/"/>
    <id>http://wonkeyz.com/2017/08/05/pit-of-GCD/</id>
    <published>2017-08-05T10:02:59.000Z</published>
    <updated>2017-12-20T03:15:59.400Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å‘ä¸­æˆ‘ä»¬ç”¨åˆ°æœ€å¤šçš„å®ç°å¤šçº¿ç¨‹æ–¹å¼å°±æ˜¯GCDäº†ï¼Œç”¨å¤šäº†é‡åˆ°çš„å‘ä¹Ÿå°±å¤šï¼Œä¸‹é¢æˆ‘æ¥æ€»ç»“ä¸€äº›ä½¿ç”¨GCDæ—¶å¯èƒ½é‡åˆ°çš„å‘å’Œæ³¨æ„ç‚¹ï¼Œä»¥é˜²ä¸‡ä¸€ã€‚</p><h2 id="GCDä¸AutoreleasePool"><a href="#GCDä¸AutoreleasePool" class="headerlink" title="GCDä¸AutoreleasePool"></a>GCDä¸AutoreleasePool</h2><p>æˆ‘ä»¬çŸ¥é“åœ¨ä½¿ç”¨<code>NSThread</code>æ—¶ï¼Œéœ€è¦åœ¨çº¿ç¨‹è°ƒåº¦æ–¹æ³•ä¸­æ‰‹åŠ¨æ·»åŠ <code>AutoreleasePool</code>ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œé‚£ä¹ˆGCDéœ€è¦å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸ï¼Œå› ä¸ºåœ¨ä¸»çº¿ç¨‹å’ŒGCDä¸­çš„çº¿ç¨‹ï¼Œéƒ½é»˜è®¤æ‹¥æœ‰è‡ªåŠ¨é‡Šæ”¾æ± ã€‚æ¯æ¬¡æ‰§è¡Œäº‹ä»¶å¾ªç¯æ—¶ï¼Œå°±ä¼šå°†å…¶æ¸…ç©ºã€‚</p><a id="more"></a><h2 id="dispatch-once-tå¿…é¡»æ˜¯å…¨å±€æˆ–staticå˜é‡"><a href="#dispatch-once-tå¿…é¡»æ˜¯å…¨å±€æˆ–staticå˜é‡" class="headerlink" title="dispatch_once_tå¿…é¡»æ˜¯å…¨å±€æˆ–staticå˜é‡"></a>dispatch_once_tå¿…é¡»æ˜¯å…¨å±€æˆ–staticå˜é‡</h2><p>åœ¨å•ä¾‹ä¸­æˆ‘ä»¬ä¼šç”¨åˆ°<code>dispatch_once_t</code>ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡Xcodeè‡ªå¸¦çš„snippetæ•²å‡ºæ¥çš„ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">    ...</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯<code>static</code>å…³é”®å­—ï¼Œå®ƒç¡®ä¿äº†<code>dispatch_once_t</code>åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä»è€Œä½¿blockåªæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥å¦‚æœå“ªå¤©è‡ªå·±æ‰‹æ•²çš„æ—¶å€™åˆ«å¿˜äº†å®ƒã€‚</p><p>å°½é‡å°‘ç”¨<code>dispatch_once</code>ï¼Œå°±åƒå°½é‡å°‘ç”¨NSObjectçš„ç±»æ–¹æ³•<code>initialize()</code>å’Œ<code>(void)load</code>ï¼Œå®ƒä¼šå¸¦æ¥éš¾ä»¥æ’æŸ¥çš„bugã€‚</p><h2 id="dispatch-time-t"><a href="#dispatch-time-t" class="headerlink" title="dispatch_time_t"></a>dispatch_time_t</h2><p>åœ¨åˆ›å»º<code>dispatch_after</code>åŠ<code>dispatch_timer</code>æ—¶ä¼šç”¨åˆ°<code>dispatch_time(dispatch_time_t when, int64_t delta);</code>ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹ï¼Œä¸€èˆ¬ç”¨<code>DISPATCH_TIME_NOW</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ—¶é—´é—´éš”ï¼Œç³»ç»Ÿç»™äº†ä»¥ä¸‹å‡ ç§å¸¸é‡ï¼Œæ³¨æ„å•ä½å‡æ˜¯çº³ç§’ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ¯ç§’æœ‰å¤šå°‘çº³ç§’</span></div><div class="line"><span class="meta">#define NSEC_PER_SEC 1000000000ull</span></div><div class="line"><span class="comment">// æ¯æ¯«ç§’æœ‰å¤šå°‘çº³ç§’</span></div><div class="line"><span class="meta">#define NSEC_PER_MSEC 1000000ull</span></div><div class="line"><span class="comment">// æ¯ç§’æœ‰å¤šå°‘å¾®ç§’</span></div><div class="line"><span class="meta">#define USEC_PER_SEC 1000000ull</span></div><div class="line"><span class="comment">// æ¯å¾®ç§’æœ‰å¤šå°‘çº³ç§’</span></div><div class="line"><span class="meta">#define NSEC_PER_USEC 1000ull</span></div></pre></td></tr></table></figure></p><p>æ‰€ä»¥åˆ†åˆ«ç”¨å®ƒä»¬æ¥è¡¨ç¤º1ç§’è¿™æ ·å†™ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span></div><div class="line"><span class="built_in">NSEC_PER_MSEC</span> * <span class="built_in">NSEC_PER_USEC</span></div><div class="line">USEC_PER_SEC * <span class="built_in">NSEC_PER_USEC</span></div></pre></td></tr></table></figure></p><h2 id="dispatch-source-t"><a href="#dispatch-source-t" class="headerlink" title="dispatch_source_t"></a>dispatch_source_t</h2><p>å®˜æ–¹ç»™å‡ºçš„åˆ›å»º<code>dispatch_source_t</code>çš„ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">dispatch_source_t CreateDispatchTimer(uint64_t interval,</div><div class="line">              uint64_t leeway,</div><div class="line">              <span class="built_in">dispatch_queue_t</span> queue,</div><div class="line">              dispatch_block_t block)</div><div class="line">&#123;</div><div class="line">   dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER,</div><div class="line">                                                     <span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line">   <span class="keyword">if</span> (timer)</div><div class="line">   &#123;</div><div class="line">      dispatch_source_set_timer(timer, dispatch_walltime(<span class="literal">NULL</span>, <span class="number">0</span>), interval, leeway);</div><div class="line">      dispatch_source_set_event_handler(timer, block);</div><div class="line">      dispatch_resume(timer);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> timer;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ul><li><code>dispatch_source_t</code>æ˜¯é—´éš”å®šæ—¶å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯éš”ä¸€æ®µæ—¶é—´é—´éš”å®šæ—¶å™¨å°±ä¼šè§¦å‘ã€‚åœ¨<code>NSTimer</code>ä¸­è¦åšåˆ°åŒæ ·çš„æ•ˆæœéœ€è¦æ‰‹åŠ¨æŠŠ<code>repeats</code>è®¾ç½®ä¸º<code>YES</code>ã€‚</li><li><code>dispatch_source_set_timer</code>ä¸­ç¬¬äºŒä¸ªå‚æ•°ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨<code>dispatch_time</code>æˆ–è€…<code>DISPATCH_TIME_NOW</code>æ—¶ï¼Œç³»ç»Ÿä¼šä½¿ç”¨é»˜è®¤æ—¶é’Ÿæ¥è¿›è¡Œè®¡æ—¶ã€‚ç„¶è€Œå½“ç³»ç»Ÿä¼‘çœ çš„æ—¶å€™ï¼Œé»˜è®¤æ—¶é’Ÿæ˜¯ä¸èµ°çš„ï¼Œä¹Ÿå°±ä¼šå¯¼è‡´è®¡æ—¶å™¨åœæ­¢ã€‚ä½¿ç”¨<code>dispatch_walltime</code>å¯ä»¥è®©è®¡æ—¶å™¨æŒ‰ç…§çœŸå®æ—¶é—´é—´éš”è¿›è¡Œè®¡æ—¶ã€‚</li><li><code>dispatch_source_set_timer</code>çš„ç¬¬å››ä¸ªå‚æ•°<code>leeway</code>æŒ‡çš„æ˜¯ä¸€ä¸ªæœŸæœ›çš„å®¹å¿æ—¶é—´ï¼Œå°†å®ƒè®¾ç½®ä¸º 1 ç§’ï¼Œæ„å‘³ç€ç³»ç»Ÿæœ‰å¯èƒ½åœ¨å®šæ—¶å™¨æ—¶é—´åˆ°è¾¾çš„å‰ 1 ç§’æˆ–è€…å 1 ç§’æ‰çœŸæ­£è§¦å‘å®šæ—¶å™¨ã€‚åœ¨è°ƒç”¨æ—¶æ¨èè®¾ç½®ä¸€ä¸ªåˆç†çš„<code>leeway</code>å€¼ã€‚éœ€è¦æ³¨æ„ï¼Œå°±ç®—æŒ‡å®š<code>leeway</code>å€¼ä¸º 0ï¼Œç³»ç»Ÿä¹Ÿæ— æ³•ä¿è¯å®Œå…¨ç²¾ç¡®çš„è§¦å‘æ—¶é—´ï¼Œåªæ˜¯ä¼šå°½å¯èƒ½æ»¡è¶³è¿™ä¸ªéœ€æ±‚ã€‚</li><li>event handler blockä¸­çš„ä»£ç ä¼šåœ¨æŒ‡å®šçš„queueä¸­æ‰§è¡Œã€‚å½“queueæ˜¯åå°çº¿ç¨‹çš„æ—¶å€™ï¼Œ<code>dispatch_source_t</code>ç›¸æ¯”<code>NSTimer</code>å°±å¥½æ“ä½œä¸€äº›äº†ã€‚å› ä¸º<code>NSTimer</code>æ˜¯éœ€è¦<code>Runloop</code>æ”¯æŒçš„ï¼Œå¦‚æœè¦åœ¨åå°queueä¸­ä½¿ç”¨ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨æ·»åŠ Runloopã€‚</li><li><code>dispatch_source_set_event_handler</code>è¿™ä¸ªå‡½æ•°åœ¨æ‰§è¡Œå®Œä¹‹åï¼Œblockä¼šç«‹é©¬æ‰§è¡Œä¸€éï¼Œåé¢éš”ä¸€å®šæ—¶é—´é—´éš”å†æ‰§è¡Œä¸€æ¬¡ã€‚è€Œ <code>NSTimer</code>ç¬¬ä¸€æ¬¡æ‰§è¡Œæ˜¯åˆ°è®¡æ—¶å™¨è§¦å‘ä¹‹åã€‚è¿™ä¹Ÿæ˜¯å’Œ<code>NSTimer</code>ä¹‹é—´çš„ä¸€ä¸ªæ˜¾è‘—åŒºåˆ«ã€‚</li></ul><h3 id="åœæ­¢timer"><a href="#åœæ­¢timer" class="headerlink" title="åœæ­¢timer"></a>åœæ­¢timer</h3><p>åœæ­¢<code>dispatch_source_t</code>æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯ä½¿ç”¨<code>dispatch_suspend</code>ï¼Œå¦å¤–ä¸€ç§æ˜¯ä½¿ç”¨<code>dispatch_source_cancel</code>ã€‚</p><p><code>dispatch_suspend</code>ä¸¥æ ¼ä¸Šåªæ˜¯æŠŠtimeræš‚æ—¶æŒ‚èµ·ï¼Œå®ƒå’Œ<code>dispatch_resume</code>æ˜¯ä¸€ä¸ªå¹³è¡¡è°ƒç”¨ï¼Œ<strong>ä¸¤è€…åˆ†åˆ«ä¼šå‡å°‘å’Œå¢åŠ dispatchå¯¹è±¡çš„æŒ‚èµ·è®¡æ•°ã€‚å½“è¿™ä¸ªè®¡æ•°å¤§äº 0 çš„æ—¶å€™ï¼Œtimerå°±ä¼šæ‰§è¡Œã€‚åœ¨æŒ‚èµ·æœŸé—´ï¼Œäº§ç”Ÿçš„äº‹ä»¶ä¼šç§¯ç´¯èµ·æ¥ï¼Œç­‰åˆ°resumeçš„æ—¶å€™ä¼šèåˆä¸ºä¸€ä¸ªäº‹ä»¶å‘é€</strong>ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdispatch sourceå¹¶æ²¡æœ‰æä¾›ç”¨äºæ£€æµ‹sourceæœ¬èº«çš„æŒ‚èµ·è®¡æ•°çš„ APIï¼Œä¹Ÿå°±æ˜¯è¯´å¤–éƒ¨ä¸èƒ½å¾—çŸ¥ä¸€ä¸ªsourceå½“å‰æ˜¯ä¸æ˜¯æŒ‚èµ·çŠ¶æ€ï¼Œåœ¨è®¾è®¡ä»£ç é€»è¾‘æ—¶éœ€è¦è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚</p><p><code>dispatch_source_cancel</code>åˆ™æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„å–æ¶ˆtimerã€‚è¢«å–æ¶ˆä¹‹åå¦‚æœæƒ³å†æ¬¡æ‰§è¡Œtimerï¼Œåªèƒ½é‡æ–°åˆ›å»ºæ–°çš„timerã€‚è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºå¯¹<code>NSTimer</code>æ‰§è¡Œ<code>invalidate</code>ã€‚</p><p>å…³äºå–æ¶ˆtimerï¼Œå¦å¤–ä¸€ä¸ªå¾ˆé‡è¦çš„æ³¨æ„äº‹é¡¹ï¼Œ<code>dispatch_suspend</code>ä¹‹åçš„timerï¼Œæ˜¯ä¸èƒ½è¢«é‡Šæ”¾çš„ï¼ä¸‹é¢çš„ä»£ç ä¼šå¼•èµ·å´©æºƒï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)stopTimer &#123;</div><div class="line">    dispatch_suspend(_timer);</div><div class="line">    _timer = <span class="literal">nil</span>; <span class="comment">// EXC_BAD_INSTRUCTION å´©æºƒ</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>å› æ­¤ä½¿ç”¨<code>dispatch_suspend</code>æ—¶ï¼Œtimeræœ¬èº«çš„å®ä¾‹éœ€è¦ä¸€ç›´ä¿æŒã€‚ä½¿ç”¨<code>dispatch_source_cancel</code>åˆ™æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)stopTimer &#123;</div><div class="line">    dispatch_source_cancel(_timer);</div><div class="line">    _timer = <span class="literal">nil</span>; <span class="comment">// OK</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2 id="dispatch-after"><a href="#dispatch-after" class="headerlink" title="dispatch_after"></a>dispatch_after</h2><p>å…ˆæ¥çœ‹ä¸‹å®˜æ–¹å¯¹å®ƒçš„è¯´æ˜:<code>Schedule a block for execution on a given queue at a specified time</code>ï¼Œè¿™æ„å‘³ç€<code>dispatch_after</code>æ˜¯å°†block<strong>å»¶è¿Ÿæ·»åŠ </strong>åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸æ˜¯<strong>å»¶è¿Ÿæ‰§è¡Œ</strong>ã€‚ç¤ºä¾‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">dispatch_time_t delayTime3 = dispatch_time(DISPATCH_TIME_NOW, <span class="number">3</span>*<span class="built_in">NSEC_PER_SEC</span>);</div><div class="line">dispatch_time_t delayTime2 = dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span>*<span class="built_in">NSEC_PER_SEC</span>);</div><div class="line"><span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();</div><div class="line"></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"current task"</span>);</div><div class="line"></div><div class="line">dispatch_after(delayTime3, mainQueue, ^&#123;</div><div class="line">      <span class="built_in">NSLog</span>(<span class="string">@"3ç§’ä¹‹åæ·»åŠ åˆ°é˜Ÿåˆ—"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">dispatch_after(delayTime2, mainQueue, ^&#123;</div><div class="line">       <span class="built_in">NSLog</span>(<span class="string">@"2ç§’ä¹‹åæ·»åŠ åˆ°é˜Ÿåˆ—"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"next task"</span>);</div><div class="line"></div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">26.367321</span> GCDTest[<span class="number">10342</span>:<span class="number">171487</span>] current task</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">26.367583</span> GCDTest[<span class="number">10342</span>:<span class="number">171487</span>] next task</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">28.552447</span> GCDTest[<span class="number">10342</span>:<span class="number">171487</span>] <span class="number">2</span>ç§’ä¹‹åæ·»åŠ åˆ°é˜Ÿåˆ—</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">29.369393</span> GCDTest[<span class="number">10342</span>:<span class="number">171487</span>] <span class="number">3</span>ç§’ä¹‹åæ·»åŠ åˆ°é˜Ÿåˆ—</div></pre></td></tr></table></figure></p><p>ä»è¾“å‡ºä¸­å¯ä»¥çœ‹å‡ºæ˜¯å»¶è¿Ÿæ·»åŠ ï¼Œæ‰€ä»¥å¦‚æœä½ æƒ³è¦ç²¾ç¡®æ§åˆ¶æ‰§è¡Œé¡ºåºï¼Œé‚£ä¹ˆè¦æ…ç”¨<code>dispatch_after</code>å’¯~</p><h2 id="dispatch-suspendä¸dispatch-resume"><a href="#dispatch-suspendä¸dispatch-resume" class="headerlink" title="dispatch_suspendä¸dispatch_resume"></a>dispatch_suspendä¸dispatch_resume</h2><p>GCDæä¾›äº†æš‚åœ/æŒ‚èµ·(<code>dispatch_suspend</code>)ä¸æ¢å¤(<code>dispatch_resume</code>)é˜Ÿåˆ—ä¸Šçš„ä»»åŠ¡çš„åŠŸèƒ½ï¼ˆ<strong>ä¸æ”¯æŒå¯¹ç³»ç»Ÿé»˜è®¤åˆ›å»ºå…¨å±€é˜Ÿåˆ—ã€ä¸»é˜Ÿåˆ—çš„æ“ä½œ</strong>ï¼‰ã€‚<strong>ä½†è¿™é‡Œçš„æš‚åœå¹¶ä¸æ˜¯æŒ‡ç«‹åˆ»æš‚åœé˜Ÿåˆ—ä¸Šè¿è¡Œçš„blockï¼Œè€Œæ˜¯ç­‰å½“å‰è¿è¡Œçš„blockç»“æŸåï¼Œå†æš‚åœé˜Ÿåˆ—ï¼Œæ¢å¤åç»§ç»­æ‰§è¡Œ</strong>ï¼Œç¤ºä¾‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"me.test.gcd"</span>, DISPATCH_QUEUE_SERIAL);</div><div class="line"><span class="comment">//æäº¤ç¬¬ä¸€ä¸ªblockï¼Œå»¶æ—¶5ç§’æ‰“å°ã€‚</span></div><div class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"After 5 seconds..."</span>);</div><div class="line">&#125;);</div><div class="line"><span class="comment">//æäº¤ç¬¬äºŒä¸ªblockï¼Œä¹Ÿæ˜¯å»¶æ—¶5ç§’æ‰“å°</span></div><div class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"After 5 seconds again..."</span>);</div><div class="line">&#125;);</div><div class="line"><span class="comment">//å»¶æ—¶ä¸€ç§’</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"sleep 1 second..."</span>);</div><div class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];</div><div class="line"><span class="comment">//æŒ‚èµ·é˜Ÿåˆ—</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"suspend..."</span>);</div><div class="line">dispatch_suspend(queue);</div><div class="line"></div><div class="line"><span class="comment">//å»¶æ—¶10ç§’</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"sleep 10 second..."</span>);</div><div class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">10</span>];</div><div class="line"></div><div class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"test resume 1"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//æ¢å¤é˜Ÿåˆ—</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"resume..."</span>);</div><div class="line">dispatch_resume(queue);</div><div class="line"></div><div class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"test resume 2"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//è¾“å‡ºä¸ºï¼š</span></div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">13</span>:<span class="number">29</span>:<span class="number">39.067920</span> GCDTest[<span class="number">28453</span>:<span class="number">667453</span>] sleep <span class="number">1</span> second...</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">13</span>:<span class="number">29</span>:<span class="number">40.068305</span> GCDTest[<span class="number">28453</span>:<span class="number">667453</span>] suspend...</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">13</span>:<span class="number">29</span>:<span class="number">40.068544</span> GCDTest[<span class="number">28453</span>:<span class="number">667453</span>] sleep <span class="number">10</span> second...</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">13</span>:<span class="number">29</span>:<span class="number">44.073200</span> GCDTest[<span class="number">28453</span>:<span class="number">668668</span>] After <span class="number">5</span> seconds...</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">13</span>:<span class="number">29</span>:<span class="number">50.070099</span> GCDTest[<span class="number">28453</span>:<span class="number">667453</span>] resume...</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">13</span>:<span class="number">29</span>:<span class="number">55.071913</span> GCDTest[<span class="number">28453</span>:<span class="number">668668</span>] After <span class="number">5</span> seconds again...</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">13</span>:<span class="number">29</span>:<span class="number">55.072092</span> GCDTest[<span class="number">28453</span>:<span class="number">668668</span>] test resume <span class="number">1</span></div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">13</span>:<span class="number">29</span>:<span class="number">55.072246</span> GCDTest[<span class="number">28453</span>:<span class="number">668668</span>] test resume <span class="number">2</span></div></pre></td></tr></table></figure></p><p>æ‰€æœ‰ä½¿ç”¨<code>dispatch_suspend</code>æ—¶è¦æ³¨æ„å’¯~è¯¦è§<a href="http://blog.csdn.net/zhangyingeios/article/details/73250620" target="_blank" rel="external">dispatch_suspend ä¸ dispatch_resumeæ¢ç´¢</a>ã€‚</p><h2 id="dispatch-apply"><a href="#dispatch-apply" class="headerlink" title="dispatch_apply"></a>dispatch_apply</h2><p><code>dispatch_apply</code>åœ¨ç»™å®šçš„é˜Ÿåˆ—ä¸Šå¤šæ¬¡æ‰§è¡ŒæŸä¸€ä»»åŠ¡ï¼Œå®ƒä¸ä¼šç«‹åˆ»è¿”å›ï¼Œè€Œæ˜¯åœ¨æ‰§è¡Œå®Œblockä¸­çš„ä»»åŠ¡åæ‰ä¼šè¿”å›ï¼Œæ˜¯åŒæ­¥æ‰§è¡Œçš„å‡½æ•°ã€‚<strong>åœ¨ä¸»çº¿ç¨‹ç›´æ¥è°ƒç”¨ä¼šé˜»å¡ä¸»çº¿ç¨‹å»æ‰§è¡Œblockä¸­çš„ä»»åŠ¡</strong>ï¼Œä¸ºäº†ä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œä¸€èˆ¬æŠŠ<code>dispatch_apply</code>æ”¾åœ¨å¼‚æ­¥é˜Ÿåˆ—ä¸­è°ƒç”¨ï¼Œæ‰§è¡Œå®Œæˆåé€šçŸ¥ä¸»çº¿ç¨‹ã€‚ç¤ºä¾‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_queue_t</span> globalQueue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"current task"</span>);</div><div class="line"><span class="built_in">dispatch_async</span>(globalQueue, ^&#123;</div><div class="line">   <span class="built_in">dispatch_queue_t</span> applyQueue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">   <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ3--blockæ‰§è¡Œçš„æ¬¡æ•°</span></div><div class="line">   <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼ŒapplyQueue--blockä»»åŠ¡æäº¤åˆ°çš„é˜Ÿåˆ—</span></div><div class="line">   <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œblock--éœ€è¦é‡å¤æ‰§è¡Œçš„ä»»åŠ¡</span></div><div class="line">   dispatch_apply(<span class="number">3</span>, applyQueue, ^(size_t index) &#123;</div><div class="line">          <span class="built_in">NSLog</span>(<span class="string">@"current index %@"</span>,@(index));</div><div class="line">          sleep(<span class="number">1</span>);</div><div class="line">   &#125;);</div><div class="line">   <span class="built_in">NSLog</span>(<span class="string">@"dispatch_apply æ‰§è¡Œå®Œæˆ"</span>);</div><div class="line"></div><div class="line">   <span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();</div><div class="line">   <span class="built_in">dispatch_async</span>(mainQueue, ^&#123;</div><div class="line">          <span class="built_in">NSLog</span>(<span class="string">@"å›åˆ°ä¸»çº¿ç¨‹æ›´æ–°UI"</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"next task"</span>);</div><div class="line"></div><div class="line"><span class="comment">//è¾“å‡ºï¼š</span></div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">15.192467</span> GCDTest[<span class="number">32639</span>:<span class="number">763148</span>] current task</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">15.193226</span> GCDTest[<span class="number">32639</span>:<span class="number">763148</span>] next task</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">15.193245</span> GCDTest[<span class="number">32639</span>:<span class="number">763480</span>] current index <span class="number">0</span></div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">15.193252</span> GCDTest[<span class="number">32639</span>:<span class="number">763466</span>] current index <span class="number">1</span></div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">15.193261</span> GCDTest[<span class="number">32639</span>:<span class="number">763545</span>] current index <span class="number">2</span></div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">16.194556</span> GCDTest[<span class="number">32639</span>:<span class="number">763480</span>] dispatch_apply æ‰§è¡Œå®Œæˆ</div><div class="line"><span class="number">2017</span><span class="number">-08</span><span class="number">-05</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">16.194792</span> GCDTest[<span class="number">32639</span>:<span class="number">763148</span>] å›åˆ°ä¸»çº¿ç¨‹æ›´æ–°UI</div></pre></td></tr></table></figure></p><h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><p>æ­»é”ï¼šä¸¤ä¸ªï¼ˆå¤šä¸ªï¼‰çº¿ç¨‹éƒ½è¦ç­‰å¾…å¯¹æ–¹å®ŒæˆæŸä¸ªæ“ä½œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œè¿™æ—¶å°±ä¼šå‘ç”Ÿæ­»é”ã€‚<br>ä»¥ä¸‹å‡ ç§æƒ…å†µä¼šäº§ç”Ÿæ­»é”ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p><ul><li><p>ä¸»çº¿ç¨‹ä¸²è¡Œé˜Ÿåˆ—åŒæ­¥æ‰§è¡Œä»»åŠ¡ï¼Œåœ¨ä¸»çº¿ç¨‹è¿è¡Œæ—¶ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();</div><div class="line"><span class="built_in">dispatch_sync</span>(mainQueue,^&#123;</div><div class="line">  <span class="built_in">NSLog</span>(<span class="string">"MainQueue"</span>);            </div><div class="line">&#125;);</div></pre></td></tr></table></figure></li><li><p>è‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—åµŒå¥—æ‰§è¡ŒåŒæ­¥ä»»åŠ¡(å¹¶å‘é˜Ÿåˆ—ä¸ä¼šé€ æˆæ­»é”)ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"me.test.gcd"</span>, DISPATCH_QUEUE_SERIAL);</div><div class="line"><span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;   <span class="comment">//è¯¥ä»£ç æ®µåé¢çš„ä»£ç éƒ½ä¸ä¼šæ‰§è¡Œï¼Œç¨‹åºè¢«é”å®šåœ¨è¿™é‡Œ</span></div><div class="line">  <span class="built_in">NSLog</span>(<span class="string">@"ä¼šæ‰§è¡Œçš„ä»£ç "</span>);</div><div class="line">  <span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;</div><div class="line">      <span class="built_in">NSLog</span>(<span class="string">@"ä»£ç ä¸æ‰§è¡Œ"</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></li><li><p>åµŒå¥—ä½¿ç”¨<code>dispatch_apply</code>ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"me.test.gcd"</span>, DISPATCH_QUEUE_SERIAL);</div><div class="line">dispatch_apply(<span class="number">3</span>, queue, ^(size_t i) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"current index %@"</span>,@(i));</div><div class="line">dispatch_apply(<span class="number">3</span>, queue, ^(size_t j) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"current index %@"</span>,@(j));</div><div class="line">&#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//åªä¼šæ‰§è¡Œä¸€æ¬¡current index 1</span></div></pre></td></tr></table></figure></li></ul><h2 id="dispatch-group"><a href="#dispatch-group" class="headerlink" title="dispatch_group"></a>dispatch_group</h2><p>å½“æˆ‘ä»¬éœ€è¦åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œåœ¨æ‰€æœ‰ä»»åŠ¡å®Œæˆåæ±‡æ€»ç»“æœæ—¶å¯ä»¥ä½¿ç”¨<code>dispatch_group</code>(é˜Ÿåˆ—ç»„)ï¼Œå…ˆçœ‹ä¸‹åŸºæœ¬ç”¨æ³•ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</div><div class="line"><span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();</div><div class="line">dispatch_group_t group = dispatch_group_create();</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"current task"</span>);</div><div class="line">dispatch_group_async(group, queue, ^&#123;</div><div class="line">      <span class="built_in">NSLog</span>(<span class="string">@"å¹¶è¡Œä»»åŠ¡1"</span>);</div><div class="line">&#125;);</div><div class="line">dispatch_group_async(group, queue, ^&#123;</div><div class="line">      <span class="built_in">NSLog</span>(<span class="string">@"å¹¶è¡Œä»»åŠ¡2"</span>);</div><div class="line">&#125;);</div><div class="line">dispatch_group_notify(groupQueue, mainQueue, ^&#123;</div><div class="line">      <span class="built_in">NSLog</span>(<span class="string">@"groupä¸­çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆ,å›åˆ°ä¸»çº¿ç¨‹æ›´æ–°UI"</span>);</div><div class="line">&#125;);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"next task"</span>);</div></pre></td></tr></table></figure></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>dispatch_group_wait</code>ç»™gorupè®¾ç½®è¶…æ—¶æ—¶é™ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯<code>dispatch_group_wait</code>æ˜¯åŒæ­¥çš„æ‰€ä»¥ä¸èƒ½æ”¾åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå¦åˆ™ä¼šå‘ç”Ÿé˜»å¡ã€‚</p><p>è¿˜æœ‰ä¸€ç§æ·»åŠ ä»»åŠ¡çš„æ–¹å¼æ˜¯é€šè¿‡<code>dispatch_group_enter</code>å’Œ<code>dispatch_group_leave</code>ï¼Œå®ƒä»¬å¿…é¡»æˆå¯¹å‡ºç°ï¼Œé€šå¸¸åœ¨æ— æ³•è®¿é—®åˆ°é˜Ÿåˆ—å˜é‡æ—¶ä½¿ç”¨ï¼Œå¦‚ä½¿ç”¨AFNetworkingæ·»åŠ å¤šä¸ªå¼‚æ­¥ä»»åŠ¡æ—¶ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">AFHTTPRequestOperationManager *manager = [AFHTTPRequestOperationManager manager];</div><div class="line"></div><div class="line">dispatch_group_t group = dispatch_group_create();  </div><div class="line"><span class="comment">//Enter group</span></div><div class="line">dispatch_group_enter(group);</div><div class="line">[manager GET:<span class="string">@"http://www.baidu.com"</span> parameters:<span class="literal">nil</span> success:^(AFHTTPRequestOperation *operation, <span class="keyword">id</span> responseObject) &#123;</div><div class="line">    <span class="comment">//Deal with result...</span></div><div class="line">    <span class="comment">//Leave group</span></div><div class="line">    dispatch_group_leave(group);</div><div class="line">&#125;    failure:^(AFHTTPRequestOperation *operation, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">    <span class="comment">//Deal with error...</span></div><div class="line">    <span class="comment">//Leave group</span></div><div class="line">    dispatch_group_leave(group);</div><div class="line">&#125;];</div><div class="line"><span class="comment">//More request...</span></div></pre></td></tr></table></figure></p><p>æ›´å¤šè§£è¯»è¯·è§ï¼š<a href="http://blog.csdn.net/u011103194/article/details/50248807" target="_blank" rel="external">dispatch_group_enterçš„å­¦ä¹ </a>ã€<a href="http://www.jianshu.com/p/228403206664" target="_blank" rel="external">ä½¿ç”¨dispatch_groupæ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥</a>ã€‚</p><h2 id="dispatch-semaphore-t"><a href="#dispatch-semaphore-t" class="headerlink" title="dispatch_semaphore_t"></a>dispatch_semaphore_t</h2><p>ç›¸å…³æ–¹æ³•ï¼š</p><ul><li><code>dispatch_semaphore_create(long value)</code>ï¼šæ–¹æ³•æ¥æ”¶ä¸€ä¸ªlongç±»å‹çš„å‚æ•°, è¿”å›ä¸€ä¸ª<code>dispatch_semaphore_t</code>ç±»å‹çš„ä¿¡å·é‡ï¼Œå€¼ä¸ºä¼ å…¥çš„å‚æ•°ï¼›</li><li><code>dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout)</code>ï¼šæ¥æ”¶ä¸€ä¸ªä¿¡å·å’Œæ—¶é—´å€¼ï¼Œè‹¥ä¿¡å·çš„ä¿¡å·é‡ä¸º0ï¼Œåˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ä¿¡å·é‡å¤§äº0æˆ–è€…ç»è¿‡è¾“å…¥çš„æ—¶é—´å€¼ï¼›è‹¥ä¿¡å·é‡å¤§äº0ï¼Œåˆ™ä¼šä½¿ä¿¡å·é‡å‡1å¹¶è¿”å›ï¼Œç¨‹åºç»§ç»­ä½ä¸‹æ‰§è¡Œï¼›</li><li><code>dispatch_semaphore_signal(dispatch_semaphore_t dsema)</code>ï¼šä½¿ä¿¡å·é‡åŠ 1å¹¶è¿”å›ã€‚</li></ul><p>ä½¿ç”¨ä¿¡å·é‡å¯ä»¥åšåˆ°çº¿ç¨‹åŒæ­¥ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</div><div class="line">        </div><div class="line">__block <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">    i = <span class="number">100</span>;</div><div class="line">    dispatch_semaphore_signal(semaphore);</div><div class="line">&#125;);</div><div class="line">    </div><div class="line">dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"i = %zd"</span>, i);</div><div class="line"></div><div class="line"><span class="comment">// è¾“å‡ºä¸ºi = 0</span></div></pre></td></tr></table></figure></p><p>å› ä¸ºæ˜¯å°†blockå¼‚æ­¥æ·»åŠ åˆ°ä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—é‡Œé¢ï¼Œæ‰€ä»¥ç¨‹åºåœ¨ä¸»çº¿ç¨‹è·ƒè¿‡blockç›´æ¥åˆ°<code>dispatch_semaphore_wait</code>è¿™ä¸€è¡Œï¼Œå› ä¸ºsemaphoreä¿¡å·é‡ä¸º0ï¼Œæ—¶é—´å€¼ä¸ºDISPATCH_TIME_FOREVERï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°blockåœ¨å­çº¿ç¨‹æ‰§è¡Œåˆ°<code>dispatch_semaphore_signal</code>ï¼Œä½¿ä¿¡å·é‡+1ï¼Œæ­¤æ—¶semaphoreä¿¡å·é‡ä¸º1äº†ï¼Œæ‰€ä»¥ç¨‹åºç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚è¿™å°±ä¿è¯äº†çº¿ç¨‹é—´åŒæ­¥äº†ã€‚</p><p>è¿˜å¯ä»¥åšçº¿ç¨‹é”ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">1</span>);</div><div class="line">        </div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line">     <span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">          <span class="comment">// ç›¸å½“äºåŠ é”</span></div><div class="line">          dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">          <span class="built_in">NSLog</span>(<span class="string">@"i = %zd semaphore = %@"</span>, i, semaphore);</div><div class="line">          <span class="comment">// ç›¸å½“äºè§£é”</span></div><div class="line">          dispatch_semaphore_signal(semaphore);</div><div class="line">      &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>å½“çº¿ç¨‹1æ‰§è¡Œåˆ°<code>dispatch_semaphore_wait</code>è¿™ä¸€è¡Œæ—¶ï¼Œsemaphoreçš„ä¿¡å·é‡ä¸º1ï¼Œæ‰€ä»¥ä½¿ä¿¡å·é‡-1å˜ä¸º0ï¼Œå¹¶ä¸”çº¿ç¨‹1ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼›å¦‚æœå½“åœ¨çº¿ç¨‹1 NSLogè¿™ä¸€è¡Œä»£ç è¿˜æ²¡æ‰§è¡Œå®Œçš„æ—¶å€™ï¼Œåˆæœ‰çº¿ç¨‹2æ¥è®¿é—®ï¼Œæ‰§è¡Œ<code>dispatch_semaphore_wait</code>æ—¶ç”±äºæ­¤æ—¶ä¿¡å·é‡ä¸º0ï¼Œä¸”æ—¶é—´ä¸º<code>DISPATCH_TIME_FOREVER</code>ï¼Œæ‰€ä»¥ä¼šä¸€ç›´é˜»å¡çº¿ç¨‹2ï¼ˆæ­¤æ—¶çº¿ç¨‹2å¤„äºç­‰å¾…çŠ¶æ€ï¼‰ï¼Œç›´åˆ°çº¿ç¨‹1æ‰§è¡Œå®ŒNSLogå¹¶æ‰§è¡Œå®Œ<code>dispatch_semaphore_signal</code>ä½¿ä¿¡å·é‡ä¸º1åï¼Œçº¿ç¨‹2æ‰èƒ½è§£é™¤é˜»å¡ç»§ç»­ä½ä¸‹æ‰§è¡Œã€‚è¿™æ ·å°±èµ·åˆ°äº†çº¿ç¨‹é”çš„ä½œç”¨ã€‚</p><h2 id="dispatch-barrier-async"><a href="#dispatch-barrier-async" class="headerlink" title="dispatch_barrier_async"></a>dispatch_barrier_async</h2><p><code>dispatch_barrier_async</code>çš„ä½œç”¨å°±æ˜¯å‘æŸä¸ªé˜Ÿåˆ—æ’å…¥ä¸€ä¸ªblockï¼Œå½“ç›®å‰æ­£åœ¨æ‰§è¡Œçš„blockè¿è¡Œå®Œæˆåï¼Œé˜»å¡è¿™ä¸ªblockåé¢æ·»åŠ çš„blockï¼Œåªè¿è¡Œè¿™ä¸ªblockç›´åˆ°å®Œæˆï¼Œç„¶åå†ç»§ç»­åç»­çš„ä»»åŠ¡ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š<code>dispatchbarrier\(a)sync</code>åªåœ¨è‡ªå·±åˆ›å»ºçš„å¹¶å‘é˜Ÿåˆ—ä¸Šæœ‰æ•ˆï¼Œåœ¨å…¨å±€(Global)å¹¶å‘é˜Ÿåˆ—ã€ä¸²è¡Œé˜Ÿåˆ—ä¸Šï¼Œæ•ˆæœè·Ÿdispatch_(a)syncæ•ˆæœä¸€æ ·ï¼Œæ‰€ä»¥è¦å°å¿ƒåˆ«æ­»é”ï¼</p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://www.dullgrass.com/2015/11/19/iOS%E4%B8%ADGCD%E7%9A%84%E4%BD%BF%E7%94%A8%E5%B0%8F%E7%BB%93/" target="_blank" rel="external">iOSä¸­GCDçš„ä½¿ç”¨å°ç»“</a><br><a href="http://tutuge.me/2015/04/03/something-about-gcd/" target="_blank" rel="external">GCDä½¿ç”¨ç»éªŒä¸æŠ€å·§æµ…è°ˆ</a><br><a href="https://knightsj.github.io/2017/01/13/%E6%B5%85%E6%98%BE%E6%98%93%E6%87%82%E8%AE%B2%E8%A7%A3%E7%9A%84iOS%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%8A%80%E6%9C%AF-GCD/" target="_blank" rel="external">æµ…æ˜¾æ˜“æ‡‚è®²è§£iOSå¤šçº¿ç¨‹æŠ€æœ¯-GCD</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼€å‘ä¸­æˆ‘ä»¬ç”¨åˆ°æœ€å¤šçš„å®ç°å¤šçº¿ç¨‹æ–¹å¼å°±æ˜¯GCDäº†ï¼Œç”¨å¤šäº†é‡åˆ°çš„å‘ä¹Ÿå°±å¤šï¼Œä¸‹é¢æˆ‘æ¥æ€»ç»“ä¸€äº›ä½¿ç”¨GCDæ—¶å¯èƒ½é‡åˆ°çš„å‘å’Œæ³¨æ„ç‚¹ï¼Œä»¥é˜²ä¸‡ä¸€ã€‚&lt;/p&gt;
&lt;h2 id=&quot;GCDä¸AutoreleasePool&quot;&gt;&lt;a href=&quot;#GCDä¸AutoreleasePool&quot; class=&quot;headerlink&quot; title=&quot;GCDä¸AutoreleasePool&quot;&gt;&lt;/a&gt;GCDä¸AutoreleasePool&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬çŸ¥é“åœ¨ä½¿ç”¨&lt;code&gt;NSThread&lt;/code&gt;æ—¶ï¼Œéœ€è¦åœ¨çº¿ç¨‹è°ƒåº¦æ–¹æ³•ä¸­æ‰‹åŠ¨æ·»åŠ &lt;code&gt;AutoreleasePool&lt;/code&gt;ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œé‚£ä¹ˆGCDéœ€è¦å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸ï¼Œå› ä¸ºåœ¨ä¸»çº¿ç¨‹å’ŒGCDä¸­çš„çº¿ç¨‹ï¼Œéƒ½é»˜è®¤æ‹¥æœ‰è‡ªåŠ¨é‡Šæ”¾æ± ã€‚æ¯æ¬¡æ‰§è¡Œäº‹ä»¶å¾ªç¯æ—¶ï¼Œå°±ä¼šå°†å…¶æ¸…ç©ºã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="GCD" scheme="http://wonkeyz.com/tags/GCD/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨å¯¹è±¡deallocæ—¶åšä¸€äº›æ“ä½œ</title>
    <link href="http://wonkeyz.com/2017/07/28/Do-some-operation-with%20-object-dealloc/"/>
    <id>http://wonkeyz.com/2017/07/28/Do-some-operation-with -object-dealloc/</id>
    <published>2017-07-28T06:53:00.000Z</published>
    <updated>2017-10-19T07:14:06.505Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åšç›´æ’­é—´ä¼˜åŒ–æ—¶é‡åˆ°ä¸ªå¥‡è‘©éœ€æ±‚ï¼Œéœ€è¦åœ¨è¯„è®ºè¾“å…¥è§†å›¾é‡Šæ”¾æ—¶åšä¸€äº›æ“ä½œï¼Œå½“æ—¶æ²¡æƒ³å¤ªå¤šç›´æ¥åœ¨CommentViewå¤–éƒ¨å…¬å¼€ä¸€ä¸ªblockï¼Œç„¶ååœ¨CommentViewçš„<code>dealloc</code>æ–¹æ³•é‡Œè°ƒç”¨è¯¥blockï¼Œç®€å•ç²—æš´â€¦<a id="more"></a>äº‹åæƒ³äº†æƒ³èƒ½ä¸èƒ½å°è£…ä¸€ä¸ªé€šç”¨çš„æ–¹æ³•ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªé‡Šæ”¾æ—¶è°ƒç”¨çš„blockå‘¢ï¼Ÿç¬¬ä¸€æ—¶é—´æƒ³åˆ°ç”¨Method Swizzlingæ¥hookå¯¹è±¡çš„<code>dealloc</code>æ–¹æ³•ï¼Œé©¬ä¸Šé¢†æ‚Ÿåˆ°è¿™æ ·æœªå…ä¾µå…¥æ€§å¤ªå¼ºï¼Œæ—¥åä¹Ÿè®¸ä¼šå¯¼è‡´éš¾ä»¥æ’æŸ¥çš„bugï¼Œä»”ç»†æ€è€ƒåæƒ³åˆ°äº†ä¸€ä¸ªå·§å¦™çš„æ–¹æ³•ï¼Œé€šè¿‡Categoryç»™<code>NSObject</code>å…¬å¼€ä¸€ä¸ªæ·»åŠ blockçš„æ–¹æ³•ï¼Œåˆ©ç”¨runtimeçš„AssociatedObjectç»™å¯¹è±¡æ­é…ä¸€ä¸ªâ€˜â€˜å°ä¼™ä¼´â€™â€™ï¼Œåœ¨å¯¹è±¡é‡Šæ”¾æ—¶ï¼Œè¿™ä¸ªâ€˜â€˜å°ä¼™ä¼´â€™â€™è´Ÿè´£è°ƒç”¨blockï¼Œè¿™æ ·æ—¢åšåˆ°äº†ä¸å¯¹è±¡çš„å…±å­˜äº¡åˆç®€å•å¹²å‡€ï¼Œä¸Šä»£ç ~<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^DeallocBlock)(<span class="keyword">void</span>);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Associate</span>)</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">ç»™å¯¹è±¡æ·»åŠ é‡Šæ”¾æ—¶è°ƒç”¨çš„block</div><div class="line">*/</div><div class="line">- (<span class="keyword">void</span>)addDeallocBlock:(DeallocBlock)deallocBlock;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"NSObject+Associate.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Partner</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) DeallocBlock deallocBlock;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Partner</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc &#123;</div><div class="line">    <span class="keyword">if</span> (_deallocBlock) &#123;</div><div class="line">        _deallocBlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">void</span> *kPartnerArrayKey = &amp;kPartnerArrayKey;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Associate</span>)</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)addDeallocBlock:(DeallocBlock)deallocBlock &#123;</div><div class="line">    <span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="built_in">NSMutableArray</span> *partnerArray = objc_getAssociatedObject(<span class="keyword">self</span>, kPartnerArrayKey);</div><div class="line">        <span class="keyword">if</span> (!partnerArray) &#123;</div><div class="line">            partnerArray = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">            objc_setAssociatedObject(<span class="keyword">self</span>, kPartnerArrayKey, partnerArray, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">        &#125;</div><div class="line">        Partner *partner = [[Partner alloc] init];</div><div class="line">        partner.deallocBlock = deallocBlock;</div><div class="line">        [partnerArray addObject:partner];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰å‡ ç‚¹<strong>æ³¨æ„äº‹é¡¹</strong>ï¼š<br>1.blockè§¦å‘æ—¶çš„çº¿ç¨‹ä¸å¯¹è±¡é‡Šæ”¾æ—¶çš„çº¿ç¨‹ä¸€è‡´ï¼Œæ³¨æ„åç»­æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚<br>2.å¦‚æœä½ æƒ³åœ¨blocké‡Œå¼•ç”¨å¯¹è±¡ï¼Œé‚£ä¹ˆæ— è®ºå¼ºå¼±å¼•ç”¨éƒ½æ˜¯ä¸å¯è¡Œçš„ï¼Œå¼ºå¼•ç”¨ä¼šé€ æˆå¾ªç¯å¼•ç”¨ï¼Œå¼±å¼•ç”¨åˆ™è·å–ä¸åˆ°å¯¹è±¡ï¼Œå› ä¸ºå·²ç»è¢«è‡³ä¸ºnilï¼Œå¯ä»¥ä½¿ç”¨<code>__unsafe_unretained</code>ä¿®é¥°ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__<span class="keyword">unsafe_unretained</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) unsafeSelf = <span class="keyword">self</span>;</div></pre></td></tr></table></figure></p><p>ç°åœ¨çœ‹èµ·æ¥æ¯”æœ€å¼€å§‹çš„ç›´æ¥åœ¨CommentViewçš„deallocé‡Œåšæ“ä½œçš„æƒ³æ³•æˆç†Ÿå¤šäº†ï¼Œä½†ä¹‹åæˆ‘å†æŸ¥é˜…ç›¸å…³èµ„æ–™æ—¶è¿˜æ˜¯å‘ç°è‡ªå·±<em>too young too native</em>äº†â€¦å…¶å®æ—©å°±æœ‰å¤§ä½¬å†™äº†ç±»ä¼¼çš„æ¡†æ¶ï¼Œæ”¾ä¸ªé“¾æ¥ä¾›å¤§å®¶è†œ<a href="https://github.com/ChenYilong/CYLDeallocBlockExecutor#%E4%BD%BF%E7%94%A8cyldeallocblockexecutor" target="_blank" rel="external">CYLDeallocBlockExecutor</a>ï¼Œä»£ç ä¸æ˜¯å¾ˆå¤æ‚ï¼Œä½†æ˜¯è€ƒè™‘çš„ç‚¹å’Œå®ç°æ€è·¯å¾ˆèµï¼Œä¹Ÿè®¸è¿™å°±æ˜¯å·®è·å§â€¦å…¶ä¸­æ¶‰åŠåˆ°äº†<code>NSHashTable</code>ï¼Œä¸äº†è§£çš„å¯ä»¥çœ‹å—å¤§çš„<a href="http://southpeak.github.io/2015/05/10/ios-techset-1/" target="_blank" rel="external">iOSçŸ¥è¯†å°é›† ç¬¬1æœŸ(2015.05.10)-NSHashTableéƒ¨åˆ†</a>ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘åšç›´æ’­é—´ä¼˜åŒ–æ—¶é‡åˆ°ä¸ªå¥‡è‘©éœ€æ±‚ï¼Œéœ€è¦åœ¨è¯„è®ºè¾“å…¥è§†å›¾é‡Šæ”¾æ—¶åšä¸€äº›æ“ä½œï¼Œå½“æ—¶æ²¡æƒ³å¤ªå¤šç›´æ¥åœ¨CommentViewå¤–éƒ¨å…¬å¼€ä¸€ä¸ªblockï¼Œç„¶ååœ¨CommentViewçš„&lt;code&gt;dealloc&lt;/code&gt;æ–¹æ³•é‡Œè°ƒç”¨è¯¥blockï¼Œç®€å•ç²—æš´â€¦
    
    </summary>
    
    
      <category term="runitme" scheme="http://wonkeyz.com/tags/runitme/"/>
    
  </entry>
  
  <entry>
    <title>RunLoopå­¦ä¹ æ€»ç»“</title>
    <link href="http://wonkeyz.com/2017/07/22/Runloop-Learning-summary/"/>
    <id>http://wonkeyz.com/2017/07/22/Runloop-Learning-summary/</id>
    <published>2017-07-22T03:31:16.000Z</published>
    <updated>2017-12-13T05:36:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>å‰ä¸¤ç¯‡æ€»ç»“äº†<code>Runtime</code>çš„çŸ¥è¯†ç‚¹ï¼Œè¿™ç¯‡å°±é¡ºä¾¿æ¥çœ‹ä¸‹å®ƒçš„åŒå§“å…„å¼Ÿ<code>RunLoop</code>å§~</p><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p><code>RunLoop</code>ç›´è¯‘è¿‡æ¥å°±æ˜¯ä¸€ç›´åœ¨è·‘çš„å¾ªç¯ã€‚ä¹Ÿè®¸å¹³æ—¶æˆ‘ä»¬å¾ˆå°‘ç”¨å®ƒï¼Œä½†æ˜¯APPçš„è¿è¡Œç¦»ä¸å¼€å®ƒï¼Œå½“APPå¯åŠ¨æ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œå¹¶å¯åŠ¨ä¸»çº¿ç¨‹çš„<code>RunLoop</code>ï¼Œ<code>RunLoop</code>ä¼šä¸æ–­å¾ªç¯ä½¿ç¨‹åºä¸€ç›´è¿è¡Œï¼Œå¹¶ç›‘å¬ç”¨æˆ·çš„å„ç§æ“ä½œï¼Œç„¶åæŠŠæ¶ˆæ¯åˆ†å‘ç»™çº¿ç¨‹æ¥å¤„ç†ï¼›å½“çº¿ç¨‹ç©ºé—²æ—¶ï¼Œ<code>RunLoop</code>è¿˜ä¼šè®©çº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œè¾¾åˆ°çœç”µçš„æ•ˆæœã€‚è¿™ç§æ¨¡å¼è¢«ç§°ä¸º<strong>äº‹ä»¶é©±åŠ¨æ¨¡å‹</strong>ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š<br><a id="more"></a><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;  </div><div class="line">    <span class="keyword">while</span> (AppIsRunning) &#123;  </div><div class="line">        <span class="keyword">id</span> whoWakesMe = SleepForWakingUp;  </div><div class="line">        <span class="keyword">id</span> event = GetEvent(whoWakesMe);  </div><div class="line">        HandleEvent(event);  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>æ³¨ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½è‡ªå·±çš„<code>RunLoop</code>ï¼Œå®ƒä»¬ä¸€ä¸€å¯¹åº”ï¼Œä½†åªæœ‰ä¸»çº¿ç¨‹çš„æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå…¶ä»–å­çº¿ç¨‹éœ€è¦<strong>åœ¨çº¿ç¨‹å†…éƒ¨</strong>è°ƒç”¨<code>[NSRunLoop currentRunLoop]</code>æ¥è·å–<code>RunLoop</code>ï¼Œåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶å°±ä¼šåˆ›å»º<code>RunLoop</code>ï¼Œå½“çº¿ç¨‹ç»“æŸæ—¶<code>RunLoop</code>éšä¹‹é”€æ¯ã€‚<br>å†æ¥çœ‹ä¸‹ä¸€å¼ å¤§å®¶å¾ˆç†Ÿæ‚‰çš„å›¾ï¼Œå–è‡ª<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html" target="_blank" rel="external">å®˜ç½‘</a>:<br><img src="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/Art/runloop.jpg" alt="NSRunLoopäº‹ä»¶é©±åŠ¨æ¨¡å‹"></p><p><code>RunLoop</code>å°±æ˜¯ä¸­é—´çš„é»„åœˆï¼ˆæ˜¯ä¸æ˜¯å¾ˆå½¢è±¡ğŸ¤£ï¼‰ï¼Œå³è¾¹æ˜¯<code>RunLoop</code>éœ€è¦æ¥æ”¶çš„æºäº‹ä»¶ï¼Œæ¥æ”¶åè°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†æ–¹æ³•ã€‚æˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæºï¼š</p><h3 id="Input-Source-è¾“å…¥æº"><a href="#Input-Source-è¾“å…¥æº" class="headerlink" title="Input Source è¾“å…¥æº"></a>Input Source è¾“å…¥æº</h3><p>è¾“å…¥æºåŒ…æ‹¬ä¸‰ç§:<code>NSPort</code>ã€<code>è‡ªå®šä¹‰æº</code>ã€<code>performSelector:OnThread:delay</code>ã€‚å®ƒç”¨æ¥æŠ•é€’å¼‚æ­¥æ¶ˆæ¯ï¼Œé€šå¸¸æ¶ˆæ¯æ¥è‡ªå…¶ä»–çº¿ç¨‹æˆ–è€…ç¨‹åºã€‚åœ¨æ¥å—åˆ°æ¶ˆæ¯å¹¶è°ƒç”¨æŒ‡å®šçš„æ–¹æ³•æ—¶ï¼Œçº¿ç¨‹å¯¹åº”çš„<code>RunLoop</code>å¯¹è±¡ä¼šé€šè¿‡æ‰§è¡Œ<code>runUntilDate:</code>æ–¹æ³•æ¥é€€å‡ºã€‚</p><h4 id="NSPort"><a href="#NSPort" class="headerlink" title="NSPort"></a>NSPort</h4><p><code>NSPort</code>æ˜¯æè¿°é€šè®¯ä¿¡é“çš„æŠ½è±¡ç±»(source1)ã€‚åªéœ€è¦ç®€å•çš„åˆ›å»ºç«¯å£å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨<code>NSPort</code>çš„æ–¹æ³•å°†ç«¯å£å¯¹è±¡åŠ å…¥åˆ°<code>RunLoop</code>ï¼Œç«¯å£å¯¹è±¡ä¼šå¤„ç†åˆ›å»ºä»¥åŠé…ç½®è¾“å…¥æºã€‚<br><code>NSPort</code>åˆ†ä¸‰ç§ï¼š<code>NSMessagePort</code>ï¼ˆåŸºæœ¬åºŸå¼ƒï¼‰ã€<code>NSMachPort</code>ã€ <code>NSSocketPort</code>ã€‚<code>NSMachPort</code>å¯ä»¥ä½œä¸º<a href="https://www.cnblogs.com/samyangldora/p/4631815.html" target="_blank" rel="external">çº¿ç¨‹ä¹‹é—´çš„é€šè®¯é€šé“</a>ã€‚<br>ç³»ç»Ÿä¸­çš„<code>NSURLConnection</code>æ˜¯åŸºäº<code>NSSocketPort</code>è¿›è¡Œé€šä¿¡çš„ï¼Œæ‰€ä»¥å½“åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨<code>NSURLConnection</code>æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨å¯åŠ¨<code>RunLoop</code>, å› ä¸ºå­çº¿ç¨‹ä¸­çš„<code>RunLoop</code>é»˜è®¤æ˜¯æ²¡æœ‰å¯åŠ¨çš„ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSURLConnection</span> *connection = [[<span class="built_in">NSURLConnection</span> alloc] initWithRequest:request delegate:<span class="keyword">self</span> startImmediately:<span class="literal">NO</span>];</div><div class="line">[connection scheduleInRunLoop:[<span class="built_in">NSRunLoop</span> currentRunLoop] forMode:<span class="built_in">NSRunLoopCommonModes</span>];</div><div class="line">[connection start];</div></pre></td></tr></table></figure></p><h4 id="Custom"><a href="#Custom" class="headerlink" title="Custom"></a>Custom</h4><p>å¯ä»¥ä½¿ç”¨<code>CFRunLoopSourceRef</code>ç±»å‹ç›¸å…³çš„å‡½æ•°æ¥åˆ›å»ºè‡ªå®šä¹‰è¾“å…¥æºï¼Œæ¥ç€ä½¿ç”¨å›è°ƒå‡½æ•°æ¥é…ç½®è¾“å…¥æºã€‚<code>Core Fundation</code>ä¼šåœ¨æ°å½“çš„æ—¶å€™è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå¤„ç†è¾“å…¥äº‹ä»¶ä»¥åŠæ¸…ç†æºã€‚å¸¸è§çš„è§¦æ‘¸ã€æ»šåŠ¨äº‹ä»¶ç­‰å°±æ˜¯è¯¥ç±»æºï¼Œç”±ç³»ç»Ÿå†…éƒ¨å®ç°ï¼ŒåŸºæœ¬ç”¨ä¸åˆ°ã€‚</p><h4 id="performSelector-OnThread"><a href="#performSelector-OnThread" class="headerlink" title="performSelector:OnThread:"></a>performSelector:OnThread:</h4><p>è‹¹æœæä¾›äº†å¯ä»¥åœ¨ä»»ä¸€çº¿ç¨‹æ‰§è¡Œselectorçš„è¾“å…¥æºï¼Œå¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ä¸»çº¿ç¨‹</span></div><div class="line">performSelectorOnMainThread:withObject:waitUntilDone:</div><div class="line">performSelectorOnMainThread:withObject:waitUntilDone:modes:</div><div class="line"><span class="comment">// æŒ‡å®šçº¿ç¨‹</span></div><div class="line">performSelector:onThread:withObject:waitUntilDone:</div><div class="line">performSelector:onThread:withObject:waitUntilDone:modes:</div><div class="line"><span class="comment">// é’ˆå¯¹å½“å‰çº¿ç¨‹</span></div><div class="line">performSelector:withObject:afterDelay:         </div><div class="line">performSelector:withObject:afterDelay:inModes:</div><div class="line"><span class="comment">// å–æ¶ˆåœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œå’Œä¸Šé¢ä¸¤ä¸ªæ–¹æ³•å¯¹åº”</span></div><div class="line">cancelPreviousPerformRequestsWithTarget:</div><div class="line">cancelPreviousPerformRequestsWithTarget:selector:object:</div></pre></td></tr></table></figure></p><p>è¿™äº›selectoræ‰§è¡Œçš„æ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹çš„<code>RunLoop</code>å¤„äºå¯åŠ¨çŠ¶æ€ã€‚<br>å’Œç«¯å£æºä¸€æ ·ï¼Œè¿™äº›selectorçš„è¯·æ±‚ä¼šåœ¨ç›®æ ‡çº¿ç¨‹ä¸­åŠ å…¥åˆ°<code>queue</code>ä¸­åºåˆ—åŒ–ï¼Œä»¥å‡ç¼“çº¿ç¨‹ä¸­å¤šä¸ªæ–¹æ³•æ‰§è¡Œå¸¦æ¥çš„åŒæ­¥é—®é¢˜ã€‚<br>å®˜æ–¹æ–‡æ¡£è¯´<code>selector</code>ä¼šåœ¨æ‰§è¡Œå®Œæˆåä¼šè¢«ç§»å‡º<code>RunLoop</code>ï¼Œä½†ç»æµ‹è¯•åªæœ‰<code>performSelector:withObject:afterDelay:</code>ä¼šç§»é™¤ï¼Œå› ä¸ºå®ƒæ˜¯timeræºã€‚<br>è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„æˆ‘ä»¬å¹³æ—¶ç”¨çš„<code>performSelector:(SEL)aSelector</code>æ–¹æ³•ä¸çº¿ç¨‹æ— å…³ï¼Œå®ƒæ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œä¸ä¼šæ·»åŠ åˆ°<code>RunLoop</code>ä¸­ã€‚  </p><h3 id="Timer-Source-æ—¶é—´æº"><a href="#Timer-Source-æ—¶é—´æº" class="headerlink" title="Timer Source æ—¶é—´æº"></a>Timer Source æ—¶é—´æº</h3><p><code>Timer sources</code>åœ¨é¢„è®¾çš„æ—¶é—´ç‚¹å”¤é†’<code>RunLoop</code>åŒæ­¥çš„ç»™çº¿ç¨‹å‘é€äº‹ä»¶ï¼Œæ˜¯çº¿ç¨‹é€šçŸ¥è‡ªå·±åšæŸäº‹çš„ä¸€ç§æ–¹å¼ã€‚å¸¸ç”¨çš„æ–¹æ³•æœ‰ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">NSTimer</span> *)timerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)ti invocation:(<span class="built_in">NSInvocation</span> *)invocation repeats:(<span class="built_in">BOOL</span>)yesOrNo;</div><div class="line">+ (<span class="built_in">NSTimer</span> *)scheduledTimerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)ti invocation:(<span class="built_in">NSInvocation</span> *)invocation repeats:(<span class="built_in">BOOL</span>)yesOrNo;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector withObject:(<span class="keyword">id</span>)anArgument afterDelay:(<span class="built_in">NSTimeInterval</span>)delay inModes:(<span class="built_in">NSArray</span> *)modes;</div><div class="line"></div><div class="line">+ (<span class="built_in">CADisplayLink</span> *)displayLinkWithTarget:(<span class="keyword">id</span>)target selector:(SEL)sel;</div><div class="line">- (<span class="keyword">void</span>)addToRunLoop:(<span class="built_in">NSRunLoop</span> *)runloop forMode:(<span class="built_in">NSString</span> *)mode;</div><div class="line">- (<span class="keyword">void</span>)removeFromRunLoop:(<span class="built_in">NSRunLoop</span> *)runloop forMode:(<span class="built_in">NSRunLoopMode</span>)mode;</div></pre></td></tr></table></figure></p><p>æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š<br><code>scheduledTimerWithTimeInterval:</code>åˆ›å»ºçš„timerä¼šè‡ªåŠ¨ä»¥<code>NSDefaultRunLoopMode</code>æ¨¡å¼åŠ è½½åˆ°å½“å‰<code>RunLoop</code>ä¸­ï¼Œè€Œå…¶ä»–æ–¹æ³•åˆ›å»ºçš„åˆ™éœ€è¦æ‰‹åŠ¨è°ƒç”¨<code>[[NSRunLoop currentRunLoop] addTimer:_timer forMode:NSRunLoopCommonModes];</code>æ·»åŠ åˆ°<code>RunLoop</code>ä¸­ã€‚<br>å½“<code>repates</code>ä¸ºNOæ—¶ï¼Œtimeråœ¨æ‰§è¡Œå®Œæˆæ—¶ï¼Œä¼šä»<code>RunLoop</code>ä¸­ç§»é™¤ï¼Œå½“ä¸ºYESæ—¶ï¼Œtimerä¼šä¸€ç›´ä¿å­˜åœ¨å½“å‰<code>RunLoop</code>ä¸­ï¼Œç›´åˆ°<code>invalidated</code>æ–¹æ³•è°ƒç”¨ã€‚<br>å› ä¸º<code>NSTimer</code>æ˜¯åŸºäº<code>RunLoop</code>çš„ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯å®æ—¶çš„ï¼Œä¼šæœ‰è¯¯å·®ã€‚å› ä¸º<code>RunLoop</code>åªè´Ÿè´£åˆ†å‘æºçš„æ¶ˆæ¯ã€‚å¦‚æœçº¿ç¨‹å½“å‰æ­£åœ¨å¤„ç†ç¹é‡çš„ä»»åŠ¡ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´Timeræœ¬æ¬¡å»¶æ—¶ï¼Œæˆ–è€…å°‘æ‰§è¡Œä¸€æ¬¡ã€‚å…¶å®æ‰€æœ‰å®šæ—¶å™¨éƒ½æ˜¯éƒ½ä¸æ˜¯ç»å¯¹ç²¾ç¡®çš„ï¼Œå…·ä½“åˆ†æè§<a href="http://blog.lessfun.com/blog/2016/08/05/reliable-timer-in-ios/" target="_blank" rel="external">æ›´å¯é å’Œé«˜ç²¾åº¦çš„ iOS å®šæ—¶å™¨</a>ã€‚</p><h2 id="CFRunLoop"><a href="#CFRunLoop" class="headerlink" title="CFRunLoop"></a>CFRunLoop</h2><p>ç›¸ä¿¡ä½ å’Œæˆ‘ä¸€æ ·ï¼Œçœ‹äº†ä¸Šé¢çš„è¿˜æ˜¯äº‘é‡Œé›¾é‡Œçš„ï¼Œæ„Ÿè§‰<code>RunLoop</code>å¹¶æ²¡æœ‰å¤šå¼ºå¤§ï¼Œçœ‹æ¥è¿˜æ˜¯äº†è§£çš„ä¸å¤Ÿæ·±å…¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹ä¸‹<code>NSRunLoop</code>çš„åº•å±‚å®ç°<a href="https://opensource.apple.com/source/CF/CF-855.17/CFRunLoop.h.auto.html" target="_blank" rel="external">CFRunLoop</a>ã€‚å®ƒçš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> __CFRunLoop &#123;</div><div class="line">    <span class="built_in">CFMutableSetRef</span> _commonModes;     </div><div class="line">    <span class="built_in">CFMutableSetRef</span> _commonModeItems; </div><div class="line">    <span class="built_in">CFRunLoopModeRef</span> _currentMode;    </div><div class="line">    <span class="built_in">CFMutableSetRef</span> _modes;           </div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p><p>ä¸Šä¸€å¼ sunnyxxå¤§ç¥çš„CFRunLoopæ„æˆå›¾ï¼š<img src="http://owgqmweju.bkt.clouddn.com/17-12-10/16351272.jpg" alt="CFRunLoopæ„æˆ"><br>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºRunLoopä¸Threadä¸€ä¸€å¯¹åº”ï¼Œä¸€ä¸ªRunLoopæœ‰nä¸ªModeï¼Œæ¯ä¸ªModeæœ‰nä¸ªSource/Timer/Observerã€‚<strong>ä½†åœ¨æ¯æ¬¡è°ƒç”¨RunLoopçš„ä¸»å‡½æ•°æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ªModeï¼ˆ<code>CFRunLoopRunSpecific</code>å‡½æ•°ï¼‰ï¼Œè¿™ä¸ªModeè¢«ç§°ä½œ<code>currentMode</code>ã€‚å¦‚æœéœ€è¦åˆ‡æ¢Modeï¼Œåªèƒ½é€€å‡ºLoopï¼Œé‡å¯æ–°çš„Loop</strong>ã€‚è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„Source/Timer/Observerï¼Œè®©å…¶äº’ä¸å½±å“ã€‚æˆ‘ä»¬ä»ä¸‹å¾€ä¸Šçœ‹ï¼š</p><h3 id="CFRunLoopSourceRef"><a href="#CFRunLoopSourceRef" class="headerlink" title="CFRunLoopSourceRef"></a>CFRunLoopSourceRef</h3><p><code>CFRunLoopSourceRef</code>æ˜¯<code>RunLoop</code>çš„æ•°æ®æºæŠ½è±¡ç±»ï¼Œæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼šSource0å’ŒSource1ã€‚</p><ul><li>Source0æ˜¯éåŸºäºportçš„ï¼ŒåŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼Œä¸èƒ½ä¸»åŠ¨è§¦å‘äº‹ä»¶ã€‚å®ƒè´Ÿè´£Appå†…éƒ¨äº‹ä»¶ï¼Œç”±Appè´Ÿè´£ç®¡ç†è§¦å‘ï¼Œä¾‹å¦‚UIEventã€UITouchäº‹ä»¶ã€‚ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦å…ˆè°ƒç”¨<code>CFRunLoopSourceSignal(source)</code>ï¼Œå°†è¿™ä¸ªSourceæ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨<code>CFRunLoopWakeUp(runloop)</code>æ¥å”¤é†’<code>RunLoop</code>ï¼Œè®©å…¶å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚</li><li>Source1æ˜¯åŸºäºportçš„ï¼ŒåŒ…å«äº†ä¸€ä¸ª<a href="https://segmentfault.com/a/1190000002400329" target="_blank" rel="external">mach_port</a>å’Œä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œè¢«ç”¨äºé€šè¿‡å†…æ ¸å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯ã€‚å®ƒèƒ½ä¸»åŠ¨å”¤é†’RunLoopï¼Œæ¥æ”¶ç³»ç»Ÿåˆ†å‘äº‹ä»¶ã€‚</li></ul><h3 id="CFRunLoopTimerRef"><a href="#CFRunLoopTimerRef" class="headerlink" title="CFRunLoopTimerRef"></a>CFRunLoopTimerRef</h3><p><code>CFRunLoopTimerRef</code>æ˜¯åŸºäºæ—¶é—´çš„è§¦å‘å™¨ï¼Œå®ƒåŒ…å«ä¸€ä¸ªæ—¶é—´é•¿åº¦å’Œä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ã€‚å½“å…¶åŠ å…¥åˆ° RunLoop æ—¶ï¼ŒRunLoopä¼šæ³¨å†Œå¯¹åº”çš„æ—¶é—´ç‚¹ï¼Œå½“æ—¶é—´ç‚¹åˆ°æ—¶ï¼ŒRunLoopä¼šè¢«å”¤é†’ä»¥æ‰§è¡Œé‚£ä¸ªå›è°ƒã€‚ä¸Šé¢æåˆ°çš„Timer Sourceä¸­çš„æ–¹æ³•éƒ½æ˜¯åŸºäº<code>CFRunLoopTimerRef</code>çš„å°è£…ï¼Œ</p><p>Source1å’ŒTimeréƒ½å±äºç«¯å£äº‹ä»¶æºï¼Œä¸åŒçš„æ˜¯æ‰€æœ‰çš„Timeréƒ½å…±ç”¨ä¸€ä¸ªç«¯å£(Timer Port)ï¼Œè€Œæ¯ä¸ªSource1éƒ½æœ‰ä¸åŒçš„å¯¹åº”ç«¯å£ã€‚<br>Source0å±äºInput Sourceä¸­çš„ä¸€éƒ¨åˆ†ï¼ŒInput Sourceè¿˜åŒ…æ‹¬cuntomè‡ªå®šä¹‰æºï¼Œç”±å…¶ä»–çº¿ç¨‹æ‰‹åŠ¨å‘å‡ºã€‚</p><h3 id="CFRunLoopObserverRef"><a href="#CFRunLoopObserverRef" class="headerlink" title="CFRunLoopObserverRef"></a>CFRunLoopObserverRef</h3><p>å®ƒç”¨æ¥ç›‘å¬<code>RunLoop</code>å½“å‰çš„çŠ¶æ€ï¼Œæ¯ä¸ªObserveréƒ½åŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œå½“ RunLoop çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§‚å¯Ÿè€…å°±èƒ½é€šè¿‡å›è°ƒæ¥æ”¶åˆ°è¿™ä¸ªå˜åŒ–ã€‚å¯ä»¥è§‚å¯Ÿçš„çŠ¶æ€æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="built_in">CF_OPTIONS</span>(<span class="built_in">CFOptionFlags</span>, <span class="built_in">CFRunLoopActivity</span>) &#123;</div><div class="line">    kCFRunLoopEntry         = (<span class="number">1</span>UL &lt;&lt; <span class="number">0</span>), <span class="comment">// å³å°†è¿›å…¥Loop</span></div><div class="line">    kCFRunLoopBeforeTimers  = (<span class="number">1</span>UL &lt;&lt; <span class="number">1</span>), <span class="comment">// å³å°†å¤„ç† Timer</span></div><div class="line">    kCFRunLoopBeforeSources = (<span class="number">1</span>UL &lt;&lt; <span class="number">2</span>), <span class="comment">// å³å°†å¤„ç† Source</span></div><div class="line">    kCFRunLoopBeforeWaiting = (<span class="number">1</span>UL &lt;&lt; <span class="number">5</span>), <span class="comment">// å³å°†è¿›å…¥ä¼‘çœ </span></div><div class="line">    kCFRunLoopAfterWaiting  = (<span class="number">1</span>UL &lt;&lt; <span class="number">6</span>), <span class="comment">// åˆšä»ä¼‘çœ ä¸­å”¤é†’</span></div><div class="line">    kCFRunLoopExit          = (<span class="number">1</span>UL &lt;&lt; <span class="number">7</span>), <span class="comment">// å³å°†é€€å‡ºLoop</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p><p>ä½ å¯ä»¥åœ¨<code>RunLoop</code>ä¸­è§‚å¯Ÿä¸€ä¸ªæˆ–å¤šä¸ªçŠ¶æ€ï¼Œè§‚å¯Ÿè€…ä¹Ÿå¯ä»¥è®¾ç½®æ˜¯å¦åªè§‚å¯Ÿä¸€æ¬¡æˆ–è€…é‡å¤å¤šæ¬¡è§‚å¯Ÿï¼Œå¦‚æœåªè§‚å¯Ÿä¸€æ¬¡ï¼Œé‚£ä¹ˆè°ƒç”¨å›è°ƒå‡½æ•°ä»¥åï¼Œè§‚å¯Ÿè€…å°±è‡ªåŠ¨è¢«ç§»é™¤äº†ã€‚<br>ä¸Šä»£ç ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// åˆ›å»ºobserver</span></div><div class="line"><span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(<span class="built_in">CFAllocatorGetDefault</span>(), kCFRunLoopAllActivities, <span class="literal">YES</span>, <span class="number">0</span>, ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"----ç›‘å¬åˆ°RunLoopçŠ¶æ€å‘ç”Ÿæ”¹å˜---%zd"</span>, activity);</div><div class="line">&#125;);</div><div class="line"><span class="comment">//å‚æ•°1ï¼šåˆ†é…å†…å­˜ å‚æ•°2ï¼šè¦ç›‘å¬å“ªä¸ªrunloopçŠ¶æ€çš„æ ‡è®° å‚æ•°3ï¼šæ˜¯å¦é‡å¤ã€‚è¿™ä¸ªobserveræ˜¯åªè°ƒç”¨ä¸€æ¬¡è¿˜æ˜¯runloopæ¯æ¬¡å¾ªç¯éƒ½è°ƒ å‚æ•°4ï¼šä¼˜å…ˆçº§ï¼Œä¸€èˆ¬ä¼ 0</span></div><div class="line"></div><div class="line"><span class="comment">// æ·»åŠ è§‚å¯Ÿè€…åˆ°RunLoop</span></div><div class="line"><span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), observer, kCFRunLoopDefaultMode);   </div><div class="line"></div><div class="line"><span class="comment">// é‡Šæ”¾observer</span></div><div class="line"><span class="built_in">CFRelease</span>(observer);</div></pre></td></tr></table></figure></p><p>ä¸Šé¢çš„Source/Timer/Observerè¢«ç»Ÿç§°ä¸ºmode itemï¼Œ<strong>æ¯ä¸ªitemå¯ä»¥åŒæ—¶åŠ å…¥å¤šä¸ªmodeï¼Œä½†ä¸€ä¸ªitemè¢«é‡å¤åŠ å…¥åŒä¸€ä¸ªmodeæ— æ•ˆï¼Œå¦‚æœä¸€ä¸ªmodeä¸­ä¸€ä¸ªiteméƒ½æ²¡æœ‰ï¼ŒRunLoopå°±ä¼šç«‹å³é€€å‡º</strong>ã€‚  </p><h3 id="CFRunLoopMode"><a href="#CFRunLoopMode" class="headerlink" title="CFRunLoopMode"></a>CFRunLoopMode</h3><p><code>CFRunLoopMode</code>çš„ä»£ç ç»“æ„å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> __CFRunLoopMode &#123;</div><div class="line">    <span class="built_in">CFStringRef</span> _name;            </div><div class="line">    <span class="built_in">CFMutableSetRef</span> _sources0;    </div><div class="line">    <span class="built_in">CFMutableSetRef</span> _sources1;    </div><div class="line">    <span class="built_in">CFMutableArrayRef</span> _observers; </div><div class="line">    <span class="built_in">CFMutableArrayRef</span> _timers;    </div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p><p>å¯ä»¥ä»ä¸­çœ‹å‡ºä¸Šé¢æåˆ°çš„ä¸€ä¸ªModeå¯ä»¥å¯¹åº”å¤šä¸ªitemçš„ç»“æ„ï¼Œç³»ç»Ÿå®šä¹‰äº†ä»¥ä¸‹å‡ ç§Modeï¼š  </p><ul><li>NSRunLoopDefaultMode: é»˜è®¤Modeï¼Œä¹Ÿæ˜¯ç©ºé—²çŠ¶æ€ã€‚ä¸»çº¿ç¨‹é€šå¸¸åœ¨è¿™Modeä¸‹è¿è¡Œã€‚</li><li>UITrackingRunLoopMode: ç•Œé¢è·Ÿè¸ªModeï¼ŒScrollViewæ»šåŠ¨æ—¶å€™çš„æ¨¡å¼ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–Modeå½±å“ã€‚</li><li>UIInitializationRunLoopMode: åœ¨åˆšå¯åŠ¨ç¨‹åºæ—¶è¿›å…¥çš„ç¬¬ä¸€ä¸ªModeï¼Œç§æœ‰ï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨ã€‚</li><li>NSRunLoopCommonModes: è¿™æ˜¯ä¸€ç»„å¯é…ç½®çš„é€šç”¨æ¨¡å¼ï¼Œé»˜è®¤åŒ…æ‹¬äº†ç¬¬1å’Œç¬¬2ç§æ¨¡å¼ï¼Œå¯ä»¥æ·»åŠ è‡ªå·±çš„Modeã€‚</li></ul><p>æ›´å¤šModeè¯·è§<a href="http://iphonedevwiki.net/index.php/CFRunLoop" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚  </p><p>å¸¸è§çš„åº”ç”¨æ¯”å¦‚æˆ‘ä»¬åœ¨æ»‘åŠ¨scrollViewæ—¶ï¼Œä»å¼€å§‹æ»‘åŠ¨åˆ°ç»“æŸæ»‘åŠ¨ï¼Œç³»ç»Ÿå°±æŠŠä¸»çº¿ç¨‹çš„RunLoopModeç”±<code>NSRunLoopDefaultMode</code>åˆ‡æ¢åˆ°<code>UITrackingRunLoopMode</code>å†åˆ°<code>NSRunLoopDefaultMode</code>ï¼Œè¿™ä¹Ÿæ˜¯iOSåˆ—è¡¨æ»‘åŠ¨æµç•…çš„ç§˜å¯†ä¹‹ä¸€ã€‚<br>å†æ¯”å¦‚æˆ‘ä»¬åœ¨å¼€å‘ä¸­ä¼šå‘ç°å½“åˆ—è¡¨æ»‘åŠ¨æ—¶timerè§¦å‘çš„äº‹ä»¶ä¸ä¼šè¢«æ‰§è¡Œï¼ŒåŸå› æ˜¯ä½¿ç”¨<code>scheduledTimerWithTimeInterval</code>æ–¹æ³•åˆ›å»ºçš„timerä¼šå·²<code>NSRunLoopDefaultMode</code>åŠ å…¥åˆ°<code>RunLoop</code>ä¸­ï¼Œä½†åœ¨æ»‘åŠ¨æ—¶Modeè¢«åˆ‡æ¢æˆäº†<code>UITrackingRunLoopMode</code>ï¼Œ<strong>ModeItemè¦åœ¨å¯¹åº”çš„Modeä¸‹æ‰ä¼šè¢«<code>RunLoop</code>å¤„ç†</strong>ï¼Œæ‰€ä»¥å¦‚æœæƒ³åœ¨æ»‘åŠ¨æ—¶ä¸å½±å“timerçš„æ‰§è¡Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç åˆ›å»ºtimerï¼Œè®©timeråœ¨ä¸¤ä¸ªModeä¸­éƒ½èƒ½å›è°ƒï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:<span class="number">1.0</span></div><div class="line">                                             target:<span class="keyword">self</span></div><div class="line">                                           selector:<span class="keyword">@selector</span>(timerTick:)</div><div class="line">                                           userInfo:<span class="literal">nil</span></div><div class="line">                                            repeats:<span class="literal">YES</span>];</div><div class="line">[[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</div></pre></td></tr></table></figure></p><p>Modeæš´éœ²çš„ç®¡ç†mode itemçš„æ¥å£æœ‰ä¸‹é¢å‡ ä¸ªï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">CFRunLoopAddSource</span>(<span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFRunLoopSourceRef</span> source, <span class="built_in">CFStringRef</span> modeName);</div><div class="line"><span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFStringRef</span> modeName);</div><div class="line"><span class="built_in">CFRunLoopAddTimer</span>(<span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFRunLoopTimerRef</span> timer, <span class="built_in">CFStringRef</span> mode);</div><div class="line"><span class="built_in">CFRunLoopRemoveSource</span>(<span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFRunLoopSourceRef</span> source, <span class="built_in">CFStringRef</span> modeName);</div><div class="line"><span class="built_in">CFRunLoopRemoveObserver</span>(<span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFStringRef</span> modeName);</div><div class="line"><span class="built_in">CFRunLoopRemoveTimer</span>(<span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFRunLoopTimerRef</span> timer, <span class="built_in">CFStringRef</span> mode);</div></pre></td></tr></table></figure></p><p>ä½ åªèƒ½é€šè¿‡modeNameæ¥æ“ä½œå†…éƒ¨çš„modeï¼Œå½“ä½ ä¼ å…¥ä¸€ä¸ªæ–°çš„modeNameä½†RunLoopå†…éƒ¨æ²¡æœ‰å¯¹åº”modeæ—¶ï¼ŒRunLoopä¼šè‡ªåŠ¨å¸®ä½ åˆ›å»ºå¯¹åº”çš„<code>CFRunLoopModeRef</code>ã€‚å¯¹äºä¸€ä¸ªRunLoopæ¥è¯´ï¼Œå…¶å†…éƒ¨çš„modeåªèƒ½å¢åŠ ä¸èƒ½åˆ é™¤ã€‚</p><h3 id="RunLoopçš„ç¡çœ ä¸å”¤é†’"><a href="#RunLoopçš„ç¡çœ ä¸å”¤é†’" class="headerlink" title="RunLoopçš„ç¡çœ ä¸å”¤é†’"></a>RunLoopçš„ç¡çœ ä¸å”¤é†’</h3><p>åœ¨Appè¿è¡Œæ—¶ï¼Œåœ¨Debugæ é‡ŒæŒ‰ä¸‹æš‚åœï¼Œä¼šå‡ºç°ä»¥ä¸‹å †æ ˆ<img src="http://owgqmweju.bkt.clouddn.com/17-12-11/38340739.jpg" alt=""><br>è¿™å°±æ˜¯<code>RunLoop</code>çš„ç¡çœ çŠ¶æ€ï¼Œä¸å‰é¢æåˆ°çš„MachPortæœ‰å…³ï¼Œå›¾ç‰‡é‡Œé¢ä¸Šè¾¹çš„ä¸¤ä¸ª<code>mach_msg</code>å‡½æ•°ä¼šæŒ‡å®šä¸€ä¸ªç«¯å£å‘ç»™å†…æ ¸ä¸€ä¸ªæ¶ˆæ¯ï¼Œæ­¤æ—¶<code>RunLoop</code>å°±æ˜¯æ­£åœ¨ç­‰å¾…æ¥æ”¶ä¿¡æ¯çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…å”¤é†’ï¼Œå†…æ ¸æ­¤åˆ»å°†å…¶æŒ‚èµ·ï¼ˆä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰çš„æŒ‚èµ·ï¼Œè¿˜åœ¨å†…å­˜é‡Œï¼Œå…¶å®å°±æ˜¯ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…æœ‰äººå«é†’ï¼Œç±»ä¼¼äºNSNotificationCenter,åœ¨æ”¶åˆ°Postæ—¶å”¤é†’è¿›è¡Œå¤„ç†ï¼‰è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æŒ‡å®šç”¨äºå”¤é†’çš„<code>mach_port</code>ç«¯å£ï¼›</li><li>è°ƒç”¨<code>mach_msg</code>ç›‘å¬å”¤é†’ç«¯å£ï¼Œè¢«å”¤é†’å‰ï¼Œç³»ç»Ÿå†…æ ¸å°†æ­¤çº¿ç¨‹æŒ‚èµ·ï¼Œåœç•™åœ¨<code>mach_msg_trap</code>çŠ¶æ€ï¼›</li><li>ç”±å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆæˆ–å¦ä¸€ä¸ªè¿›ç¨‹ä¸­çš„æŸä¸ªçº¿ç¨‹ï¼‰å‘å†…æ ¸å‘é€è¿™ä¸ªç«¯å£çš„msgåï¼ŒtrapçŠ¶æ€è¢«å”¤é†’ï¼ŒRunLoopç»§ç»­è¿è¡Œï¼›  </li></ul><h3 id="RunLoopå¾ªç¯é€»è¾‘"><a href="#RunLoopå¾ªç¯é€»è¾‘" class="headerlink" title="RunLoopå¾ªç¯é€»è¾‘"></a>RunLoopå¾ªç¯é€»è¾‘</h3><p>çœ‹å®Œäº†<code>RunLoop</code>çš„ç»“æ„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹<code>RunLoop</code>åˆ°åº•æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚<br>å…ˆæ¥çœ‹ä¸‹ä¸¤ä¸ªæ‰§è¡Œ<code>RunLoop</code>çš„å‡½æ•°ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ç”¨DefaultModeå¯åŠ¨</span></div><div class="line"><span class="keyword">void</span> <span class="built_in">CFRunLoopRun</span>(<span class="keyword">void</span>) &#123;</div><div class="line">    <span class="built_in">CFRunLoopRunSpecific</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), kCFRunLoopDefaultMode, <span class="number">1.0e10</span>, <span class="literal">false</span>);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">// ç”¨æŒ‡å®šçš„Modeå¯åŠ¨ï¼Œå…è®¸è®¾ç½®RunLoopè¶…æ—¶æ—¶é—´</span></div><div class="line"><span class="keyword">int</span> <span class="built_in">CFRunLoopRunInMode</span>(<span class="built_in">CFStringRef</span> modeName, <span class="built_in">CFTimeInterval</span> seconds, Boolean stopAfterHandle) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">CFRunLoopRunSpecific</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), modeName, seconds, returnAfterSourceHandled);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>OKï¼Œæ‰¾åˆ°æºå¤´äº†ï¼Œå°±æ˜¯<code>CFRunLoopRunSpecific(runloop, modeName, seconds, stopAfterHandle)</code>å‡½æ•°ï¼Œå…¶å†…éƒ¨å°±æ˜¯do-whileå¾ªç¯ï¼Œç”±äºä»£ç å¤ªå¤šï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä¸‹æ‰§è¡Œè¿‡ç¨‹çš„ç®€è¿°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">1 é€šçŸ¥è§‚å¯Ÿè€…runLoopå·²ç»å¯åŠ¨(DoObserver)</div><div class="line">2 è®°å½•RunLoopå¯åŠ¨äº‹ä»¶,å¹¶è®¾å®šRunLoopè¿è¡Œçš„è¶…æ—¶æ¡ä»¶</div><div class="line"></div><div class="line">---- RunLoopè¿›å…¥å¾ªç¯ ----</div><div class="line"></div><div class="line">3 é€šçŸ¥è§‚å¯Ÿè€…ä»»ä½•å³å°†è¦å¼€å§‹çš„timer(DoObserver)</div><div class="line">4 é€šçŸ¥è§‚å¯Ÿç€ä»»ä½•å³å°†å¯åŠ¨çš„source0(DoObserver)</div><div class="line">5 è°ƒç”¨RunLoopModeçš„blocksé“¾ä¸­çš„blockæ–¹æ³•(DoBlocks)</div><div class="line">6 å¯åŠ¨ä»»ä½•å‡†å¤‡å¥½çš„éåŸºäºç«¯å£çš„source0æº(DoSource0)</div><div class="line">7 è°ƒç”¨RunLoopModeçš„blocksé“¾ä¸­çš„blockæ–¹æ³•(DoBlocks)</div><div class="line">8 æ£€æŸ¥MachPortç«¯å£æ˜¯å¦æœ‰æ¶ˆæ¯è¦å¤„ç†ï¼Œå¦‚æœæœ‰ç«‹å³è¿›å…¥æ­¥éª¤12</div><div class="line">9 å¦‚æœæ²¡æœ‰æ¶ˆæ¯å¤„ç†,é€šçŸ¥è§‚å¯Ÿè€…çº¿ç¨‹è¿›å…¥ä¼‘çœ (DoObserver)</div><div class="line"></div><div class="line">---- RunLoopä¼‘çœ ----</div><div class="line"></div><div class="line">10 å°†çº¿ç¨‹è‡³äºä¼‘çœ ç›´åˆ°ä»»æ„ä¸‹é¢çš„äº‹ä»¶å‘ç”Ÿ(è°ƒç”¨`mach_msg`ä½¿RunLoopä¼‘çœ )</div><div class="line">    A.source1äº‹ä»¶</div><div class="line">    B.timerå¯åŠ¨</div><div class="line">    C.runLoopè‡ªèº«è¶…æ—¶æ—¶é—´åˆ°äº†</div><div class="line">    D.è¢«å…¶ä»–è°ƒç”¨è€…æ‰‹åŠ¨å”¤é†’</div><div class="line"></div><div class="line">11 é€šçŸ¥è§‚å¯Ÿè€…çº¿ç¨‹å°†è¢«å”¤é†’(DoObserver)</div><div class="line">12 å¤„ç†æœªå¤„ç†çš„äº‹ä»¶(æœ‰dispatchPortæ˜¾ç¤ºæ˜¯å“ªä¸ªportçš„äº‹ä»¶éœ€è¦å¤„ç†)</div><div class="line">    A.å¦‚æœlivePortä¸ºNULL,å•¥éƒ½ä¸åš(ä¼šè·³å‡ºå¾ªç¯)</div><div class="line">    B.å¦‚æœlivePortæ˜¯wakeUpPort,è¯´æ˜RunLoopè¿è¡Œè¶…æ—¶(ä¼šè·³å‡ºå¾ªç¯)</div><div class="line">    C.å¦‚æœlivePortæ˜¯timerPort,è¯´æ˜timerSourceå¯åŠ¨(DoTimers),è¿›å…¥æ­¥éª¤3</div><div class="line">    D.å¦‚æœlivePortæ˜¯dispatchPort,è¯´æ˜ç³»ç»Ÿçš„libDispatchå‘ä¸»çº¿ç¨‹é€æ¶ˆæ¯,ä¼šè°ƒdispatch_async(dispatch_get_main_queue(),block)</div><div class="line">    E.å¦‚æœlivePortæ˜¯å…¶ä»–port,é€šè¿‡mach_msgå–å‡ºå›è°ƒ,å¤„ç†äº‹ä»¶(DoSource1), è¿›å…¥æ­¥éª¤3</div><div class="line">    </div><div class="line">---- RunLoopé€€å‡ºå¾ªç¯ ----</div><div class="line"></div><div class="line">13 é€šçŸ¥è§‚å¯Ÿè€…runLoopç»“æŸ</div></pre></td></tr></table></figure></p><h2 id="Cocoaä¸­RunLoopçš„åº”ç”¨"><a href="#Cocoaä¸­RunLoopçš„åº”ç”¨" class="headerlink" title="Cocoaä¸­RunLoopçš„åº”ç”¨"></a>Cocoaä¸­RunLoopçš„åº”ç”¨</h2><p>æˆ‘ä»¬å…ˆçœ‹ä¸‹APPå¯åŠ¨åçš„çŠ¶æ€ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">CFRunLoop</span> &#123;</div><div class="line">    current mode = kCFRunLoopDefaultMode</div><div class="line">    common modes = &#123;</div><div class="line">        <span class="built_in">UITrackingRunLoopMode</span></div><div class="line">        kCFRunLoopDefaultMode</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    common mode items = &#123;</div><div class="line"> </div><div class="line">        <span class="comment">// source0 (manual)</span></div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order =<span class="number">-1</span>, &#123;</div><div class="line">            callout = _UIApplicationHandleEventQueue&#125;&#125;</div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order =<span class="number">-1</span>, &#123;</div><div class="line">            callout = PurpleEventSignalCallback &#125;&#125;</div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>, &#123;</div><div class="line">            callout = FBSSerialQueueRunLoopSourceHandler&#125;&#125;</div><div class="line"> </div><div class="line">        <span class="comment">// source1 (mach port)</span></div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>,  &#123;port = <span class="number">17923</span>&#125;&#125;</div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>,  &#123;port = <span class="number">12039</span>&#125;&#125;</div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>,  &#123;port = <span class="number">16647</span>&#125;&#125;</div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order =<span class="number">-1</span>, &#123;</div><div class="line">            callout = PurpleEventCallback&#125;&#125;</div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>, &#123;port = <span class="number">2407</span>,</div><div class="line">            callout = _ZL20notify_port_callbackP12__CFMachPortPvlS1_&#125;&#125;</div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>, &#123;port = <span class="number">1</span>c03,</div><div class="line">            callout = __IOHIDEventSystemClientAvailabilityCallback&#125;&#125;</div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>, &#123;port = <span class="number">1</span>b03,</div><div class="line">            callout = __IOHIDEventSystemClientQueueCallback&#125;&#125;</div><div class="line">        <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">1</span>, &#123;port = <span class="number">1903</span>,</div><div class="line">            callout = __IOMIGMachPortPortCallback&#125;&#125;</div><div class="line"> </div><div class="line">        <span class="comment">// Ovserver</span></div><div class="line">        <span class="built_in">CFRunLoopObserver</span> &#123;order = <span class="number">-2147483647</span>, activities = <span class="number">0x1</span>, <span class="comment">// Entry</span></div><div class="line">            callout = _wrapRunLoopWithAutoreleasePoolHandler&#125;</div><div class="line">        <span class="built_in">CFRunLoopObserver</span> &#123;order = <span class="number">0</span>, activities = <span class="number">0x20</span>,          <span class="comment">// BeforeWaiting</span></div><div class="line">            callout = _UIGestureRecognizerUpdateObserver&#125;</div><div class="line">        <span class="built_in">CFRunLoopObserver</span> &#123;order = <span class="number">1999000</span>, activities = <span class="number">0xa0</span>,    <span class="comment">// BeforeWaiting | Exit</span></div><div class="line">            callout = _afterCACommitHandler&#125;</div><div class="line">        <span class="built_in">CFRunLoopObserver</span> &#123;order = <span class="number">2000000</span>, activities = <span class="number">0xa0</span>,    <span class="comment">// BeforeWaiting | Exit</span></div><div class="line">            callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv&#125;</div><div class="line">        <span class="built_in">CFRunLoopObserver</span> &#123;order = <span class="number">2147483647</span>, activities = <span class="number">0xa0</span>, <span class="comment">// BeforeWaiting | Exit</span></div><div class="line">            callout = _wrapRunLoopWithAutoreleasePoolHandler&#125;</div><div class="line"> </div><div class="line">        <span class="comment">// Timer</span></div><div class="line">        <span class="built_in">CFRunLoopTimer</span> &#123;firing = No, interval = <span class="number">3.1536e+09</span>, tolerance = <span class="number">0</span>,</div><div class="line">            next fire date = <span class="number">453098071</span> (<span class="number">-4421.76019</span> @ <span class="number">96223387169499</span>),</div><div class="line">            callout = _ZN2CAL14timer_callbackEP16__CFRunLoopTimerPv (QuartzCore.framework)&#125;</div><div class="line">    &#125;,</div><div class="line"> </div><div class="line">    modes ï¼ &#123;</div><div class="line">        <span class="built_in">CFRunLoopMode</span>  &#123;</div><div class="line">            sources0 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</div><div class="line">            sources1 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</div><div class="line">            observers = &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</div><div class="line">            timers =    &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="built_in">CFRunLoopMode</span>  &#123;</div><div class="line">            sources0 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</div><div class="line">            sources1 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</div><div class="line">            observers = &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</div><div class="line">            timers =    &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="built_in">CFRunLoopMode</span>  &#123;</div><div class="line">            sources0 = &#123;</div><div class="line">                <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>, &#123;</div><div class="line">                    callout = FBSSerialQueueRunLoopSourceHandler&#125;&#125;</div><div class="line">            &#125;,</div><div class="line">            sources1 = (null),</div><div class="line">            observers = &#123;</div><div class="line">                <span class="built_in">CFRunLoopObserver</span> &gt;&#123;activities = <span class="number">0xa0</span>, order = <span class="number">2000000</span>,</div><div class="line">                    callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv&#125;</div><div class="line">            )&#125;,</div><div class="line">            timers = (null),</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="built_in">CFRunLoopMode</span>  &#123;</div><div class="line">            sources0 = &#123;</div><div class="line">                <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">-1</span>, &#123;</div><div class="line">                    callout = PurpleEventSignalCallback&#125;&#125;</div><div class="line">            &#125;,</div><div class="line">            sources1 = &#123;</div><div class="line">                <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">-1</span>, &#123;</div><div class="line">                    callout = PurpleEventCallback&#125;&#125;</div><div class="line">            &#125;,</div><div class="line">            observers = (null),</div><div class="line">            timers = (null),</div><div class="line">        &#125;,</div><div class="line">        </div><div class="line">        <span class="built_in">CFRunLoopMode</span>  &#123;</div><div class="line">            sources0 = (null),</div><div class="line">            sources1 = (null),</div><div class="line">            observers = (null),</div><div class="line">            timers = (null),</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="AutoreleasePool"><a href="#AutoreleasePool" class="headerlink" title="AutoreleasePool"></a>AutoreleasePool</h3><p>AutoReleasePoolæ˜¯Appleä¸­æ¸…ç†ä¸´æ—¶å˜é‡ï¼Œé‡Šæ”¾å†…å®¹çš„æœºåˆ¶ï¼Œåœ¨appçš„mainå‡½æ•°ä¸­ï¼Œæ‰€æœ‰çš„å†…å®¹éƒ½æ˜¯åŒ…è£¹åœ¨ä¸€ä¸ªAutoReleasePoolä¸­çš„ã€‚åœ¨APPå¯åŠ¨åï¼ŒAppleåœ¨RunLoopä¸­æ³¨å†Œä¸‰ä¸ªRunLoopObserverï¼Œå…¶å›è°ƒéƒ½æ˜¯<code>_wrapRunLoopWithAutoreleasePoolHandler()</code>:</p><ul><li>ç¬¬ä¸€ä¸ªRunLoopObserverç›‘å¬<code>kCFRunLoopEntry</code>çŠ¶æ€ï¼Œcallbackå‡½æ•°ä¸­ä¼šè‡ªåŠ¨åˆ›å»ºautoReleasePoolï¼Œå…¶ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åº”ç”¨å¯åŠ¨åæ‰€æœ‰çš„æ“ä½œéƒ½åœ¨autoreleasePoolä¸­è¿è¡Œã€‚</li><li>ç¬¬äºŒä¸ªRunLoopObserverç›‘å¬<code>kCFRunLoopBeforeWaiting</code>çŠ¶æ€ï¼Œåœ¨æ­¤æ—¶autoreleasePoolä¼šé‡Šæ”¾æ—§çš„æ± (<code>_objc_autoreleasePoolPop()</code>)ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„autoreleasePool(<code>_objc_autoreleasePoolPush()</code>)ã€‚</li><li>ç¬¬ä¸‰ä¸ªRunLoopObserverå…³æ³¨<code>kCFRunLoopExit</code>çŠ¶æ€ï¼Œæ­¤æ—¶é‡Šæ”¾autoreleasePoolï¼Œå…¶ä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶é‡Šæ”¾æ± å­å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹åã€‚  </li></ul><p>æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">Person.m</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)personInitWithName:(<span class="built_in">NSString</span> *)name&#123;</div><div class="line"><span class="comment">//MRCå†…å­˜ç®¡ç†åŸåˆ™ï¼šè°åˆ›å»ºè°é‡Šæ”¾</span></div><div class="line">    Person *person = [[[Person alloc]init]autorelease];<span class="comment">//è‡ªåŠ¨é‡Šæ”¾æ±  å»¶æ—¶é‡Šæ”¾</span></div><div class="line">    person.name = name;</div><div class="line">    <span class="keyword">return</span> person;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line">vc.m</div><div class="line"><span class="meta">#import <span class="meta-string">"Person.h"</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span> ,<span class="keyword">assign</span>)Person *person1;</div><div class="line">- (<span class="keyword">void</span>)viewDidLoad&#123;</div><div class="line">    ........ </div><div class="line">    <span class="keyword">self</span>.person1 = [Person personInitWithName:<span class="string">@"name1"</span>];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,<span class="keyword">self</span>.person1.name);</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">IBAction</span>)clicked:(<span class="keyword">id</span>)sender &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"person.name:%@"</span>,<span class="keyword">self</span>.person1.name);<span class="comment">//MRCä¸‹ç‚¹å‡»æŒ‰é’®åæŠ¥é‡æŒ‡é’ˆé”™è¯¯</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>MRCå†…å­˜ç®¡ç†åŸåˆ™ï¼šè°åˆ›å»ºè°é‡Šæ”¾ã€‚åœ¨æ‰§è¡Œå®Œ<code>viewDidLoad</code>å<code>RunLoop</code>è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œæ—§æ± è¢«é‡Šæ”¾ï¼Œpersonå¯¹è±¡éšä¹‹é‡Šæ”¾ï¼Œåœ¨ç‚¹å‡»äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ<code>RunLoop</code>è¢«å”¤é†’ï¼Œåˆ›å»ºæ–°æ± ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šæŠ¥é”™ã€‚</p><p>é‚£ä¹ˆå¹³æ—¶å“ªé‡Œå¯ä»¥ç”¨åˆ°<code>autoreleasepool</code>å‘¢?</p><ul><li>ä½¿ç”¨<code>NSThread</code>åšå¤šçº¿ç¨‹å¼€å‘æ—¶ï¼Œéœ€è¦åœ¨çº¿ç¨‹è°ƒåº¦æ–¹æ³•ä¸­æ‰‹åŠ¨æ·»åŠ è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå¦åˆ™å¯èƒ½ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ï¼Œåé¢ä»‹ç»AFNæ—¶ä¼šæåˆ°ã€‚</li><li>å½“å¾ªç¯ä¸­åˆ›å»ºäº†å¤§é‡ä¸´æ—¶å¯¹è±¡ï¼Œå»ºè®®ä½¿ç”¨è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œç”¨æ¥å‡å°‘é«˜å†…å­˜å ç”¨ã€‚å¦‚ï¼š</li></ul><p>æƒ³äº†è§£æ›´å¤šå¯ä»¥çœ‹ä¸‹<a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/" target="_blank" rel="external">sunnyå¤§ç¥çš„autorelease</a></p><h3 id="äº‹ä»¶å“åº”ä¸æ‰‹åŠ¿è¯†åˆ«"><a href="#äº‹ä»¶å“åº”ä¸æ‰‹åŠ¿è¯†åˆ«" class="headerlink" title="äº‹ä»¶å“åº”ä¸æ‰‹åŠ¿è¯†åˆ«"></a>äº‹ä»¶å“åº”ä¸æ‰‹åŠ¿è¯†åˆ«</h3><p>RunLoopè§£é‡Šäº†ä¸ºä½•iOSåº”ç”¨èƒ½å¤Ÿæ¥å—åˆ°å±å¹•è§¦æ‘¸ç­‰äº‹ä»¶ã€‚åœ¨APPå¯åŠ¨åï¼ŒAppleåœ¨RunLoopä¸­æ³¨å†Œäº†ä¸€ä¸ªSource1ï¼ˆåŸºäºMach Portï¼‰ç”¨æ¥æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ï¼Œå…¶å›è°ƒå‡½æ•°ä¸º<code>__IOHIDEventSystemClientQueueCallback()</code>ã€‚  </p><p>å½“ä¸€ä¸ªç‚¹å‡»äº‹ä»¶å‘ç”Ÿä»¥åï¼ŒIOKitä¼šç”Ÿæˆä¸€ä¸ªIOHIDEventäº‹ä»¶ï¼Œå¹¶ç”±ç³»ç»Ÿå±‚é¢çš„SpringBoardæ¥å—æŒ‰é”®(é”å±/é™éŸ³)ã€è§¦æ‘¸ã€åŠ é€Ÿã€æ¥è¿‘ä¼ æ„Ÿå™¨ç­‰å‡ ç§Eventï¼Œç„¶åé€šè¿‡è¿›ç¨‹é—´é€šä¿¡çš„mach portå‘é€ç»™å½“å‰Appçš„main RunLoopï¼Œç„¶ååœ¨DoSource1ä¸­ï¼Œsource1çš„å›è°ƒä¼šè§¦å‘ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ç³»ç»Ÿ<code>_UIApplicationHandleEventQueue()</code>è¿›è¡Œäº‹ä»¶åˆ†å‘ã€‚</p><p><code>_UIApplicationHandleEventQueue()</code>æ–¹æ³•ä¼šæŠŠIOHIDEventå¤„ç†å¹¶åŒ…è£…æˆå¸¸è§çš„UIEventäº‹ä»¶è¿›è¡Œå¤„ç†æˆ–åˆ†å‘ï¼Œå…¶ä¸­åŒ…æ‹¬è¯†åˆ«UIGesture/å¤„ç†å±å¹•æ—‹è½¬/å‘é€ç»™UIWindowç­‰ï¼Œé€šå¸¸äº‹ä»¶æ¯”å¦‚UIButtonç‚¹å‡»/touchesBegin/Move/End/Cancelç­‰äº‹ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªSource1å›è°ƒä¸­å®Œæˆã€‚</p><p>å½“ä¸Šé¢çš„<code>_UIApplicationHandleEventQueue()</code>è¯†åˆ«äº†ä¸€ä¸ªæ‰‹åŠ¿æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨Cancelå°†å½“å‰çš„touchesBegin/Move/Endç³»åˆ—å›è°ƒæ‰“æ–­ã€‚éšåç³»ç»Ÿå°†å¯¹åº”çš„UIGestureRecognizeræ ‡è®°ä¸ºå¾…å¤„ç†ã€‚</p><p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ªObserverç›‘æµ‹BeforeWaiting(Loopå³å°†è¿›å…¥ä¼‘çœ )äº‹ä»¶ï¼Œè¿™ä¸ªObserverçš„å›è°ƒå‡½æ•°æ˜¯<code>_UIGestureRecognizerUpdateObserver()</code>ï¼Œå…¶å†…éƒ¨ä¼šè·å–æ‰€æœ‰åˆšè¢«æ ‡è®°ä¸ºå¾…å¤„ç†çš„GestureRecognizerï¼Œå¹¶æ‰§è¡ŒGestureRecognizerçš„å›è°ƒã€‚</p><p>å½“æœ‰ UIGestureRecognizer çš„å˜åŒ–(åˆ›å»º/é”€æ¯/çŠ¶æ€æ”¹å˜)æ—¶ï¼Œè¿™ä¸ªå›è°ƒéƒ½ä¼šè¿›è¡Œç›¸åº”å¤„ç†ã€‚</p><h3 id="ç•Œé¢æ›´æ–°"><a href="#ç•Œé¢æ›´æ–°" class="headerlink" title="ç•Œé¢æ›´æ–°"></a>ç•Œé¢æ›´æ–°</h3><p>å½“åœ¨æ“ä½œUIæ—¶ï¼Œæ¯”å¦‚æ”¹å˜äº†Frameã€æ›´æ–°äº†UIView/CALayerçš„å±‚æ¬¡æ—¶ï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨äº†UIView/CALayerçš„setNeedsLayout/setNeedsDisplayæ–¹æ³•åï¼Œè¿™ä¸ª UIView/CALayerå°±è¢«æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œå¹¶è¢«æäº¤åˆ°ä¸€ä¸ªå…¨å±€çš„å®¹å™¨å»ã€‚</p><p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘å¬ BeforeWaiting(Loopå³å°†è¿›å…¥ä¼‘çœ )å’Œ Exit(å³å°†é€€å‡ºLoop)äº‹ä»¶ï¼Œå›è°ƒå»æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°ï¼š<br><code>_ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv()</code>ã€‚è¿™ä¸ªå‡½æ•°é‡Œä¼šéå†æ‰€æœ‰å¾…å¤„ç†çš„UIView/CAlayerä»¥æ‰§è¡Œå®é™…çš„ç»˜åˆ¶å’Œè°ƒæ•´ï¼Œå¹¶æ›´æ–°UIç•Œé¢ã€‚</p><h3 id="PerformSelecter"><a href="#PerformSelecter" class="headerlink" title="PerformSelecter"></a>PerformSelecter</h3><p>å½“è°ƒç”¨NSObjectçš„<code>performSelecter:afterDelay:</code>/<code>performSelector:onThread:</code>åï¼Œå®é™…ä¸Šå…¶å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ªTimerå¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„RunLoopä¸­ã€‚æ‰€ä»¥å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰RunLoopï¼Œåˆ™è¿™ä¸ªæ–¹æ³•ä¼šå¤±æ•ˆã€‚</p><h3 id="GCDä¸RunLoop"><a href="#GCDä¸RunLoop" class="headerlink" title="GCDä¸RunLoop"></a>GCDä¸RunLoop</h3><p>å½“è°ƒç”¨<code>dispatch_async(dispatch_get_main_queue(), block)</code>æ—¶ï¼ŒlibDispatchä¼šå‘ä¸»çº¿ç¨‹çš„RunLoopå‘é€æ¶ˆæ¯ï¼ŒRunLoopä¼šè¢«å”¤é†’ï¼Œå¹¶ä»æ¶ˆæ¯ä¸­å–å¾—è¿™ä¸ªblockï¼Œå¹¶åœ¨å›è°ƒ<code>__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__()</code>é‡Œæ‰§è¡Œè¿™ä¸ª blockã€‚ä½†è¿™ä¸ªé€»è¾‘ä»…é™äºdispatchåˆ‡åˆ°ä¸»çº¿ç¨‹ï¼Œdispatchåˆ°å…¶ä»–çº¿ç¨‹ä»ç„¶æ˜¯ç”±libDispatchå¤„ç†çš„ã€‚</p><h2 id="RunLoopçš„åº”ç”¨ä¸¾ä¾‹"><a href="#RunLoopçš„åº”ç”¨ä¸¾ä¾‹" class="headerlink" title="RunLoopçš„åº”ç”¨ä¸¾ä¾‹"></a>RunLoopçš„åº”ç”¨ä¸¾ä¾‹</h2><p><code>RunLoop</code>ä¸ºAppleåšäº†é‚£ä¹ˆå¤šé‡è¦çš„äº‹ï¼Œé‚£ä¹ˆå®ƒèƒ½ç»™æˆ‘ä»¬å®é™…å¼€å‘ä¸­å¸¦æ¥ä»€ä¹ˆå‘¢ï¼Ÿ<br>ä¸¾ä¸€ä¸ªç®€å•çš„éœ€æ±‚ï¼Œæ€æ ·é¿å…tableViewåœ¨æ»‘åŠ¨æ—¶åŠ è½½å›¾ç‰‡é€ æˆçš„å¡é¡¿ï¼Ÿç­”æ¡ˆæ˜¯æŠŠåŠ è½½å›¾ç‰‡çš„ä»£ç æ”¾åˆ°<code>NSDefaultRunLoopMode</code>ä¸­æ‰§è¡Œï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="keyword">self</span>.imageView performSelector:<span class="keyword">@selector</span>(setImage:) withObject:downloadedImage afterDelay:<span class="number">0</span> inModes:@[<span class="built_in">NSDefaultRunLoopMode</span>]];</div></pre></td></tr></table></figure></p><p>è¿˜æœ‰æˆ‘ä»¬ç†Ÿæ‚‰çš„<code>AFNetworking</code>ä¹Ÿç”¨åˆ°äº†<code>RunLoop</code>ï¼Œ<code>AFURLConnectionOperation</code>è¿™ä¸ªç±»æ˜¯åŸºäº<code>NSURLConnection</code>æ„å»ºçš„ï¼Œæ‰€ä»¥å®ƒå¿…é¡»è¦<code>RunLoop</code>å»é©±åŠ¨ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">+ (<span class="keyword">void</span>)networkRequestThreadEntryPoint:(<span class="keyword">id</span>)__unused object &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="comment">// æ³¨å†Œçº¿ç¨‹</span></div><div class="line">        [[<span class="built_in">NSThread</span> currentThread] setName:<span class="string">@"AFNetworking"</span>];</div><div class="line">        <span class="comment">// æ·»åŠ Porté˜²æ­¢RunLoopé€€å‡º</span></div><div class="line">        <span class="built_in">NSRunLoop</span> *runLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</div><div class="line">        [runLoop addPort:[<span class="built_in">NSMachPort</span> port] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</div><div class="line">        [runLoop run];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">NSThread</span> *)networkRequestThread &#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">NSThread</span> *_networkRequestThread = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> oncePredicate;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;oncePredicate, ^&#123;</div><div class="line">        _networkRequestThread =</div><div class="line">        [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span></div><div class="line">                                selector:<span class="keyword">@selector</span>(networkRequestThreadEntryPoint:)</div><div class="line">                                  object:<span class="literal">nil</span>];</div><div class="line">        [_networkRequestThread start];</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> _networkRequestThread;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>è¿™ç§åˆ›å»ºä¸€ä¸ªå¸¸é©»çº¿ç¨‹çš„æ€è·¯å€¼å¾—å­¦ä¹ ã€‚</p><p>è¿˜æœ‰æ¯”è¾ƒè‘—åçš„æ¡†æ¶ASDkï¼Œå®ƒæŠŠç•Œé¢æ’ç‰ˆã€ç»˜åˆ¶æ”¾åœ¨åå°æ‰§è¡Œï¼Œåˆ©ç”¨<code>RunLoop</code>é—²æ—¶å»ä¸»çº¿ç¨‹æ›´æ–°ç•Œé¢ï¼Œä»è€Œæ—¶ä¿æŒç•Œé¢çš„æµç•…ï¼Œå…·ä½“ç»†èŠ‚è¯·è§<a href="https://draveness.me/asdk-rendering" target="_blank" rel="external">ä½¿ç”¨ ASDK æ€§èƒ½è°ƒä¼˜ - æå‡ iOS ç•Œé¢çš„æ¸²æŸ“æ€§èƒ½</a>ã€‚</p><p>è§£å†³åœ¨tableViewä¸­åŒæ—¶åŠ è½½å¤šä¸ªå¤§å›¾å¡é¡¿çš„é—®é¢˜ï¼Œæ–¹æ¡ˆè§<a href="https://github.com/diwu/RunLoopWorkDistribution" target="_blank" rel="external">RunLoopWorkDistribution</a></p><p>ç›‘æ§Appå¡é¡¿<a href="https://github.com/suifengqjn/PerformanceMonitor" target="_blank" rel="external">PerformanceMonitor</a></p><h2 id="NSRunLoop"><a href="#NSRunLoop" class="headerlink" title="NSRunLoop"></a>NSRunLoop</h2><p>æœ€åæˆ‘ä»¬å›åˆ°åŸç‚¹ï¼Œæ€»ç»“ä¸€ä¸‹<code>NSRunLoop</code>çš„ä½¿ç”¨æ–¹æ³•ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Modeä¸ºé»˜è®¤çš„NSDefaultRunLoopModeæ¨¡å¼ï¼Œæ²¡æœ‰è¶…æ—¶é™åˆ¶</span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"></div><div class="line"><span class="comment">// Modeä¸ºé»˜è®¤çš„NSDefaultRunLoopModeæ¨¡å¼ï¼Œå‚æ•°ä¸ºè¿æ—¶é—´æœŸé™</span></div><div class="line">- (<span class="keyword">void</span>)runUntilDate:(<span class="built_in">NSDate</span> *)limitDate;</div><div class="line"></div><div class="line"><span class="comment">// è‡ªå®šä¹‰RunLoop Modeã€æ—¶é—´æœŸé™</span></div><div class="line">- (<span class="built_in">BOOL</span>)runMode:(<span class="built_in">NSString</span> *)mode beforeDate:(<span class="built_in">NSDate</span> *)limitDate;</div></pre></td></tr></table></figure></p><h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><ul><li>å¾ªç¯ä¸€æ—¦å¼€å¯ï¼Œå°±å…³é—­ä¸äº†ï¼Œå¹¶ä¸”ä¹‹åçš„ä»£ç å°±æ— æ³•æ‰§è¡Œã€‚apiæ–‡æ¡£ä¸­æåˆ°ï¼šå¦‚æœæ²¡æœ‰è¾“å…¥æºå’Œå®šæ—¶æºåŠ å…¥åˆ°runloopä¸­ï¼Œrunloopå°±é©¬ä¸Šé€€å‡ºï¼Œå¦åˆ™é€šè¿‡é¢‘ç¹è°ƒç”¨<code>-runMode:beforeDate:</code>æ–¹æ³•æ¥è®©runloopè¿è¡Œåœ¨NSDefaultRunLoopModeæ¨¡å¼ä¸‹ã€‚ä½†æ˜¯ï¼Œ<strong>äººä¸ºåœ°ç§»é™¤è¾“å…¥æºã€timerä¸èƒ½ä¿è¯runloopä¼šé€€å‡º</strong>ï¼Œå› ä¸ºç³»ç»Ÿæœ‰å¯èƒ½ä¼šè‡ªå·±æ·»åŠ ä¸€äº›æºæ¥å¤„ç†äº‹ä»¶ã€‚ï¼ˆä¸‹é¢ä¸¤ç§æ–¹æ³•ä¹Ÿæ˜¯ï¼‰</li><li>æ— æ³•ç”¨CFRunLoopStop(runloopRef)é€€å‡ºï¼Œè¿™ç§æ–¹å¼å¯åŠ¨çš„runloopä¸åˆ©äºæ§åˆ¶ï¼Œä¸å»ºè®®ä½¿ç”¨</li></ul><h3 id="runUntilDate"><a href="#runUntilDate" class="headerlink" title="runUntilDate:"></a>runUntilDate:</h3><ul><li>è¿è¡Œåœ¨<code>NSDefaultRunLoopMode</code>æ¨¡å¼ï¼Œæœ‰è¶…æ—¶æ—¶é—´é™åˆ¶ã€‚å®ƒå®é™…ä¸Šä¹Ÿæ˜¯ä¸æ–­è°ƒç”¨<code>-runMode:beforeDate:</code>æ–¹æ³•æ¥è®©runloopè¿è¡Œåœ¨<code>NSDefaultRunLoopMode</code>æ¨¡å¼ä¸‹ï¼Œç›´åˆ°åˆ°è¾¾è¶…æ—¶æ—¶é—´ã€‚è°ƒç”¨<code>CFRunLoopStop(runloopRef)</code>æ— æ³•åœæ­¢RunLoopçš„è¿è¡Œã€‚ä¸ºä»€ä¹ˆå‘¢..å› ä¸ºè¿™ä¸ªæ–¹æ³•åªä¼šç»“æŸå½“å‰<code>-runMode:beforeDate:</code>çš„è°ƒç”¨ï¼Œä¹‹åçš„<code>-runMode:beforeDate:</code>è¯¥è°ƒç”¨çš„è¿˜æ˜¯ä¼šç»§ç»­ã€‚ã€‚ã€‚ç›´åˆ°timeoutã€‚</li><li>å¯¹åº”<code>CFRunLoopRunInMode(kCFRunLoopDefaultMode,limiteDate,false)</code>ã€‚</li></ul><h3 id="runMode-beforeDate"><a href="#runMode-beforeDate" class="headerlink" title="runMode:beforeDate:"></a>runMode:beforeDate:</h3><ul><li>ç›¸æ¯”ä¸Šä¸€ç§æ–¹æ³•å¯ä»¥æŒ‡å®šè¿è¡Œæ¨¡å¼ã€‚å¯¹åº”<code>CFRunLoopRunInMode(mode,limiteDate,true)</code>æ–¹æ³•,åªæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œå®Œå°±é€€å‡ºã€‚</li><li>å¯ä»¥ç”¨<code>CFRunLoopStop(runloopRef)</code>é€€å‡ºrunloopã€‚åœ¨ç¬¬ä¸€ä¸ªinput sourceï¼ˆétimerï¼‰è¢«å¤„ç†æˆ–åˆ°è¾¾limitDateä¹‹årunloopé€€å‡ºã€‚</li></ul><p>OKï¼Œå…³äºRunLoopå°±æ€»ç»“åˆ°è¿™ï¼Œæ„Ÿè°¢å„ä½å¤§ä½¬çš„æ–‡ç« è®©æˆ‘èƒ½å¤Ÿææ‡‚è¿™ä¹ˆâ€é«˜ç«¯â€çš„ä¸œè¥¿ï¼Œå†æ¬¡çŒ®ä¸Šæˆ‘çš„è†ç›–orzï¼</p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">æ·±å…¥ç†è§£RunLoop</a><br><a href="http://v.youku.com/v_show/id_XODgxODkzODI0.html?spm=a2h0k.8191407.0.0&amp;from=s1.8-1-1.2" target="_blank" rel="external">sunnyxxRunLoopè®²è§£è§†é¢‘</a><br><a href="https://pan.baidu.com/s/1hrMRp0C" target="_blank" rel="external">å½¦ç¥–RunLoopè®²è§£è§†é¢‘</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰ä¸¤ç¯‡æ€»ç»“äº†&lt;code&gt;Runtime&lt;/code&gt;çš„çŸ¥è¯†ç‚¹ï¼Œè¿™ç¯‡å°±é¡ºä¾¿æ¥çœ‹ä¸‹å®ƒçš„åŒå§“å…„å¼Ÿ&lt;code&gt;RunLoop&lt;/code&gt;å§~&lt;/p&gt;
&lt;h2 id=&quot;æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚å¿µ&quot;&gt;&lt;/a&gt;æ¦‚å¿µ&lt;/h2&gt;&lt;p&gt;&lt;code&gt;RunLoop&lt;/code&gt;ç›´è¯‘è¿‡æ¥å°±æ˜¯ä¸€ç›´åœ¨è·‘çš„å¾ªç¯ã€‚ä¹Ÿè®¸å¹³æ—¶æˆ‘ä»¬å¾ˆå°‘ç”¨å®ƒï¼Œä½†æ˜¯APPçš„è¿è¡Œç¦»ä¸å¼€å®ƒï¼Œå½“APPå¯åŠ¨æ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œå¹¶å¯åŠ¨ä¸»çº¿ç¨‹çš„&lt;code&gt;RunLoop&lt;/code&gt;ï¼Œ&lt;code&gt;RunLoop&lt;/code&gt;ä¼šä¸æ–­å¾ªç¯ä½¿ç¨‹åºä¸€ç›´è¿è¡Œï¼Œå¹¶ç›‘å¬ç”¨æˆ·çš„å„ç§æ“ä½œï¼Œç„¶åæŠŠæ¶ˆæ¯åˆ†å‘ç»™çº¿ç¨‹æ¥å¤„ç†ï¼›å½“çº¿ç¨‹ç©ºé—²æ—¶ï¼Œ&lt;code&gt;RunLoop&lt;/code&gt;è¿˜ä¼šè®©çº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œè¾¾åˆ°çœç”µçš„æ•ˆæœã€‚è¿™ç§æ¨¡å¼è¢«ç§°ä¸º&lt;strong&gt;äº‹ä»¶é©±åŠ¨æ¨¡å‹&lt;/strong&gt;ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š&lt;br&gt;
    
    </summary>
    
    
      <category term="RunLoop" scheme="http://wonkeyz.com/tags/RunLoop/"/>
    
  </entry>
  
  <entry>
    <title>Runtimeå­¦ä¹ æ€»ç»“ï¼ˆäºŒï¼‰</title>
    <link href="http://wonkeyz.com/2017/07/15/Runtime-Learning-summary-2/"/>
    <id>http://wonkeyz.com/2017/07/15/Runtime-Learning-summary-2/</id>
    <published>2017-07-15T08:59:05.000Z</published>
    <updated>2017-11-23T07:35:09.321Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šå›ï¼Œæˆ‘ä»¬æ¥è¯´ä¸€ä¸‹<code>runtime</code>æœ€æœ‰è¶£çš„éƒ¨åˆ†ï¼Œæ–¹æ³•å’Œæ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼ˆå¸Œæœ›æˆ‘èƒ½å†™çš„æœ‰è¶£ğŸ˜‚ï¼‰ã€‚</p><h2 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h2><p>é¡¾åæ€ä¹‰æˆ‘ä»¬å¸¸è¯´çš„æ–¹æ³•å°±æ˜¯<code>Method</code>ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> method_t *Method;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> method_t &#123;</div><div class="line">    SEL name;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *types;  <span class="comment">//ç”¨æ¥å­˜å‚¨ç€æ–¹æ³•çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹</span></div><div class="line">    IMP imp;</div><div class="line"></div><div class="line">    <span class="keyword">struct</span> SortBySELAddress :</div><div class="line">        public std::binary_function&lt;<span class="keyword">const</span> method_t&amp;,</div><div class="line">                                    <span class="keyword">const</span> method_t&amp;, <span class="keyword">bool</span>&gt;</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">bool</span> operator() (<span class="keyword">const</span> method_t&amp; lhs,</div><div class="line">                         <span class="keyword">const</span> method_t&amp; rhs)</div><div class="line">        &#123; <span class="keyword">return</span> lhs.name &lt; rhs.name; &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p><a id="more"></a><p>æ¥çœ‹ä¸€ä¸‹å‡ ä¸ªå‚æ•°ï¼š</p><h3 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h3><p><code>name</code>ï¼šæ–¹æ³•åï¼Œç±»å‹ä¸º<code>SEL</code>ï¼Œå³æ–¹æ³•é€‰æ‹©å™¨ï¼Œæ˜¯ä¸€ä¸ªæŒ‡å‘æ–¹æ³•çš„æŒ‡é’ˆï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_selector *SEL;</div></pre></td></tr></table></figure></p><p>æ–¹æ³•çš„<code>selector</code>ç”¨äºæ–¹æ³•è¡¨ç¤ºè¿è¡Œæ—¶çš„åå­—ã€‚Objective-Cåœ¨ç¼–è¯‘æ—¶ï¼Œä¼šä¾æ®æ¯ä¸€ä¸ªæ–¹æ³•çš„åå­—ã€å‚æ•°åºåˆ—ï¼Œç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æ•´å‹æ ‡è¯†(<code>Int</code>ç±»å‹çš„åœ°å€)ï¼Œè¿™ä¸ªæ ‡è¯†å°±æ˜¯<code>SEL</code>ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºåŒºåˆ†æ–¹æ³•çš„IDã€‚<br>ä¸åŒç±»ä¸­ç›¸åŒåå­—çš„æ–¹æ³•æ‰€å¯¹åº”çš„æ–¹æ³•é€‰æ‹©å™¨æ˜¯ç›¸åŒçš„ï¼Œå³ä½¿æ–¹æ³•åå­—ç›¸åŒè€Œå˜é‡ç±»å‹ä¸åŒä¹Ÿä¼šå¯¼è‡´å®ƒä»¬å…·æœ‰ç›¸åŒçš„<code>SEL</code>ï¼Œæ‰€ä»¥Objective-Cä¸­æ–¹æ³•å‘½åæœ‰æ—¶ä¼šå¸¦ä¸Šå‚æ•°ç±»å‹(å¦‚<code>[[NSNumber alloc] initWithInt:5]</code>)ï¼Œè¿™ä¹Ÿç›´æ¥å¯¼è‡´äº†OCçš„æ–¹æ³•åé•¿çš„ä¸€æ‰¹â€¦é‚£ä¹ˆä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºå·¥ç¨‹ä¸­çš„æ‰€æœ‰çš„<code>SEL</code>ç»„æˆä¸€ä¸ª<code>Set</code>é›†åˆï¼Œ<code>Set</code>çš„ç‰¹ç‚¹å°±æ˜¯å”¯ä¸€ï¼Œå› æ­¤SELæ˜¯å”¯ä¸€çš„ï¼Œè¿™åŠ å¿«äº†æ–¹æ³•çš„æŸ¥è¯¢é€Ÿåº¦ã€‚<br><code>SEL</code>ç›¸å…³æ“ä½œå‡½æ•°ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è·å–æ–¹æ³•é€‰æ‹©å™¨åç§°</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * sel_getName ( SEL sel );</div><div class="line"></div><div class="line"><span class="comment">// å‘è¿è¡Œæ—¶ç³»ç»Ÿæ³¨å†Œä¸€ä¸ªæ–¹æ³•åç§°ï¼Œå°†æ–¹æ³•åæ˜ å°„åˆ°ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œå¹¶è¿”å›è¿™ä¸ªé€‰æ‹©å™¨ï¼Œå¦‚æœè¯¥æ–¹æ³•åç§°å·²ç»æ³¨å†Œï¼Œåˆ™ç›´æ¥è¿”å›å…¶å¯¹åº”çš„SEL</span></div><div class="line">SEL sel_registerName ( <span class="keyword">const</span> <span class="keyword">char</span> *str );</div><div class="line"></div><div class="line"><span class="comment">// å‘è¿è¡Œæ—¶ç³»ç»Ÿæ³¨å†Œä¸€ä¸ªæ–¹æ³•åç§°ï¼Œæ–¹æ³•å®ç°ç­‰åŒäºsel_registerName</span></div><div class="line">SEL sel_getUid ( <span class="keyword">const</span> <span class="keyword">char</span> *str );</div><div class="line"></div><div class="line"><span class="comment">// æ¯”è¾ƒä¸¤ä¸ªé€‰æ‹©å™¨</span></div><div class="line"><span class="built_in">BOOL</span> sel_isEqual ( SEL lhs, SEL rhs );</div></pre></td></tr></table></figure></p><h3 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h3><p><code>imp</code>ï¼šæ–¹æ³•çš„å®ç°ï¼Œç±»å‹ä¸º<code>IMP</code>ï¼Œæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (*IMP)(<span class="keyword">void</span> <span class="comment">/* id, SEL, ... */</span> );</div></pre></td></tr></table></figure></p><p>è¿™ä¸ªå‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°å°±æ˜¯æˆ‘ä»¬è¦æ‰§è¡Œæ–¹æ³•çš„å®ç°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘<code>self</code>çš„æŒ‡é’ˆ(å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼ŒæŒ‡å‘ç±»å®ä¾‹çš„å†…å­˜åœ°å€ï¼›å¦‚æœæ˜¯ç±»æ–¹æ³•ï¼Œåˆ™æ˜¯æŒ‡å‘å…ƒç±»çš„æŒ‡é’ˆ)ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯<code>SEL</code>ï¼Œæ¥ä¸‹æ¥æ˜¯æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ã€‚ å¦‚æœæˆ‘ä»¬æ‹¿åˆ°äº†<code>IMP</code>ï¼Œå°±æ„å‘³ç€å¾—åˆ°äº†æ‰§è¡ŒæŸä¸ªå®ä¾‹æŸä¸ªæ–¹æ³•çš„å…¥å£ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»•å¼€æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œç›´æ¥æ‰§è¡Œæ–¹æ³•ï¼Œè¿™åœ¨åé¢ä¼šæåˆ°ã€‚<br>æ¯ä¸ªæ–¹æ³•åéƒ½å¯¹åº”ä¸€ä¸ª<code>SEL</code>ç±»å‹çš„æ–¹æ³•é€‰æ‹©å™¨ï¼Œè€Œæ¯ä¸ªå®ä¾‹å¯¹è±¡ä¸­çš„<code>SEL</code>å¯¹åº”çš„æ–¹æ³•å®ç°è‚¯å®šæ˜¯å”¯ä¸€çš„ï¼Œé€šè¿‡ä¸€ç»„<code>id</code>å’Œ<code>SEL</code>å‚æ•°å°±èƒ½ç¡®å®šå”¯ä¸€çš„æ–¹æ³•å®ç°åœ°å€ï¼Œåä¹‹äº¦ç„¶ï¼Œ<code>SEL</code>ä¸<code>IMP</code>å½¢æˆæ˜ å°„å…³ç³»ã€‚<br><code>IMP</code>ç›¸å…³æ“ä½œå‡½æ•°ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è·å¾—æ–¹æ³•çš„å®ç°</span></div><div class="line">method_getImplementation( Method method);</div><div class="line"></div><div class="line"><span class="comment">// è®¾ç½®æ–¹æ³•çš„å®ç°ï¼ˆè¯¥å‡½æ•°è¿”å›å€¼æ˜¯æ–¹æ³•è®¾ç½®å‰çš„å®ç°ï¼‰</span></div><div class="line">IMP method_setImplementation( Method method, IMP imp);</div><div class="line"></div><div class="line"><span class="comment">// äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°</span></div><div class="line"><span class="keyword">void</span> method_exchangeImplementations( Method m1, Method m2);</div></pre></td></tr></table></figure></p><h3 id="Methodç›¸å…³æ“ä½œå‡½æ•°"><a href="#Methodç›¸å…³æ“ä½œå‡½æ•°" class="headerlink" title="Methodç›¸å…³æ“ä½œå‡½æ•°"></a>Methodç›¸å…³æ“ä½œå‡½æ•°</h3><p>é™¤äº†ä¸Šé¢æåˆ°çš„ä¸€äº›ï¼Œè¿˜æœ‰ä»¥ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è°ƒç”¨æŒ‡å®šæ–¹æ³•çš„å®ç°</span></div><div class="line"><span class="keyword">id</span> method_invoke ( <span class="keyword">id</span> receiver, Method m, ... );</div><div class="line"><span class="comment">// è°ƒç”¨è¿”å›ä¸€ä¸ªæ•°æ®ç»“æ„çš„æ–¹æ³•çš„å®ç°</span></div><div class="line"><span class="keyword">void</span> method_invoke_stret ( <span class="keyword">id</span> receiver, Method m, ... );</div><div class="line"><span class="comment">// è·å–æ–¹æ³•å</span></div><div class="line">SEL method_getName ( Method m );</div><div class="line"><span class="comment">// è·å–æè¿°æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼ç±»å‹çš„å­—ç¬¦ä¸²</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * method_getTypeEncoding ( Method m );</div><div class="line"><span class="comment">// è·å–æ–¹æ³•çš„è¿”å›å€¼ç±»å‹çš„å­—ç¬¦ä¸²</span></div><div class="line"><span class="keyword">char</span> * method_copyReturnType ( Method m );</div><div class="line"><span class="comment">// è·å–æ–¹æ³•çš„æŒ‡å®šä½ç½®å‚æ•°çš„ç±»å‹å­—ç¬¦ä¸²</span></div><div class="line"><span class="keyword">char</span> * method_copyArgumentType ( Method m, <span class="keyword">unsigned</span> <span class="keyword">int</span> index );</div><div class="line"><span class="comment">// é€šè¿‡å¼•ç”¨è¿”å›æ–¹æ³•çš„è¿”å›å€¼ç±»å‹å­—ç¬¦ä¸²</span></div><div class="line"><span class="keyword">void</span> method_getReturnType ( Method m, <span class="keyword">char</span> *dst, size_t dst_len );</div><div class="line"><span class="comment">// è¿”å›æ–¹æ³•çš„å‚æ•°çš„ä¸ªæ•°</span></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> method_getNumberOfArguments ( Method m );</div><div class="line"><span class="comment">// é€šè¿‡å¼•ç”¨è¿”å›æ–¹æ³•æŒ‡å®šä½ç½®å‚æ•°çš„ç±»å‹å­—ç¬¦ä¸²</span></div><div class="line"><span class="keyword">void</span> method_getArgumentType ( Method m, <span class="keyword">unsigned</span> <span class="keyword">int</span> index, <span class="keyword">char</span> *dst, size_t dst_len );</div><div class="line"><span class="comment">// è¿”å›æŒ‡å®šæ–¹æ³•çš„æ–¹æ³•æè¿°ç»“æ„ä½“</span></div><div class="line"><span class="keyword">struct</span> objc_method_description * method_getDescription ( Method m );</div></pre></td></tr></table></figure></p><ul><li><code>method_invoke</code>å‡½æ•°ï¼Œè¿”å›çš„æ˜¯å®é™…å®ç°çš„è¿”å›å€¼ã€‚å‚æ•°<code>receiver</code>ä¸èƒ½ä¸ºç©ºã€‚è¿™ä¸ªæ–¹æ³•çš„æ•ˆç‡ä¼šæ¯”<code>method_getImplementation</code>å’Œ<code>method_getName</code>æ›´å¿«ã€‚</li><li><code>method_getName</code>å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªSELã€‚å¦‚æœæƒ³è·å–æ–¹æ³•åçš„Cå­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½¿ç”¨<code>sel_getName(method_getName(method))</code>ã€‚</li></ul><h3 id="Method-Swizzling"><a href="#Method-Swizzling" class="headerlink" title="Method Swizzling"></a>Method Swizzling</h3><p>æˆ‘æƒ³å¤§å®¶é¡¹ç›®é‡Œå¤šå¤šå°‘å°‘éƒ½ä¼šç”¨åˆ°<code>Method Swizzling</code>ï¼Œå®ƒé€šè¿‡<code>class_replaceMethod</code>ï¼Œ<code>method_exchangeImplementations</code>å‡½æ•°æ¥é‡æ–°æ˜ å°„æ–¹æ³•å¯¹åº”çš„å®ç°ï¼Œæ˜¯é¢å‘åˆ‡é¢ç¼–ç¨‹çš„çš„ä¸€ç§å®è·µï¼Œå®ƒçš„äº¤æ¢åŸç†å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">IMP imp1 = method_getImplementation(m1);</div><div class="line">IMP imp2 = method_getImplementation(m2);</div><div class="line">method_setImplementation(m1, imp2);</div><div class="line">method_setImplementation(m2, imp1);</div></pre></td></tr></table></figure></p><p>è¿™é‡Œå°±ä¸æ”¾<code>Method Swizzling</code>å®ç°ä»£ç äº†ï¼Œå¤§å®¶åº”è¯¥éƒ½èƒ½èƒŒä¸‹æ¥äº†ï¼Œè¯´å‡ ç‚¹è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p><ul><li><code>Method Swizzling</code>åº”è¯¥æ€»åœ¨<code>+load</code>ä¸­æ‰§è¡Œï¼šObjective-Cåœ¨è¿è¡Œæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ç±»çš„ä¸¤ä¸ªæ–¹æ³•<code>+load</code>å’Œ<code>+initialize</code>ã€‚<code>+load</code>ä¼šåœ¨ç±»åˆå§‹åŠ è½½æ—¶è°ƒç”¨ï¼Œ<code>+initialize</code>ä¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ç±»çš„ç±»æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•ä¹‹å‰è¢«è°ƒç”¨ï¼Œè¿™å°±æ„å‘³ç€<code>+initialize</code>ä¸ä¸€å®šè¢«è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨<code>+load</code>èƒ½ä¿è¯åœ¨ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¢«åŠ è½½ï¼Œå¹¶ä¿è¯è¿™ç§æ”¹å˜åº”ç”¨çº§åˆ«çš„è¡Œä¸ºçš„ä¸€è‡´æ€§ã€‚</li><li><code>Method Swizzling</code>åº”è¯¥æ€»æ˜¯åœ¨<code>dispatch_once</code>ä¸­æ‰§è¡Œï¼š<code>Method Swizzling</code>ä¼šæ”¹å˜å…¨å±€çŠ¶æ€ï¼Œæ‰€ä»¥åº”ç¡®ä¿æ— è®ºæœ‰å¤šå°‘çº¿ç¨‹<code>method swizzling</code>åªè¢«æ‰§è¡Œäº†ä¸€æ¬¡ï¼Œ<code>dispatch_once</code>å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</li><li>ç†æ¸…<code>Method</code>ã€<code>SEL</code>ã€<code>IMP</code>ä¸‰è€…å…³ç³»ï¼šä¸€ä¸ªç±»ç»´æŠ¤ä¸€ä¸ªè¿è¡Œæ—¶å¯æ¥æ”¶çš„æ¶ˆæ¯åˆ†å‘è¡¨ï¼›åˆ†å‘è¡¨ä¸­çš„æ¯ä¸ªå…¥å£æ˜¯ä¸€ä¸ªæ–¹æ³•(<code>Method</code>)ï¼Œå…¶ä¸­keyæ˜¯ä¸€ä¸ªç‰¹å®šåç§°ï¼Œå³é€‰æ‹©å™¨(<code>SEL</code>)ï¼Œå…¶å¯¹åº”ä¸€ä¸ªå®ç°(<code>IMP</code>)ï¼Œå³æŒ‡å‘åº•å±‚Cå‡½æ•°çš„æŒ‡é’ˆã€‚ä¸ºäº†swizzleä¸€ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆ†å‘è¡¨ä¸­å°†ä¸€ä¸ªæ–¹æ³•çš„ç°æœ‰çš„é€‰æ‹©å™¨æ˜ å°„åˆ°ä¸åŒçš„å®ç°ï¼Œè€Œå°†è¯¥é€‰æ‹©å™¨å¯¹åº”çš„åŸå§‹å®ç°å…³è”åˆ°ä¸€ä¸ªæ–°çš„é€‰æ‹©å™¨ä¸­ã€‚</li><li>è°¨æ…ä½¿ç”¨ï¼š<code>Method Swizzling</code>è™½ç„¶æ˜¯â€œé»‘ç§‘æŠ€â€ï¼Œä½†æ˜¯è¿™ä¸€åˆ‡éƒ½å‘ç”Ÿçš„æ‚„æ— å£°æ¯ï¼Œç»™ä»£ç çš„ç»´æŠ¤å¸¦æ¥äº†ä¸€äº›éº»çƒ¦ï¼Œç”šè‡³ä¼šäº§ç”Ÿéš¾ä»¥æ’æŸ¥çš„bugï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨<code>method swizzling</code>æ—¶è¦è°¨æ…ï¼Œè®°å¾—äº¤æ¢å®Œå†è°ƒå›è‡ªå·±ï¼Œä¿è¯åªäº¤æ¢ä¸€æ¬¡ï¼Œå¦åˆ™å°±ä¼šä¹±å¥—ã€‚<br>å¦‚æœä½ è¿˜æƒ³æ›´æ·±å…¥çš„äº†è§£<code>Method Swizzling</code>ï¼Œå¯ä»¥çœ‹ä¸‹è¿™äº›å¥½æ–‡ï¼š<br><a href="http://yulingtianxia.com/blog/2017/04/17/Objective-C-Method-Swizzling/" target="_blank" rel="external">Objective-C Method Swizzling</a><br><a href="http://blog.csdn.net/yiyaaixuexi/article/details/9374411" target="_blank" rel="external">Objective-Cçš„hookæ–¹æ¡ˆï¼ˆä¸€ï¼‰: Method Swizzling</a></li></ul><h2 id="æ¶ˆæ¯æœºåˆ¶"><a href="#æ¶ˆæ¯æœºåˆ¶" class="headerlink" title="æ¶ˆæ¯æœºåˆ¶"></a>æ¶ˆæ¯æœºåˆ¶</h2><p>é‡å¤´æˆæ¥äº†ï¼ŒObjective-Cä¸­å‘é€æ¶ˆæ¯æ˜¯ç”¨ä¸­æ‹¬å·ï¼ˆ<code>[]</code>ï¼‰æŠŠæ¥æ”¶è€…å’Œæ¶ˆæ¯æ‹¬èµ·æ¥ï¼Œè€Œç›´åˆ°è¿è¡Œæ—¶æ‰ä¼šæŠŠæ¶ˆæ¯ä¸æ–¹æ³•å®ç°ç»‘å®šã€‚</p><h3 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h3><p>å½“æ‰§è¡Œ<code>[receiver message]</code>ä»£ç æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶è½¬åŒ–ä¸ºè°ƒç”¨<code>objc_msgSend</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">objc_msgSend(receiver, selector, arg1, arg2, ...)</div></pre></td></tr></table></figure></p><p>è¿™ä¸ªå‡½æ•°é€šè¿‡<code>receiver</code>å’Œ<code>selector</code>æ‰¾åˆ°äº†æ–¹æ³•çš„å®ç°ï¼Œæ‰¾åˆ°åè°ƒç”¨æ–¹æ³•çš„å®ç°ï¼Œå¹¶å°†<code>receiver</code>å’Œ<code>arg</code>ä¼ ç»™æ–¹æ³•å®ç°ï¼Œæœ€åæŠŠæ–¹æ³•å®ç°çš„è¿”å›å€¼ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚<br>é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆæ‰¾åˆ°æ–¹æ³•å®ç°çš„å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ­¥éª¤ï¼š<br>1.æ£€æµ‹è¿™ä¸ª<code>selector</code>æ˜¯ä¸æ˜¯è¦å¿½ç•¥çš„ã€‚æ¯”å¦‚<code>Mac OS X</code>å¼€å‘ï¼Œæœ‰äº†åƒåœ¾å›æ”¶å°±ä¸ç†ä¼š<code>retain</code>,<code>release</code>è¿™äº›å‡½æ•°äº†ã€‚<br>2.æ£€æµ‹è¿™ä¸ª<code>receiver</code>æ˜¯ä¸æ˜¯<code>nil</code>ã€‚ç»™ä¸€ä¸ªç©ºå¯¹è±¡å‘é€æ¶ˆæ¯ä¼šè¢«å¿½ç•¥æ‰ã€‚<br>3.æŸ¥æ‰¾è¿™ä¸ªç±»çš„<code>IMP</code>ï¼Œå…ˆä»<code>cache</code>é‡Œé¢æ‰¾ï¼Œæ‰¾åˆ°å°±è·³åˆ°å¯¹åº”çš„å‡½æ•°å»æ‰§è¡Œã€‚<br>4.å¦‚æœ<code>cache</code>æ‰¾ä¸åˆ°å°±å»ç±»çš„<code>methodLists</code>é‡Œæ‰¾ã€‚<br>5.å¦‚æœ<code>methodLists</code>æ‰¾ä¸åˆ°å°±ç”¨å¯¹è±¡çš„<code>isa</code>åˆ°çˆ¶ç±»çš„<code>methodLists</code>å»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æ ¹ç±»ä¸ºæ­¢ã€‚ï¼ˆè¿™ä¸€å¥—ä¸‹æ¥è¿˜æ‰¾ä¸åˆ°å°±è¿›å…¥<strong>åŠ¨æ€æ–¹æ³•è§£æ</strong>ï¼Œç¨ååˆ†æï¼‰<br>ç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µåœ¨<code>objc_msgSend</code>ï¼Œ<code>objc_msgSend_stret</code>ï¼Œ<code>objc_msgSendSuper</code>ï¼Œæˆ–<code>objc_msgSendSuper_stret</code>å››ä¸ªæ–¹æ³•ä¸­é€‰ä¸€ä¸ªè°ƒç”¨ã€‚å¦‚æœæ˜¯ä¼ é€’ç»™è¶…ç±»å°±ä¼šè°ƒç”¨å¸¦Superçš„å‡½æ•°ï¼Œå¦‚æœè¿”å›å€¼æ˜¯æ•°æ®ç»“æ„è€Œä¸æ˜¯ç®€å•å€¼æ—¶å°±ä¼šè°ƒç”¨å¸¦stretçš„å‡½æ•°ã€‚åœ¨i386å¹³å°è¿”å›ç±»å‹ä¸ºæµ®ç‚¹æ¶ˆæ¯ä¼šè°ƒç”¨<code>objc_msgSend_fpret</code>å‡½æ•°ã€‚</p><h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Son</span> : <span class="title">Father</span></span></div><div class="line">- (<span class="keyword">id</span>)init &#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">super</span> <span class="keyword">class</span>]));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//è¾“å‡ºç»“æœå‡ä¸ºSon</span></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure><p>ä¸ºå•¥å‘¢ï¼Ÿæ‰§è¡Œ<code>[self class]</code>ç¼–è¯‘å™¨ä¼šå…ˆè°ƒç”¨<code>objc_msgSend</code>å»Soné‡Œæ‰¾ï¼Œæ²¡æ‰¾åˆ°ï¼›ç„¶åè°ƒç”¨<code>objc_msgSendSuper</code>å»Fatheré‡Œæ‰¾ï¼Œä¸€ç›´æ‰¾åˆ°<code>NSObject</code>ï¼ŒOKæˆ‘ä»¬çœ‹ä¸‹<code>-(Class)class</code>çš„æºç ï¼Œæ‘˜è‡ª<a href="https://opensource.apple.com//source/objc4/objc4-680/runtime/NSObject.mm" target="_blank" rel="external">NSObject.mm</a>ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (Class)<span class="keyword">class</span> &#123;</div><div class="line">    <span class="keyword">return</span> object_getClass(<span class="keyword">self</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>æ ¹æ®æºç å¾—çŸ¥ç¬¬ä¸€å¥è¿”å›Sonã€‚<br>åŒç†åœ¨æ‰§è¡Œ<code>[super class]</code>æ—¶ï¼Œç¼–è¯‘å™¨ç›´æ¥è°ƒç”¨<code>objc_msgSendSuper</code>ç›´åˆ°æ‰¾åˆ°<code>NSObject</code>ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„<code>self</code>æ˜¯è°å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹<code>super</code>ä¸<code>self</code>çš„åŒºåˆ«ï¼š<br><code>self</code>æ˜¯ç±»çš„ä¸€ä¸ª<strong>éšè—å‚æ•°</strong>ï¼Œæ¯ä¸ªæ–¹æ³•çš„å®ç°çš„ç¬¬ä¸€ä¸ªå‚æ•°å³ä¸ºselfã€‚è€Œ<code>super</code>å¹¶ä¸æ˜¯éšè—å‚æ•°ï¼Œå®ƒå®é™…ä¸Šåªæ˜¯ä¸€ä¸ªâ€ç¼–è¯‘å™¨æ ‡ç¤ºç¬¦â€ï¼Œå®ƒè´Ÿè´£å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè·³è¿‡<code>objc_msgSend</code>ç›´æ¥ç”¨<code>objc_msgSendSuper</code>è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯æœ¬ç±»ä¸­çš„æ–¹æ³•ã€‚è€Œå®ƒå®é™…ä¸Šä¸<code>self</code>æŒ‡å‘éƒ½æ˜¯æ¶ˆæ¯æ¥æ”¶è€…ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹superçš„å®šä¹‰ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_super &#123; <span class="keyword">id</span> receiver; Class superClass; &#125;;</div></pre></td></tr></table></figure></p><p>å½“æˆ‘ä»¬ä½¿ç”¨<code>super</code>æ¥æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ª<code>objc_super</code>ç»“æ„ä½“ï¼Œå‚æ•°<code>receiver</code>å³æ¶ˆæ¯çš„å®é™…æ¥æ”¶è€…ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ä¾‹å­çš„Sonå¯¹è±¡ï¼Œä¸<code>self</code>ç›¸åŒï¼›å‚æ•°<code>superClass</code>å³æŒ‡é’ˆå½“å‰ç±»çš„çˆ¶ç±»ï¼›æ¥ä¸‹æ¥ç”¨<code>objc_msgSendSuper</code>è°ƒç”¨çˆ¶ç±»çš„<code>class</code>æ–¹æ³•ï¼Œä½†æ˜¯æ¶ˆæ¯æ¥å—è€…ä»æ˜¯<code>self</code>ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œ<code>[self class]</code>ä¸<code>[super class]</code>å…¶å®æ˜¯ç­‰ä»·çš„ï¼Œç»“æœè¿˜æ˜¯Sonã€‚</p><h3 id="éšè—å‚æ•°"><a href="#éšè—å‚æ•°" class="headerlink" title="éšè—å‚æ•°"></a>éšè—å‚æ•°</h3><p>æˆ‘ä»¬åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­ä½¿ç”¨æœ€å¤šçš„å‚æ•°å°±æ˜¯<code>self</code>äº†ï¼Œä½†å®ƒæ˜¯æ€ä¹ˆè¢«è·å–åˆ°çš„å‘¢ï¼Ÿå…¶å®å®ƒæ˜¯<code>objc_msgSend</code>å‡½æ•°çš„éšè—å‚æ•°ä¹‹ä¸€ï¼Œä»£è¡¨æ¶ˆæ¯çš„æ¥æ”¶å¯¹è±¡ï¼Œè¿˜æœ‰ä¸€ä¸ªä¸å¸¸ç”¨çš„æ˜¯<code>_cmd</code>ï¼Œå®ƒæ˜¯æ–¹æ³•é€‰æ‹©å™¨ï¼Œä¸€èˆ¬åœ¨å…³è”å¯¹è±¡æ—¶ä½œä¸ºkeyä½¿ç”¨ã€‚</p><h3 id="è·å–æ–¹æ³•åœ°å€"><a href="#è·å–æ–¹æ³•åœ°å€" class="headerlink" title="è·å–æ–¹æ³•åœ°å€"></a>è·å–æ–¹æ³•åœ°å€</h3><p>å‰é¢æˆ‘ä»¬æåˆ°æ‹¿åˆ°äº†æ–¹æ³•çš„<code>IMP</code>ï¼Œå°±å¯ä»¥å¯ä»¥é¿å¼€æ¶ˆæ¯ç»‘å®šè€Œç›´æ¥è·å–æ–¹æ³•çš„åœ°å€å¹¶è°ƒç”¨æ–¹æ³•ã€‚è¿™ç§åšæ³•ä¸€èˆ¬ä¸å¸¸ç”¨ï¼Œä½†å½“æˆ‘ä»¬åœ¨å¾ªç¯å†…å¤šæ¬¡è°ƒç”¨æŸä¸ªæ–¹æ³•æ—¶ï¼Œé€šè¿‡è·å–æ–¹æ³•<code>IMP</code>ç›´æ¥è°ƒç”¨ä¼šé«˜æ•ˆå¾—å¤šã€‚é‚£ä¹ˆæ€ä¹ˆè·å–å‘¢ï¼Ÿ<code>NSObject</code>ç±»æä¾›äº†<code>methodForSelector:</code>æ–¹æ³•ï¼Œè®©æˆ‘ä»¬å¯ä»¥è·å–åˆ°æ–¹æ³•çš„æŒ‡é’ˆï¼Œç„¶åé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥è°ƒç”¨å®ç°ä»£ç ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> (*<span class="keyword">setter</span>)(<span class="keyword">id</span>, SEL, <span class="built_in">BOOL</span>);</div><div class="line"><span class="keyword">int</span> i;</div><div class="line"> </div><div class="line"><span class="keyword">setter</span> = (<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="built_in">BOOL</span>))[target</div><div class="line">    methodForSelector:<span class="keyword">@selector</span>(setFilled:)];</div><div class="line"><span class="keyword">for</span> ( i = <span class="number">0</span> ; i &lt; <span class="number">1000</span> ; i++ )</div><div class="line">    <span class="keyword">setter</span>(targetList[i], <span class="keyword">@selector</span>(setFilled:), <span class="literal">YES</span>);</div></pre></td></tr></table></figure></p><h3 id="æ¶ˆæ¯è½¬å‘"><a href="#æ¶ˆæ¯è½¬å‘" class="headerlink" title="æ¶ˆæ¯è½¬å‘"></a>æ¶ˆæ¯è½¬å‘</h3><p>æƒ³å¿…å¤§å®¶éƒ½é‡åˆ°è¿‡<code>unrecognized selector sent to instance...</code>è¿™ç±»crashï¼ŒåŸå› æ˜¯è°ƒç”¨äº†ä¸€ä¸ªè¯¥å¯¹è±¡æ— æ³•æ¥æ”¶çš„æ¶ˆæ¯ï¼Œå³æœªå£°æ˜çš„æ–¹æ³•ã€‚ä¸ºäº†é¿å…è¿™ç§crashçš„å‘ç”Ÿï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨<code>respondsToSelector:</code>æ¥åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦å“åº”å†å»è°ƒç”¨ï¼Œä¸‹é¢æˆ‘ä»¬æ¥è®¨è®ºå¦ä¸€ç§æ–¹å¼ï¼š<strong>æ¶ˆæ¯è½¬å‘(message forwarding)</strong>æœºåˆ¶ï¼Œå®ƒä¸»è¦åˆ†ä¸‰ä¸ªæ­¥éª¤ï¼š</p><h4 id="åŠ¨æ€æ–¹æ³•è§£æ"><a href="#åŠ¨æ€æ–¹æ³•è§£æ" class="headerlink" title="åŠ¨æ€æ–¹æ³•è§£æ"></a>åŠ¨æ€æ–¹æ³•è§£æ</h4><p>å½“å¯¹è±¡åœ¨æ¥æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯æ—¶ï¼Œä¼šå…ˆå»ç±»é‡Œæ‰¾<code>+resolveInstanceMethod:</code>(å®ä¾‹æ–¹æ³•)æˆ–<code>+resolveClassMethod:</code>(ç±»æ–¹æ³•)ï¼Œå¦‚æœä½ é‡å†™äº†ä»–ä»¬ï¼Œé‚£ä¹ˆå¯¹è±¡å°±ä¼šè°ƒç”¨å®ƒä»¬é€šè¿‡<code>class_addMethod</code>å‡½æ•°åŠ¨æ€æ·»åŠ è¯¥æœªçŸ¥æ–¹æ³•åˆ°ç±»é‡Œï¼Œå…·ä½“é‡å†™ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">BOOL</span>)resolveClassMethod:(SEL)sel &#123;</div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(classMethod:)) &#123;</div><div class="line">        class_addMethod(object_getClass(<span class="keyword">self</span>), sel, class_getMethodImplementation(object_getClass(<span class="keyword">self</span>), <span class="keyword">@selector</span>(myClassMethod:)), <span class="string">"v@:"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [class_getSuperclass(<span class="keyword">self</span>) resolveClassMethod:sel];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)aSEL</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (aSEL == <span class="keyword">@selector</span>(instanceMethod:)) &#123;</div><div class="line">        class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], aSEL, class_getMethodImplementation([<span class="keyword">self</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(myInstanceMethod:)), <span class="string">"v@:"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:aSEL];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>è¿™ä¸€ç‰¹æ€§ä¸€èˆ¬ç”¨äºå®ç°åŠ¨æ€å±æ€§<a href="http://blog.csdn.net/daydreamingboy/article/details/22682851" target="_blank" rel="external">@dynamic</a>ã€‚</p><h4 id="é‡å®šå‘æ¥æ”¶è€…"><a href="#é‡å®šå‘æ¥æ”¶è€…" class="headerlink" title="é‡å®šå‘æ¥æ”¶è€…"></a>é‡å®šå‘æ¥æ”¶è€…</h4><p>å¦‚æœä¸Šä¸€æ­¥è¿”å›<code>NO</code>ï¼Œ<code>Runtime</code>ä¼šå†ç»™æˆ‘ä»¬ä¸€æ¬¡å¼¥è¡¥çš„æœºä¼šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™<code>- (id)forwardingTargetForSelector:(SEL)aSelector</code>æˆ–<code>+ (id)forwardingTargetForSelector:(SEL)aSelector</code>æ¥é‡å®šå‘å®ä¾‹æ–¹æ³•æˆ–ç±»æ–¹æ³•çš„æ¶ˆæ¯æ¥æ”¶è€…ï¼Œå°†â€œé”…â€ç”©ç»™æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œç¤ºä¾‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Doctor</span> : <span class="title">NSObject</span>  </span></div><div class="line">  </div><div class="line">- (<span class="keyword">void</span>)operate;  </div><div class="line"></div><div class="line"><span class="keyword">@end</span> </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Doctor</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)operate &#123;</div><div class="line">     <span class="built_in">NSLog</span>(<span class="string">@"%@, %p"</span>, <span class="keyword">self</span>, _cmd);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Teacher</span> : <span class="title">NSObject</span>  </span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Teacher</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)test &#123;</div><div class="line">     [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(operate)];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector  </div><div class="line">&#123;  </div><div class="line">    Doctor *doctor = [[Doctor alloc]init];  </div><div class="line">    <span class="keyword">if</span> ([doctor respondsToSelector:aSelector]) &#123;  </div><div class="line">        <span class="keyword">return</span> doctor;  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;  </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p><h4 id="çœŸæ­£çš„æ¶ˆæ¯è½¬å‘"><a href="#çœŸæ­£çš„æ¶ˆæ¯è½¬å‘" class="headerlink" title="çœŸæ­£çš„æ¶ˆæ¯è½¬å‘"></a>çœŸæ­£çš„æ¶ˆæ¯è½¬å‘</h4><p>å¦‚æœä¸Šé¢æ–¹æ³•è¿”å›<code>nil</code>æˆ–<code>self</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æœ€åä¸€æ ¹æ•‘å‘½ç¨»è‰å°±æ˜¯é‡å†™<code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>å’Œ<code>- (void)forwardInvocation:(NSInvocation *)anInvocation</code>æ–¹æ³•ï¼Œè§¦å‘çœŸæ­£çš„æ¶ˆæ¯è½¬å‘ï¼š<br>1.<code>Runtime</code>ç³»ç»Ÿå…ˆå‘å¯¹è±¡å‘é€<code>methodSignatureForSelector</code>æ¶ˆæ¯ï¼Œå¹¶å–åˆ°è¿”å›çš„æ–¹æ³•ç­¾åï¼›<br>2.é€šè¿‡æ–¹æ³•ç­¾åç”Ÿæˆ<code>forwardInvocation:</code>çš„<code>anInvocation</code>(<a href="http://www.jianshu.com/p/03e7279a9916" target="_blank" rel="external">NSInvocation</a>)å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«äº†æœªå‘é€æ¶ˆæ¯çš„<code>selector</code>,<code>target</code>å’Œå‚æ•°ï¼Œé€šè¿‡è¯¥å¯¹è±¡å¯¹ä¸èƒ½å¤„ç†çš„æ¶ˆæ¯åšä¸€äº›é»˜è®¤çš„å¤„ç†ï¼Œä¹Ÿå¯ä»¥å°†æ¶ˆæ¯è½¬å‘ç»™å…¶ä»–å¯¹è±¡æ¥å¤„ç†ï¼Œé¿å…æŠ›å‡ºå¼‚å¸¸ã€‚<br>å…·ä½“å®ç°å¦‚ä¸‹:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector  </div><div class="line">&#123;  </div><div class="line">    <span class="built_in">NSMethodSignature</span>* signature = [<span class="keyword">super</span> methodSignatureForSelector:aSelector];  </div><div class="line">    <span class="keyword">if</span> (signature==<span class="literal">nil</span>) &#123;  </div><div class="line">        signature = [someObj methodSignatureForSelector:aSelector];  </div><div class="line">    &#125; </div><div class="line">      </div><div class="line">    <span class="keyword">return</span> signature;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation  </div><div class="line">&#123;  </div><div class="line">    SEL seletor = [anInvocation selector];  </div><div class="line">    <span class="keyword">if</span> ([someObj respondsToSelector:seletor]) &#123;  </div><div class="line">        [anInvocation invokeWithTarget:someObj];  </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><code>NSObject</code>çš„<code>forwardInvocation:</code>æ–¹æ³•åªæ˜¯ç®€å•è°ƒç”¨äº†<code>doesNotRecognizeSelector:</code>æ–¹æ³•æŠ›å‡ºä¸Šé¢æåˆ°çš„å¼‚å¸¸ï¼Œå®ƒä¸ä¼šè½¬å‘ä»»ä½•æ¶ˆæ¯ã€‚<br><code>forwardInvocation:</code>æ–¹æ³•å°±åƒä¸€ä¸ªä¸èƒ½è¯†åˆ«çš„æ¶ˆæ¯çš„åˆ†å‘ä¸­å¿ƒï¼Œå°†è¿™äº›æ¶ˆæ¯è½¬å‘ç»™ä¸åŒæ¥æ”¶å¯¹è±¡ï¼Œæˆ–è€…å®ƒä¹Ÿå¯ä»¥è±¡ä¸€ä¸ªè¿è¾“ç«™å°†æ‰€æœ‰çš„æ¶ˆæ¯éƒ½å‘é€ç»™åŒä¸€ä¸ªæ¥æ”¶å¯¹è±¡ï¼Œè¿™ä¸€åˆ‡éƒ½å–å†³äºæ–¹æ³•çš„å…·ä½“å®ç°ã€‚è¯¥æ–¹æ³•æ‰€æä¾›æ˜¯å°†ä¸åŒçš„å¯¹è±¡é“¾æ¥åˆ°æ¶ˆæ¯é“¾çš„èƒ½åŠ›ã€‚<br>ä¸Šè¿°ä¸‰ä¸ªæ­¥éª¤ç»„æˆäº†å®Œæ•´çš„æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Œæˆ‘æ•´ç†äº†ä¸€å¼ å›¾ç®€å•æè¿°æ•´ä¸ªè¿‡ç¨‹ï¼š<br><img src="http://owgqmweju.bkt.clouddn.com/17-11-23/17288307.jpg" alt=""><br>å›è¿‡å¤´çœ‹2ã€3éƒ¨ï¼Œå®ƒä»¬è®©ä¸€ä¸ªå¯¹è±¡èƒ½å¤Ÿå¤„ç†å…¶ä»–å¯¹è±¡çš„æ¶ˆæ¯ï¼Œä½†è¡¨é¢ä¸Šçœ‹ä»æ˜¯è¯¥å¯¹è±¡åœ¨å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œè€Œè¿™æ­£æ˜¯<strong>å¤šç»§æ‰¿</strong>çš„ç‰¹æ€§ã€‚æ¶ˆæ¯è½¬å‘å¼¥è¡¥äº†Objective-Cæ— æ³•å¤šç»§æ‰¿çš„è½¯è‚‹ï¼Œä¹Ÿé¿å…äº†å› ä¸ºå¤šç»§æ‰¿å¯¼è‡´å•ä¸ªç±»å˜å¾—è‡ƒè‚¿çš„ç¼ºç‚¹ã€‚å¦‚æœä½ å¯¹æ¶ˆæ¯è½¬å‘æœºåˆ¶çš„åŸç†æ„Ÿå…´è¶£å¯ä»¥çœ‹ä¸‹<a href="http://yulingtianxia.com/blog/2016/06/15/Objective-C-Message-Sending-and-Forwarding/#æ€»ç»“" target="_blank" rel="external">Objective-C æ¶ˆæ¯å‘é€ä¸è½¬å‘æœºåˆ¶åŸç†</a></p><h2 id="Categoryä¸Protocol"><a href="#Categoryä¸Protocol" class="headerlink" title="Categoryä¸Protocol"></a>Categoryä¸Protocol</h2><p>æœ€åæˆ‘ä»¬æ¥èŠèŠå¹³æ—¶æ¯”è¾ƒå¸¸ç”¨çš„<code>Category</code>ä¸<code>Protocol</code>ï¼Œç ”ç©¶ä¸‹ä»–ä»¬åœ¨<code>runtime</code>æ˜¯æ€æ ·å®ç°å’Œä½¿ç”¨çš„ã€‚</p><h3 id="Category"><a href="#Category" class="headerlink" title="Category"></a>Category</h3><p><code>Category</code>çš„å­˜åœ¨ä½¿æˆ‘ä»¬å¯ä»¥åŠ¨æ€åœ°ä¸ºå·²çŸ¥ç±»æ·»åŠ æ–¹æ³•ï¼Œé¡¹ç›®é‡Œéšå¤„å¯è§å„ç§ç±»çš„åˆ†ç±»åº”ç”¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒåœ¨<code>runtime</code>é‡Œçš„æ•°æ®ç»“æ„ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Categoryè¡¨ç¤ºä¸€ä¸ªæŒ‡å‘objc_categoryç»“æ„ä½“çš„æŒ‡é’ˆ</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_category *Category;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> objc_category &#123;</div><div class="line">    <span class="keyword">char</span> *category_name                          OBJC2_UNAVAILABLE;<span class="comment">// åˆ†ç±»å</span></div><div class="line">    <span class="keyword">char</span> *class_name                             OBJC2_UNAVAILABLE;<span class="comment">// åˆ†ç±»æ‰€å±çš„ç±»å</span></div><div class="line">    <span class="keyword">struct</span> objc_method_list *instance_methods    OBJC2_UNAVAILABLE;<span class="comment">// å®ä¾‹æ–¹æ³•åˆ—è¡¨</span></div><div class="line">    <span class="keyword">struct</span> objc_method_list *class_methods       OBJC2_UNAVAILABLE;<span class="comment">// ç±»æ–¹æ³•åˆ—è¡¨</span></div><div class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols         OBJC2_UNAVAILABLE;<span class="comment">// åˆ†ç±»æ‰€å®ç°çš„åè®®åˆ—è¡¨</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ç¼–è¯‘å™¨ä¼šæŠŠåˆ†ç±»çš„<code>instance_methods</code>é‡Œçš„æ–¹æ³•æ·»åŠ åˆ°ç±»çš„<code>methodLists</code>é‡Œï¼ŒæŠŠ<code>class_methods</code>é‡Œçš„æ–¹æ³•æ·»åŠ åˆ°ç±»çš„å…ƒç±»çš„<code>methodLists</code>é‡Œã€‚æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> <span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Sark</span>)</span></div><div class="line"> + (<span class="keyword">void</span>)foo;</div><div class="line"> - (<span class="keyword">void</span>)foo;</div><div class="line"> <span class="keyword">@end</span></div><div class="line"></div><div class="line"> <span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Sark</span>)</span></div><div class="line"> - (<span class="keyword">void</span>)foo</div><div class="line"> &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"IMP: -[NSObject(Sark) foo]"</span>);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="keyword">@end</span></div><div class="line"></div><div class="line"> <span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">  <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">      [<span class="built_in">NSObject</span> foo];</div><div class="line">      [[<span class="built_in">NSObject</span> new] foo];</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ç¨‹åºæ­£å¸¸è¿è¡Œï¼Œè¾“å‡ºç»“æœå‡ä¸ºIMP: -[NSObject(Sark) foo]</span></div></pre></td></tr></table></figure></p><p>åˆ†æï¼šåˆ†ç±»å£°æ˜çš„ç±»æ–¹æ³•è¢«æ·»åŠ åˆ°å…ƒç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨<code>[NSObject foo]</code>æ—¶ï¼Œç¼–è¯‘å™¨å…ˆå»å…ƒç±»ä¸­æŸ¥æ‰¾<code>foo</code>çš„<code>IMP</code>ï¼Œæ²¡æ‰¾åˆ°ï¼Œå†å»å…ƒç±»çš„çˆ¶ç±»é‡Œæ‰¾ï¼Œæ‰€ä»¥åˆå›åˆ°äº†<code>NSObject</code>ï¼Œæ‰¾åˆ°äº†fooï¼Œè°ƒç”¨ã€‚è€Œå®ä¾‹æ–¹æ³•è¢«æ·»åŠ åˆ°äº†ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨<code>[[NSObject new] foo]</code>æ—¶ï¼Œå»<code>NSObject</code>é‡Œæ‰¾<code>foo</code>ï¼Œç›´æ¥è°ƒç”¨ã€‚<br>å…³äº<code>Category</code>æ›´è¯¦ç»†çš„ä»‹ç»å¯ä»¥çœ‹ä¸‹<a href="https://tech.meituan.com/DiveIntoCategory.html" target="_blank" rel="external">æ·±å…¥ç†è§£Objective-Cï¼šCategory</a>ï¼Œ<br>è¿™é‡Œå†å®‰åˆ©ä¸€ä¸ªæ–¹ä¾¿çš„åˆ†ç±»åº“<a href="https://github.com/ibireme/YYCategories" target="_blank" rel="external">YYCategories</a>ã€‚</p><h3 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h3><p>é€šè¿‡Protocolçš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„ç»“æ„ä½“ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object Protocol;</div></pre></td></tr></table></figure></p><p>ç›¸å…³æ“ä½œå‡½æ•°ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è¿”å›æŒ‡å®šçš„åè®®ï¼Œå¦‚æœè¯¥åè®®åªæ˜¯å£°æ˜è€Œæœªå®ç°è¿‡åˆ™è¿”å›nil</span></div><div class="line">Protocol * objc_getProtocol ( <span class="keyword">const</span> <span class="keyword">char</span> *name );</div><div class="line"></div><div class="line"><span class="comment">// è·å–è¿è¡Œæ—¶æ‰€çŸ¥é“çš„æ‰€æœ‰åè®®çš„æ•°ç»„</span></div><div class="line">Protocol ** objc_copyProtocolList ( <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</div><div class="line"></div><div class="line"><span class="comment">// åˆ›å»ºæ–°çš„åè®®å®ä¾‹ï¼Œå¦‚æœå·²æœ‰åŒååè®®å­˜åœ¨åˆ™è¿”å›nil</span></div><div class="line">Protocol * objc_allocateProtocol ( <span class="keyword">const</span> <span class="keyword">char</span> *name );</div><div class="line"></div><div class="line"><span class="comment">// åœ¨è¿è¡Œæ—¶ä¸­æ³¨å†Œæ–°åˆ›å»ºçš„åè®®</span></div><div class="line"><span class="keyword">void</span> objc_registerProtocol ( Protocol *proto );</div><div class="line"></div><div class="line"><span class="comment">// ä¸ºåè®®æ·»åŠ æ–¹æ³•</span></div><div class="line"><span class="keyword">void</span> protocol_addMethodDescription ( Protocol *proto, SEL name, <span class="keyword">const</span> <span class="keyword">char</span> *types, <span class="built_in">BOOL</span> isRequiredMethod, <span class="built_in">BOOL</span> isInstanceMethod );</div><div class="line"></div><div class="line"><span class="comment">// æ·»åŠ ä¸€ä¸ªå·²æ³¨å†Œçš„åè®®åˆ°åè®®ä¸­</span></div><div class="line"><span class="keyword">void</span> protocol_addProtocol ( Protocol *proto, Protocol *addition );</div><div class="line"></div><div class="line"><span class="comment">// ä¸ºåè®®æ·»åŠ å±æ€§</span></div><div class="line"><span class="keyword">void</span> protocol_addProperty ( Protocol *proto, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> objc_property_attribute_t *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount, <span class="built_in">BOOL</span> isRequiredProperty, <span class="built_in">BOOL</span> isInstanceProperty );</div><div class="line"></div><div class="line"><span class="comment">// è¿”å›åè®®å</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * protocol_getName ( Protocol *p );</div><div class="line"></div><div class="line"><span class="comment">// æµ‹è¯•ä¸¤ä¸ªåè®®æ˜¯å¦ç›¸ç­‰</span></div><div class="line"><span class="built_in">BOOL</span> protocol_isEqual ( Protocol *proto, Protocol *other );</div><div class="line"></div><div class="line"><span class="comment">// è·å–åè®®ä¸­æŒ‡å®šæ¡ä»¶çš„æ–¹æ³•çš„æ–¹æ³•æè¿°æ•°ç»„</span></div><div class="line"><span class="keyword">struct</span> objc_method_description * protocol_copyMethodDescriptionList ( Protocol *p, <span class="built_in">BOOL</span> isRequiredMethod, <span class="built_in">BOOL</span> isInstanceMethod, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</div><div class="line"></div><div class="line"><span class="comment">// è·å–åè®®ä¸­æŒ‡å®šæ–¹æ³•çš„æ–¹æ³•æè¿°</span></div><div class="line"><span class="keyword">struct</span> objc_method_description protocol_getMethodDescription ( Protocol *p, SEL aSel, <span class="built_in">BOOL</span> isRequiredMethod, <span class="built_in">BOOL</span> isInstanceMethod );</div><div class="line"></div><div class="line"><span class="comment">// è·å–åè®®ä¸­çš„å±æ€§åˆ—è¡¨</span></div><div class="line">objc_property_t * protocol_copyPropertyList ( Protocol *proto, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</div><div class="line"></div><div class="line"><span class="comment">// è·å–åè®®çš„æŒ‡å®šå±æ€§</span></div><div class="line">objc_property_t protocol_getProperty ( Protocol *proto, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="built_in">BOOL</span> isRequiredProperty, <span class="built_in">BOOL</span> isInstanceProperty );</div><div class="line"></div><div class="line"><span class="comment">// è·å–åè®®é‡‡ç”¨çš„åè®®</span></div><div class="line">Protocol ** protocol_copyProtocolList ( Protocol *proto, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</div><div class="line"></div><div class="line"><span class="comment">// æŸ¥çœ‹åè®®æ˜¯å¦é‡‡ç”¨äº†å¦ä¸€ä¸ªåè®®</span></div><div class="line"><span class="built_in">BOOL</span> protocol_conformsToProtocol ( Protocol *proto, Protocol *other );</div></pre></td></tr></table></figure></p><p>å½“æˆ‘ä»¬ä½¿ç”¨<code>objc_allocateProtocol</code>åŠ¨æ€æ·»åŠ ä¸€ä¸ªåè®®åï¼Œå†ä½¿ç”¨<code>protocol_addMethodDescription</code>ã€<code>protocol_addProtocol</code>å’Œ<code>protocol_addProperty</code>å¾€åè®®ä¸­æ·»åŠ æ–¹æ³•æˆ–å±æ€§ï¼Œæœ€åè®°å¾—è°ƒç”¨<code>objc_registerProtocol</code>æ³¨å†Œè¿™ä¸ªåè®®ï¼Œæ³¨å†Œåä¸èƒ½ä¿®æ”¹è¯¥åè®®ã€‚</p><h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><h3 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h3><p><code>Runtime</code>è¿˜æœ‰ä¸€äº›å…³äº<code>block</code>çš„æ“ä½œå‡½æ•°ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªæŒ‡é’ˆå‡½æ•°çš„æŒ‡é’ˆï¼Œè¯¥å‡½æ•°è°ƒç”¨æ—¶ä¼šè°ƒç”¨ç‰¹å®šçš„block</span></div><div class="line"><span class="comment">// blockå‚æ•°å¿…é¡»æ˜¯method_return_type ^(id self, args...)å½¢å¼çš„</span></div><div class="line">IMP imp_implementationWithBlock ( <span class="keyword">id</span> block );</div><div class="line"></div><div class="line"><span class="comment">// è¿”å›ä¸IMP(ä½¿ç”¨imp_implementationWithBlockåˆ›å»ºçš„)ç›¸å…³çš„block</span></div><div class="line"><span class="keyword">id</span> imp_getBlock ( IMP anImp );</div><div class="line"></div><div class="line"><span class="comment">// è§£é™¤blockä¸IMP(ä½¿ç”¨imp_implementationWithBlockåˆ›å»ºçš„)çš„å…³è”å…³ç³»ï¼Œå¹¶é‡Šæ”¾blockçš„æ‹·è´</span></div><div class="line"><span class="built_in">BOOL</span> imp_removeBlock ( IMP anImp );</div></pre></td></tr></table></figure></p><h3 id="weak"><a href="#weak" class="headerlink" title="__weak"></a>__weak</h3><p>å…³äºå¼±å¼•ç”¨çš„æ“ä½œå‡½æ•°ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// åŠ è½½å¼±å¼•ç”¨æŒ‡é’ˆå¼•ç”¨çš„å¯¹è±¡å¹¶è¿”å›</span></div><div class="line"><span class="keyword">id</span> objc_loadWeak ( <span class="keyword">id</span> *location );</div><div class="line"></div><div class="line"><span class="comment">// å­˜å‚¨__weakå˜é‡çš„æ–°å€¼</span></div><div class="line"><span class="keyword">id</span> objc_storeWeak ( <span class="keyword">id</span> *location, <span class="keyword">id</span> obj );</div></pre></td></tr></table></figure></p><p>è¿™é‡Œä¸åšè¯¦ç»†ä»‹ç»ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹ä¸‹<a href="https://halfrost.com/ios_block_retain_circle/" target="_blank" rel="external">æ·±å…¥ç ”ç©¶ Block ç”¨ weakSelfã€strongSelf</a>ã€‚  </p><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>ä»¥ä¸Šå°±æ˜¯æˆ‘è¿™é˜µå­å­¦ä¹ <code>runtime</code>çš„æ‰€æœ‰æ€»ç»“ï¼Œéƒ½æ˜¯ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œä¸ç®—æ·±å…¥ï¼Œä½†æ¯”èµ·ä¹‹å‰çš„å°ç™½ç¨‹åº¦è¿›æ­¥äº†ä¸å°‘ã€‚ä½œä¸ºä¸€åç¨‹åºçŒ¿ï¼Œä¸åº”è¯¥åªåœç•™åœ¨ä¼šç”¨çš„ç¨‹åº¦ï¼Œè¦æœ‰ä¸€è¨€ä¸åˆå°±çœ‹æºç çš„æ€åº¦ï¼<br>è¿˜è¦æ„Ÿè°¢å„ä½å¤§ä½¬çš„åšæ–‡åˆ†äº«ï¼ˆæ–‡ä¸­æœ‰é“¾æ¥ï¼‰ï¼Œå¦‚æœä½ è§‰å¾—æ–‡ç« å“ªé‡Œæœ‰é—®é¢˜ï¼Œæ¬¢è¿æŒ‡æ­£~å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¤ªè‚¤æµ…ï¼Œæ¨è<a href="https://halfrost.com/objc_runtime_isa_class/" target="_blank" rel="external">éœœç¥çš„runtimeå…¥é™¢ç³»åˆ—</a>ï¼Œåæ­£æˆ‘æ˜¯è·ªç€çœ‹å®Œçš„orzã€‚ã€‚ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¹¦æ¥ä¸Šå›ï¼Œæˆ‘ä»¬æ¥è¯´ä¸€ä¸‹&lt;code&gt;runtime&lt;/code&gt;æœ€æœ‰è¶£çš„éƒ¨åˆ†ï¼Œæ–¹æ³•å’Œæ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼ˆå¸Œæœ›æˆ‘èƒ½å†™çš„æœ‰è¶£ğŸ˜‚ï¼‰ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Method&quot;&gt;&lt;a href=&quot;#Method&quot; class=&quot;headerlink&quot; title=&quot;Method&quot;&gt;&lt;/a&gt;Method&lt;/h2&gt;&lt;p&gt;é¡¾åæ€ä¹‰æˆ‘ä»¬å¸¸è¯´çš„æ–¹æ³•å°±æ˜¯&lt;code&gt;Method&lt;/code&gt;ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; method_t *Method;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; method_t &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    SEL name;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; *types;  &lt;span class=&quot;comment&quot;&gt;//ç”¨æ¥å­˜å‚¨ç€æ–¹æ³•çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    IMP imp;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; SortBySELAddress :&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        public std::binary_function&amp;lt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; method_t&amp;amp;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; method_t&amp;amp;, &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt; operator() (&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; method_t&amp;amp; lhs,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                         &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; method_t&amp;amp; rhs)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#123; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; lhs.name &amp;lt; rhs.name; &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="runtime" scheme="http://wonkeyz.com/tags/runtime/"/>
    
  </entry>
  
  <entry>
    <title>Runtimeå­¦ä¹ æ€»ç»“ï¼ˆä¸€ï¼‰</title>
    <link href="http://wonkeyz.com/2017/07/09/Runtime-Learning-summary-1/"/>
    <id>http://wonkeyz.com/2017/07/09/Runtime-Learning-summary-1/</id>
    <published>2017-07-09T03:00:35.000Z</published>
    <updated>2018-02-01T01:34:52.432Z</updated>
    
    <content type="html"><![CDATA[<p><code>Runtime</code>åœ¨ä¸šå†…æœ‰iOSå¼€å‘â€˜â€˜é»‘ç§‘æŠ€â€™â€™ä¹‹ç§°ï¼Œä½†åœ¨å¹³æ—¶å¼€å‘ä¸­ä¹Ÿå°±æ¥è§¦äº†<code>Method Swizzling</code>ï¼Œ<code>AssociatedObject</code>è¿™å‡ ç§åº”ç”¨ï¼Œç”¨äº†è¿™ä¹ˆä¹…OCï¼Œå´å¯¹å®ƒçš„å†…åœ¨ä¸€æ— æ‰€çŸ¥ï¼Œå®åœ¨è¯´ä¸è¿‡å»â€¦ä»Šå¤©æˆ‘æ¥æ€»ç»“ä¸€ä¸‹æœ€è¿‘å­¦ä¹ <code>runtime</code>çš„çŸ¥è¯†ç‚¹ï¼Œçœ‹çœ‹å®ƒç©¶ç«Ÿâ€˜â€˜é»‘â€™â€™åœ¨å“ªé‡Œã€‚<br><a id="more"></a></p><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“Objective-Cæ˜¯ä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶åˆ›å»ºï¼Œæ£€æŸ¥ï¼Œä¿®æ”¹ç±»ã€å¯¹è±¡å’Œå®ƒä»¬çš„æ–¹æ³•ï¼Œè¿™ä¸€åˆ‡éƒ½å½’åŠŸäº<code>runtime</code>ï¼Œå®ƒæ˜¯ç”¨Cå’Œæ±‡ç¼–å†™çš„åº“ï¼Œè¿™ä¸ªåº“ä½¿Cå…·æœ‰äº†é¢å‘å¯¹è±¡çš„èƒ½åŠ›ã€‚æ€»ç»“èµ·æ¥ï¼Œ<code>Runtime</code>åº“ä¸»è¦åšäº†å‡ ä»¶äº‹:</p><ul><li>å°è£…ï¼šç”¨Cçš„ç»“æ„ä½“è¡¨ç¤ºOCçš„å¯¹è±¡ï¼Œç”¨Cçš„å‡½æ•°å®ç°OCçš„æ–¹æ³•ï¼Œè¿™äº›ç»“æ„ä½“å’Œå‡½æ•°è¢«<code>runtime</code>å‡½æ•°å°è£…åï¼ŒOCå°±å…·æœ‰äº†åŠ¨æ€çš„ç‰¹æ€§ã€‚</li><li>æ”¶å‘æ¶ˆæ¯ï¼šåœ¨å¯¹è±¡æ‰§è¡ŒæŸä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•è¢«<code>runtime</code>å½“åšä¸€æ¡æ¶ˆæ¯å‘é€ç»™æ¥æ”¶è€…ï¼Œä¹Ÿå°±æ˜¯å¯¹è±¡ï¼Œ<code>Runtime</code>ä¼šæ ¹æ®æ¥æ”¶è€…èƒ½å¦å“åº”è¯¥æ¶ˆæ¯è€Œåšå‡ºä¸åŒçš„ååº”ã€‚  </li></ul><p>ä¸‹é¢æˆ‘ä»¬é€ä¸€æ¥çœ‹ä¸‹å¹³æ—¶å†ç†Ÿæ‚‰ä¸è¿‡çš„ç±»ä¸å¯¹è±¡ã€æˆå‘˜å˜é‡ä¸å±æ€§çš„æ•°æ®ç»“æ„å’Œæ“ä½œå‡½æ•°ã€‚</p><h2 id="ç±»ä¸å¯¹è±¡"><a href="#ç±»ä¸å¯¹è±¡" class="headerlink" title="ç±»ä¸å¯¹è±¡"></a>ç±»ä¸å¯¹è±¡</h2><h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h4><p>é€šè¿‡<code>objc.h</code>ä¸<code>runtime.h</code>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªæŒ‡å‘objc_classç»“æ„ä½“çš„æŒ‡é’ˆClassï¼Œä¹Ÿå°±æ˜¯OCä¸­çš„ç±»</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</div><div class="line"><span class="comment">// ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹</span></div><div class="line"><span class="keyword">struct</span> objc_class &#123;</div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line">    </div><div class="line"><span class="meta">#if !__OBJC2__</span></div><div class="line">    Class super_class                   OBJC2_UNAVAILABLE;<span class="comment">// çˆ¶ç±»</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name                      OBJC2_UNAVAILABLE;<span class="comment">// ç±»å</span></div><div class="line">    <span class="keyword">long</span> version                          OBJC2_UNAVAILABLE;<span class="comment">// ç±»ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸º0</span></div><div class="line">    <span class="keyword">long</span> info                            OBJC2_UNAVAILABLE;<span class="comment">// ç±»ä¿¡æ¯ï¼Œä¾›è¿è¡Œæ—¶ä½¿ç”¨çš„ä¸€äº›ä½æ ‡è¯†</span></div><div class="line">    <span class="keyword">long</span> instance_size                   OBJC2_UNAVAILABLE;<span class="comment">// å®ä¾‹å˜é‡å¤§å°</span></div><div class="line">    <span class="keyword">struct</span> objc_ivar_list *ivars         OBJC2_UNAVAILABLE;<span class="comment">// æˆå‘˜å˜é‡åˆ—è¡¨</span></div><div class="line">    <span class="keyword">struct</span> objc_method_list **methodLists OBJC2_UNAVAILABLE;<span class="comment">// æ–¹æ³•åˆ—è¡¨</span></div><div class="line">    <span class="keyword">struct</span> objc_cache *cache              OBJC2_UNAVAILABLE;<span class="comment">// æ–¹æ³•ç¼“å­˜</span></div><div class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols OBJC2_UNAVAILABLE;<span class="comment">// åè®®åˆ—è¡¨</span></div><div class="line"><span class="meta">#endif</span></div><div class="line">&#125; OBJC2_UNAVAILABLE;</div></pre></td></tr></table></figure></p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¿™å‡ ä¸ªå­—æ®µï¼š</p><ul><li><code>isa</code>ï¼šæˆ‘ä»¬çŸ¥é“OCä¸­å¯¹è±¡çš„<code>isa</code>æŒ‡å‘ç±»ï¼ŒåŒæ ·ç±»ä¹Ÿæœ‰ä¸€ä¸ª<code>isa</code>æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘<code>meta Class</code>(å…ƒç±»)ï¼Œè¿™é‡Œç±»ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</li><li><code>super_class</code>ï¼šæŒ‡å‘è¯¥ç±»çš„çˆ¶ç±»ï¼Œå¦‚æœè¯¥ç±»å·²ç»æ˜¯<code>Root Class</code>(å¦‚<code>NSObject</code>æˆ–<code>NSProxy</code>)ï¼Œåˆ™<code>super_class</code>ä¸º<code>NULL</code>ã€‚</li><li><p><code>cache</code>ï¼šè¯¥å­—æ®µç”¨äºç¼“å­˜è°ƒç”¨è¿‡çš„æ–¹æ³•ã€‚<code>cache</code>æŒ‡é’ˆæŒ‡å‘<code>objc_cache</code>ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_cache &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mask <span class="comment">/* total = mask + 1 */</span> OBJC2_UNAVAILABLE; <span class="comment">// æŒ‡å®šåˆ†é…ç¼“å­˜bucketçš„æ€»æ•°ã€‚runtimeä½¿ç”¨è¿™ä¸ªå­—æ®µç¡®å®šçº¿æ€§æŸ¥æ‰¾æ•°ç»„çš„ç´¢å¼•ä½ç½®</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> occupied OBJC2_UNAVAILABLE; <span class="comment">// å®é™…å ç”¨ç¼“å­˜bucketæ€»æ•°</span></div><div class="line">    Method buckets[<span class="number">1</span>] OBJC2_UNAVAILABLE; <span class="comment">// æŒ‡å‘Methodæ•°æ®ç»“æ„æŒ‡é’ˆçš„æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„çš„å…ƒç´ æ€»æ•°ä¸èƒ½è¶…è¿‡mask+1ï¼Œå¦‚æœä¸ºç©ºåˆ™è¡¨ç¤ºç¼“å­˜bucketæ²¡æœ‰è¢«å ç”¨ï¼Œå®ƒæœ‰å¯èƒ½æ˜¯ä¸è¿ç»­çš„ï¼Œä¼šéšç€æ—¶é—´è€Œå˜å¤§ã€‚</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></li><li><p>å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å°±ä¼šè¢«æ”¾åˆ°<code>cache</code>ä¸­ï¼Œä¸‹æ¬¡è°ƒç”¨<code>runtime</code>å°±ä¼šä¼˜å…ˆå»<code>cache</code>ä¸­æŸ¥æ‰¾ï¼Œè¿™æ ·å°±é¿å…äº†æ¯æ¬¡éƒ½ç›´æ¥å»<code>methodLists</code>ä¸­æŸ¥æ‰¾ï¼Œæé«˜äº†æ•ˆç‡ã€‚</p></li></ul><h4 id="objc-object"><a href="#objc-object" class="headerlink" title="objc_object"></a>objc_object</h4><p>çœ‹å®Œäº†<code>Class</code>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹å¯¹è±¡ï¼Œå‚è€ƒ<code>objc-private.h</code>éƒ¨åˆ†æºç ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_object &#123;</div><div class="line">private:</div><div class="line">    isa_t isa;</div><div class="line"></div><div class="line">public:</div><div class="line">    <span class="comment">// ISA() assumes this is NOT a tagged pointer object</span></div><div class="line">    Class ISA();</div><div class="line"></div><div class="line">    <span class="comment">// getIsa() allows this to be a tagged pointer object</span></div><div class="line">    Class getIsa();</div><div class="line"></div><div class="line">    <span class="comment">// initIsa() should be used to init the isa of new objects only.</span></div><div class="line">    <span class="comment">// If this object already has an isa, use changeIsa() for correctness.</span></div><div class="line">    <span class="comment">// initInstanceIsa(): objects with no custom RR/AWZ</span></div><div class="line">    <span class="comment">// initClassIsa(): class objects</span></div><div class="line">    <span class="comment">// initProtocolIsa(): protocol objects</span></div><div class="line">    <span class="comment">// initIsa(): other objects</span></div><div class="line">    <span class="keyword">void</span> initIsa(Class cls <span class="comment">/*nonpointer=false*/</span>);</div><div class="line">    <span class="keyword">void</span> initClassIsa(Class cls <span class="comment">/*nonpointer=maybe*/</span>);</div><div class="line">    <span class="keyword">void</span> initProtocolIsa(Class cls <span class="comment">/*nonpointer=maybe*/</span>);</div><div class="line">    <span class="keyword">void</span> initInstanceIsa(Class cls, <span class="keyword">bool</span> hasCxxDtor);</div><div class="line">    <span class="comment">// çœç•¥å…¶ä»–æ–¹æ³•å£°æ˜...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</div></pre></td></tr></table></figure></p><p><code>objc_object</code>ç»“æ„ä½“åŒ…å«ä¸€ä¸ªç±»å‹ä¸º<code>isa_t</code>çš„<code>isa</code>æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æŒ‡å‘è¿™ä¸ªå¯¹è±¡æ‰€å±ç±»çš„æŒ‡é’ˆã€‚publiché‡Œé¢å®šä¹‰äº†ä¸€äº›æ“ä½œ<code>isa</code>çš„æ–¹æ³•ã€‚<code>Runtime</code>åº“ä¼šåœ¨è¯¥ç±»çš„æ–¹æ³•åˆ—è¡¨åŠçˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­å»å¯»æ‰¾ä¸æ¶ˆæ¯å¯¹åº”çš„<code>selector</code>ï¼Œæ‰¾åˆ°åå³æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ã€‚<br>ä¸‹é¢çš„<code>id</code>æ˜¯ä¸€ä¸ª<code>objc_object</code>ç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆï¼Œè¿™ä¸ªç±»å‹çš„å¯¹è±¡èƒ½å¤Ÿè½¬æ¢æˆä»»æ„ç±»å‹çš„å¯¹è±¡ï¼Œç±»ä¼¼äºCè¯­è¨€ä¸­void *æŒ‡é’ˆçš„ä½œç”¨ã€‚<br>è¿™é‡Œæœ‰ä¸€ç‚¹è¦ç‰¹æ®Šè¯´æ˜ï¼Œå…¶å®<code>isa</code>å¹¶ä¸æ€»æ˜¯æŒ‡å‘å®ä¾‹å¯¹è±¡æ‰€å±çš„ç±»ï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨KVOæ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªä¸­é—´ç±»ï¼Œç³»ç»Ÿä¼šé€šè¿‡<code>isa-swizzling</code>æŠŠ<code>isa</code>æŒ‡å‘è¿™ä¸ªç±»è€Œä¸æ˜¯çœŸå®çš„ç±»ï¼Œæ‰€ä»¥ä¸èƒ½ä¾é å®ƒæ¥ç¡®å®šç±»å‹ï¼Œè€Œåº”è¯¥ç”¨<code>class</code>æ–¹æ³•æ¥ç¡®å®šå®ä¾‹å¯¹è±¡çš„ç±»ã€‚è¯¦è§<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><h4 id="Meta-Class"><a href="#Meta-Class" class="headerlink" title="Meta Class"></a>Meta Class</h4><p>ä¸Šé¢æˆ‘ä»¬è¯´åˆ°ç±»æœ¬èº«ä¹Ÿæ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆä»–çš„<code>isa</code>æŒ‡å‘è°å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯å…ƒç±»<code>Meta Class</code>ã€‚å½“æˆ‘ä»¬å‘ä¸€ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯æ—¶ï¼Œ<code>runtime</code>ä¼šåœ¨è¿™ä¸ªå¯¹è±¡æ‰€å±ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè€Œå‘ä¸€ä¸ªç±»å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šåœ¨è¿™ä¸ªç±»çš„<code>Meta Class</code>çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ã€‚<br><code>Meta Class</code>å­˜å‚¨ç€ä¸€ä¸ªç±»çš„æ‰€æœ‰ç±»æ–¹æ³•ï¼Œæ¯ä¸ªç±»éƒ½ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„<code>Meta Class</code>ï¼Œå› ä¸ºæ¯ä¸ªç±»çš„ç±»æ–¹æ³•åŸºæœ¬ä¸å¯èƒ½å®Œå…¨ç›¸åŒã€‚<br>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ<code>Meta Class</code>çš„<code>isa</code>åˆæŒ‡å‘è°å‘¢ï¼Ÿè¿™ä¹ˆæä¸‹å»å²‚ä¸æ˜¯æ— ç©·æ— å°½â€¦ä¸ºäº†é¿å…è¿™ç§å°´å°¬çš„é—®é¢˜ï¼ŒObjective-Cçš„è®¾è®¡è€…è®©æ‰€æœ‰<code>Meta Class</code>çš„<code>isa</code>éƒ½æŒ‡å‘åŸºç±»ï¼ˆRoot Classï¼‰çš„<code>Meta Class</code>ï¼Œå³æ‰€æœ‰çš„ç±»çš„<code>Meta Class</code>ï¼ŒåŒ…æ‹¬Root Classï¼ŒSuperclassï¼ŒSubclassçš„<code>isa</code>éƒ½æŒ‡å‘Root classçš„<code>Meta Class</code>ï¼Œè€ŒRoot Classçš„<code>Meta Class</code>çš„<code>isa</code>æŒ‡é’ˆåˆæŒ‡å‘äº†å®ƒè‡ªå·±ï¼Œè¿™æ ·å°±å½¢æˆä¸€ä¸ªé—­ç¯ã€‚å¦‚å›¾ï¼š<br><img src="http://owgqmweju.bkt.clouddn.com/17-11-17/86473124.jpg" alt="å›¾1"><br>å†æ¥ä¸€ä¸ªå°demoæ¥éªŒè¯ä¸€ä¸‹ä¸Šå›¾ï¼ˆå–è‡ª<a href="http://blog.sunnyxx.com/2014/11/06/runtime-nuts/" target="_blank" rel="external">ç¥ç»ç—…é™¢objc runtimeå…¥é™¢è€ƒè¯•</a>ï¼‰<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Sark</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">     <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">          <span class="built_in">BOOL</span> res1 = [(<span class="keyword">id</span>)[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];</div><div class="line">          <span class="built_in">BOOL</span> res2 = [(<span class="keyword">id</span>)[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];</div><div class="line">          <span class="built_in">BOOL</span> res3 = [(<span class="keyword">id</span>)[Sark <span class="keyword">class</span>] isKindOfClass:[Sark <span class="keyword">class</span>]];</div><div class="line">          <span class="built_in">BOOL</span> res4 = [(<span class="keyword">id</span>)[Sark <span class="keyword">class</span>] isMemberOfClass:[Sark <span class="keyword">class</span>]];</div><div class="line">          <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d %d"</span>, res1, res2, res3, res4);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ç»“æœä¸º1 0 0 0</span></div></pre></td></tr></table></figure></p><p>å…ˆæ¥çœ‹ä¸‹<code>isKindOfClass:</code>,<code>isMemberOfClass:</code>åœ¨<code>Object.mm</code>ä¸­çš„å®ç°ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>)isKindOf:aClass &#123;</div><div class="line">     Class cls;</div><div class="line">     <span class="keyword">for</span> (cls = isa; cls; cls = cls-&gt;superclass)</div><div class="line">          <span class="keyword">if</span> (cls == (Class)aClass)</div><div class="line">               <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">     <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isMemberOf:aClass &#123;</div><div class="line">     <span class="keyword">return</span> isa == (Class)aClass;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>æˆ‘ä»¬ä»å¤´èµ°ä¸€éï¼Œres1ç¬¬ä¸€æ¬¡clsæ˜¯NSObjectçš„Meta Classï¼Œå› ä¸ºä»–æ˜¯åŸºç±»ï¼Œæ‰€æœ‰ç¬¬äºŒæ¬¡clsåˆæŒ‡å›äº†NSObjectï¼Œè¿”å›YESï¼›res2åªèµ°äº†ä¸€æ¬¡è¿”å›NOï¼›res3ç¬¬ä¸€æ¬¡clsæ˜¯Sarkçš„Meta Classï¼Œç¬¬äºŒæ¬¡clsæ˜¯NSObjectçš„Meta Classï¼Œç¬¬ä¸‰æ¬¡clsæ˜¯NSObjectï¼Œè¿”å›NOï¼›res4æ˜¾ç„¶è¿”å›NOã€‚</p><h3 id="æ“ä½œå‡½æ•°"><a href="#æ“ä½œå‡½æ•°" class="headerlink" title="æ“ä½œå‡½æ•°"></a>æ“ä½œå‡½æ•°</h3><h4 id="ç±»æ“ä½œå‡½æ•°"><a href="#ç±»æ“ä½œå‡½æ•°" class="headerlink" title="ç±»æ“ä½œå‡½æ•°"></a>ç±»æ“ä½œå‡½æ•°</h4><p>èŠå®Œç±»ä¸å¯¹è±¡çš„åŸºæœ¬ç»“æ„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹éƒ½å¯ä»¥å¯¹å®ƒä»¬åšå“ªäº›æ“ä½œã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è·å–ç±»å</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * class_getName ( Class cls );</div><div class="line"></div><div class="line"><span class="comment">// è·å–çˆ¶ç±»</span></div><div class="line">Class class_getSuperclass ( Class cls );</div><div class="line"><span class="comment">// è·å–å…ƒç±»</span></div><div class="line">Class objc_getMetaClass( Class cls );</div><div class="line"><span class="comment">// åˆ¤æ–­ç»™å®šçš„Classæ˜¯å¦æ˜¯ä¸€ä¸ªå…ƒç±»</span></div><div class="line"><span class="built_in">BOOL</span> class_isMetaClass ( Class cls );</div><div class="line"></div><div class="line"><span class="comment">// è·å–ç‰ˆæœ¬å·</span></div><div class="line"><span class="keyword">int</span> class_getVersion ( Class cls );</div><div class="line"><span class="comment">// è®¾ç½®ç‰ˆæœ¬å·</span></div><div class="line"><span class="keyword">void</span> class_setVersion ( Class cls, <span class="keyword">int</span> version );</div><div class="line"></div><div class="line"><span class="comment">// è·å–å®ä¾‹å¤§å°</span></div><div class="line">size_t class_getInstanceSize ( Class cls );</div><div class="line"></div><div class="line"><span class="comment">// æˆå‘˜å˜é‡æ“ä½œå‡½æ•°</span></div><div class="line"><span class="comment">// è·å–ç±»ä¸­æŒ‡å®šåç§°å®ä¾‹æˆå‘˜å˜é‡çš„ä¿¡æ¯</span></div><div class="line">Ivar class_getInstanceVariable ( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name );</div><div class="line"><span class="comment">// è·å–ç±»æˆå‘˜å˜é‡çš„ä¿¡æ¯</span></div><div class="line">Ivar class_getClassVariable ( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name );</div><div class="line"><span class="comment">// æ·»åŠ æˆå‘˜å˜é‡</span></div><div class="line"><span class="built_in">BOOL</span> class_addIvar ( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, size_t size, uint8_t alignment, <span class="keyword">const</span> <span class="keyword">char</span> *types ); </div><div class="line"><span class="comment">// è·å–æ•´ä¸ªæˆå‘˜å˜é‡åˆ—è¡¨</span></div><div class="line">Ivar * class_copyIvarList ( Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</div><div class="line"></div><div class="line"><span class="comment">// å±æ€§æ“ä½œå‡½æ•°</span></div><div class="line"><span class="comment">// è·å–æŒ‡å®šçš„å±æ€§</span></div><div class="line">objc_property_t class_getProperty ( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name );</div><div class="line"><span class="comment">// è·å–å±æ€§åˆ—è¡¨</span></div><div class="line">objc_property_t * class_copyPropertyList ( Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</div><div class="line"><span class="comment">// æ·»åŠ å±æ€§</span></div><div class="line"><span class="built_in">BOOL</span> class_addProperty ( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> objc_property_attribute_t *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount );</div><div class="line"><span class="comment">// æ›¿æ¢ç±»çš„å±æ€§</span></div><div class="line"><span class="keyword">void</span> class_replaceProperty ( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> objc_property_attribute_t *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount );</div><div class="line"></div><div class="line"><span class="comment">// åè®®æ“ä½œå‡½æ•°</span></div><div class="line"><span class="comment">// æ·»åŠ åè®®</span></div><div class="line"><span class="built_in">BOOL</span> class_addProtocol ( Class cls, Protocol *protocol );</div><div class="line"><span class="comment">// è¿”å›ç±»æ˜¯å¦å®ç°æŒ‡å®šçš„åè®®</span></div><div class="line"><span class="built_in">BOOL</span> class_conformsToProtocol ( Class cls, Protocol *protocol );</div><div class="line"><span class="comment">// è¿”å›ç±»å®ç°çš„åè®®åˆ—è¡¨</span></div><div class="line">Protocol * class_copyProtocolList ( Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</div></pre></td></tr></table></figure></p><p><code>Objective-C</code>ä¸æ”¯æŒå¾€å·²å­˜åœ¨çš„ç±»ä¸­æ·»åŠ æˆå‘˜ï¼Œå› æ­¤ä¸ç®¡æ˜¯ç³»ç»Ÿåº“æä¾›çš„ç±»ï¼Œè¿˜æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»ï¼Œéƒ½æ— æ³•åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡ã€‚æ‰€ä»¥<code>class_addIvar</code>åªæ”¯æŒç»™è¿è¡Œæ—¶åˆ›å»ºçš„éå…ƒç±»æ·»åŠ æˆå‘˜å˜é‡ï¼Œè¿˜éœ€è¦æ³¨æ„è¿™ä¸ªæ–¹æ³•åªèƒ½åœ¨<code>objc_allocateClassPair</code>å‡½æ•°ä¸<code>objc_registerClassPair</code>ä¹‹é—´è°ƒç”¨ã€‚<br>ç±»ä¼¼äº<code>class_copyIvarList</code>,<code>class_getClassVariable</code>çš„å‡½æ•°è¿”å›çš„æ•°ç»„åœ¨ä½¿ç”¨åéœ€è¦ä½¿ç”¨<code>free()</code>æ‰‹åŠ¨é‡Šæ”¾ï¼Œ<code>outCount</code>æŒ‡é’ˆè¿”å›æ•°ç»„çš„å¤§å°ã€‚<br><code>class_conformsToProtocol</code>ç›¸å½“äº<code>conformsToProtocol:</code>æ–¹æ³•ã€‚  </p><h4 id="å¯¹è±¡æ“ä½œå‡½æ•°"><a href="#å¯¹è±¡æ“ä½œå‡½æ•°" class="headerlink" title="å¯¹è±¡æ“ä½œå‡½æ•°"></a>å¯¹è±¡æ“ä½œå‡½æ•°</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è¿”å›æŒ‡å®šå¯¹è±¡çš„ä¸€ä»½æ‹·è´</span></div><div class="line"><span class="keyword">id</span> object_copy ( <span class="keyword">id</span> obj, size_t size );</div><div class="line"><span class="comment">// é‡Šæ”¾æŒ‡å®šå¯¹è±¡å ç”¨çš„å†…å­˜</span></div><div class="line"><span class="keyword">id</span> object_dispose ( <span class="keyword">id</span> obj );</div><div class="line"></div><div class="line"><span class="comment">// ä¿®æ”¹å¯¹è±¡å®ä¾‹å˜é‡çš„å€¼</span></div><div class="line">Ivar object_setInstanceVariable ( <span class="keyword">id</span> obj, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> *value );</div><div class="line"><span class="comment">// è·å–å¯¹è±¡å®ä¾‹å˜é‡çš„å€¼</span></div><div class="line">Ivar object_getInstanceVariable ( <span class="keyword">id</span> obj, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> **outValue );</div><div class="line"><span class="comment">// è¿”å›æŒ‡å‘ç»™å®šå¯¹è±¡åˆ†é…çš„ä»»ä½•é¢å¤–å­—èŠ‚çš„æŒ‡é’ˆ</span></div><div class="line"><span class="keyword">void</span> * object_getIndexedIvars ( <span class="keyword">id</span> obj );</div><div class="line"><span class="comment">// ä¿®æ”¹å¯¹è±¡å®ä¾‹å˜é‡çš„å€¼ï¼Œå¦‚æœIvarå·²çŸ¥ï¼Œåˆ™è°ƒç”¨è¯¥å‡½æ•°ä¼šæ¯”object_setInstanceVariableå¿«ï¼Œä¸‹é¢ä¸€æ ·</span></div><div class="line"><span class="keyword">void</span> object_setIvar ( <span class="keyword">id</span> obj, Ivar ivar, <span class="keyword">id</span> value );</div><div class="line"><span class="comment">// è·å–å¯¹è±¡å®ä¾‹å˜é‡çš„å€¼</span></div><div class="line"><span class="keyword">id</span> object_getIvar ( <span class="keyword">id</span> obj, Ivar ivar );</div><div class="line"></div><div class="line"><span class="comment">// è¿”å›å¯¹è±¡çš„ç±»å</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * object_getClassName ( <span class="keyword">id</span> obj );</div><div class="line"><span class="comment">// è¿”å›å¯¹è±¡çš„ç±»</span></div><div class="line">Class object_getClass ( <span class="keyword">id</span> obj );</div><div class="line"><span class="comment">// è®¾ç½®å¯¹è±¡çš„ç±»</span></div><div class="line">Class object_setClass ( <span class="keyword">id</span> obj, Class cls );</div></pre></td></tr></table></figure><p>ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨è¿è¡Œæ—¶è½¬æ¢å¯¹è±¡çš„ç±»å‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSObject</span> *a = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line"><span class="keyword">id</span> newB = object_copy(a, class_getInstanceSize(MyClass.class));</div><div class="line">object_setClass(newB, MyClass.class);</div><div class="line">object_dispose(a);</div></pre></td></tr></table></figure></p><h4 id="åŠ¨æ€åˆ›å»ºç±»å’Œå¯¹è±¡"><a href="#åŠ¨æ€åˆ›å»ºç±»å’Œå¯¹è±¡" class="headerlink" title="åŠ¨æ€åˆ›å»ºç±»å’Œå¯¹è±¡"></a>åŠ¨æ€åˆ›å»ºç±»å’Œå¯¹è±¡</h4><h5 id="åŠ¨æ€åˆ›å»ºç±»"><a href="#åŠ¨æ€åˆ›å»ºç±»" class="headerlink" title="åŠ¨æ€åˆ›å»ºç±»"></a>åŠ¨æ€åˆ›å»ºç±»</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°ç±»å’Œå…ƒç±»</span></div><div class="line">Class objc_allocateClassPair ( Class superclass, <span class="keyword">const</span> <span class="keyword">char</span> *name, size_t extraBytes ); <span class="comment">// å¦‚æœåˆ›å»ºçš„æ˜¯root classï¼Œåˆ™superclassä¸ºNilã€‚extraBytesé€šå¸¸ä¸º0</span></div><div class="line"><span class="comment">// é”€æ¯ä¸€ä¸ªç±»åŠå…¶ç›¸å…³è”çš„ç±»</span></div><div class="line"><span class="keyword">void</span> objc_disposeClassPair ( Class cls ); <span class="comment">// å¦‚æœç¨‹åºä¸­è¿˜å­˜åœ¨è¯¥ç±»æˆ–å­ç±»çš„å®ä¾‹ï¼Œå°±ä¸èƒ½å¤Ÿè°ƒç”¨è¯¥æ–¹æ³•ã€‚</span></div><div class="line"><span class="comment">// åœ¨åº”ç”¨ä¸­æ³¨å†Œç”±objc_allocateClassPairåˆ›å»ºçš„ç±»</span></div><div class="line"><span class="keyword">void</span> objc_registerClassPair ( Class cls ); <span class="comment">// åˆ›å»ºäº†æ–°ç±»åï¼Œä½¿ç”¨class_addMethodï¼Œclass_addIvarå‡½æ•°ä¸ºæ–°ç±»æ·»åŠ æ–¹æ³•ï¼Œå®ä¾‹å˜é‡å’Œå±æ€§åå†è°ƒç”¨è¿™ä¸ªæ¥æ³¨å†Œç±»ã€‚</span></div></pre></td></tr></table></figure><p>ä»£ç ç¤ºä¾‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Class cls = objc_allocateClassPair(MyClass.class, <span class="string">"MySubClass"</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">class_addMethod(cls, <span class="keyword">@selector</span>(submethod1), (IMP)imp_submethod1, <span class="string">"v@:"</span>);</div><div class="line">class_replaceMethod(cls, <span class="keyword">@selector</span>(method1), (IMP)imp_submethod1, <span class="string">"v@:"</span>);</div><div class="line"></div><div class="line">class_addIvar(cls, <span class="string">"_ivar1"</span>, <span class="keyword">sizeof</span>(<span class="built_in">NSString</span> *), log(<span class="keyword">sizeof</span>(<span class="built_in">NSString</span> *)), <span class="string">"i"</span>);</div><div class="line"></div><div class="line">objc_property_attribute_t type = &#123;<span class="string">"T"</span>, <span class="string">"@\"NSString\""</span>&#125;;</div><div class="line">objc_property_attribute_t ownership = &#123; <span class="string">"C"</span>, <span class="string">""</span> &#125;;</div><div class="line">objc_property_attribute_t backingivar = &#123; <span class="string">"V"</span>, <span class="string">"_ivar1"</span>&#125;;</div><div class="line">objc_property_attribute_t attrs[] = &#123;type, ownership, backingivar&#125;;</div><div class="line">class_addProperty(cls, <span class="string">"property2"</span>, attrs, <span class="number">3</span>);</div><div class="line"></div><div class="line">objc_registerClassPair(cls);</div><div class="line"></div><div class="line"><span class="keyword">id</span> instance = [[cls alloc] init];</div><div class="line">[instance performSelector:<span class="keyword">@selector</span>(submethod1)];</div><div class="line">[instance performSelector:<span class="keyword">@selector</span>(method1)];</div><div class="line"></div><div class="line"><span class="comment">// è¾“å‡ºç»“æœå‡ä¸ºrun sub method 1</span></div></pre></td></tr></table></figure></p><h5 id="åŠ¨æ€åˆ›å»ºå¯¹è±¡"><a href="#åŠ¨æ€åˆ›å»ºå¯¹è±¡" class="headerlink" title="åŠ¨æ€åˆ›å»ºå¯¹è±¡"></a>åŠ¨æ€åˆ›å»ºå¯¹è±¡</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// åˆ›å»ºç±»å®ä¾‹</span></div><div class="line"><span class="keyword">id</span> class_createInstance ( Class cls, size_t extraBytes );</div><div class="line"><span class="comment">// åœ¨æŒ‡å®šä½ç½®åˆ›å»ºç±»å®ä¾‹</span></div><div class="line"><span class="keyword">id</span> objc_constructInstance ( Class cls, <span class="keyword">void</span> *bytes );</div><div class="line"><span class="comment">// é”€æ¯ç±»å®ä¾‹</span></div><div class="line"><span class="keyword">void</span> * objc_destructInstance ( <span class="keyword">id</span> obj ); <span class="comment">// ä¸ä¼šé‡Šæ”¾ç§»é™¤ä»»ä½•ä¸è¯¥å®ä¾‹ç›¸å…³çš„å¼•ç”¨</span></div></pre></td></tr></table></figure><p><code>class_createInstance</code>ï¼šåˆ›å»ºå®ä¾‹æ—¶ï¼Œä¼šåœ¨é»˜è®¤çš„å†…å­˜åŒºåŸŸä¸ºç±»åˆ†é…å†…å­˜ï¼Œæ— æ³•åœ¨ARCç¯å¢ƒä¸‹ä½¿ç”¨ã€‚è¿™é‡Œå»¶ä¼¸ä¸€ä¸ªçŸ¥è¯†ç‚¹<a href="http://www.jianshu.com/p/bab5e34e5ff0" target="_blank" rel="external">æ·±å…¥ç†è§£allocã€initæ–¹æ³•</a>ï¼Œ<code>class_createInstance</code>æ•ˆæœä¸<code>alloc</code>æ–¹æ³•ç±»ä¼¼ï¼Œæˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">id</span> theObject = class_createInstance(<span class="built_in">NSString</span>.class, <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span>));</div><div class="line"> </div><div class="line"><span class="keyword">id</span> str1 = [theObject init];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [str1 <span class="keyword">class</span>]);</div><div class="line"><span class="keyword">id</span> str2 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [str2 <span class="keyword">class</span>]);</div><div class="line"></div><div class="line"><span class="comment">// è¾“å‡ºç»“æœä¸ºNSString,__NSCFConstantString</span></div></pre></td></tr></table></figure></p><p>åœ¨ä½¿ç”¨<code>objc_destructInstance</code>å‡½æ•°æ—¶å¹¶ä¸ä¼šé‡Šæ”¾å¹¶ç§»é™¤ä»»ä½•ä¸å¯¹è±¡ç›¸å…³çš„å¼•ç”¨ã€‚</p><h4 id="è·å–ç±»å®šä¹‰"><a href="#è·å–ç±»å®šä¹‰" class="headerlink" title="è·å–ç±»å®šä¹‰"></a>è·å–ç±»å®šä¹‰</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è·å–å·²æ³¨å†Œçš„ç±»å®šä¹‰çš„åˆ—è¡¨</span></div><div class="line"><span class="keyword">int</span> objc_getClassList ( Class *buffer, <span class="keyword">int</span> bufferCount );</div><div class="line"><span class="comment">// åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘æ‰€æœ‰å·²æ³¨å†Œç±»çš„æŒ‡é’ˆåˆ—è¡¨</span></div><div class="line">Class * objc_copyClassList ( <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</div><div class="line"></div><div class="line"><span class="comment">// è¿”å›æŒ‡å®šç±»çš„ç±»å®šä¹‰</span></div><div class="line">Class objc_lookUpClass ( <span class="keyword">const</span> <span class="keyword">char</span> *name );</div><div class="line">Class objc_getClass ( <span class="keyword">const</span> <span class="keyword">char</span> *name );</div><div class="line">Class objc_getRequiredClass ( <span class="keyword">const</span> <span class="keyword">char</span> *name );</div><div class="line"></div><div class="line"><span class="comment">// è¿”å›æŒ‡å®šç±»çš„å…ƒç±»</span></div><div class="line">Class objc_getMetaClass ( <span class="keyword">const</span> <span class="keyword">char</span> *name );</div></pre></td></tr></table></figure><h2 id="æˆå‘˜å˜é‡ä¸å±æ€§"><a href="#æˆå‘˜å˜é‡ä¸å±æ€§" class="headerlink" title="æˆå‘˜å˜é‡ä¸å±æ€§"></a>æˆå‘˜å˜é‡ä¸å±æ€§</h2><h3 id="æ•°æ®ç»“æ„-1"><a href="#æ•°æ®ç»“æ„-1" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><h4 id="Ivar"><a href="#Ivar" class="headerlink" title="Ivar"></a>Ivar</h4><p><code>Ivar</code>è¡¨ç¤ºå®ä¾‹å˜é‡çš„ç±»å‹ï¼ŒæŒ‡å‘<code>objc_ivar</code>ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œ<code>ivar</code>æŒ‡é’ˆåœ°å€æ˜¯æ ¹æ®<code>class</code>ç»“æ„ä½“çš„åœ°å€åŠ ä¸ŠåŸºåœ°å€åç§»å­—èŠ‚å¾—åˆ°çš„ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_ivar *Ivar;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> objc_ivar &#123;</div><div class="line">    <span class="keyword">char</span> *ivar_name               OBJC2_UNAVAILABLE;<span class="comment">// å˜é‡å</span></div><div class="line">    <span class="keyword">char</span> *ivar_type             OBJC2_UNAVAILABLE;<span class="comment">// å˜é‡ç±»å‹</span></div><div class="line">    <span class="keyword">int</span> ivar_offset            OBJC2_UNAVAILABLE;<span class="comment">// åŸºåœ°å€åç§»å­—èŠ‚</span></div><div class="line"><span class="meta">#ifdef __LP64__</span></div><div class="line">    <span class="keyword">int</span> space                 OBJC2_UNAVAILABLE;</div><div class="line"><span class="meta">#endif</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h4 id="objc-property-tã€objc-property-attribute-t"><a href="#objc-property-tã€objc-property-attribute-t" class="headerlink" title="objc_property_tã€objc_property_attribute_t"></a>objc_property_tã€objc_property_attribute_t</h4><p><code>objc_property_t</code>ï¼šå£°æ˜çš„å±æ€§çš„ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªæŒ‡å‘<code>objc_property</code>ç»“æ„ä½“çš„æŒ‡é’ˆï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_property *objc_property_t;</div></pre></td></tr></table></figure></p><p><code>objc_property_attribute_t</code>ï¼šå®šä¹‰äº†å±æ€§çš„ç‰¹æ€§çš„ç»“æ„ä½“ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;           <span class="comment">// å±æ€§ç‰¹æ€§å</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *value;          <span class="comment">// å±æ€§ç‰¹æ€§å€¼</span></div><div class="line">&#125; objc_property_attribute_t;</div></pre></td></tr></table></figure></p><p>åˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„attribureï¼š</p><table><thead><tr><th>attribure</th><th>name</th><th>value</th></tr></thead><tbody><tr><td>nonatomic</td><td>N</td><td>ç©º</td></tr><tr><td>strong/retain</td><td>&amp;</td><td>ç©º</td></tr><tr><td>weak</td><td>W</td><td>ç©º</td></tr><tr><td>copy</td><td>C</td><td>ç©º</td></tr><tr><td>å±æ€§çš„ç±»å‹type</td><td>T</td><td>@â€TypeNameâ€, å¦‚ @â€NSStringâ€</td></tr><tr><td>å±æ€§å¯¹åº”çš„å®ä¾‹å˜é‡Ivar</td><td>V</td><td>Ivar_name, å¦‚ _name</td></tr><tr><td>readonly</td><td>R</td><td>ç©º</td></tr><tr><td>getter</td><td>G</td><td>GetterName, å¦‚ isHighlight</td></tr><tr><td>setter</td><td>S</td><td>SetterName, å¦‚ setName</td></tr><tr><td>assign/atomic</td><td>é»˜è®¤å³ä¸ºassignå’Œatomic</td><td>ç©º</td></tr></tbody></table><h3 id="æ“ä½œå‡½æ•°-1"><a href="#æ“ä½œå‡½æ•°-1" class="headerlink" title="æ“ä½œå‡½æ•°"></a>æ“ä½œå‡½æ•°</h3><h4 id="æˆå‘˜å˜é‡"><a href="#æˆå‘˜å˜é‡" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è·å–æˆå‘˜å˜é‡å</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * ivar_getName ( Ivar v );</div><div class="line"><span class="comment">// è·å–æˆå‘˜å˜é‡ç±»å‹ç¼–ç </span></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * ivar_getTypeEncoding ( Ivar v );</div><div class="line"><span class="comment">// è·å–æˆå‘˜å˜é‡çš„åç§»é‡</span></div><div class="line">ptrdiff_t ivar_getOffset ( Ivar v );</div></pre></td></tr></table></figure><p>å…³äºç±»å‹ç¼–ç ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸‹å®˜æ–¹æ–‡æ¡£<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100-SW1" target="_blank" rel="external">Type Encodings</a>ã€<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html#//apple_ref/doc/uid/TP40008048-CH101-SW6" target="_blank" rel="external">Property Type String</a>ã€‚</p><h4 id="å…³è”å¯¹è±¡"><a href="#å…³è”å¯¹è±¡" class="headerlink" title="å…³è”å¯¹è±¡"></a>å…³è”å¯¹è±¡</h4><p>å¦‚æœåœ¨å¼€å‘ä¸­ä½ å‡†å¤‡ç»™ç³»ç»Ÿçš„ç±»é¢å¤–æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œä½ å¯èƒ½ä¼šæƒ³åˆ°ä½¿ç”¨ç»§æ‰¿æ¥å®ç°ï¼Œä½†æ˜¯åªå¢åŠ ä¸€ä¸ªå±æ€§ï¼Œå°±å»ç»§æ‰¿ä¸€ä¸ªç±»ï¼Œæœªå…å¤ªéº»çƒ¦äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œruntimeæä¾›äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼šå³å…³è”å¯¹è±¡(Associated Object)ã€‚å‡½æ•°å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è®¾ç½®å…³è”å¯¹è±¡</span></div><div class="line"><span class="keyword">void</span> objc_setAssociatedObject ( <span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">id</span> value, objc_AssociationPolicy policy );</div><div class="line"><span class="comment">// è·å–å…³è”å¯¹è±¡</span></div><div class="line"><span class="keyword">id</span> objc_getAssociatedObject ( <span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> *key );</div><div class="line"><span class="comment">// ç§»é™¤å…³è”å¯¹è±¡</span></div><div class="line"><span class="keyword">void</span> objc_removeAssociatedObjects ( <span class="keyword">id</span> object );</div></pre></td></tr></table></figure></p><p>å…¶ä¸­å‚æ•°å«ä¹‰ä¸ºï¼š<br>1.<code>id object</code>ç»™è°æ·»åŠ å…³è”å¯¹è±¡ã€‚<br>2.<code>const void *key</code>å…³è”å¯¹è±¡å”¯ä¸€çš„keyï¼Œè·å–æ—¶ä¼šç”¨åˆ°ã€‚<br>3.<code>id value</code>å…³è”å¯¹è±¡ã€‚<br>4.<code>objc_AssociationPolicy</code>å…³è”ç­–ç•¥ï¼Œæœ‰ä»¥ä¸‹å‡ ç§ç­–ç•¥ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">    OBJC_ASSOCIATION_ASSIGN = <span class="number">0</span>,</div><div class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="number">1</span>, </div><div class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="number">3</span>,</div><div class="line">    OBJC_ASSOCIATION_RETAIN = <span class="number">01401</span>,</div><div class="line">    OBJC_ASSOCIATION_COPY = <span class="number">01403</span> </div><div class="line">&#125;;</div></pre></td></tr></table></figure></p><p>æ ¹æ®è¦å…³è”å¯¹è±¡çš„ç±»å‹æ¥é€‰æ‹©å…³è”ç­–ç•¥ã€‚æœ‰äº†ä¸Šé¢ä¸‰ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»™åˆ†ç±»æ·»åŠ /ç§»é™¤å…³è”å¯¹è±¡äº†ï¼Œç®€å•ä»£ç å®ä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ·»åŠ å…³è”å¯¹è±¡ï¼ˆå¯ä»¥ç”¨æ–¹æ³•åœ°å€ä½œä¸ºkeyï¼‰</span></div><div class="line">- (<span class="keyword">void</span>)addAssociatedObject:(<span class="keyword">id</span>)object&#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(getAssociatedObject), object, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">&#125;</div><div class="line"><span class="comment">//è·å–å…³è”å¯¹è±¡ï¼ˆ_cmdä»£è¡¨å½“å‰è°ƒç”¨æ–¹æ³•çš„åœ°å€ï¼‰</span></div><div class="line">- (<span class="keyword">id</span>)getAssociatedObject&#123;</div><div class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h4 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è·å–å±æ€§å</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * property_getName ( objc_property_t property );</div><div class="line"><span class="comment">// è·å–å±æ€§ç‰¹æ€§æè¿°å­—ç¬¦ä¸²</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * property_getAttributes ( objc_property_t property );</div><div class="line"><span class="comment">// è·å–å±æ€§ä¸­æŒ‡å®šçš„ç‰¹æ€§</span></div><div class="line"><span class="keyword">char</span> * property_copyAttributeValue ( objc_property_t property, <span class="keyword">const</span> <span class="keyword">char</span> *attributeName );</div><div class="line"><span class="comment">// è·å–å±æ€§çš„ç‰¹æ€§åˆ—è¡¨</span></div><div class="line">objc_property_attribute_t * property_copyAttributeList ( objc_property_t property, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</div></pre></td></tr></table></figure><p>å®ä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</div><div class="line">objc_property_t * properties = class_copyPropertyList([Model <span class="keyword">class</span>], &amp;outCount);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</div><div class="line">    objc_property_t property = properties[i];</div><div class="line">    <span class="comment">//å±æ€§å</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * name = property_getName(property);</div><div class="line">    <span class="comment">//å±æ€§æè¿°</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * propertyAttr = property_getAttributes(property);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"å±æ€§ %s çš„æè¿°ä¸º %s"</span>, name, propertyAttr);</div><div class="line"></div><div class="line">    <span class="comment">//å±æ€§çš„ç‰¹æ€§</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> attrCount = <span class="number">0</span>;</div><div class="line">    objc_property_attribute_t * attrs = property_copyAttributeList(property, &amp;attrCount);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; attrCount; j ++) &#123;</div><div class="line">        objc_property_attribute_t attr = attrs[j];</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> * name = attr.name;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> * value = attr.value;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"å±æ€§ç‰¹æ€§åç§°ï¼š%s å€¼ï¼š%s"</span>, name, value);</div><div class="line">    &#125;</div><div class="line">    free(attrs);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\n"</span>);</div><div class="line">&#125;</div><div class="line">free(properties);</div></pre></td></tr></table></figure></p><p>è¾“å‡ºç»“æœä¸ºï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å¯ä»¥ç»“åˆä¸Šè¡¨ç†è§£</span></div><div class="line">[<span class="number">24076</span>:<span class="number">1005550</span>] å±æ€§ str çš„æè¿°ä¸º T<span class="string">@"NSString"</span>,C,N,V_str</div><div class="line">[<span class="number">24076</span>:<span class="number">1005550</span>] å±æ€§ç‰¹æ€§åç§°ï¼šT å€¼ï¼š<span class="string">@"NSString"</span></div><div class="line">[<span class="number">24076</span>:<span class="number">1005550</span>] å±æ€§ç‰¹æ€§åç§°ï¼šC å€¼ï¼š</div><div class="line">[<span class="number">24076</span>:<span class="number">1005550</span>] å±æ€§ç‰¹æ€§åç§°ï¼šN å€¼ï¼š</div><div class="line">[<span class="number">24076</span>:<span class="number">1005550</span>] å±æ€§ç‰¹æ€§åç§°ï¼šV å€¼ï¼š_str</div><div class="line"></div><div class="line">[<span class="number">24076</span>:<span class="number">1005550</span>] å±æ€§ array çš„æè¿°ä¸º T<span class="string">@"NSArray"</span>,R,N,V_array</div><div class="line">[<span class="number">24076</span>:<span class="number">1005550</span>] å±æ€§ç‰¹æ€§åç§°ï¼šT å€¼ï¼š<span class="string">@"NSArray"</span></div><div class="line">[<span class="number">24076</span>:<span class="number">1005550</span>] å±æ€§ç‰¹æ€§åç§°ï¼šR å€¼ï¼š</div><div class="line">[<span class="number">24076</span>:<span class="number">1005550</span>] å±æ€§ç‰¹æ€§åç§°ï¼šN å€¼ï¼š</div><div class="line">[<span class="number">24076</span>:<span class="number">1005550</span>] å±æ€§ç‰¹æ€§åç§°ï¼šV å€¼ï¼š_array</div></pre></td></tr></table></figure></p><p>é€šè¿‡ä¸Šé¢çš„ç®€å•æ€»ç»“ï¼Œæˆ‘å¯¹Objective-Cç±»ä¸å¯¹è±¡çš„åº•å±‚å®ç°æœ‰äº†æ›´æ·±çš„ç†è§£ï¼ŒåŒæ—¶ä¹Ÿæ„Ÿå—åˆ°äº†<code>runtime</code>çš„å¼ºå¤§ã€‚ä¸‹ç¯‡æ–‡ç« æˆ‘ä¼šæ€»ç»“ä¸€ä¸‹æ–¹æ³•ã€æ¶ˆæ¯çš„ç»“æ„ä¸æ“ä½œå‡½æ•°ï¼Œæ•¬è¯·æœŸå¾…~</p><p>å‚è€ƒé“¾æ¥ï¼š<br><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/index.html" target="_blank" rel="external">Objective-C Runtimeå®˜æ–¹æ–‡æ¡£</a><br><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008048" target="_blank" rel="external">Objective-C Runtime Programming Guide</a><br><a href="http://southpeak.github.io/categories/objectivec/" target="_blank" rel="external">å—å¤§runtimeæ€»ç»“</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;Runtime&lt;/code&gt;åœ¨ä¸šå†…æœ‰iOSå¼€å‘â€˜â€˜é»‘ç§‘æŠ€â€™â€™ä¹‹ç§°ï¼Œä½†åœ¨å¹³æ—¶å¼€å‘ä¸­ä¹Ÿå°±æ¥è§¦äº†&lt;code&gt;Method Swizzling&lt;/code&gt;ï¼Œ&lt;code&gt;AssociatedObject&lt;/code&gt;è¿™å‡ ç§åº”ç”¨ï¼Œç”¨äº†è¿™ä¹ˆä¹…OCï¼Œå´å¯¹å®ƒçš„å†…åœ¨ä¸€æ— æ‰€çŸ¥ï¼Œå®åœ¨è¯´ä¸è¿‡å»â€¦ä»Šå¤©æˆ‘æ¥æ€»ç»“ä¸€ä¸‹æœ€è¿‘å­¦ä¹ &lt;code&gt;runtime&lt;/code&gt;çš„çŸ¥è¯†ç‚¹ï¼Œçœ‹çœ‹å®ƒç©¶ç«Ÿâ€˜â€˜é»‘â€™â€™åœ¨å“ªé‡Œã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="runtime" scheme="http://wonkeyz.com/tags/runtime/"/>
    
  </entry>
  
  <entry>
    <title>iOSæ€§èƒ½ä¼˜åŒ–UIç¯‡ï¼ˆäºŒï¼‰</title>
    <link href="http://wonkeyz.com/2017/06/29/iOS-Performance%20optimization-UI-2/"/>
    <id>http://wonkeyz.com/2017/06/29/iOS-Performance optimization-UI-2/</id>
    <published>2017-06-29T08:59:23.000Z</published>
    <updated>2017-10-27T10:36:55.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šå›ï¼Œæˆ‘ä»¬æ¥èŠä¸€ä¸‹UIæ€§èƒ½ä¼˜åŒ–çš„å‡ å¤§é‡ç‚¹å¯¹è±¡ã€‚</p><h3 id="UITableView"><a href="#UITableView" class="headerlink" title="UITableView"></a>UITableView</h3><p>æˆ‘ç›¸ä¿¡æ¯ä¸€ä½iOSå¼€å‘äººå‘˜å†™<code>UITableView</code>è‚¯å®šéƒ½è¦å†™åäº†ï¼Œä½†æ˜¯å¤§å®¶ç¡®å®šåœ¨å†™çš„æ—¶å€™éƒ½æ³¨æ„åˆ°è¿™äº›åŸåˆ™orç»†èŠ‚äº†å—ï¼Ÿ</p><ul><li>å°½é‡é¿å…åŠ¨æ€é«˜åº¦çš„cellï¼Œå¦‚æœå·²ç¡®å®šæ§ä»¶çš„é«˜åº¦ï¼Œç›´æ¥ä½¿ç”¨<code>tableView</code>çš„<code>rowHeight</code>ã€<code>sectionHeaderHeight</code>å’Œ<code>sectionFooterHeight</code>è®¾ç½®é«˜åº¦ï¼Œé¿å…è¯·æ±‚delegateã€‚åœ¨<code>heightForRowAtIndexPath:</code>ä¸­å°½é‡ä¸ä½¿ç”¨<code>cellForRowAtIndexPath:</code>ï¼Œå¦‚æœä½ éœ€è¦ç”¨åˆ°å®ƒï¼Œæœ€å¥½åªç”¨ä¸€æ¬¡ç„¶åç¼“å­˜ç»“æœã€‚<a id="more"></a></li><li>ä½¿ç”¨<code>dequeueReusableCellWithIdentifier:</code>æˆ–<code>dequeueReusableCellWithIdentifier:forIndexPath:</code>å¤ç”¨cellï¼Œåè€…éœ€è¦æ­é…<code>registerClass/Nib:forCellReuseIdentifier:</code>ä½¿ç”¨ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨é»˜è®¤æ²¡æœ‰cellå¯å¤ç”¨çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„cellå‡ºæ¥ï¼Œæ¨èä½¿ç”¨åè€…ã€‚</li><li>å¯¹äºåŠ¨æ€é«˜åº¦çš„cellï¼Œåšå¯¹åº”æ ‡è®°ï¼Œç¼“å­˜è¡Œé«˜ã€‚æ¨èä½¿ç”¨sunnyxxå¤§ç¥çš„<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell" target="_blank" rel="external">UITableView-FDTemplateLayoutCell</a>ã€‚å¦‚æœcellå¯¹åº”çš„æ¨¡å‹æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¸åšç›¸åº”çš„è®¡ç®—æ¸²æŸ“å¤„ç†ã€‚</li><li>ä½¿ç”¨è‡ªå®šä¹‰è§†å›¾æ„é€ çš„cellï¼Œè¦é¿å…è°ƒç”¨<code>layoutIfNeeded</code>æ¯æ¬¡å¯¹å…¶è¿›è¡Œå¸ƒå±€ã€‚å°½é‡å›ºå®šcellå­è§†å›¾çš„å°ºå¯¸ï¼Œç¡®ä¿æ¯ä¸ªcellæ¸²æŸ“æ‰€éœ€æ—¶é—´æœ€å°åŒ–ã€‚<br>å°½é‡ä½¿ç”¨ä¸é€æ˜çš„å­è§†å›¾ï¼ŒåŒ…æ‹¬cellæœ¬èº«ï¼Œè¿™ç‚¹å·²ç»åœ¨ä¸Šç¯‡åŸºæœ¬æ³•ä¸­æè¿‡ã€‚<br>ç¡®ä¿cellçš„å­è§†å›¾æ•°é‡æœ€å°‘ï¼Œé¿å…è€—è´¹æ€§èƒ½çš„æ“ä½œï¼Œå¦‚å›¾ç‰‡çš„ç¼©æ”¾ã€æ¸å˜ç­‰ã€‚<br>å¦‚æœè‡ªå®šä¹‰cellçš„æ ·å¼åŸºæœ¬ç¡®å®šä¸ä¼šå‘ç”Ÿå¤§çš„å¸ƒå±€å˜åŒ–ï¼Œæˆ–è€…åœ¨æ»‘åŠ¨æ—¶æœ‰æ˜æ˜¾çš„æ€§èƒ½é—®é¢˜ï¼Œé‚£ä¹ˆä½ å¯èƒ½éœ€è¦å¼‚æ­¥ç»˜åˆ¶è¿™ä¸ªcellï¼Œæˆ‘ä¼šåœ¨è‡ªå®šä¹‰è§†å›¾éƒ¨åˆ†è®²è§£ã€‚</li><li>åœ¨å¿«é€Ÿæ»šåŠ¨æ—¶å¦‚æœå‡ºç°äº†å¡é¡¿ï¼Œé‚£ä¹ˆä½ é™¤äº†ä½¿ç”¨å¼‚æ­¥ç»˜åˆ¶cellï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨â€˜â€˜å ä½â€™â€™cellï¼Œè¿™ç§æ–¹å¼åœ¨å›½å†…çš„Appæ¯”è¾ƒå°‘è§ï¼Œå¦‚å›¾ï¼š<br><img src="http://owgqmweju.bkt.clouddn.com/17-10-26/41893848.jpg" alt="å›¾1"><br>â€˜â€˜å ä½â€™â€™cellç±»ä¼¼äºå ä½å›¾ï¼Œå®ƒå‘Šè¯‰ç”¨æˆ·è¿™éƒ¨åˆ†å³å°†å±•ç¤ºä¸€äº›ä¿¡æ¯ï¼Œå½“æ»šåŠ¨é€Ÿåº¦é™ä½åˆ°ä¸€å®šå€¼æ—¶ï¼Œå†å±•ç¤ºæœ€ç»ˆæ•°æ®ã€‚éƒ¨åˆ†ä»£ç å®ç°å¦‚ä¸‹ï¼š<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)scrollViewDidScroll:(<span class="built_in">UIScrollView</span> *)scrollView &#123;</div><div class="line">    <span class="comment">// é€šè¿‡scrollViewçš„panGestureRecognizerè·å–æ»‘åŠ¨é€Ÿç‡</span></div><div class="line">    <span class="keyword">self</span>.velocity = [scrollView.panGestureRecognizer velocityInView:<span class="keyword">self</span>.view];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</div><div class="line">    <span class="comment">// æ ¹æ®æ»‘åŠ¨é€Ÿç‡åšç›¸åº”å†…å®¹å±•ç¤º</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.velocity.y &gt; maxVelocity) &#123;</div><div class="line">        <span class="keyword">return</span> placeholderCell;</div><div class="line">    &#125;<span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> cell;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><p>è¿˜æœ‰ä¸€ç§saoå¥—è·¯æ˜¯æŒ‰éœ€åŠ è½½cell<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æŒ‰éœ€åŠ è½½ - å¦‚æœç›®æ ‡è¡Œä¸å½“å‰è¡Œç›¸å·®è¶…è¿‡æŒ‡å®šè¡Œæ•°ï¼Œåªåœ¨ç›®æ ‡æ»šåŠ¨èŒƒå›´çš„å‰åæŒ‡å®š3è¡ŒåŠ è½½ã€‚</span></div><div class="line">- (<span class="keyword">void</span>)scrollViewWillEndDragging:(<span class="built_in">UIScrollView</span> *)scrollView withVelocity:(<span class="built_in">CGPoint</span>)velocity targetContentOffset:(<span class="keyword">inout</span> <span class="built_in">CGPoint</span> *)targetContentOffset&#123;</div><div class="line">    <span class="built_in">NSIndexPath</span> *ip = [<span class="keyword">self</span> indexPathForRowAtPoint:<span class="built_in">CGPointMake</span>(<span class="number">0</span>, targetContentOffset-&gt;y)];</div><div class="line">    <span class="built_in">NSIndexPath</span> *cip = [[<span class="keyword">self</span> indexPathsForVisibleRows] firstObject];</div><div class="line">    <span class="built_in">NSInteger</span> skipCount = <span class="number">8</span>;</div><div class="line">    <span class="keyword">if</span> (labs(cip.row - ip.row) &gt; skipCount) &#123;</div><div class="line">        <span class="built_in">NSArray</span> *temp = [<span class="keyword">self</span> indexPathsForRowsInRect:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, targetContentOffset-&gt;y, <span class="keyword">self</span>.width, <span class="keyword">self</span>.height)];</div><div class="line">        <span class="built_in">NSMutableArray</span> *arr = [<span class="built_in">NSMutableArray</span> arrayWithArray:temp];</div><div class="line">        <span class="keyword">if</span> (velocity.y &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="built_in">NSIndexPath</span> *indexPath = [temp lastObject];</div><div class="line">            <span class="keyword">if</span> (indexPath.row + <span class="number">3</span> &lt; datas.count) &#123;</div><div class="line">                [arr addObject:[<span class="built_in">NSIndexPath</span> indexPathForRow:indexPath.row+<span class="number">1</span> inSection:<span class="number">0</span>]];</div><div class="line">                [arr addObject:[<span class="built_in">NSIndexPath</span> indexPathForRow:indexPath.row+<span class="number">2</span> inSection:<span class="number">0</span>]];</div><div class="line">                [arr addObject:[<span class="built_in">NSIndexPath</span> indexPathForRow:indexPath.row+<span class="number">3</span> inSection:<span class="number">0</span>]];</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">NSIndexPath</span> *indexPath = [temp firstObject];</div><div class="line">            <span class="keyword">if</span> (indexPath.row &gt; <span class="number">3</span>) &#123;</div><div class="line">                [arr addObject:[<span class="built_in">NSIndexPath</span> indexPathForRow:indexPath.row<span class="number">-3</span> inSection:<span class="number">0</span>]];</div><div class="line">                [arr addObject:[<span class="built_in">NSIndexPath</span> indexPathForRow:indexPath.row<span class="number">-2</span> inSection:<span class="number">0</span>]];</div><div class="line">                [arr addObject:[<span class="built_in">NSIndexPath</span> indexPathForRow:indexPath.row<span class="number">-1</span> inSection:<span class="number">0</span>]];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        [needLoadArr addObjectsFromArray:arr];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// åœ¨`tableView:cellForRowAtIndexPath:`æ–¹æ³•ä¸­åŠ å…¥åˆ¤æ–­ï¼šï¼Œä¿®æ”¹æ ·å¼</span></div><div class="line"><span class="keyword">if</span> (needLoadArr.count &gt; <span class="number">0</span></div><div class="line">    &amp;&amp;</div><div class="line">    [needLoadArr indexOfObject:indexPath] == <span class="built_in">NSNotFound</span>) &#123;</div><div class="line">        [cell clear];</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p><p>è¯¦è§<a href="https://github.com/johnil/VVeboTableViewDemo" target="_blank" rel="external">VVeboTableViewDemo</a></p><h3 id="UIWebViewã€WKWebView"><a href="#UIWebViewã€WKWebView" class="headerlink" title="UIWebViewã€WKWebView"></a>UIWebViewã€WKWebView</h3><p>ç”±äºH5å…·æœ‰åŠ¨æ€åŒ–ï¼Œä¸ç”¨å‘ç‰ˆç­‰ä¼˜åŠ¿ï¼Œè¶Šæ¥è¶Šå¤šçš„H5é¡µé¢å‡ºç°çš„åŸç”ŸAppä¸­ã€‚è‹¹æœæä¾›äº†ä¸¤ç§åŠ è½½H5çš„æ§ä»¶ï¼Œ<code>UIWebView</code>,<code>WKWebView</code>ï¼Œ<code>WKWebView</code>æ˜¯iOS8çš„æ–°ç‰¹æ€§ï¼Œé€šè¿‡ç®€å•çš„æµ‹è¯•å³å¯å‘ç°UIWebViewå ç”¨è¿‡å¤šå†…å­˜ï¼Œä¸”å†…å­˜å³°å€¼æ›´æ˜¯å¤¸å¼ ã€‚WKWebViewç½‘é¡µåŠ è½½é€Ÿåº¦æ›´å¿«ï¼Œå ç”¨å†…å­˜æ›´å°ï¼Œä¸‹é¢åˆ—ä¸¾ä¸€äº›å…¶å®ƒçš„ä¼˜åŠ¿ï¼š</p><ul><li>æ”¯æŒæ›´å¤šçš„H5ç‰¹æ€§</li><li>60fpsçš„æ»šåŠ¨åˆ·æ–°ç‡åŠå†…ç½®æ‰‹åŠ¿</li><li>ä¸Safariç›¸åŒçš„JavaScriptå¼•æ“</li><li>å°†<code>UIWebView</code>å’Œ<code>UIWebViewDelegate</code>é‡æ„æˆäº†14ä¸ªç±»ï¼Œ3ä¸ªåè®®ï¼Œå¯ä»¥è®©å¼€å‘è€…è¿›è¡Œæ›´ç»†è‡´çš„é…ç½®</li></ul><p>ç®€ç›´å®Œçˆ†<code>UIWebView</code>ï¼Œæ‰€ä»¥æƒ³è¦ä¼˜åŒ–ä½ çš„webViewï¼Œé‚£ä¹ˆä»ç°åœ¨å¼€å§‹å¼ƒ<code>UIWebView</code>ï¼Œç”¨<code>WKWebView</code>å§ï¼ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹<code>WKWebView</code>ã€‚  </p><h4 id="åŠ è½½é¡µé¢"><a href="#åŠ è½½é¡µé¢" class="headerlink" title="åŠ è½½é¡µé¢"></a>åŠ è½½é¡µé¢</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import<span class="meta-string">&lt;WebKit/WebKit.h&gt;</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)loadRequest &#123;</div><div class="line">    _wkWebView = [[<span class="built_in">WKWebView</span> alloc] initWithFrame:<span class="keyword">self</span>.view.bounds configuration:[<span class="built_in">WKWebViewConfiguration</span> new]]; </div><div class="line">    <span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://www.wonkeyz.com/"</span>]];</div><div class="line">    [_wkWebView loadRequest:request];</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="åŸç”Ÿè°ƒç”¨JS"><a href="#åŸç”Ÿè°ƒç”¨JS" class="headerlink" title="åŸç”Ÿè°ƒç”¨JS"></a>åŸç”Ÿè°ƒç”¨JS</h4><p>1.ä½¿ç”¨<code>WKUserScript</code><br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// JSä»£ç </span></div><div class="line"><span class="built_in">NSString</span> *js = <span class="string">@"window.alert('æµ‹è¯•åŸç”Ÿè°ƒç”¨JS');"</span>;</div><div class="line"><span class="comment">// æ ¹æ®JSä»£ç åˆå§‹åŒ–WKUserScriptå¯¹è±¡</span></div><div class="line"><span class="built_in">WKUserScript</span> *script = [[<span class="built_in">WKUserScript</span> alloc] initWithSource:js injectionTime:<span class="built_in">WKUserScriptInjectionTimeAtDocumentEnd</span> forMainFrameOnly:<span class="literal">YES</span>];</div><div class="line"><span class="comment">// æ ¹æ®ç”Ÿæˆçš„WKUserScriptå¯¹è±¡ï¼Œåˆå§‹åŒ–WKWebViewConfiguration</span></div><div class="line"><span class="built_in">WKWebViewConfiguration</span> *config = [<span class="built_in">WKWebViewConfiguration</span> new];</div><div class="line">[config.userContentController addUserScript:script];</div></pre></td></tr></table></figure></p><p>2.ç›´æ¥è°ƒç”¨JSä»£ç <br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[_wkWebView evaluateJavaScript:js completionHandler:^(<span class="keyword">id</span> _Nullable, <span class="built_in">NSError</span> * _Nullable error) &#123;</div><div class="line">        <span class="comment">// è·å–jsæ–¹æ³•è¿”å›å€¼ï¼Œå›è°ƒæ“ä½œç­‰</span></div><div class="line">    &#125;];</div></pre></td></tr></table></figure></p><h4 id="JSè°ƒç”¨åŸç”Ÿ"><a href="#JSè°ƒç”¨åŸç”Ÿ" class="headerlink" title="JSè°ƒç”¨åŸç”Ÿ"></a>JSè°ƒç”¨åŸç”Ÿ</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å‘JSæ³¨å…¥OCæ–¹æ³•</span></div><div class="line">[[_webView configuration].userContentController addScriptMessageHandler:<span class="keyword">self</span> name:<span class="string">@"ocMethod"</span>];</div><div class="line"></div><div class="line"><span class="comment">// JSè°ƒç”¨</span></div><div class="line">window.webkit.messageHandlers.ocMethod.postMessage(value);</div><div class="line"></div><div class="line"><span class="comment">// æ¥æ”¶JSè°ƒç”¨</span></div><div class="line">- (<span class="keyword">void</span>)userContentController:(<span class="built_in">WKUserContentController</span> *)userContentController didReceiveScriptMessage:(<span class="built_in">WKScriptMessage</span> *)message &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"JS è°ƒç”¨äº† %@ æ–¹æ³•ï¼Œä¼ å›å‚æ•° %@"</span>,message.name,message.body);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ä¸è¿‡<code>WKWebView</code>è¿˜æ˜¯æœ‰ä¸€äº›å‘çš„ï¼Œæœ‰å¾ˆå¤šç›¸å…³æ–‡ç« ï¼Œè¿™é‡Œå¥‰ä¸Šå‡ ç¯‡å¤§ä½¬çš„æ€»ç»“<a href="http://www.jianshu.com/p/403853b63537" target="_blank" rel="external">WKWebViewçš„ä½¿ç”¨å’Œå„ç§å‘çš„è§£å†³æ–¹æ³•ï¼ˆOCï¼‹Swiftï¼‰</a>ï¼Œ<a href="http://www.jianshu.com/p/7bb5f15f1daa" target="_blank" rel="external">WKWebViewå­¦ä¹ ç¬”è®°</a>ã€‚</p><h3 id="è‡ªå®šä¹‰è§†å›¾çš„ç»˜åˆ¶"><a href="#è‡ªå®šä¹‰è§†å›¾çš„ç»˜åˆ¶" class="headerlink" title="è‡ªå®šä¹‰è§†å›¾çš„ç»˜åˆ¶"></a>è‡ªå®šä¹‰è§†å›¾çš„ç»˜åˆ¶</h3><p>æˆ‘ä»¬æ¥åšä¸€ä¸ªç®€å•çš„demoï¼Œå¦‚å›¾ï¼š<img src="http://owgqmweju.bkt.clouddn.com/17-10-27/22309726.jpg" alt="å›¾2"><br>æ­£å¸¸ä»£ç å¸ƒå±€å°±ä¸å†™äº†ï¼Œè¿™é‡Œç»™å‡ºç»˜åˆ¶ä»£ç <br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)drawRect:(<span class="built_in">CGRect</span>)rect &#123;</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"drink.jpg"</span>];</div><div class="line">        <span class="built_in">CGRect</span> imageFrame = <span class="built_in">CGRectMake</span>(<span class="number">15</span>, <span class="number">15</span>, <span class="number">80</span>, <span class="number">80</span>);</div><div class="line">        [image drawInRect:imageFrame];</div><div class="line">    &#125;</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">NSString</span> *title = <span class="string">@"This is title,This is title,This is title,This is title"</span>;</div><div class="line">        <span class="built_in">UIFont</span> *titleFont = [<span class="built_in">UIFont</span> boldSystemFontOfSize:<span class="number">17</span>];</div><div class="line">        <span class="built_in">NSDictionary</span> *attrs = @&#123;<span class="built_in">NSFontAttributeName</span> : titleFont,</div><div class="line">                                <span class="built_in">NSForegroundColorAttributeName</span> : kTextColor</div><div class="line">                                &#125;;</div><div class="line">        <span class="built_in">CGRect</span> titleFrame = <span class="built_in">CGRectMake</span>(<span class="number">105</span>, <span class="number">10</span>, <span class="keyword">self</span>.width - <span class="number">125</span>, <span class="number">30</span>);</div><div class="line">        [title drawInRect:titleFrame withAttributes:attrs];</div><div class="line">    &#125;</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">NSString</span> *content = <span class="string">@"This is content,This is content,This is content,This is content,This is content"</span>;</div><div class="line">        <span class="built_in">UIFont</span> *contentFont = [<span class="built_in">UIFont</span> boldSystemFontOfSize:<span class="number">13</span>];</div><div class="line">        <span class="built_in">NSDictionary</span> *attrs = @&#123;<span class="built_in">NSFontAttributeName</span> : contentFont,</div><div class="line">                                <span class="built_in">NSForegroundColorAttributeName</span> : kLigthTextColor</div><div class="line">                                &#125;;</div><div class="line">        <span class="built_in">CGRect</span> contentFrame = <span class="built_in">CGRectMake</span>(<span class="number">105</span>, <span class="number">40</span>, <span class="keyword">self</span>.width - <span class="number">125</span>, <span class="number">40</span>);</div><div class="line">        [content drawInRect:contentFrame withAttributes:attrs];</div><div class="line">    &#125;</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">NSString</span> *time = <span class="string">@"This is time"</span>;</div><div class="line">        <span class="built_in">UIFont</span> *timeFont = [<span class="built_in">UIFont</span> boldSystemFontOfSize:<span class="number">12</span>];</div><div class="line">        <span class="built_in">NSDictionary</span> *attrs = @&#123;<span class="built_in">NSFontAttributeName</span> : timeFont,</div><div class="line">                                <span class="built_in">NSForegroundColorAttributeName</span> : kLigthTextColor</div><div class="line">                                &#125;;</div><div class="line">        <span class="built_in">CGRect</span> timeFrame = <span class="built_in">CGRectMake</span>(<span class="number">105</span>, <span class="number">80</span>, <span class="keyword">self</span>.width - <span class="number">125</span>, <span class="number">20</span>);</div><div class="line">        [time drawInRect:timeFrame withAttributes:attrs];</div><div class="line">    &#125;</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</div><div class="line">        <span class="built_in">CGContextSetStrokeColorWithColor</span>(context, kLineBackColor.CGColor);</div><div class="line">        <span class="built_in">CGContextStrokeRect</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="keyword">self</span>.height - kLineHeight, <span class="keyword">self</span>.width, kLineHeight));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>å¯¹æ¯”ä¸€ä¸‹æ¸²æŸ“æ—¶é—´ï¼Œå·¦ä¸ºå¤åˆè§†å›¾æ–¹å¼ï¼Œå³ä¸ºç›´æ¥ç»˜åˆ¶<br><img src="http://owgqmweju.bkt.clouddn.com/17-10-27/34929283.jpg" alt="å›¾3"><br>é€šè¿‡å¯¹æ¯”å‘ç°ç»˜åˆ¶å¾—åˆ°çš„cellæ¸²æŸ“æ—¶é—´ç¼©çŸ­æ˜æ˜¾ï¼Œå¯¹äºæ›´å¤æ‚çš„ç•Œé¢æ€§èƒ½ä¼˜åŠ¿å¯æƒ³è€ŒçŸ¥ã€‚å› æ­¤ï¼Œä»æ€§èƒ½è§’åº¦æ¥çœ‹ï¼Œç›´æ¥ç»˜åˆ¶è§†å›¾æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†ä»ç»´æŠ¤è§’åº¦æ¥çœ‹ï¼Œä»£ç ä¼šæ¯”è¾ƒéš¾ç»´æŠ¤è¿­ä»£ï¼Œæ‰€ä»¥åœ¨æŸäº›ç•Œé¢æ ·å¼ç¨³å®šä¸‹æ¥ï¼Œä½ å¯ä»¥è€ƒè™‘é‡æ„æˆç»˜åˆ¶è§†å›¾ã€‚æˆ–è€…ç›´æ¥ä½¿ç”¨ä¸Šæ–‡æåˆ°çš„é«˜æ€§èƒ½æ¡†æ¶<a href="https://github.com/ibireme/YYKit" target="_blank" rel="external">YYkit</a>ã€<a href="https://github.com/TextureGroup/Texture" target="_blank" rel="external">Texture</a>ã€‚</p><h3 id="Auto-Layout"><a href="#Auto-Layout" class="headerlink" title="Auto Layout"></a>Auto Layout</h3><p>å†è¡¥å……ä¸€ä¸‹æ¯”è¾ƒå…·æœ‰äº‰è®®æ€§çš„Auto Layoutï¼Œå®ƒç»™æˆ‘ä»¬æ—¥å¸¸å¼€å‘å¸¦æ¥äº†å¾ˆå¤§çš„ä¾¿åˆ©ï¼Œä½†ä¾¿åˆ©çš„ä»£ä»·å°±æ˜¯è€—è´¹æ›´å¤šçš„æ€§èƒ½ã€‚<br>Auto Layoutä½¿ç”¨Cassowaryç®—æ³•ä½œä¸ºçº¦æŸæ±‚è§£å·¥å…·åŒ…ï¼Œä»–çš„å¤æ‚åº¦ä¸ºOï¼ˆNï¼‰ï¼Œå…¶ä¸­Næ˜¯çº¦æŸçš„æ•°ç›®ï¼Œè€Œä¸æ˜¯å…ƒç´ çš„æ•°ç›®ã€‚è¿™æ„å‘³ç€ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ºäº†ç¡®å®šè§†å›¾ä¸­æ‰€æœ‰å…ƒç´ çš„ä½ç½®å’Œå¤§å°ï¼Œå¯èƒ½æœ‰å¤§æ¦‚4Nä¸ªæ–¹ç¨‹è¦æ±‚è§£ï¼Œè€Œä¸”æ–¹ç¨‹èŠ±è´¹çš„æ—¶é—´ä¸å…ƒç´ çš„ä¸ªæ•°å’ŒåŒ…å«çš„çº¦æŸä¸ªæ•°æ˜¯ä¸æˆæ¯”ä¾‹çš„ã€‚å½“è§†å›¾æ•°é‡å¢åŠ è‡³å‡ ç™¾ä¸ªï¼Œç›´æ¥è®¾è®¾ç½®ç»“æ„å¤§å°è¦æ¯”ç”¨è‡ªåŠ¨å¸ƒå±€å¿«1000å€å·¦å³ï¼(æµ‹è¯•demo<a href="https://github.com/floriankugler/AutoLayoutProfiling" target="_blank" rel="external">AutoLayoutProfiling</a>)<br>æ›´è¯¦ç»†çš„åˆ†æè¯·è§<a href="https://draveness.me/layout-performance" target="_blank" rel="external">ä» Auto Layout çš„å¸ƒå±€ç®—æ³•è°ˆæ€§èƒ½</a>ã€‚<br>æ‰€ä»¥å½“ä½ ä¸ºæŸä¸ªä½¿ç”¨Auto Layoutçš„ç•Œé¢æ€§èƒ½æ¶ˆè€—è‹¦æ¼æ—¶ï¼Œé‚£ä¹ˆè¯·æ”¹ä¸ºä»£ç å¸ƒå±€å§ğŸ˜‚  </p><p>UIç¯‡çš„æ€§èƒ½ä¼˜åŒ–å°±æ€»ç»“åˆ°è¿™ï¼Œèœé¸Ÿç¬¬ä¸€æ¬¡å†™è¿™ç±»æ–‡ç« è¿˜è¯·å„ä½å¤§ä½¬å¤šåŒ…æ¶µï¼Œåªæ±‚åˆ«è¾£åˆ°å„ä½å¤§ä½¬çš„åŒçœ¼ğŸ˜‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¹¦æ¥ä¸Šå›ï¼Œæˆ‘ä»¬æ¥èŠä¸€ä¸‹UIæ€§èƒ½ä¼˜åŒ–çš„å‡ å¤§é‡ç‚¹å¯¹è±¡ã€‚&lt;/p&gt;
&lt;h3 id=&quot;UITableView&quot;&gt;&lt;a href=&quot;#UITableView&quot; class=&quot;headerlink&quot; title=&quot;UITableView&quot;&gt;&lt;/a&gt;UITableView&lt;/h3&gt;&lt;p&gt;æˆ‘ç›¸ä¿¡æ¯ä¸€ä½iOSå¼€å‘äººå‘˜å†™&lt;code&gt;UITableView&lt;/code&gt;è‚¯å®šéƒ½è¦å†™åäº†ï¼Œä½†æ˜¯å¤§å®¶ç¡®å®šåœ¨å†™çš„æ—¶å€™éƒ½æ³¨æ„åˆ°è¿™äº›åŸåˆ™orç»†èŠ‚äº†å—ï¼Ÿ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å°½é‡é¿å…åŠ¨æ€é«˜åº¦çš„cellï¼Œå¦‚æœå·²ç¡®å®šæ§ä»¶çš„é«˜åº¦ï¼Œç›´æ¥ä½¿ç”¨&lt;code&gt;tableView&lt;/code&gt;çš„&lt;code&gt;rowHeight&lt;/code&gt;ã€&lt;code&gt;sectionHeaderHeight&lt;/code&gt;å’Œ&lt;code&gt;sectionFooterHeight&lt;/code&gt;è®¾ç½®é«˜åº¦ï¼Œé¿å…è¯·æ±‚delegateã€‚åœ¨&lt;code&gt;heightForRowAtIndexPath:&lt;/code&gt;ä¸­å°½é‡ä¸ä½¿ç”¨&lt;code&gt;cellForRowAtIndexPath:&lt;/code&gt;ï¼Œå¦‚æœä½ éœ€è¦ç”¨åˆ°å®ƒï¼Œæœ€å¥½åªç”¨ä¸€æ¬¡ç„¶åç¼“å­˜ç»“æœã€‚
    
    </summary>
    
    
      <category term="æ€§èƒ½ä¼˜åŒ–" scheme="http://wonkeyz.com/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
      <category term="UITableView" scheme="http://wonkeyz.com/tags/UITableView/"/>
    
      <category term="UIWebView" scheme="http://wonkeyz.com/tags/UIWebView/"/>
    
      <category term="WKWebView" scheme="http://wonkeyz.com/tags/WKWebView/"/>
    
  </entry>
  
  <entry>
    <title>iOSæ€§èƒ½ä¼˜åŒ–UIç¯‡ï¼ˆä¸€ï¼‰</title>
    <link href="http://wonkeyz.com/2017/06/24/iOS-Performance%20optimization-UI-1/"/>
    <id>http://wonkeyz.com/2017/06/24/iOS-Performance optimization-UI-1/</id>
    <published>2017-06-24T06:22:03.000Z</published>
    <updated>2017-10-26T09:16:53.935Z</updated>
    
    <content type="html"><![CDATA[<p> è¿™æ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„è¯é¢˜ï¼Œç¨‹åºçŒ¿çš„ä¸€ç”Ÿé™¤äº†åœ¨ç¼–è¯‘ã€å†™bugã€æ”¹bugï¼Œå°±æ˜¯åœ¨ä¸æ–­åœ°é‡æ„ä¼˜åŒ–ï¼Œä¼˜åŒ–çš„ç‚¹ä¹Ÿå¤šç§å¤šæ ·ï¼Œå…¶ä¸­æœ€ç›´è§‚æœ‰æ•ˆçš„å°±æ˜¯UIéƒ¨åˆ†çš„ä¼˜åŒ–äº†ï¼Œè¿™æ–¹é¢æœ‰å¾ˆå¤šç›¸å…³èµ„æ–™ï¼Œä¹Ÿæœ‰å¦‚<a href="https://github.com/ibireme/YYKit" target="_blank" rel="external">YYkit</a>ã€<a href="https://github.com/TextureGroup/Texture" target="_blank" rel="external">Texture</a>è¿™ç§ç¥çº§æ¡†æ¶ä»æ ¹æºä¸Šè§£å†³äº†å¡é¡¿çš„é—®é¢˜ã€‚ä½œä¸ºèœé¸Ÿçš„æˆ‘æ— æ³•åƒå¤§ä½¬ä»¬ä¸€æ ·ä»æ ¹æºä¸Šåˆ†æè§£å†³UIæ€§èƒ½é—®é¢˜ï¼Œåªèƒ½å†™ä¸€ç¯‡æ¯”è¾ƒåŸºç¡€çš„æ–‡ç« ï¼Œæ€»ç»“ä¸€ä¸‹å¸¸ç”¨çš„æ§ä»¶çš„ä½¿ç”¨æ³¨æ„ç‚¹ï¼Œå¸Œæœ›å¯¹ä½ çš„æ—¥å¸¸å¼€å‘æœ‰å¸®åŠ©~<br> <a id="more"></a></p><h3 id="åŸºæœ¬æ³•"><a href="#åŸºæœ¬æ³•" class="headerlink" title="åŸºæœ¬æ³•"></a>åŸºæœ¬æ³•</h3><p>å…ˆæ¥ä¸€æ³¢UIæ“ä½œçš„åŸºæœ¬æ³•åˆ™ï¼š</p><ul><li>å°½é‡å‡å°‘åœ¨ä¸»çº¿ç¨‹ä¸­çš„æ“ä½œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚æ‰§è¡Œçš„æ“ä½œè¶Šå¤šå°±æ„å‘³ç€è¶Šé«˜çš„ä¸¢å¸§ç‡ï¼Œä»è€Œå¯¼è‡´ä¸¢å¸§å¡é¡¿ã€‚</li><li>å°½é‡ä¿æŒè§†å›¾çš„æ‰å¹³åŒ–ï¼Œé¿å…è§†å›¾çš„å¤šå±‚åµŒå¥—ã€‚<br>åªè¦ç»™è§†å›¾æ·»åŠ å­è§†å›¾ï¼Œæˆ–å…¶å­è§†å›¾å¸ƒå±€å‘ç”Ÿå˜åŒ–éƒ½ä¼šè§¦å‘çˆ¶è§†å›¾çš„<code>layoutSubviews</code>æ–¹æ³•ï¼Œå¦‚æœä¸€ä¸ªè§†å›¾è¢«å¡äº†å¾ˆå¤šå­è§†å›¾ï¼Œæ€§èƒ½æ¶ˆè€—å¯æƒ³è€ŒçŸ¥ã€‚é‚£ä¹ˆè¿™ç§æƒ…å†µå¦‚ä½•é¿å…å‘¢ï¼Ÿæœ€å¥½çš„æ–¹æ³•æ˜¯è‡ªå®šä¹‰è§†å›¾ç»˜åˆ¶ã€‚è¿™æ ·åªä¼šè§¦å‘ä¸€ä¸ªè§†å›¾çš„ç»˜åˆ¶æ–¹æ³•ï¼Œè€Œä¸æ˜¯å¤šä¸ªå­è§†å›¾çš„ï¼ŒåŒæ—¶é¿å…äº†çˆ¶è§†å›¾å¤šæ¬¡è°ƒç”¨<code>layoutSubviews</code>å’Œ<code>drawRect:</code>æ–¹æ³•ï¼Œå…·ä½“æ“ä½œæ–‡ä¸­ä¼šç»™å‡ºdemoã€‚  </li><li>å°½é‡ä½¿ç”¨ä¸é€æ˜è§†å›¾ã€‚<br>å½“ä¸€ä¸ªviewæ˜¯é€æ˜çš„ï¼ŒiOSéœ€è¦æ¸²æŸ“ä¸€ä¸ªåƒç´ ä¸¤æ¬¡æˆ–å¤šæ¬¡ï¼Œè¿™æ˜¯å› ä¸ºä¸€ä¸ªåƒç´ åŒæ—¶å±äºå¾ˆå¤šsubviewsã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶çš„è¿‡ç¨‹ã€‚ä¸é€æ˜çš„è§†å›¾å¯ä»¥æå¤§åœ°æé«˜æ¸²æŸ“çš„é€Ÿåº¦ã€‚å› æ­¤å¦‚éå¿…è¦ï¼Œå¯ä»¥å°†table cellåŠå…¶å­è§†å›¾çš„<code>opaque</code>å±æ€§è®¾ä¸ºYESï¼ˆé»˜è®¤å€¼ï¼‰ã€‚</li><li>ä¸€äº›æƒ…å†µä¸‹é¿å…ä½¿ç”¨å…·æœ‰é€šç”¨ç›®çš„åŠåŠŸèƒ½ä¸°å¯Œçš„æ§ä»¶ï¼Œç³»ç»Ÿæ§ä»¶è™½ç„¶æ–¹ä¾¿ï¼Œä½†æœ‰æ—¶ä¹Ÿä¼šå¸¦æ¥ä¸å¿…è¦çš„æ¶ˆè€—ï¼Œä½ å¯ä»¥é€šè¿‡å°è£…è§†å›¾ç»˜åˆ¶å†…å®¹æ¥ä»£æ›¿ã€‚å¦‚åªæ˜¾ç¤ºå¤§æ®µçº¯æ–‡æœ¬ï¼Œé‚£ä¹ˆä¸å¿…ä½¿ç”¨åŠŸèƒ½å¤æ‚çš„<code>UILabel</code>ã€‚</li><li>å°½é‡å»¶è¿ŸåŠ è½½ã€é‡ç”¨å¤æ‚è§†å›¾ã€‚<br>è¿™ç‚¹æˆ‘ç›¸ä¿¡å¤§å®¶åœ¨ä½¿ç”¨<code>UITableView</code>ã€<code>UICollectionView</code>æ—¶éƒ½æ·±æœ‰ä½“ä¼šï¼Œå¦‚æœä½ å¯¹æœºåˆ¶è¶³å¤Ÿäº†è§£ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨<code>UIScrollView</code>æ—¶ä¹Ÿå¯ä»¥å°è¯•ä½¿ç”¨é‡ç”¨æœºåˆ¶ã€‚</li><li>å°½é‡é¿å…å‡ºç°è¾ƒå¤§çš„xibæˆ–storyboardã€‚sbå›ºç„¶å¼ºå¤§ï¼Œä½†æ•´ä¸ªXMLæ–‡ä»¶åœ¨ä½¿ç”¨ä¹‹å‰å¿…é¡»è¢«è§£æå’ŒåŠ è½½ï¼Œæ‰€ä»¥åº”è¯¥æœ€å°åŒ–sbä¸­çš„å•å…ƒæ•°ç›®ï¼Œåˆ›å»ºå¤šä¸ªsbæˆ–xibï¼Œè¿™æ ·ä¸ä»…æœ‰åŠ©äºå‡å°‘åº”ç”¨å¯åŠ¨æ—¶é—´ï¼Œè¿˜èƒ½é™ä½æ•´ä½“å†…å­˜æ¶ˆè€—ã€‚</li></ul><p>èŠå®ŒåŸºæœ¬æ³•ï¼Œæˆ‘ä»¬æ¥èŠä¸€ä¸‹å‡ ä¸ªå¸¸è§è§†å›¾ï¼Œçœ‹çœ‹æœ‰å“ªäº›æ€§èƒ½å°æŠ€å·§ã€‚</p><h4 id="UILabel"><a href="#UILabel" class="headerlink" title="UILabel"></a>UILabel</h4><p>è¿™ç»å¯¹æ˜¯ä½ ç”¨çš„æœ€å¤šçš„æ§ä»¶ï¼Œçœ‹ä¼¼ç®€å•ï¼Œä½†ä½ çœŸçš„äº†è§£å®ƒçš„æ€§èƒ½æ¶ˆè€—ç‚¹å—ï¼Ÿå…ˆæ¥çœ‹çœ‹ä»–æœ‰å¤šå¤æ‚ã€‚<br><img src="http://owgqmweju.bkt.clouddn.com/17-10-19/50317192.jpg" alt="å›¾1"><br>å›¾ä¸­çš„æ¯ä¸€é¡¹è®¾ç½®éƒ½ä¼šå¢åŠ <code>UILabel</code>çš„æ¸²æŸ“ä»£ä»·ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š<br>1.ä½¿ç”¨å­—ä½“æ ·å¼åŠè¦è¢«æ¸²æŸ“çš„æ–‡æœ¬æ—¶ï¼Œè®¡ç®—éœ€è¦çš„åƒç´ æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¶ˆè€—è¾ƒå¤§çš„è¿‡ç¨‹ï¼Œåº”å°½é‡å°‘åšã€‚<br>2.æ£€æŸ¥è¦è¢«æ¸²æŸ“çš„å®½åº¦ã€‚<br>3.æ£€æŸ¥<code>numberOfLines</code>ï¼Œè®¡ç®—å°†è¦å±•ç¤ºçš„è¡Œæ•°ã€‚<br>4.<code>sizeToFit</code>æ˜¯å¦è¢«è°ƒç”¨ï¼Œè°ƒç”¨åˆ™è®¡ç®—é«˜åº¦ï¼Œæœªè°ƒç”¨åˆ™æ£€æŸ¥å½“å‰å°ºå¯¸æ˜¯å¦èƒ½å±•ç¤ºå®Œæ•´å†…å®¹ã€‚<br>5.å¦‚æœsizeä¸å¤Ÿå±•ç¤ºï¼Œåˆ™ä½¿ç”¨<code>lineBreakMode</code>ç¡®å®šéšè—æˆ–æˆªæ–­çš„ä½ç½®ã€‚<br>6.æ£€æŸ¥å…¶ä»–é…ç½®é€‰é¡¹ï¼Œå¦‚çº¯æ–‡æœ¬orå¯Œæ–‡æœ¬ï¼Œå¯Œæ–‡æœ¬çš„æ ·å¼ï¼Œå¯¹é½æ–¹å¼ï¼Œè‡ªåŠ¨æ”¶ç¼©ç­‰ã€‚<br>7.æœ€åä½¿ç”¨å­—ä½“ã€ç±»å‹åŠé¢œè‰²ç­‰æ¸²æŸ“æœ€ç»ˆæ˜¾ç¤ºçš„æ–‡æœ¬ã€‚<br>æ•´ä¸ªè¿‡ç¨‹ä¸‹æ¥çš„æ¸²æŸ“ä»£ä»·ä¸å®¹å°è§‘ï¼Œæ‰€ä»¥å¹³æ—¶ä½¿ç”¨è¦é¿å…ä¸€äº›ä¸å¿…è¦çš„æ€§èƒ½æµªè´¹ã€‚<br>psï¼šæœ‰æ—¶ä¼šå‘ç°labelçš„æ–‡å­—å˜æ¨¡ç³Šï¼Œé‚£ä¹ˆä½ éœ€è¦æ£€æŸ¥ä¸€ä¸‹labelçš„frameæ˜¯å¦éƒ½ä¸ºæ•´æ•°ã€‚</p><h4 id="UIButton"><a href="#UIButton" class="headerlink" title="UIButton"></a>UIButton</h4><p>æŒ‰é’®åŒæ ·æ— å¤„ä¸åœ¨ï¼Œæ ·å¼å¤šå˜ã€åŠŸèƒ½å¼ºå¤§çš„å®ƒæ¸²æŸ“æ–¹å¼ä¸»è¦æœ‰ä»¥ä¸‹å››ç§ï¼š</p><ul><li>ä½¿ç”¨è‡ªå®šä¹‰æ–‡æœ¬é»˜è®¤æ¸²æŸ“</li><li>å…¨å°ºå¯¸èµ„æºæ¸²æŸ“</li><li>å¯å˜å°ºå¯¸èµ„æºæ¸²æŸ“</li><li>ä½¿ç”¨<code>CALayer</code>å’Œè´å¡å°”æ›²çº¿è‡ªå®šä¹‰ç»˜åˆ¶</li></ul><p>ä¸‹è¡¨ç®€å•åˆ—å‡ºäº†å‡ ç§æ¸²æŸ“æ–¹å¼çš„åˆ©å¼Šã€‚å…·ä½“è§<a href="https://robots.thoughtbot.com/designing-for-ios-taming-uibutton#advantages-of-bezier-approach" target="_blank" rel="external">Designing for iOS: Taming UIButton</a>ã€‚</p><table><thead><tr><th>æ¸²æŸ“æ–¹å¼</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>è‡ªå®šä¹‰æ–‡æœ¬</td><td>ç®€å•æ˜“ç”¨</td><td>æ ·å¼å•ä¸€</td></tr><tr><td>å…¨å°ºå¯¸èµ„æº</td><td>å¯è‡ªå®šä¹‰èƒŒæ™¯å›¾ <br> æ ·å¼å¤šå˜ <br> å¯å®ç°A/Bæµ‹è¯•</td><td>å›¾ç‰‡å¯¼è‡´ipaåŒ…å˜å¤§</td></tr><tr><td>å¯å˜å°ºå¯¸èµ„æº</td><td>ipaåŒ…å¤§å°å¢é‡è¾ƒå…¨å°ºå¯¸å°</td><td>èµ„æºçš„ä»»ä½•æ›´æ”¹å¯èƒ½éƒ½ä¼šé‡æ–°è®¡ç®—<code>UIEdgeInsets</code></td></tr><tr><td>è‡ªå®šä¹‰ç»˜åˆ¶</td><td>é«˜åº¦è‡ªå®šä¹‰æ ·å¼</td><td>éšç€è¿­ä»£ä»£ç å›è¶Šå‘è‡ƒè‚¿</td></tr></tbody></table><p>é€šè¿‡ä¸Šé¢çš„æ¯”è¾ƒï¼Œä½ éœ€è¦æƒè¡¡ä¸€ä¸‹åˆ©å¼Šï¼Œåˆ°åº•æ˜¯è¦æ€§èƒ½èƒ½è¿˜æ˜¯è¦ipaåŒ…ä¿æŒåˆé€‚çš„å¤§å°ã€‚</p><h4 id="UIImageView"><a href="#UIImageView" class="headerlink" title="UIImageView"></a>UIImageView</h4><p>å›¾åƒçš„ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œä½†åœ¨æ¸²æŸ“ä»£ä»·è¾ƒå¤§çš„UIå…ƒç´ ä¸­ï¼Œå›¾åƒé¦–å±ˆä¸€æŒ‡ã€‚åœ¨ä½¿ç”¨UIImageã€UIImageViewæ—¶ï¼Œæ³¨æ„ä»¥ä¸‹å‡ ç‚¹æœ‰åŠ©äºæ€§èƒ½æå‡ï¼š</p><ul><li>åŠ è½½å›¾ç‰‡çš„æ–¹å¼æœ‰ä¸‰ç§<code>imageNamed:</code>ã€<code>imageWithContentsOfFile:</code>ã€<code>imageWithData:</code>ï¼Œæ­£ç¡®é€‰æ‹©å›¾ç‰‡åŠ è½½æ–¹å¼èƒ½å¤Ÿå¯¹å†…å­˜ä¼˜åŒ–èµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ã€‚<br><code>imageNamed:</code>ä¼˜ç‚¹åœ¨äºå¯ä»¥ç¼“å­˜å·²ç»åŠ è½½çš„å›¾ç‰‡ï¼Œç¡®ä¿å†…å®¹åªè¢«åŠ è½½è‡³å†…å­˜ä¸€æ¬¡ï¼Œè¿™å¯¹äºå›¾åƒçš„é‡å¤åˆ©ç”¨æ˜¯éå¸¸æœ‰ä¼˜åŠ¿çš„ã€‚å¯¹äºå¸¸ç”¨çš„å°å›¾æ¨èä½¿ç”¨è¯¥æ–¹æ³•ï¼Œå¯ä»¥èŠ‚çœå‡ºæ¯æ¬¡éƒ½ä»ç£ç›˜åŠ è½½å›¾ç‰‡çš„æ—¶é—´ï¼Œè¿™æ ·èƒ½æ›´å¥½çš„å“åº”ç”¨æˆ·çš„æ“ä½œã€‚<br><code>imageWithContentsOfFile:</code>å’Œ<code>imageWithData:</code>è¿™ä¸¤ç§æ–¹æ³•çš„æœ¬è´¨æ˜¯ä¸€æ ·çš„ï¼Œ éƒ½æ˜¯ç®€å•çš„åŠ è½½å›¾ç‰‡ï¼Œå¹¶ä¸ä¼šå°†å›¾ç‰‡ç¼“å­˜èµ·æ¥ï¼Œå›¾åƒä¼šè¢«ç³»ç»Ÿä»¥æ•°æ®æ–¹å¼åŠ è½½åˆ°ç•Œé¢ã€‚ä¸€äº›ä¸å¸¸ç”¨çš„å¤§å›¾æ¨èä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•ï¼Œè¿™æ ·å°±ä¸ä¼šç¼“å­˜è¿™äº›å›¾ç‰‡å ç”¨å†…å­˜ã€‚</li><li>å¯¹äºç½‘ç»œå›¾åƒï¼Œä½¿ç”¨é«˜æ€§èƒ½çš„å›¾åƒç¼“å­˜åº“ï¼Œå¦‚<a href="https://github.com/ibireme/YYWebImage" target="_blank" rel="external">YYWebImage</a>ã€<a href="https://github.com/rs/SDWebImage" target="_blank" rel="external">SDWebImage</a>ã€‚</li><li>åœ¨å›¾ç‰‡æ ¼å¼çš„é€‰æ‹©ä¸ŠåŒæ ·å¾ˆæœ‰è®²ç©¶ï¼Œé€‰æ‹©åˆé€‚çš„æ ¼å¼èƒ½å¤Ÿä¸ºä½ çš„åº”ç”¨å¸¦æ¥æœ€ä½³ä½“éªŒï¼Œè¿™é‡Œå¥‰ä¸ŠYYå¤§ç¥çš„åšæ–‡<a href="https://blog.ibireme.com/2015/11/02/mobile_image_benchmark/" target="_blank" rel="external">ç§»åŠ¨ç«¯å›¾ç‰‡æ ¼å¼è°ƒç ”</a>ã€‚</li><li>è½½å…¥çš„å›¾ç‰‡ä¸<code>UIImageView</code>å°ºå¯¸ç›¸åŒã€‚å› ä¸ºè°ƒæ•´å›¾ç‰‡å°ºå¯¸æ˜¯ä¸€ä¸ªæ€§èƒ½æ¶ˆè€—è¾ƒå¤§çš„æ“ä½œï¼Œå¦‚æœå›¾åƒåœ¨<code>UIScrollView</code>ä¸­ï¼Œåˆ™æ¶ˆè€—æ›´å¤§ã€‚å¦‚æœå›¾ç‰‡æ¥è‡ªç½‘ç»œä¸‹è½½ï¼Œé‚£ä¹ˆå°½é‡åšåˆ°ä¸‹è½½çš„å›¾ç‰‡ä¸è§†å›¾å°ºå¯¸åŒ¹é…ï¼Œæˆ–è€…å¯¹å›¾ç‰‡è¿›è¡Œé¢„å¤„ç†ï¼Œè°ƒæ•´å°ºå¯¸ã€‚</li><li>åœ¨éä¸»çº¿ç¨‹ä¸­è§£å‹JPG/PNGå›¾ç‰‡ï¼Œæœ€å¥½åœ¨ä¸€ä¸ªä¸“ç”¨é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚</li><li>åœ¨ä¸€äº›ç•Œé¢çš„å®ç°ä¸Šï¼Œç¡®å®šæ˜¯å¦çœŸçš„éœ€è¦å›¾ç‰‡ã€‚å¦‚å±•ç¤ºä¸€ä¸ªè¯„åˆ†æ§ä»¶<img src="http://owgqmweju.bkt.clouddn.com/17-10-20/33841778.jpg" alt="enter image description here">ï¼Œé‚£ä¹ˆæœ€å¥½é€šè¿‡ç›´æ¥ç»˜åˆ¶ï¼Œè°ƒæ•´é€æ˜åº¦æˆ–è¦†ç›–æ¥å®ç°ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¤šå¼ å›¾ç‰‡ã€‚ç±»ä¼¼æƒ…å†µçš„å–èˆæ—¢å¯ä»¥ä¼˜åŒ–æ€§èƒ½ï¼Œè¿˜èƒ½ç»™å®‰è£…åŒ…ç˜¦èº«ã€‚</li></ul><p>å…ˆæ€»ç»“åˆ°è¿™é‡Œï¼Œä¸‹ç¯‡æˆ‘ä¼šæ€»ç»“ä¸€äº›å…³äº<code>UITableView</code>ã€<code>WebView</code>å’Œè‡ªå®šä¹‰è§†å›¾çš„æ€§èƒ½ä¼˜åŒ–ç‚¹ï¼Œæ•¬è¯·æœŸå¾…ï¼</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt; è¿™æ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„è¯é¢˜ï¼Œç¨‹åºçŒ¿çš„ä¸€ç”Ÿé™¤äº†åœ¨ç¼–è¯‘ã€å†™bugã€æ”¹bugï¼Œå°±æ˜¯åœ¨ä¸æ–­åœ°é‡æ„ä¼˜åŒ–ï¼Œä¼˜åŒ–çš„ç‚¹ä¹Ÿå¤šç§å¤šæ ·ï¼Œå…¶ä¸­æœ€ç›´è§‚æœ‰æ•ˆçš„å°±æ˜¯UIéƒ¨åˆ†çš„ä¼˜åŒ–äº†ï¼Œè¿™æ–¹é¢æœ‰å¾ˆå¤šç›¸å…³èµ„æ–™ï¼Œä¹Ÿæœ‰å¦‚&lt;a href=&quot;https://github.com/ibireme/YYKit&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;YYkit&lt;/a&gt;ã€&lt;a href=&quot;https://github.com/TextureGroup/Texture&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Texture&lt;/a&gt;è¿™ç§ç¥çº§æ¡†æ¶ä»æ ¹æºä¸Šè§£å†³äº†å¡é¡¿çš„é—®é¢˜ã€‚ä½œä¸ºèœé¸Ÿçš„æˆ‘æ— æ³•åƒå¤§ä½¬ä»¬ä¸€æ ·ä»æ ¹æºä¸Šåˆ†æè§£å†³UIæ€§èƒ½é—®é¢˜ï¼Œåªèƒ½å†™ä¸€ç¯‡æ¯”è¾ƒåŸºç¡€çš„æ–‡ç« ï¼Œæ€»ç»“ä¸€ä¸‹å¸¸ç”¨çš„æ§ä»¶çš„ä½¿ç”¨æ³¨æ„ç‚¹ï¼Œå¸Œæœ›å¯¹ä½ çš„æ—¥å¸¸å¼€å‘æœ‰å¸®åŠ©~&lt;br&gt;
    
    </summary>
    
    
      <category term="æ€§èƒ½ä¼˜åŒ–" scheme="http://wonkeyz.com/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ä»¿Facebookç‚¹èµåŠ¨ç”»</title>
    <link href="http://wonkeyz.com/2017/06/20/Imitation-Facebook-point-like-animation/"/>
    <id>http://wonkeyz.com/2017/06/20/Imitation-Facebook-point-like-animation/</id>
    <published>2017-06-20T07:13:44.000Z</published>
    <updated>2017-11-22T06:24:04.903Z</updated>
    
    <content type="html"><![CDATA[<p>å…ˆå†™ä¸€ä¸ªç®€å•çš„åŠ¨ç”»ç»ƒç»ƒæ‰‹ï¼Œæ•ˆæœå¦‚å›¾ï¼š<br><img src="http://owgqmweju.bkt.clouddn.com/17-10-16/8652901.jpg" alt="å›¾1"><br><a id="more"></a></p><h3 id="æ‹†è§£åŠ¨ç”»"><a href="#æ‹†è§£åŠ¨ç”»" class="headerlink" title="æ‹†è§£åŠ¨ç”»"></a>æ‹†è§£åŠ¨ç”»</h3><p>æ— è®ºåŠ¨ç”»å¤šå¤æ‚ï¼ˆè™½ç„¶è¿™ä¸ªå¹¶ä¸å¤æ‚ğŸ˜‚ï¼‰ï¼Œæˆ‘ç›¸ä¿¡éƒ½æ˜¯ç”±è‹¥å¹²ç®€å•çš„åŠ¨ç”»ç»„æˆçš„ï¼Œä¸‹é¢æ¥æ‹†è§£ä¸€ä¸‹è¿™ä¸ªåŠ¨ç”»ï¼Œé€ä¸€å®ç°æ•ˆæœè‡ªç„¶å°±è¾¾åˆ°äº†~</p><ul><li>ç¼©æ”¾åŠ¨ç”»</li><li>ç²’å­åŠ¨ç”»</li></ul><h3 id="ç¼©æ”¾åŠ¨ç”»"><a href="#ç¼©æ”¾åŠ¨ç”»" class="headerlink" title="ç¼©æ”¾åŠ¨ç”»"></a>ç¼©æ”¾åŠ¨ç”»</h3><p>ç¼©æ”¾åŠ¨ç”»å®ç°èµ·æ¥å¾ˆç®€å•ï¼Œè¿™é‡Œç”¨åˆ°äº†å¸§åŠ¨ç”»ï¼Œç›´æ¥ä¸Šä»£ç ï¼Œä¸€ç›®äº†ç„¶~<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark - Target Method</span></div><div class="line">- (<span class="keyword">void</span>)clickButtonAction &#123;</div><div class="line">    <span class="keyword">self</span>.selected = !<span class="keyword">self</span>.selected;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.selected) &#123;</div><div class="line">        [<span class="keyword">self</span> popOutside];</div><div class="line">        [_explodeView animate];</div><div class="line">    &#125;<span class="keyword">else</span> &#123;</div><div class="line">        [<span class="keyword">self</span> popInside];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#pragma mark - Animate Methods</span></div><div class="line">- (<span class="keyword">void</span>)popInside &#123;</div><div class="line">    <span class="keyword">self</span>.transform = <span class="built_in">CGAffineTransformIdentity</span>;</div><div class="line">    </div><div class="line">    [<span class="built_in">UIView</span> animateKeyframesWithDuration:<span class="number">.5</span>f delay:<span class="number">0</span> options:<span class="number">0</span> animations:^&#123;</div><div class="line">        </div><div class="line">        [<span class="built_in">UIView</span> addKeyframeWithRelativeStartTime:<span class="number">0</span></div><div class="line">                                relativeDuration:<span class="number">1</span> / <span class="number">2.</span>f</div><div class="line">                                      animations:^&#123;</div><div class="line">                                          <span class="keyword">self</span>.transform = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">.7</span>f, <span class="number">.7</span>f);</div><div class="line">                                      &#125;];</div><div class="line">        [<span class="built_in">UIView</span> addKeyframeWithRelativeStartTime:<span class="number">1</span> / <span class="number">2.</span>f</div><div class="line">                                relativeDuration:<span class="number">1</span> / <span class="number">2.</span>f</div><div class="line">                                      animations:^&#123;</div><div class="line">                                          <span class="keyword">self</span>.transform = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">1.</span>f, <span class="number">1.</span>f);</div><div class="line">                                      &#125;];</div><div class="line">    &#125; completion:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)popOutside &#123;</div><div class="line">    <span class="keyword">self</span>.transform = <span class="built_in">CGAffineTransformIdentity</span>;</div><div class="line">    </div><div class="line">    [<span class="built_in">UIView</span> animateKeyframesWithDuration:<span class="number">.5</span>f delay:<span class="number">0</span> options: <span class="built_in">UIViewKeyframeAnimationOptionCalculationModeCubicPaced</span> animations: ^&#123;</div><div class="line">        </div><div class="line">        [<span class="built_in">UIView</span> addKeyframeWithRelativeStartTime:<span class="number">0</span></div><div class="line">                                relativeDuration:<span class="number">1</span> / <span class="number">3.</span>f</div><div class="line">                                      animations:^&#123;</div><div class="line">                                          <span class="keyword">self</span>.transform = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">1.5</span>f, <span class="number">1.5</span>f);</div><div class="line">                                      &#125;];</div><div class="line">        [<span class="built_in">UIView</span> addKeyframeWithRelativeStartTime:<span class="number">1</span> / <span class="number">3.</span>f</div><div class="line">                                relativeDuration:<span class="number">1</span> / <span class="number">3.</span>f</div><div class="line">                                      animations:^&#123;</div><div class="line">                                          <span class="keyword">self</span>.transform = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">.8</span>f, <span class="number">.8</span>f);</div><div class="line">                                      &#125;];</div><div class="line">        [<span class="built_in">UIView</span> addKeyframeWithRelativeStartTime:<span class="number">2</span> / <span class="number">3.</span>f</div><div class="line">                                relativeDuration:<span class="number">1</span> / <span class="number">3.</span>f</div><div class="line">                                      animations:^&#123;</div><div class="line">                                          <span class="keyword">self</span>.transform = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">1.</span>f, <span class="number">1.</span>f);</div><div class="line">                                      &#125;];</div><div class="line">    &#125; completion:<span class="literal">nil</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="ç²’å­åŠ¨ç”»"><a href="#ç²’å­åŠ¨ç”»" class="headerlink" title="ç²’å­åŠ¨ç”»"></a>ç²’å­åŠ¨ç”»</h3><p>è¿™ä¸ªçˆ†ç‚¸æ•ˆæœæ˜¯ä¸æ˜¯çœ‹èµ·æ¥å¾ˆçœ¼ç†Ÿï¼Ÿæ²¡é”™å…¶å®å®ƒè·ŸçƒŸèŠ±ã€ä¸‹é›ªçš„åŠ¨ç”»å®ç°æ˜¯ä¸€æ ·çš„ï¼Œéƒ½ç”¨åˆ°äº†<code>CALayer</code>çš„ä¸€ä¸ªé«˜æ€§èƒ½åŸç”Ÿç²’å­å¼•æ“<a href="https://developer.apple.com/documentation/quartzcore/caemitterlayer" target="_blank" rel="external">CAEmitterLayer</a>ã€‚<br>ç®€å•ä»‹ç»ä¸€ä¸‹<code>CAEmitterLayer</code>ï¼Œ<code>CAEmitterLayer</code>ç›¸å½“äº<code>CAEmitterCell</code>çš„å®¹å™¨ï¼Œæ¯ä¸€ä¸ªcellç›¸å½“äºä¸€ä¸ªç²’å­ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸€ä¸ª<code>CAEmitterCell</code>ç²’å­æ•ˆæœæ¥ä½œä¸ºç²’å­æ ·å¼æ¨¡æ¿ï¼Œæ¯”å¦‚ç²’å­çš„å›¾ç‰‡ã€ç”Ÿæˆç‡ã€ç”Ÿå‘½å‘¨æœŸç­‰å‚æ•°ï¼Œ<code>CAEmitterLayer</code>ä¼šåŸºäºæ¨¡æ¿å®ä¾‹åŒ–è¯¥æ ·å¼çš„ç²’å­æµï¼Œæ ¹æ®è®¾ç½®å¥½çš„å‘å°„ä½ç½®ã€å‘å°„æ¨¡å¼ã€å½¢çŠ¶ä½¿ä»–ä»¬åŠ¨èµ·æ¥ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setupEmitterLayer &#123;</div><div class="line">    <span class="keyword">self</span>.clipsToBounds = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">self</span>.userInteractionEnabled = <span class="literal">NO</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//åˆ›å»ºç²’å­</span></div><div class="line">    <span class="built_in">CAEmitterCell</span> *emitter = [<span class="built_in">CAEmitterCell</span> emitterCell];</div><div class="line">    emitter.contents        = (<span class="keyword">id</span>)[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"like_dot"</span>].CGImage;</div><div class="line">    emitter.name            = <span class="string">@"emitterCell"</span>;</div><div class="line">    emitter.birthRate       = <span class="number">0</span>;</div><div class="line">    emitter.lifetime        = <span class="number">.7</span>f;</div><div class="line">    emitter.lifetimeRange   = <span class="number">.3</span>f;</div><div class="line">    emitter.alphaRange      = <span class="number">.2</span>f;</div><div class="line">    emitter.alphaSpeed      = <span class="number">-1.</span>f;</div><div class="line">    emitter.velocity        = <span class="number">40.</span>f;</div><div class="line">    emitter.velocityRange   = <span class="number">10.</span>f;</div><div class="line">    emitter.emissionRange   = M_PI_4;</div><div class="line">    emitter.scale           = <span class="number">.05</span>f;</div><div class="line">    emitter.scaleRange      = <span class="number">.02</span>f;</div><div class="line">    </div><div class="line">    <span class="comment">//åˆ›å»ºç²’å­å›¾å±‚</span></div><div class="line">    _emitterLayer = [<span class="built_in">CAEmitterLayer</span> layer];</div><div class="line">    _emitterLayer.name              = <span class="string">@"emitterLayer"</span>;</div><div class="line">    _emitterLayer.frame             = <span class="keyword">self</span>.bounds;</div><div class="line">    _emitterLayer.emitterShape      = kCAEmitterLayerCircle;</div><div class="line">    _emitterLayer.emitterMode       = kCAEmitterLayerOutline;</div><div class="line">    _emitterLayer.emitterPosition   = <span class="keyword">self</span>.center;</div><div class="line">    _emitterLayer.emitterSize       = <span class="built_in">CGSizeMake</span>(<span class="number">25</span>, <span class="number">0</span>);</div><div class="line">    _emitterLayer.renderMode        = kCAEmitterLayerOldestFirst;</div><div class="line">    _emitterLayer.masksToBounds     = <span class="literal">NO</span>;</div><div class="line">    _emitterLayer.emitterCells      = @[emitter];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.layer addSublayer: _emitterLayer];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#pragma mark - Public Methods</span></div><div class="line">- (<span class="keyword">void</span>)animate &#123;</div><div class="line">    [_emitterLayer removeAnimationForKey:<span class="string">@"likeAnimation"</span>];</div><div class="line">    dispatch_time_t delay = dispatch_time(DISPATCH_TIME_NOW, <span class="number">.2</span>f * <span class="built_in">NSEC_PER_SEC</span>);</div><div class="line">    dispatch_after(delay, dispatch_get_main_queue(), ^&#123;</div><div class="line">        <span class="keyword">self</span>.emitterLayer.beginTime = <span class="built_in">CACurrentMediaTime</span>();</div><div class="line">        <span class="built_in">CABasicAnimation</span> *animation = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath: <span class="string">@"emitterCells.emitterCell.birthRate"</span>];</div><div class="line">        animation.fromValue = @<span class="number">0</span>;</div><div class="line">        animation.toValue = @<span class="number">600</span>;</div><div class="line">        [_emitterLayer addAnimation:animation forKey:<span class="string">@"likeAnimation"</span>];</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>æå®šï¼å¦‚æœå¯¹å¸§åŠ¨ç”»å’Œç²’å­åŠ¨ç”»æœ‰ç–‘é—®å¯ä»¥çœ‹ä¸‹é¢ä¸¤ç¯‡æ–‡ç« ï¼š<br><a href="http://www.jianshu.com/p/a071bba99a1b" target="_blank" rel="external">Transformå’ŒKeyFrameåŠ¨ç”»</a><br><a href="https://segmentfault.com/a/1190000008580771" target="_blank" rel="external">CAEmitterLayerå’ŒCAEmitterCellçš„åŸºæœ¬ç”¨æ³•</a></p><p>demoåœ°å€ï¼š<a href="https://github.com/zhangMax/WZLikeButton" target="_blank" rel="external">WZLikeButton</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å…ˆå†™ä¸€ä¸ªç®€å•çš„åŠ¨ç”»ç»ƒç»ƒæ‰‹ï¼Œæ•ˆæœå¦‚å›¾ï¼š&lt;br&gt;&lt;img src=&quot;http://owgqmweju.bkt.clouddn.com/17-10-16/8652901.jpg&quot; alt=&quot;å›¾1&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="animation" scheme="http://wonkeyz.com/tags/animation/"/>
    
  </entry>
  
  <entry>
    <title>Stay hungry, Stay foolish.</title>
    <link href="http://wonkeyz.com/2017/06/13/Stay-hungry-Stay-foolish/"/>
    <id>http://wonkeyz.com/2017/06/13/Stay-hungry-Stay-foolish/</id>
    <published>2017-06-13T08:11:03.000Z</published>
    <updated>2017-10-19T07:13:24.645Z</updated>
    
    <content type="html"><![CDATA[<p>åšäº†ä¸€å¹´å¤šiOSå¼€å‘çš„èœé¸Ÿä¸€åªï¼Œå¹³æ—¶å–œæ¬¢çœ‹å„ç§å¤§ä½¬çš„åšå®¢ï¼Œè·ç›Šè‰¯å¤šï¼Œä½†éšç€å¹´é¾„çš„å¢é•¿ï¼Œè®°æ€§è¶Šæ¥è¶Šå·®â€¦çœ‹è¿‡çš„ä¸œè¥¿å¦‚æœä¸è®°åœ¨å°æœ¬æœ¬ä¸Šï¼Œæ€•ä¸æ˜¯è¦å¿˜å…‰â€¦æ‰€ä»¥å¼„äº†ä¸ªåšå®¢ï¼Œè®°å½•å¹³æ—¶å·¥ä½œä¸­é‡åˆ°çš„å‘ï¼Œä»¥åŠæ‹œè¯»å¤§ä½¬åšå®¢çš„ä¸€äº›â€˜â€˜é¢†æ‚Ÿâ€™â€™ï¼Œå¸Œæœ›è‡ªå·±èƒ½åšæŒä¸‹å»ï¼Œä¹Ÿå¸Œæœ›èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›å¸®åŠ©ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åšäº†ä¸€å¹´å¤šiOSå¼€å‘çš„èœé¸Ÿä¸€åªï¼Œå¹³æ—¶å–œæ¬¢çœ‹å„ç§å¤§ä½¬çš„åšå®¢ï¼Œè·ç›Šè‰¯å¤šï¼Œä½†éšç€å¹´é¾„çš„å¢é•¿ï¼Œè®°æ€§è¶Šæ¥è¶Šå·®â€¦çœ‹è¿‡çš„ä¸œè¥¿å¦‚æœä¸è®°åœ¨å°æœ¬æœ¬ä¸Šï¼Œæ€•ä¸æ˜¯è¦å¿˜å…‰â€¦æ‰€ä»¥å¼„äº†ä¸ªåšå®¢ï¼Œè®°å½•å¹³æ—¶å·¥ä½œä¸­é‡åˆ°çš„å‘ï¼Œä»¥åŠæ‹œè¯»å¤§ä½¬åšå®¢çš„ä¸€äº›â€˜â€˜é¢†æ‚Ÿâ€™â€™ï¼Œå¸Œæœ›è‡ªå·±èƒ½åšæŒä¸‹å»ï¼Œä¹Ÿå¸Œæœ›èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›å¸®åŠ©ã€‚&lt;/p
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://wonkeyz.com/tags/iOS/"/>
    
  </entry>
  
</feed>
